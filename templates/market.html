{% extends "base.html" %}
{% block content %}

<div class="wrap">
  <header>
    <div class="brand">üß© STL Market</div>

    <div class="search-box">
      <input id="q" placeholder="–ü–æ—à—É–∫: dragon, stand, toy..." />
      <button class="btn" id="btnSearch">üîç</button>
    </div>

    <div class="toolbar">
      <button class="btn" id="btnMine" title="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –º–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è">–ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
      <a href="{{ url_for('market.page_upload') }}" class="btn primary">+ –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å</a>
    </div>
  </header>

  <div class="controls">
    <label>–ü–æ–∫–∞–∑–∞—Ç–∏:
      <select id="filterFree">
        <option value="all">–£—Å—ñ</option>
        <option value="free">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ</option>
        <option value="paid">–ü–ª–∞—Ç–Ω—ñ</option>
      </select>
    </label>
    <label>–°–æ—Ä—Ç—É–≤–∞—Ç–∏:
      <select id="sort">
        <option value="new">–ù–æ–≤—ñ</option>
        <option value="price_asc">–¶—ñ–Ω–∞ ‚Üë</option>
        <option value="price_desc">–¶—ñ–Ω–∞ ‚Üì</option>
        <option value="downloads">–ü–æ–ø—É–ª—è—Ä–Ω—ñ</option>
      </select>
    </label>
  </div>

  <div id="notice" class="notice" style="display:none"></div>

  <div id="grid" class="grid"></div>
  <div id="sentinel" class="sentinel"></div>
</div>

<style>
  :root {
    --bg:#0f1116; --card:#141923; --muted:#8792a7;
    --line:#232a3a; --text:#e7ebf4; --accent:#3b82f6; --danger:#ef4444;
  }
  .wrap{max-width:1280px;margin:0 auto;padding:16px;}
  header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;}
  .brand{font-weight:800;font-size:18px;letter-spacing:.3px;}
  .search-box{flex:1;display:flex;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:6px;}
  .search-box input{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;outline:none;}
  .toolbar{display:flex;gap:8px}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
  .btn:active{transform:scale(.98);}
  .btn.danger{border-color:var(--danger); color:#fff; background:var(--danger);}
  .btn.ghost{opacity:.85}
  .btn.active{outline:2px solid var(--accent)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;}
  select{background:var(--card);border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px 10px;}

  /* 3 –≤ —Ä—è–¥ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ, –¥–∞–ª—ñ 2/1 */
  .grid{display:grid;gap:16px;grid-template-columns:repeat(3,minmax(0,1fr));}
  @media(max-width:1100px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
  @media(max-width:700px){ .grid{grid-template-columns:1fr;} }

  .item{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:transform .15s;}
  .item:hover{transform:translateY(-2px);}

  /* –°—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ñ—Ä–µ–π–º –ø—ñ–¥ –ø—Ä–µ–≤‚Äô—é (–Ω–µ —Å—Ç—Ä–∏–±–∞—î —ñ –Ω–µ —Ä–æ–∑—Ç—è–≥—É—î –ø–µ—Ä—à—É –∫–∞—Ä—Ç–∫—É) */
  .thumb-wrap{position:relative;width:100%;padding-top:66.666%; /* 3:2 */ background:#0c0f16;border-bottom:1px solid var(--line);cursor:pointer;}
  .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block;}

  .meta{padding:12px;display:flex;flex-direction:column;gap:6px;}
  .title{font-weight:700;}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px;}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 6px;border-radius:999px;color:var(--muted);}
  .muted{color:var(--muted);font-size:13px;}
  .price{font-weight:700;}
  .actions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
  .empty{text-align:center;color:var(--muted);padding:20px;}
  .notice{margin:8px 0;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);}
  .sentinel{height:1px}
</style>

<script type="module">
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};

  const grid = document.getElementById('grid');
  const q = document.getElementById('q');
  const filterFree = document.getElementById('filterFree');
  const sortSel = document.getElementById('sort');
  const btnSearch = document.getElementById('btnSearch');
  const btnMine = document.getElementById('btnMine');
  const notice = document.getElementById('notice');
  const sentinel = document.getElementById('sentinel');

  let MODE = 'all';         // 'all' | 'mine'
  let page = 1;
  const PER_PAGE = 24;
  let hasMore = true;
  let loading = false;
  let series = 0;

  btnSearch.addEventListener('click', resetAndLoad);
  filterFree.addEventListener('change', ()=>{ if(MODE==='all') resetAndLoad(); });
  sortSel.addEventListener('change', resetAndLoad);
  window.addEventListener('load', resetAndLoad);
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); resetAndLoad(); } });

  btnMine.addEventListener('click', ()=>{
    if (!CURRENT_USER_ID){ showNotice('–ü–æ—Ç—Ä—ñ–±–Ω–æ —É–≤—ñ–π—Ç–∏, —â–æ–± –±–∞—á–∏—Ç–∏ —Å–≤–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è.'); return; }
    MODE = (MODE === 'mine') ? 'all' : 'mine';
    btnMine.classList.toggle('active', MODE==='mine');
    resetAndLoad();
  });

  function showNotice(text, timeout=2200){
    notice.textContent = text;
    notice.style.display = 'block';
    if (timeout){ setTimeout(()=>{ notice.style.display='none'; }, timeout); }
  }

  function resetAndLoad(){
    page = 1; hasMore = true; loading = false; series++;
    grid.innerHTML = '';
    loadNextPage();
  }

  const PLACEHOLDER = '/static/img/placeholder_stl.jpg';
  function assetUrl(src){
    if (!src) return PLACEHOLDER;
    const s = String(src).trim();
    if (s.startsWith('http://') || s.startsWith('https://')) return s;
    if (s.startsWith('/static/')) return s;
    if (s.startsWith('static/'))  return '/'+s;
    return s[0] === '/' ? s : '/'+s;
  }

  async function loadNextPage(){
    if (!hasMore || loading) return;
    loading = true;
    const mySeries = series;

    const loadingCard = document.createElement('div');
    loadingCard.className = 'empty';
    loadingCard.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
    grid.appendChild(loadingCard);

    try{
      let url;
      if (MODE === 'mine'){
        url = `/api/my/items?page=${page}&per_page=${PER_PAGE}`;
      } else {
        const qs = new URLSearchParams({
          q: q.value || '',
          free: filterFree.value,
          sort: sortSel.value,             // ‚á¶ –î–û–î–ê–ù–û: –ø–µ—Ä–µ–¥–∞—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ –±–µ–∫–µ–Ω–¥
          page: String(page),
          per_page: String(PER_PAGE)
        }).toString();
        url = `/api/items?${qs}`;
      }

      const r = await fetch(url);
      if (mySeries !== series) return;

      if (!r.ok){
        if (loadingCard.parentNode === grid) grid.removeChild(loadingCard);
        if (MODE==='mine' && r.status===401){
          showNotice('–£–≤—ñ–π–¥–∏, —â–æ–± –±–∞—á–∏—Ç–∏ —Å–≤–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è.');
          grid.innerHTML = `<div class="empty">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è.</div>`;
        } else {
          grid.innerHTML = `<div class="empty">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (${r.status}).</div>`;
        }
        hasMore = false; loading = false; return;
      }

      const data = await r.json().catch(()=> ({}));
      const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      const pages = Number(data.pages || 1);

      if (loadingCard.parentNode === grid) grid.removeChild(loadingCard);
      appendItems(items);

      page += 1;
      hasMore = page <= pages && items.length > 0;

      if (!grid.children.length){
        grid.innerHTML = `<div class="empty">${MODE==='mine' ? '–£ —Ç–µ–±–µ —â–µ –Ω–µ–º–∞—î –æ–≥–æ–ª–æ—à–µ–Ω—å.' : '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòø'}</div>`;
      }
    }catch(e){
      console.error(e);
      if (loadingCard.parentNode === grid) grid.removeChild(loadingCard);
      grid.innerHTML = `<div class="empty">–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.</div>`;
      hasMore = false;
    }finally{
      loading = false;
    }
  }

  function appendItems(items){
    // –∫–ª—ñ—î–Ω—Ç—Å—å–∫–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è MODE==='mine' –∞–±–æ –∫–æ–ª–∏ —Ö–æ—á–µ—à –ø—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ—Ä—è–¥–æ–∫)
    if (sortSel.value === 'price_asc') {
      items.sort((a,b)=>(+a.price||0)-(+b.price||0));
    } else if (sortSel.value === 'price_desc') {
      items.sort((a,b)=>(+b.price||0)-(+a.price||0));
    } else if (sortSel.value === 'new') {
      items.sort((a,b)=> new Date(b.created_at || 0) - new Date(a.created_at || 0));
    } else if (sortSel.value === 'downloads') {
      items.sort((a,b)=>(+b.downloads||0)-(+a.downloads||0));
    }

    for(const it of items){
      const tagsArr = Array.isArray(it.tags)
        ? it.tags
        : (typeof it.tags === 'string' ? it.tags.split(',').map(s=>s.trim()).filter(Boolean) : []);

      // ---- –ù–û–í–ï: –Ω–∞–¥—ñ–π–Ω–∏–π –≤–∏–±—ñ—Ä –æ–±–∫–ª–∞–¥–∏–Ω–∫–∏ (cover -> cover_url -> photos.images[0] -> gallery_urls[0]) ----
      let coverCandidate = it.cover || it.cover_url || null;

      // —è–∫—â–æ –±–µ–∫–µ–Ω–¥ –≤—ñ–¥–¥–∞–≤ it.photos
      if (!coverCandidate && it.photos){
        try{
          const ph = (typeof it.photos === 'string') ? JSON.parse(it.photos) : it.photos;
          if (ph && Array.isArray(ph.images) && ph.images.length) coverCandidate = ph.images[0];
        }catch(_){}
      }
      // —è–∫—â–æ –±–µ–∫–µ–Ω–¥ –≤—ñ–¥–¥–∞–≤ it.gallery_urls —è–∫ –º–∞—Å–∏–≤ –∞–±–æ —Ä—è–¥–æ–∫ JSON
      if (!coverCandidate && it.gallery_urls){
        try{
          const g = Array.isArray(it.gallery_urls) ? it.gallery_urls
                  : JSON.parse(it.gallery_urls || '[]');
          if (Array.isArray(g) && g.length) coverCandidate = g[0];
        }catch(_){}
      }

      const coverSrc = assetUrl(coverCandidate);

      const el = document.createElement('div');
      el.className='item';
      el.dataset.id = it.id; // –ø—Ä–∏–≤ º—è–∑—É—î–º–æ id –¥–æ –∫–∞—Ä—Ç–∫–∏
      el.innerHTML = `
        <div class="thumb-wrap" data-open>
          <img src="${coverSrc}" alt="${escapeHtml(it.title||'')}" class="thumb"
               loading="lazy"
               onerror="this.onerror=null;this.src='${PLACEHOLDER}';">
        </div>
        <div class="meta">
          <div class="title">${escapeHtml(it.title||'–ë–µ–∑ –Ω–∞–∑–≤–∏')}</div>
          <div class="tags">${tagsArr.map(t=>`<span class='tag'>${escapeHtml(t)}</span>`).join('')}</div>
          <div class="muted">‚òÖ ${it.rating ?? '‚Äî'} ‚Ä¢ ‚¨áÔ∏è ${it.downloads ?? 0}</div>
          <div class="price">${(+it.price||0)===0 ? '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ' : (Number(it.price)+' PLN')}</div>
          <div class="actions">
            <button class="btn primary" data-open>–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
            ${ ownerActions() }
          </div>
        </div>
      `;
      grid.appendChild(el);
    }
  }

  // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –≤ —Ä–µ–∂–∏–º—ñ "–ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è"
  function ownerActions(){
    if (MODE !== 'mine') return '';
    return `
      <button class="btn ghost" data-edit>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
      <button class="btn danger" data-del>–í–∏–¥–∞–ª–∏—Ç–∏</button>
    `;
  }

  grid.addEventListener('click', async (e)=>{
    const card = e.target.closest('.item');
    if (!card) return;
    const itemId = card.dataset.id;

    if (e.target.closest('[data-open]')){
      if (itemId) window.location.href = `/item/${itemId}`;
      return;
    }

    if (MODE === 'mine'){
      if (e.target.closest('[data-edit]') && itemId){
        window.location.href = `/edit/${itemId}`;
        return;
      }
      if (e.target.closest('[data-del]') && itemId){
        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –±–µ–∑–ø–æ–≤–æ—Ä–æ—Ç–Ω–æ?')) return;
        try{
          const r = await fetch(`/api/item/${itemId}/delete`, { method:'POST' });
          const j = await r.json().catch(()=>({}));
          if (r.ok && j.ok){
            showNotice('–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ.');
            resetAndLoad();
          } else {
            showNotice('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ (–Ω–µ–º–∞—î –ø—Ä–∞–≤ –∞–±–æ –ø–æ–º–∏–ª–∫–∞).');
          }
        }catch(err){
          console.error(err);
          showNotice('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ.');
        }
      }
    }
  });

  const io = new IntersectionObserver((entries)=>{
    for (const en of entries){ if (en.isIntersecting) loadNextPage(); }
  }, { rootMargin: '800px 0px' });
  io.observe(sentinel);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
    ));
  }
</script>

{% endblock %}
