{% extends "base.html" %}
{% block content %}

<div class="page">
  <h1>–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</h1>

  {% if not current_user or not current_user.is_authenticated %}
    <div class="panel" style="text-align:center">
      <p class="muted">–©–æ–± —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å, —É–≤—ñ–π–¥–∏.</p>
      <a class="btn" href="{{ url_for('login') }}">–£–≤—ñ–π—Ç–∏</a>
    </div>
  {% else %}
  <div class="panel">
    <div class="row">
      <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="left">
        <div class="avatar-wrap" title="–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä">
          {% if current_user.avatar %}
            <img id="avatarPreview" class="avatar" src="{{ current_user.avatar }}" alt="avatar">
          {% else %}
            <img id="avatarPreview" class="avatar" src="{{ url_for('static', filename='avatar_default.png') }}" alt="avatar">
          {% endif %}
          <button class="edit-btn" type="button"><span>‚úé</span></button>
          <input id="avatarFile" type="file" accept="image/*">
        </div>

        <div class="stat">
          <div class="badge">üí∞ PXP: <b>{{ current_user.pxp or 0 }}</b></div>

          <!-- +1 PXP (test) -->
          <form action="{{ url_for('profile_pxp') }}" method="post" class="inline">
            <button class="btn small" type="submit">+1 PXP (test)</button>
          </form>
        </div>

        <a href="{{ url_for('top100') }}" class="btn gray" style="width:100%;text-align:center">Top-100</a>
        <a href="{{ url_for('donate') }}" class="btn" style="width:100%;text-align:center;margin-top:8px">–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ PXP</a>
      </div>

      <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="right">
        <div class="idline muted" style="margin-bottom:8px">
          id: {{ current_user.id if current_user.id is not none else "‚Äî" }} ‚Ä¢ {{ current_user.email }}
        </div>

        <form method="post" action="{{ url_for('profile_update') }}" id="profileForm" class="form">
          <div class="field">
            <div class="label">–Ü–º‚Äô—è / –Ω—ñ–∫</div>
            <input class="input" type="text" name="name" value="{{ current_user.name or '' }}" placeholder="–¢–≤–æ—î —ñ–º‚Äô—è">
          </div>

          <!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ, –∫—É–¥–∏ JS –∫–ª–∞–¥–µ dataURL –∞–≤–∞—Ç–∞—Ä–∞ -->
          <input type="hidden" name="avatar" id="avatarData" value="{{ current_user.avatar or '' }}">

          <div class="field">
            <div class="label">–ü—Ä–æ —Å–µ–±–µ</div>
            <textarea class="textarea" name="bio" rows="4" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ —Å–µ–±–µ">{{ current_user.bio or '' }}</textarea>
          </div>

          <div>
            <button class="btn" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="btn gray" type="button" id="resetBtn" style="margin-left:8px">–°–∫–∏–Ω—É—Ç–∏</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style>
  body{background:#0f1115;color:#e8eaed;margin:0}
  .page{max-width:980px;margin:0 auto;padding:16px 24px 40px}
  h1{margin:10px 0 16px;font-size:22px}
  .panel{background:#11141b;border:1px solid #1d2230;border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .row{display:flex;gap:20px;flex-wrap:wrap}
  .left{flex:0 0 260px}
  .right{flex:1}

  .muted{color:#9fb0d4}

  /* avatar */
  .avatar-wrap{position:relative;width:200px;height:200px;margin:6px auto 10px;cursor:pointer}
  .avatar{width:100%;height:100%;border-radius:50%;object-fit:cover;background:#1a2033;border:2px solid #1d2230}
  .edit-btn{position:absolute;right:8px;bottom:8px;background:#1c64ec;border:0;color:#fff;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 18px rgba(28,100,236,.35)}
  .edit-btn:hover{filter:brightness(.95)}
  .edit-btn span{font-size:20px;line-height:1}
  input[type="file"]{display:none}

  .field{margin-bottom:14px}
  .label{font-size:12px;color:#9fb0d4;margin-bottom:6px}
  .input, .textarea{
    width:100%;background:#0f131c;border:1px solid #1b2131;color:#e8eaed;
    border-radius:10px;padding:10px 12px;outline:none
  }
  .textarea{min-height:110px;resize:vertical}
  .btn{display:inline-block;padding:10px 16px;background:#1c64ec;color:#fff;font-weight:700;border-radius:10px;text-decoration:none;border:0;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  .btn.gray{background:#23293a;color:#dbe5ff}
  .btn.small{padding:8px 12px;border-radius:10px}

  .stat{display:flex;gap:10px;align-items:center;margin:8px 0 18px}
  .badge{background:#0f131c;border:1px solid #1b2131;border-radius:10px;padding:8px 10px}
  .inline{display:inline}
</style>

<script>
  // –µ–ª–µ–º–µ–Ω—Ç–∏
  const avatarWrap  = document.querySelector('.avatar-wrap');
  const avatarImg   = document.getElementById('avatarPreview');
  const avatarFile  = document.getElementById('avatarFile');
  const avatarData  = document.getElementById('avatarData');
  const resetBtn    = document.getElementById('resetBtn');

  // –∫–ª—ñ–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä—Ü—ñ –∞–±–æ –∫–Ω–æ–ø—Ü—ñ-–æ–ª—ñ–≤—Ü—é -> –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤–∏–±—ñ—Ä —Ñ–∞–π–ª—É
  avatarWrap.addEventListener('click', () => avatarFile.click());

  // –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É —Ä–æ–±–∏–º–æ –ø—Ä–µ–≤‚Äô—é —Ç–∞ –∫–ª–∞–¥–µ–º–æ –≤ hidden –ø–æ–ª–µ —è–∫ dataURL
  avatarFile.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      avatarImg.src = dataUrl;     // –ø–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤‚Äô—é
      avatarData.value = dataUrl;  // –≤—ñ–¥–ø—Ä–∞–≤–∏–º–æ –≤ –ë–î –ø—Ä–∏ "–ó–±–µ—Ä–µ–≥—Ç–∏"
    };
    reader.readAsDataURL(f);
  });

  // —Å–∫–∏–Ω—É—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ (–ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–µ—Ñ–æ–ª—Ç)
  resetBtn?.addEventListener('click', () => {
    avatarImg.src = "{{ current_user.avatar or url_for('static', filename='avatar_default.png') }}";
    avatarData.value = "{{ current_user.avatar or '' }}";
    const form = document.getElementById('profileForm');
    form.querySelector('[name="name"]').value = "{{ current_user.name or '' }}";
    form.querySelector('[name="bio"]').value  = `{{ (current_user.bio or '').replace('`','\\`') }}`;
  });
</script>

{% endblock %}
