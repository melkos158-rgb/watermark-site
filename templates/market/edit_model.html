{% extends "market/layout.html" %}

{% block title %}
–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–æ–¥–µ–ª—å ‚Äì Proofly Market
{% endblock %}

{% block content %}

<link rel="stylesheet" href="/static/css/edit_model.css">
<script src="/static/market/js/edit_model.js" defer></script>

<div class="edit-model-page">

    <!-- HEADER -->
    <header class="edit-header">
        <div class="edit-header-left">
            <a href="/market?owner=me" class="edit-back-link">‚Üê –ú–æ—ó –º–æ–¥–µ–ª—ñ</a>

            <h1 class="edit-title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–æ–¥–µ–ª—å</h1>

            <p class="edit-subtitle">
                –¢–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ.
                –§–æ—Ç–æ —Ç–∞ STL –æ–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
                <strong>¬´–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏¬ª</strong>.
            </p>
        </div>

        <div class="edit-header-right">
            <a href="/item/{{ item.id }}" class="btn btn-secondary" target="_blank">
                –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ç—ñ
            </a>
        </div>
    </header>

    <div class="edit-layout">

        <!-- LEFT SIDE ‚Äì FORM -->
        <div class="edit-main">

            <form class="edit-form"
                  action="/market/edit/{{ item.id }}"
                  method="POST"
                  enctype="multipart/form-data"
                  data-item-id="{{ item.id }}">

                <!-- COVER PREVIEW -->
                <section class="edit-section">
                    <h2 class="edit-section-title">–ü—Ä–µ–≤ º—é</h2>

                    <div class="edit-preview-row">
                        <img
                            class="preview-img"
                            src="{{
                                item.preview_url
                                or item.cover_url
                                or item.cover
                                or '/static/img/no-preview.png'
                            }}"
                        >
                    </div>
                </section>

                <!-- BASIC INFO -->
                <section class="edit-section">
                    <h2 class="edit-section-title">–ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h2>

                    <!-- TITLE -->
                    <label class="edit-label">–ù–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ</label>
                    <input class="edit-input"
                           type="text"
                           name="title"
                           value="{{ item.title }}"
                           required>

                    <!-- PRICE -->
                    <div class="edit-row">
                        <div class="edit-col">
                            <label class="edit-label">–¶—ñ–Ω–∞ (0 = –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</label>
                            <input class="edit-input"
                                   type="number"
                                   name="price"
                                   min="0"
                                   step="0.01"
                                   value="{{ item.price }}">
                        </div>

                        <div class="edit-col edit-col--hint">
                            <p class="edit-hint">
                                –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –º–æ–¥–µ–ª—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å —É 3‚Äì7 —Ä–∞–∑—ñ–≤ –±—ñ–ª—å—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å.
                            </p>
                        </div>
                    </div>

                    <!-- DESCRIPTION -->
                    <label class="edit-label">–û–ø–∏—Å –º–æ–¥–µ–ª—ñ</label>
                    <textarea class="edit-textarea"
                              name="description">{{ item.description }}</textarea>

                    <!-- TAGS -->
                    <label class="edit-label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
                    <input class="edit-input"
                           type="text"
                           name="tags"
                           value="{{ item.tags }}"
                           placeholder="dragon, flexi, fantasy">
                </section>

                <!-- CATEGORY -->
                <section class="edit-section">
                    <h2 class="edit-section-title">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</h2>

                    <label class="edit-label">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>

                    {% set _cats = (categories if categories is defined else (g.market_categories if g and g.market_categories is defined else [])) %}
                    <select class="edit-input"
                            name="category">
                        {% for cat in _cats %}
                            {% set cat_val = (cat.name if cat is not string and cat is not number and cat.name is defined else cat) %}
                            <option value="{{ cat_val }}"
                                    {% if item.category == cat_val %}selected{% endif %}>
                                {{ cat_val }}
                            </option>
                        {% endfor %}
                    </select>
                </section>

                <!-- PHOTOS -->
                <section class="edit-section">
                    <h2 class="edit-section-title">–§–æ—Ç–æ</h2>

                    <div class="edit-photos-row">

                        <!-- CURRENT COVER -->
                        <div class="edit-photo-current">
                            <p class="edit-label-small">–ü–æ—Ç–æ—á–Ω–∞ –æ–±–∫–ª–∞–¥–∏–Ω–∫–∞</p>

                            <div class="edit-cover-preview">
                                <img src="{{ item.cover_url
                                           or item.cover
                                           or item.preview_url
                                           or '/static/img/no-preview.png' }}">
                            </div>
                        </div>

                        <!-- NEW PHOTOS -->
                        <div class="edit-photo-upload">
                            <p class="edit-label-small">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ —Ñ–æ—Ç–æ</p>

                            <label class="edit-dropzone">
                                <span class="edit-dropzone-text">
                                    –ü–µ—Ä–µ—Ç—è–≥–Ω–∏ JPG / PNG / WebP –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏
                                </span>
                                <input type="file"
                                       name="gallery_files"
                                       accept=".jpg,.jpeg,.png,.webp"
                                       multiple>
                            </label>

                            <p class="edit-hint">
                                –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 3‚Äì6 —Ñ–æ—Ç–æ. –î–æ–¥–∞–¥—É—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- STL FILE -->
                <section class="edit-section">
                    <h2 class="edit-section-title">STL-—Ñ–∞–π–ª</h2>

                    <div class="edit-row">
                        <div class="edit-col">
                            <p class="edit-label-small">–ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª:</p>

                            {% if item.stl_main_url or item.url %}
                                <a class="edit-link"
                                   target="_blank"
                                   href="{{ item.stl_main_url or item.url }}">
                                    –í—ñ–¥–∫—Ä–∏—Ç–∏ STL
                                </a>
                            {% else %}
                                <p class="edit-hint">–ù–µ–º–∞—î STL —Ñ–∞–π–ª—É.</p>
                            {% endif %}
                        </div>
                    </div>

                    <label class="edit-label">–ó–∞–º—ñ–Ω–∏—Ç–∏ STL</label>

                    <label class="edit-dropzone">
                        <span class="edit-dropzone-text">
                            –ü–µ—Ä–µ—Ç—è–≥–Ω–∏ STL / OBJ / GLTF / PLY –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏
                        </span>
                        <input type="file"
                               name="stl_file"
                               accept=".stl,.obj,.ply,.gltf,.glb">
                    </label>

                    <p class="edit-hint">
                        –ù–æ–≤–∏–π STL –∑–∞–º—ñ–Ω–∏—Ç—å —Å—Ç–∞—Ä–∏–π –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.
                    </p>
                </section>

                <!-- ACTION BUTTONS -->
                <section class="edit-section">

                    <div class="edit-footer-buttons">
                        <button class="save-btn" type="submit">
                            üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏
                        </button>

                        <a class="btn btn-secondary"
                           href="/item/{{ item.id }}"
                           target="_blank">
                            –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –º–æ–¥–µ–ª—å
                        </a>
                    </div>

                    <p class="edit-autosave-status" id="editAutosaveStatus">
                        –ó–º—ñ–Ω–∏ –Ω–µ –≤–Ω–æ—Å–∏–ª–∏—Å—è.
                    </p>
                </section>
            </form>

            <!-- DELETE MODEL -->
            <button class="delete-btn" 
                    type="button"
                    data-item-id="{{ item.id }}"
                    onclick="deleteModel(this)">
                üóë –í–∏–¥–∞–ª–∏—Ç–∏ –º–æ–¥–µ–ª—å
            </button>

        </div>


        <!-- RIGHT SIDE ‚Äì VIEWER + STATS -->
        <aside class="edit-sidebar">

            <!-- 3D VIEWER -->
            <section class="edit-section">
                <h2 class="edit-section-title">3D-–ø—Ä–µ–≤ º—é</h2>

                <div id="editStlViewer"
                     class="edit-stl-viewer"
                     data-stl-url="{{ item.stl_main_url or item.url }}">
                    <p class="edit-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≥–ª—è–¥—É‚Ä¶</p>
                </div>
            </section>

            <!-- STATS -->
            <section class="edit-section">
                <h2 class="edit-section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

                <ul class="edit-stats-list">
                    <li>
                        <span>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</span>
                        <strong>{{ item.downloads or 0 }}</strong>
                    </li>

                    <li>
                        <span>–†–µ–π—Ç–∏–Ω–≥:</span>
                        <strong>{{ item.rating or 0.0 }}</strong>
                    </li>

                    <li>
                        <span>ID –º–æ–¥–µ–ª—ñ:</span>
                        <code>#{{ item.id }}</code>
                    </li>
                </ul>
            </section>

        </aside>
    </div>

</div>

{% endblock %}
