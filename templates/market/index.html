{# templates/market/index.html #}
{% extends "market/layout.html" %}
{% set market_page = 'list' %}

{% block market_body %}
<div class="market-main" data-market-root>

  <!-- Author Profile Header (shown when filtering by author_id) -->
  {% if author_id %}
  <div id="authorProfileHeader" class="author-profile-header" data-author-id="{{ author_id }}" 
       data-i18n-showing="{{ _('Showing models by') }}"
       data-i18n-followers="{{ _('followers') }}"
       data-i18n-models="{{ _('models') }}"
       data-i18n-follow="{{ _('Follow') }}"
       data-i18n-following="{{ _('Following') }}"
       data-i18n-clear="{{ _('Clear filter') }}"
       style="background: var(--card, #11141b); border: 1px solid var(--line, #1b2131); border-radius: 12px; padding: 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
    <img id="authorAvatar" src="/static/img/user.jpg" alt="Author" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent, #667eea);">
    <div style="flex: 1;">
      <div id="authorShowingText" style="font-size: 0.85rem; color: var(--muted, #9fb0d4); margin-bottom: 4px;">{{ _('Showing models by') }}</div>
      <h2 id="authorName" style="margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 700;">Loading...</h2>
      <div id="authorStats" style="display: flex; gap: 16px; font-size: 0.9rem; color: var(--muted, #9fb0d4);">
        <button id="followersCountBtn" style="background: none; border: none; padding: 0; color: var(--muted, #9fb0d4); cursor: pointer; transition: color 0.2s; font-size: 0.9rem; font-family: inherit;" onmouseover="this.style.color='var(--accent, #667eea)'" onmouseout="this.style.color='var(--muted, #9fb0d4)'">
          <span id="authorFollowers" data-count="0">0 {{ _('followers') }}</span>
        </button>
        <span id="authorModels" data-count="0">0 {{ _('models') }}</span>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
      <button id="authorFollowBtn" class="btn-follow" style="padding: 10px 24px; border: 2px solid var(--accent, #667eea); background: transparent; color: var(--accent, #667eea); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 120px;" disabled>Loading...</button>
      <a href="/market" id="authorClearFilter" style="font-size: 0.85rem; color: var(--muted, #9fb0d4); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--accent, #667eea)'" onmouseout="this.style.color='var(--muted, #9fb0d4)'">‚úï {{ _('Clear filter') }}</a>
    </div>
  </div>

  <!-- Followers/Following Modal -->
  <div id="followersModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--card, #11141b); border: 1px solid var(--line, #1b2131); border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
      <div style="padding: 20px; border-bottom: 1px solid var(--line, #1b2131); display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 16px;">
          <button id="tabFollowers" class="modal-tab active" style="background: none; border: none; padding: 8px 16px; cursor: pointer; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--accent, #667eea);">Followers</button>
          <button id="tabFollowing" class="modal-tab" style="background: none; border: none; padding: 8px 16px; cursor: pointer; font-weight: 600; color: var(--muted); border-bottom: 2px solid transparent;">Following</button>
        </div>
        <button id="closeModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>
      <div id="modalContent" style="padding: 20px; overflow-y: auto; flex: 1;">
        <div id="modalLoading" style="text-align: center; color: var(--muted); padding: 40px;">Loading...</div>
        <div id="modalUserList" style="display: none;"></div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å: –ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è + –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å -->
  <div class="market-top-actions">
    <div class="mta-left">
      <a href="/market?owner=me" class="btn ghost market-my-btn">
        –ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
      </a>
    </div>
    <div class="mta-right">
      <a href="/market/upload" class="btn primary market-add-btn">
        + –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å
      </a>
    </div>
  </div>

  <!-- –†—è–¥–æ–∫ –ø–æ—à—É–∫—É + —Å–µ–ª–µ–∫—Ç–∏ –ü–æ–∫–∞–∑–∞—Ç–∏ / –°–æ—Ä—Ç—É–≤–∞—Ç–∏ -->
  <div class="market-controls">
    <div class="mc-search-wrap">
      <input
        id="q"
        type="search"
        class="mc-search"
        placeholder="–ü–æ—à—É–∫: dragon, stand, toy‚Ä¶"
        autocomplete="off"
      >
      <button id="btn-search" type="button" class="mc-search-btn">
        üîç
      </button>
    </div>

    <div class="mc-selects">
      <label class="mc-label">
        –ü–æ–∫–∞–∑–∞—Ç–∏:
        <select class="mc-select" data-filter-show>
          <option value="all" selected>–£—Å—ñ</option>
          <option value="free">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ</option>
          <option value="paid">–ü–ª–∞—Ç–Ω—ñ</option>
        </select>
      </label>

      <label class="mc-label">
        –°–æ—Ä—Ç—É–≤–∞—Ç–∏:
        <select class="mc-select" data-filter-sort>
          <option value="new" selected>–ù–æ–≤—ñ</option>
          <option value="downloads">–ü–æ–ø—É–ª—è—Ä–Ω—ñ</option>
          <option value="downloads">–¢–æ–ø –∑–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–º</option>
          <option value="price_asc">–¶—ñ–Ω–∞ ‚Üë</option>
          <option value="price_desc">–¶—ñ–Ω–∞ ‚Üì</option>
        </select>
      </label>

      <label class="mc-label">
        Min Proof Score:
        <select class="mc-select" data-filter-proof-score>
          <option value="0" selected>All</option>
          <option value="50">Min PS 50</option>
          <option value="70">Min PS 70</option>
          <option value="85">Min PS 85</option>
          <option value="95">Min PS 95</option>
        </select>
      </label>

      <label class="mc-label mc-checkbox-label">
        <input type="checkbox" class="mc-checkbox" data-filter-auto-presets>
        <span>‚öôÔ∏è Auto presets</span>
      </label>
    </div>
  </div>

  <!-- –®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∑–∞ —Ç–µ–≥–∞–º–∏ -->
  <div class="market-quick-filters">
    <button type="button" class="mqf-chip is-active" data-filter-tag="all">
      –£—Å—ñ –º–æ–¥–µ–ª—ñ
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="dragon">
      üêâ –î—Ä–∞–∫–æ–Ω–∏
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="stand">
      üì± –ü—ñ–¥—Å—Ç–∞–≤–∫–∏
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="toy">
      üß∏ –Ü–≥—Ä–∞—à–∫–∏
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="cosplay">
      üé≠ –ö–æ—Å–ø–ª–µ–π
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="other">
      ‚ú® –Ü–Ω—à–µ
    </button>
  </div>

  <!-- –ë–ª–æ–∫ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–ø–æ–º–∏–ª–∫–∞ / ‚Äú–Ω–µ–º–∞—î –º–æ–¥–µ–ª–µ–π‚Äù / –ª–æ–∞–¥–µ—Ä) -->
  <div class="market-notice" data-market-notice style="display:none"></div>

  <!-- –°—ñ—Ç–∫–∞ –∫–∞—Ä—Ç–æ–∫ -->
  <div class="market-grid-wrap">
    <div class="market-grid" data-market-grid>
      <div class="market-grid-placeholder">
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π‚Ä¶
      </div>
    </div>

    <!-- sentinel –¥–ª—è infinite-scroll (–º–æ–∂–Ω–∞ –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ) -->
    <div class="market-sentinel" data-market-sentinel></div>
  </div>

  <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è, –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JS -->
  <div class="market-pagination" data-market-pagination></div>
</div>

{% if author_id %}
<script type="module">
// Author Profile Header - load author info and handle follow
(async () => {
  // Get authorId from Jinja (server-side) or URL (client-side fallback)
  const authorId = {{ author_id }} || Number(new URLSearchParams(location.search).get('author_id')) || 0;
  if (!authorId) return;
  
  const header = document.getElementById('authorProfileHeader');
  if (!header) return;

  // Get i18n labels from data attributes
  const i18n = {
    followers: header.dataset.i18nFollowers || 'followers',
    models: header.dataset.i18nModels || 'models',
    follow: header.dataset.i18nFollow || 'Follow',
    following: header.dataset.i18nFollowing || 'Following'
  };

  // Load author info
  try {
    const resp = await fetch(`/api/user/${authorId}/mini`);
    if (!resp.ok) throw new Error('Failed to load author');
    
    const data = await resp.json();
    if (!data.ok || !data.user) throw new Error('Invalid response');
    
    const user = data.user;
    
    // Update UI with i18n
    const avatarEl = document.getElementById('authorAvatar');
    const nameEl = document.getElementById('authorName');
    const followersEl = document.getElementById('authorFollowers');
    const modelsEl = document.getElementById('authorModels');
    
    if (avatarEl) avatarEl.src = user.avatar_url || '/static/img/user.jpg';
    if (nameEl) nameEl.textContent = user.name || 'Unknown';
    
    if (followersEl) {
      const count = Number(user.followers_count) || 0;
      followersEl.dataset.count = count;
      followersEl.textContent = `${count} ${i18n.followers}`;
    }
    
    if (modelsEl) {
      const count = Number(user.items_count) || 0;
      modelsEl.dataset.count = count;
      modelsEl.textContent = `${count} ${i18n.models}`;
    }
    
    // Check follow status with robust parsing
    let isFollowing = false;
    try {
      const followsResp = await fetch('/api/user/follows');
      if (followsResp.ok) {
        const followsData = await followsResp.json();
        if (followsData.ok && followsData.follows) {
          // Support both array formats: [3, 5, 7] or [{followed_id: 3}, ...]
          const followsRaw = Array.isArray(followsData.follows) ? followsData.follows : [];
          const followIds = followsRaw.map(x => {
            if (typeof x === "number") return x;
            if (x && typeof x === "object") return Number(x.followed_id ?? x.author_id ?? x.id);
            return NaN;
          }).filter(n => Number.isFinite(n));
          
          isFollowing = followIds.includes(authorId);
        }
      }
    } catch (e) {
      console.warn('Could not load follow status:', e);
    }
    
    // Setup follow button with i18n
    const followBtn = document.getElementById('authorFollowBtn');
    if (!followBtn) return;
    
    followBtn.disabled = false;
    followBtn.textContent = isFollowing ? `‚úì ${i18n.following}` : `+ ${i18n.follow}`;
    followBtn.style.background = isFollowing ? 'var(--accent, #667eea)' : 'transparent';
    followBtn.style.color = isFollowing ? '#fff' : 'var(--accent, #667eea)';
    
    // Lock to prevent double-click spam
    let followBusy = false;
    
    followBtn.addEventListener('click', async () => {
      if (followBusy) return;
      followBusy = true;
      
      followBtn.disabled = true;
      const prevText = followBtn.textContent;
      followBtn.textContent = '‚Ä¶';
      
      try {
        const method = isFollowing ? 'DELETE' : 'POST';
        const toggleResp = await fetch(`/api/follow/${authorId}`, { method });
        
        if (toggleResp.status === 401) {
          window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname + window.location.search);
          return;
        }
        
        if (!toggleResp.ok) throw new Error('Follow failed');
        
        const toggleData = await toggleResp.json();
        if (toggleData.ok) {
          // Update state from API response
          isFollowing = toggleData.following;
          followBtn.textContent = isFollowing ? `‚úì ${i18n.following}` : `+ ${i18n.follow}`;
          followBtn.style.background = isFollowing ? 'var(--accent, #667eea)' : 'transparent';
          followBtn.style.color = isFollowing ? '#fff' : 'var(--accent, #667eea)';
          
          // Update follower count directly from API response
          const followerEl = document.getElementById('authorFollowers');
          if (followerEl && typeof toggleData.followers_count === 'number') {
            const newCount = toggleData.followers_count;
            followerEl.dataset.count = newCount;
            followerEl.textContent = `${newCount} ${i18n.followers}`;
          }
        } else {
          // Restore previous state on error
          followBtn.textContent = prevText;
        }
      } catch (err) {
        console.error('Follow error:', err);
        alert('Failed to update follow status');
        // Restore previous state on error
        followBtn.textContent = prevText;
      } finally {
        followBusy = false;
        followBtn.disabled = false;
      }
    });
    
  } catch (err) {
    console.error('Error loading author:', err);
    header.innerHTML = '<p style="color: var(--muted);">Failed to load author information</p>';
  }
})();

// Followers/Following Modal
(function() {
  const modal = document.getElementById('followersModal');
  const followersBtn = document.getElementById('followersCountBtn');
  const closeBtn = document.getElementById('closeModal');
  const tabFollowers = document.getElementById('tabFollowers');
  const tabFollowing = document.getElementById('tabFollowing');
  const modalContent = document.getElementById('modalContent');
  const modalLoading = document.getElementById('modalLoading');
  const modalUserList = document.getElementById('modalUserList');
  
  if (!modal || !followersBtn) return;
  
  const authorId = {{ author_id }} || Number(new URLSearchParams(location.search).get('author_id')) || 0;
  if (!authorId) return;
  
  let currentTab = 'followers';
  
  // Open modal on followers count click
  followersBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    currentTab = 'followers';
    updateTabs();
    loadUsers('followers');
  });
  
  // Close modal
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
  
  // Tab switching
  tabFollowers.addEventListener('click', () => {
    currentTab = 'followers';
    updateTabs();
    loadUsers('followers');
  });
  
  tabFollowing.addEventListener('click', () => {
    currentTab = 'following';
    updateTabs();
    loadUsers('following');
  });
  
  function updateTabs() {
    if (currentTab === 'followers') {
      tabFollowers.style.color = 'var(--text)';
      tabFollowers.style.borderBottomColor = 'var(--accent, #667eea)';
      tabFollowing.style.color = 'var(--muted)';
      tabFollowing.style.borderBottomColor = 'transparent';
    } else {
      tabFollowing.style.color = 'var(--text)';
      tabFollowing.style.borderBottomColor = 'var(--accent, #667eea)';
      tabFollowers.style.color = 'var(--muted)';
      tabFollowers.style.borderBottomColor = 'transparent';
    }
  }
  
  async function loadUsers(type) {
    modalLoading.style.display = 'block';
    modalUserList.style.display = 'none';
    
    try {
      const resp = await fetch(`/api/user/${authorId}/${type}`);
      const data = await resp.json();
      
      if (!data.ok || !Array.isArray(data.users)) {
        throw new Error('Invalid response');
      }
      
      modalLoading.style.display = 'none';
      
      if (data.users.length === 0) {
        modalUserList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">No users found</p>';
        modalUserList.style.display = 'block';
        return;
      }
      
      // Render user list
      const html = data.users.map(user => `
        <a href="/market?author_id=${user.id}" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; text-decoration: none; color: inherit; transition: background 0.2s;" onmouseover="this.style.background='var(--hover, rgba(102, 126, 234, 0.1))'" onmouseout="this.style.background='transparent'">
          <img src="${user.avatar_url}" alt="${user.name}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
          <div style="flex: 1;">
            <div style="font-weight: 600;">${user.name}</div>
          </div>
        </a>
      `).join('');
      
      modalUserList.innerHTML = html;
      modalUserList.style.display = 'block';
      
    } catch (err) {
      console.error('Error loading users:', err);
      modalLoading.style.display = 'none';
      modalUserList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">Failed to load users</p>';
      modalUserList.style.display = 'block';
    }
  }
})();
</script>
{% endif %}

{% endblock %}
