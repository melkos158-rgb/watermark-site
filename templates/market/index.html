{# templates/market/index.html #}
{% extends "market/layout.html" %}
{% set market_page = 'list' %}

{% block market_body %}
<div class="market-main" data-market-root>

  <!-- Author Profile Header (shown when filtering by author_id) -->
  {% if author_id %}
  <div id="authorProfileHeader" class="author-profile-header" data-author-id="{{ author_id }}" 
       data-i18n-showing="{{ _('Showing models by') }}"
       data-i18n-followers="{{ _('followers') }}"
       data-i18n-models="{{ _('models') }}"
       data-i18n-follow="{{ _('Follow') }}"
       data-i18n-following="{{ _('Following') }}"
       data-i18n-clear="{{ _('Clear filter') }}"
       style="background: var(--card, #11141b); border: 1px solid var(--line, #1b2131); border-radius: 12px; padding: 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
    <img id="authorAvatar" src="/static/img/user.jpg" alt="Author" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent, #667eea);">
    <div style="flex: 1;">
      <div id="authorShowingText" style="font-size: 0.85rem; color: var(--muted, #9fb0d4); margin-bottom: 4px;">{{ _('Showing models by') }}</div>
      <h2 id="authorName" style="margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 700;">Loading...</h2>
      <div id="authorStats" style="display: flex; gap: 16px; font-size: 0.9rem; color: var(--muted, #9fb0d4);">
        <span id="authorFollowers" data-count="0">0 {{ _('followers') }}</span>
        <span id="authorModels" data-count="0">0 {{ _('models') }}</span>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
      <button id="authorFollowBtn" class="btn-follow" style="padding: 10px 24px; border: 2px solid var(--accent, #667eea); background: transparent; color: var(--accent, #667eea); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 120px;" disabled>Loading...</button>
      <a href="/market" id="authorClearFilter" style="font-size: 0.85rem; color: var(--muted, #9fb0d4); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--accent, #667eea)'" onmouseout="this.style.color='var(--muted, #9fb0d4)'">‚úï {{ _('Clear filter') }}</a>
    </div>
  </div>
  {% endif %}

  <!-- –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å: –ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è + –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å -->
  <div class="market-top-actions">
    <div class="mta-left">
      <a href="/market?owner=me" class="btn ghost market-my-btn">
        –ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
      </a>
    </div>
    <div class="mta-right">
      <a href="/market/upload" class="btn primary market-add-btn">
        + –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å
      </a>
    </div>
  </div>

  <!-- –†—è–¥–æ–∫ –ø–æ—à—É–∫—É + —Å–µ–ª–µ–∫—Ç–∏ –ü–æ–∫–∞–∑–∞—Ç–∏ / –°–æ—Ä—Ç—É–≤–∞—Ç–∏ -->
  <div class="market-controls">
    <div class="mc-search-wrap">
      <input
        id="q"
        type="search"
        class="mc-search"
        placeholder="–ü–æ—à—É–∫: dragon, stand, toy‚Ä¶"
        autocomplete="off"
      >
      <button id="btn-search" type="button" class="mc-search-btn">
        üîç
      </button>
    </div>

    <div class="mc-selects">
      <label class="mc-label">
        –ü–æ–∫–∞–∑–∞—Ç–∏:
        <select class="mc-select" data-filter-show>
          <option value="all" selected>–£—Å—ñ</option>
          <option value="free">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ</option>
          <option value="paid">–ü–ª–∞—Ç–Ω—ñ</option>
        </select>
      </label>

      <label class="mc-label">
        –°–æ—Ä—Ç—É–≤–∞—Ç–∏:
        <select class="mc-select" data-filter-sort>
          <option value="new" selected>–ù–æ–≤—ñ</option>
          <option value="downloads">–ü–æ–ø—É–ª—è—Ä–Ω—ñ</option>
          <option value="downloads">–¢–æ–ø –∑–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–º</option>
          <option value="price_asc">–¶—ñ–Ω–∞ ‚Üë</option>
          <option value="price_desc">–¶—ñ–Ω–∞ ‚Üì</option>
        </select>
      </label>
    </div>
  </div>

  <!-- –®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∑–∞ —Ç–µ–≥–∞–º–∏ -->
  <div class="market-quick-filters">
    <button type="button" class="mqf-chip is-active" data-filter-tag="all">
      –£—Å—ñ –º–æ–¥–µ–ª—ñ
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="dragon">
      üêâ –î—Ä–∞–∫–æ–Ω–∏
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="stand">
      üì± –ü—ñ–¥—Å—Ç–∞–≤–∫–∏
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="toy">
      üß∏ –Ü–≥—Ä–∞—à–∫–∏
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="cosplay">
      üé≠ –ö–æ—Å–ø–ª–µ–π
    </button>
    <button type="button" class="mqf-chip" data-filter-tag="other">
      ‚ú® –Ü–Ω—à–µ
    </button>
  </div>

  <!-- –ë–ª–æ–∫ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–ø–æ–º–∏–ª–∫–∞ / ‚Äú–Ω–µ–º–∞—î –º–æ–¥–µ–ª–µ–π‚Äù / –ª–æ–∞–¥–µ—Ä) -->
  <div class="market-notice" data-market-notice style="display:none"></div>

  <!-- –°—ñ—Ç–∫–∞ –∫–∞—Ä—Ç–æ–∫ -->
  <div class="market-grid-wrap">
    <div class="market-grid" data-market-grid>
      <div class="market-grid-placeholder">
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π‚Ä¶
      </div>
    </div>

    <!-- sentinel –¥–ª—è infinite-scroll (–º–æ–∂–Ω–∞ –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ) -->
    <div class="market-sentinel" data-market-sentinel></div>
  </div>

  <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è, –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JS -->
  <div class="market-pagination" data-market-pagination></div>
</div>

<style>
  /* Author Profile Header */
  #authorFollowBtn:hover:not(:disabled){
    background: var(--accent, #667eea) !important;
    color: #fff !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  #authorFollowBtn:disabled{
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  @media (max-width: 640px){
    .author-profile-header{
      flex-direction: column !important;
      text-align: center;
    }
    
    .author-profile-header > div:last-child{
      width: 100%;
      align-items: center !important;
    }
    
    #authorFollowBtn{
      width: 100%;
      max-width: 240px;
    }
  }

  .market-main{
    max-width:1280px;
    margin:0 auto;
    padding:16px 16px 32px;
  }

  .market-top-actions{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
    gap:8px;
  }

  .market-add-btn{
    border-radius:999px;
    font-size:13px;
    padding:8px 18px;
  }

  .market-my-btn{
    border-radius:999px;
    font-size:13px;
    padding:8px 14px;
  }

  .market-controls{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    justify-content:space-between;
    align-items:flex-end;
    margin-bottom:10px;
  }

  .mc-search-wrap{
    display:flex;
    align-items:center;
    gap:6px;
    flex:1 1 280px;
    max-width:420px;
  }

  .mc-search{
    flex:1 1 auto;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--line, #1b2131);
    background:var(--card, #11141b);
    color:var(--ink, #e8eaed);
    font-size:13px;
    outline:none;
  }

  .mc-search:focus{
    border-color:#5965f3;
  }

  .mc-search-btn{
    padding:8px 11px;
    border-radius:999px;
    border:1px solid var(--line, #1b2131);
    background:var(--card, #11141b);
    color:var(--ink, #e8eaed);
    cursor:pointer;
    font-size:13px;
  }

  .mc-selects{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:flex-end;
  }

  .mc-label{
    font-size:13px;
    color:var(--muted, #9fb0d4);
    display:flex;
    gap:8px;
    align-items:center;
  }

  .mc-select{
    background:var(--card, #11141b);
    border:1px solid var(--line, #1b2131);
    border-radius:999px;
    padding:6px 10px;
    color:var(--ink, #e8eaed);
    font-size:13px;
    outline:none;
  }

  .mc-select:focus{
    border-color:#5965f3;
  }

  .market-quick-filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:14px;
  }

  .mqf-chip{
    border-radius:999px;
    border:1px solid var(--line, #1b2131);
    background:var(--card, #11141b);
    color:var(--ink, #e8eaed);
    font-size:12px;
    padding:4px 10px;
    cursor:pointer;
    opacity:0.9;
  }

  .mqf-chip.is-active{
    background:#5b66ff;
    border-color:#5b66ff;
    color:#fff;
    opacity:1;
  }

  .market-grid-wrap{
    border-radius:14px;
    border:1px solid var(--line, #1b2131);
    background:rgba(15,17,23,.7);
    padding:16px;
    position:relative;
  }

  .market-grid{
    display:grid;
    gap:16px;
    grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
  }

  .market-grid > *{
    background:var(--card, #11141b);
    border-radius:14px;
    border:1px solid var(--line, #1b2131);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .market-grid img{
    width:100%;
    display:block;
    aspect-ratio:4/3;
    object-fit:cover;
  }

  .market-grid .mi-body,
  .market-grid .card-body,
  .market-grid .body,
  .market-grid .market-card-body{
    padding:10px 12px 12px;
    font-size:13px;
  }

  .market-grid-placeholder{
    grid-column:1 / -1;
    text-align:center;
    font-size:14px;
    color:var(--muted, #9fb0d4);
    padding:24px 0;
  }

  .market-pagination{
    margin-top:16px;
    display:flex;
    justify-content:center;
  }

  .market-pagination-inner{
    display:flex;
    gap:6px;
  }

  .pg-btn{
    min-width:32px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line, #1b2131);
    background:var(--card, #11141b);
    color:var(--ink, #e8eaed);
    font-size:13px;
    cursor:pointer;
  }

  .pg-btn.is-active{
    background:var(--btn, #1a73e8);
    border-color:var(--btn, #1a73e8);
    color:#fff;
  }

  .market-notice{
    margin-bottom:12px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line, #1b2131);
    background:var(--card, #11141b);
    font-size:14px;
    color:var(--ink, #e8eaed);
  }

  .market-notice.error{
    border-color:#ef4444;
    color:#fecaca;
  }

  .market-sentinel{
    height:1px;
  }

  @media (max-width:768px){
    .market-main{padding:12px;}
    .market-grid-wrap{padding:12px;}
    .mc-selects{width:100%; justify-content:flex-start;}
  }
</style>

{% if author_id %}
<script type="module">
// Author Profile Header - load author info and handle follow
(async () => {
  // Get authorId from Jinja (server-side) or URL (client-side fallback)
  const authorId = {{ author_id }} || Number(new URLSearchParams(location.search).get('author_id')) || 0;
  if (!authorId) return;
  
  const header = document.getElementById('authorProfileHeader');
  if (!header) return;

  // Get i18n labels from data attributes
  const i18n = {
    followers: header.dataset.i18nFollowers || 'followers',
    models: header.dataset.i18nModels || 'models',
    follow: header.dataset.i18nFollow || 'Follow',
    following: header.dataset.i18nFollowing || 'Following'
  };

  // Load author info
  try {
    const resp = await fetch(`/api/user/${authorId}/mini`);
    if (!resp.ok) throw new Error('Failed to load author');
    
    const data = await resp.json();
    if (!data.ok || !data.user) throw new Error('Invalid response');
    
    const user = data.user;
    
    // Update UI with i18n
    const avatarEl = document.getElementById('authorAvatar');
    const nameEl = document.getElementById('authorName');
    const followersEl = document.getElementById('authorFollowers');
    const modelsEl = document.getElementById('authorModels');
    
    if (avatarEl) avatarEl.src = user.avatar_url || '/static/img/user.jpg';
    if (nameEl) nameEl.textContent = user.name || 'Unknown';
    
    if (followersEl) {
      const count = Number(user.followers_count) || 0;
      followersEl.dataset.count = count;
      followersEl.textContent = `${count} ${i18n.followers}`;
    }
    
    if (modelsEl) {
      const count = Number(user.items_count) || 0;
      modelsEl.dataset.count = count;
      modelsEl.textContent = `${count} ${i18n.models}`;
    }
    
    // Check follow status with robust parsing
    let isFollowing = false;
    try {
      const followsResp = await fetch('/api/user/follows');
      if (followsResp.ok) {
        const followsData = await followsResp.json();
        if (followsData.ok && followsData.follows) {
          // Support both array formats: [3, 5, 7] or [{followed_id: 3}, ...]
          const followsRaw = Array.isArray(followsData.follows) ? followsData.follows : [];
          const followIds = followsRaw.map(x => {
            if (typeof x === "number") return x;
            if (x && typeof x === "object") return Number(x.followed_id ?? x.author_id ?? x.id);
            return NaN;
          }).filter(n => Number.isFinite(n));
          
          isFollowing = followIds.includes(authorId);
        }
      }
    } catch (e) {
      console.warn('Could not load follow status:', e);
    }
    
    // Setup follow button with i18n
    const followBtn = document.getElementById('authorFollowBtn');
    if (!followBtn) return;
    
    followBtn.disabled = false;
    followBtn.textContent = isFollowing ? `‚úì ${i18n.following}` : `+ ${i18n.follow}`;
    followBtn.style.background = isFollowing ? 'var(--accent, #667eea)' : 'transparent';
    followBtn.style.color = isFollowing ? '#fff' : 'var(--accent, #667eea)';
    
    followBtn.addEventListener('click', async () => {
      followBtn.disabled = true;
      
      try {
        const method = isFollowing ? 'DELETE' : 'POST';
        const toggleResp = await fetch(`/api/follow/${authorId}`, { method });
        
        if (toggleResp.status === 401) {
          window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname + window.location.search);
          return;
        }
        
        if (!toggleResp.ok) throw new Error('Follow failed');
        
        const toggleData = await toggleResp.json();
        if (toggleData.ok) {
          isFollowing = toggleData.following;
          followBtn.textContent = isFollowing ? `‚úì ${i18n.following}` : `+ ${i18n.follow}`;
          followBtn.style.background = isFollowing ? 'var(--accent, #667eea)' : 'transparent';
          followBtn.style.color = isFollowing ? '#fff' : 'var(--accent, #667eea)';
          
          // Update follower count with guard and i18n
          const followerEl = document.getElementById('authorFollowers');
          if (followerEl && typeof toggleData.followers_count === 'number') {
            const newCount = toggleData.followers_count;
            followerEl.dataset.count = newCount;
            followerEl.textContent = `${newCount} ${i18n.followers}`;
          }
        }
      } catch (err) {
        console.error('Follow error:', err);
        alert('Failed to update follow status');
      } finally {
        followBtn.disabled = false;
      }
    });
    
  } catch (err) {
    console.error('Error loading author:', err);
    header.innerHTML = '<p style="color: var(--muted);">Failed to load author information</p>';
  }
})();
</script>
{% endif %}

{% endblock %}
