{# 1) обираємо коректне посилання: спершу slug, інакше — за id #}
{% if it.slug %}
  {% set href = url_for('market.detail', slug=it.slug) %}
{% elif it.id %}
  {% set href = url_for('market.page_item', item_id=it.id) %}
{% else %}
  {% set href = '#' %}
{% endif %}

{# 2) шукаємо обкладинку: images[kind=cover] -> cover_url -> cover -> gallery[0] -> placeholder #}
{% set cover_img = None %}
{% if it.images %}
  {% set c = (it.images|selectattr('kind','equalto','cover')|list|first) %}
  {% if c %}{% set cover_img = c.url %}{% endif %}
{% endif %}
{% if not cover_img and it.cover_url %}{% set cover_img = it.cover_url %}{% endif %}
{% if not cover_img and it.cover %}{% set cover_img = it.cover %}{% endif %}
{% if not cover_img and it.gallery_urls %}
  {% set g = it.gallery_urls if it.gallery_urls is iterable else [] %}
  {% if g and g|length %}{% set cover_img = g[0] %}{% endif %}
{% endif %}
{% set cover_fallback = url_for('static', filename='img/placeholder_stl.jpg') %}

<article class="card {% if it.is_featured or it.featured %}featured{% endif %}">
  <a class="thumb" href="{{ href }}">
    {% if it.is_free or (it.price_cents|default(0) == 0 and it.price|default(0) == 0) %}
      <span class="badge free">FREE</span>
    {% elif it.trending %}
      <span class="badge trend">TRENDING</span>
    {% elif it.is_featured or it.featured %}
      <span class="badge feat">FEATURED</span>
    {% endif %}
    <img loading="lazy"
         src="{{ cover_img or cover_fallback }}"
         onerror="this.onerror=null;this.src='{{ cover_fallback }}';"
         alt="{{ it.title or 'Model' }}">
  </a>

  <div class="meta">
    <h3 class="ttl">
      <a href="{{ href }}">{{ it.title or 'Без назви' }}</a>
    </h3>

    <div class="row">
      <span>★ {{ '%.1f'|format(it.rating or 0) }} · ⬇ {{ it.downloads or 0 }}</span>
      <strong>
        {% if it.is_free or (it.price_cents is defined and it.price_cents|int == 0) or (it.price is defined and it.price|int == 0) %}
          {{ _('Безкоштовно') }}
        {% else %}
          {% if it.price_cents is defined %}
            {{ ((it.price_cents or 0)/100)|round(2) }} {{ it.currency or 'PLN' }}
          {% else %}
            {{ it.price or 0 }} {{ it.currency or 'PLN' }}
          {% endif %}
        {% endif %}
      </strong>
    </div>
  </div>
</article>

<style>
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  transition:transform .15s, box-shadow .15s;
}
.card:hover{
  transform:translateY(-3px) scale(1.02);
  box-shadow:0 0 18px rgba(100,120,255,.15);
}
.thumb{
  position:relative;
  display:block;
  width:100%;
  padding-top:66.666%;
  overflow:hidden;
  border-bottom:1px solid var(--line);
}
.thumb img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transition:transform .3s ease;
}
.card:hover .thumb img{ transform:scale(1.05); }

.badge{
  position:absolute;
  top:8px;left:8px;
  background:#1a73e8;
  color:#fff;
  font-size:11px;
  padding:2px 8px;
  border-radius:6px;
  font-weight:600;
  letter-spacing:.5px;
}
.badge.free{background:#00b894;}
.badge.trend{background:#fdcb6e;color:#222;}
.badge.feat{background:#6c5ce7;}

.meta{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.ttl{margin:0;font-size:15px;line-height:1.3;}
.ttl a{color:var(--text);text-decoration:none;}
.ttl a:hover{text-decoration:underline;}
.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  color:var(--muted);
  gap:8px;
  font-size:13px;
}
.row strong{color:var(--text);}
</style>
