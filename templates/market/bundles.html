{% extends "market/layout.html" %}

{% block market_main %}

{# 
  –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–Ω–¥–ª–∞–º–∏ STL –º–æ–¥–µ–ª–µ–π.

  –û—á—ñ–∫—É–≤–∞–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥—É:
    - bundles: —Å–ø–∏—Å–æ–∫ –±–∞–Ω–¥–ª—ñ–≤ –∞–≤—Ç–æ—Ä–∞
      [
        {
          id, title, price, discount, items_count, thumb_url, is_active
        }, ...
      ]

    - my_items: —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –∞–≤—Ç–æ—Ä–∞
      [
        { id, title, price, thumb_url },
        ...
      ]

    - edit_bundle: –±–∞–Ω–¥–ª, —è–∫–∏–π –∑–∞—Ä–∞–∑ —Ä–µ–¥–∞–≥—É—î—Ç—å—Å—è (–∞–±–æ None)
#}

{% set bundles = bundles or [] %}
{% set my_items = my_items or [] %}
{% set edit_bundle = edit_bundle or None %}

<section class="bundles-page">
  <header class="bundles-header">
    <h1>–ú–æ—ó –±–∞–Ω–¥–ª–∏</h1>
    <p class="muted">
      –û–±‚Äô—î–¥–Ω—É–π –∫—ñ–ª—å–∫–∞ STL –º–æ–¥–µ–ª–µ–π —É –Ω–∞–±–æ—Ä–∏ –∑—ñ –∑–Ω–∏–∂–∫–æ—é ‚Äî —è–∫ –Ω–∞ Humble Bundle, —Ç—ñ–ª—å–∫–∏ –¥–ª—è 3D-–¥—Ä—É–∫—É.
    </p>
  </header>

  <div class="bundles-layout">
    <!-- ================= –õ–Ü–í–ê –ö–û–õ–û–ù–ö–ê: –°–ü–ò–°–û–ö –ë–ê–ù–î–õ–Ü–í ================= -->
    <section class="bundles-list card-like">
      <div class="bundles-list-header">
        <h2>–£—Å—ñ –±–∞–Ω–¥–ª–∏</h2>
        <p class="muted small">
          –¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≤—Å—ñ —Ç–≤–æ—ó –Ω–∞–±–æ—Ä–∏ STL. –ú–æ–∂–µ—à –≤–º–∏–∫–∞—Ç–∏ / –≤–∏–º–∏–∫–∞—Ç–∏, —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª—è—Ç–∏.
        </p>
      </div>

      {% if not bundles %}
        <div class="bundles-empty muted">
          –£ —Ç–µ–±–µ —â–µ –Ω–µ–º–∞—î –±–∞–Ω–¥–ª—ñ–≤. –°—Ç–≤–æ—Ä–∏ –ø–µ—Ä—à–∏–π —Å–ø—Ä–∞–≤–∞ üëâ
        </div>
      {% else %}
        <div class="bundles-table-wrap">
          <table class="bundles-table">
            <thead>
              <tr>
                <th>–ù–∞–∑–≤–∞</th>
                <th>–¶—ñ–Ω–∞</th>
                <th>–ó–Ω–∏–∂–∫–∞</th>
                <th>–ú–æ–¥–µ–ª–µ–π</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for b in bundles %}
                <tr>
                  <td>
                    <div class="bundle-row-main">
                      {% if b.thumb_url %}
                        <img src="{{ b.thumb_url }}" alt="{{ b.title }}" class="bundle-row-thumb">
                      {% endif %}
                      <div class="bundle-row-text">
                        <div class="bundle-row-title">{{ b.title }}</div>
                        <div class="bundle-row-id muted small">ID: {{ b.id }}</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    {{ "%.2f"|format(b.price or 0) }} z≈Ç
                  </td>
                  <td>
                    {% if b.discount and b.discount > 0 %}
                      -{{ "%.0f"|format(b.discount) }}%
                    {% else %}
                      <span class="muted small">–±–µ–∑ –∑–Ω–∏–∂–∫–∏</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ b.items_count or 0 }}
                  </td>
                  <td>
                    {% if b.is_active %}
                      <span class="badge badge-green">–ê–∫—Ç–∏–≤–Ω–∏–π</span>
                    {% else %}
                      <span class="badge badge-grey">–í–∏–º–∫–Ω–µ–Ω–æ</span>
                    {% endif %}
                  </td>
                  <td class="bundle-row-actions">
                    <a href="{{ url_for('market.bundles', edit_id=b.id) }}" class="btn tiny ghost">
                      –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                    </a>
                    <form method="post"
                          action="{{ url_for('market.delete_bundle', bundle_id=b.id) }}"
                          onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –±–∞–Ω–¥–ª? –¶–µ –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏.');">
                      <button type="submit" class="btn tiny danger">
                        –í–∏–¥–∞–ª–∏—Ç–∏
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </section>

    <!-- ================= –ü–†–ê–í–ê –ö–û–õ–û–ù–ö–ê: –°–¢–í–û–†–ï–ù–ù–Ø / –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø ================= -->
    <section class="bundles-editor card-like">
      <h2>
        {% if edit_bundle %}
          –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±–∞–Ω–¥–ª–∞
        {% else %}
          –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –±–∞–Ω–¥–ª
        {% endif %}
      </h2>

      <form method="post" action="{{ url_for('market.save_bundle') }}">
        {% if edit_bundle %}
          <input type="hidden" name="bundle_id" value="{{ edit_bundle.id }}">
        {% endif %}

        <div class="field">
          <label for="bundle-title">–ù–∞–∑–≤–∞ –±–∞–Ω–¥–ª–∞</label>
          <input id="bundle-title"
                 name="title"
                 type="text"
                 class="inp"
                 maxlength="120"
                 required
                 value="{{ edit_bundle.title if edit_bundle else '' }}"
                 placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Flexi Dragons Mega Pack">
        </div>

        <div class="field">
          <label for="bundle-desc">–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å</label>
          <textarea id="bundle-desc"
                    name="description"
                    class="inp"
                    rows="3"
                    placeholder="–û–ø–∏—à–∏, —â–æ –≤—Ö–æ–¥–∏—Ç—å –¥–æ –Ω–∞–±–æ—Ä—É, –¥–ª—è –∫–æ–≥–æ –≤—ñ–Ω, —á–∏–º –≤–∏–≥—ñ–¥–Ω–∏–π‚Ä¶">{{ edit_bundle.description if edit_bundle else '' }}</textarea>
        </div>

        <div class="field field-inline">
          <div>
            <label for="bundle-price">–¶—ñ–Ω–∞ –±–∞–Ω–¥–ª–∞</label>
            <input id="bundle-price"
                   name="price"
                   type="number"
                   min="0"
                   step="0.01"
                   class="inp"
                   required
                   value="{{ "%.2f"|format(edit_bundle.price) if edit_bundle and edit_bundle.price is not none else '' }}"
                   placeholder="0.00">
          </div>
          <div>
            <label for="bundle-discount">–ó–Ω–∏–∂–∫–∞ (%)</label>
            <input id="bundle-discount"
                   name="discount"
                   type="number"
                   min="0"
                   max="100"
                   step="1"
                   class="inp"
                   value="{{ "%.0f"|format(edit_bundle.discount) if edit_bundle and edit_bundle.discount is not none else '' }}"
                   placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 30">
            <p class="muted small">
              –ù–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –±–µ–π–¥–∂–∞ —Ç–∏–ø—É ‚Äú-30%‚Äù.
            </p>
          </div>
        </div>

        <div class="field">
          <label>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–Ω–¥–ª–∞ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
          <p class="muted small">
            –ü–æ–∫–∏ —â–æ –º–æ–∂–Ω–∞ –≤–∫–∞–∑–∞—Ç–∏ URL (Cloudinary), –ø–æ—Ç—ñ–º –∑—Ä–æ–±–∏–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
          </p>
          <input
            type="url"
            name="thumb_url"
            class="inp"
            placeholder="https://‚Ä¶"
            value="{{ edit_bundle.thumb_url if edit_bundle else '' }}"
          >
        </div>

        <div class="field">
          <label>–ú–æ–¥–µ–ª—ñ –≤ –±–∞–Ω–¥–ª—ñ</label>
          <p class="muted small">
            –í–∏–±–µ—Ä–∏, —è–∫—ñ –∑ —Ç–≤–æ—ó—Ö STL –≤—Ö–æ–¥—è—Ç—å –¥–æ –Ω–∞–±–æ—Ä—É.
          </p>

          <div class="bundle-items-list">
            {% if not my_items %}
              <p class="muted small">
                –£ —Ç–µ–±–µ —â–µ –Ω–µ–º–∞—î –º–æ–¥–µ–ª–µ–π –¥–ª—è –±–∞–Ω–¥–ª–∞. –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂ STL –≤ –º–∞—Ä–∫–µ—Ç.
              </p>
            {% else %}
              {% set included_ids = (edit_bundle.item_ids if edit_bundle and edit_bundle.item_ids is defined else []) %}
              {% for item in my_items %}
                {% set checked = item.id in included_ids %}
                <label class="bundle-item-row">
                  <input type="checkbox"
                         name="item_ids"
                         value="{{ item.id }}"
                         {% if checked %}checked{% endif %}>
                  {% if item.thumb_url %}
                    <img src="{{ item.thumb_url }}" alt="{{ item.title }}" class="bundle-item-thumb">
                  {% endif %}
                  <span class="bundle-item-title">
                    {{ item.title }}
                    {% if item.price and item.price > 0 %}
                      <span class="muted small">‚Äî {{ "%.2f"|format(item.price) }} z≈Ç</span>
                    {% else %}
                      <span class="muted small">‚Äî –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</span>
                    {% endif %}
                  </span>
                </label>
              {% endfor %}
            {% endif %}
          </div>
        </div>

        <div class="field field-inline">
          <label class="checkbox-line">
            <input type="checkbox"
                   name="is_active"
                   value="1"
                   {% if not edit_bundle or edit_bundle.is_active %}checked{% endif %}>
            <span>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –±–∞–Ω–¥–ª —É –º–∞—Ä–∫–µ—Ç—ñ</span>
          </label>
        </div>

        <div class="field">
          <button type="submit" class="btn primary">
            {% if edit_bundle %}
              –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
            {% else %}
              –°—Ç–≤–æ—Ä–∏—Ç–∏ –±–∞–Ω–¥–ª
            {% endif %}
          </button>
        </div>
      </form>
    </section>
  </div>
</section>

{% endblock %}
