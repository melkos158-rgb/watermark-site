{% extends "market/layout.html" %}
{% set market_page = 'detail' %}

{% block market_body %}
{# ------------------ MAIN MODEL SRC ------------------ #}
{% set main_src =
  item.main_model_url
  or item.stl_main_url
  or item.url
  or (item.stl_files[0] if item.stl_files) %}

<article class="detail-wrap">
  <!-- –•–ª—ñ–±–Ω—ñ –∫—Ä–∏—Ö—Ç–∏ -->
  <nav class="crumbs">
    <a href="{{ url_for('market.page_market') }}">–ú–∞—Ä–∫–µ—Ç</a>
    <span>/</span>
    <span>{{ item.title }}</span>
  </nav>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –º–µ—Ç–∞ -->
  <header class="detail-head">
    <h1 class="title">{{ item.title }}</h1>
    <div class="meta">
      <span>‚òÖ {{ item.rating or '‚Äî' }} ({{ item.ratings_cnt or 0 }})</span>
      <span>‚¨á {{ item.downloads or 0 }}</span>

      {# –¶—ñ–Ω–∞ #}
      {% if item.is_free %}
        <span class="price free">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</span>
      {% else %}
        {% set cents = item.price_cents
                        if item.price_cents is not none
                        else ( (item.price * 100) if item.price is defined and item.price is not none else 0 ) %}
        <span class="price">{{ (cents / 100.0)|round(2) }} PLN</span>
      {% endif %}

      <span class="sep">‚Ä¢</span>
      <a class="author" href="#author">
        –ê–≤—Ç–æ—Ä: {{ item.owner.name if item.owner else '‚Äî' }}
      </a>

      {% if item.format %}
        <span class="sep">‚Ä¢</span>
        <span class="fmt">–§–æ—Ä–º–∞—Ç: {{ item.format|upper }}</span>
      {% endif %}

      {% if item.created_at %}
        <span class="sep">‚Ä¢</span>
        <span class="date">
          –î–æ–¥–∞–Ω–æ:
          {% if item.created_at is string %}
            {{ item.created_at[:10] }}
          {% else %}
            {{ item.created_at.strftime('%Y-%m-%d') }}
          {% endif %}
        </span>
      {% endif %}
    </div>
  </header>

  <!-- Proof Score Panel (loaded async) -->
  <section class="proof-score-panel" id="proofScorePanel" style="display:none;">
    <h3>üîç Printability Analysis</h3>
    <div class="proof-score-content">
      <div class="proof-score-badge">
        <span class="score" id="proofScoreValue">‚Äî</span>
        <span class="label">/100</span>
      </div>
      <div class="metrics" id="proofMetrics">
        <p>Loading analysis...</p>
      </div>
      <div class="warnings" id="proofWarnings"></div>
    </div>
  </section>

  <!-- Print Settings Panel (loaded async) -->
  <section class="print-settings-card" id="print-settings-card" data-item-id="{{ item.id }}" style="display:none;">
    <h3>‚öôÔ∏è Recommended Print Settings</h3>
    <div class="subtitle">Auto-generated by Proofly</div>
    <div class="print-settings-body" id="print-settings-body">
      <div class="muted">Loading recommendations‚Ä¶</div>
    </div>
    <div class="print-settings-footer">
      <button type="button" class="btn btn-secondary" id="btn-copy-slice-hints" disabled>
        üìã Copy settings
      </button>
    </div>
  </section>

  <div class="detail-grid">
    <!-- ====== –í‚Äô–Æ–í–ï–† ====== -->
    <section class="viewer-card">
      <div class="viewer-toolbar">
        <button type="button" class="vt-btn" data-viewer-action="reset">
          üîÑ –°–∫–∏–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É
        </button>
        <button type="button" class="vt-btn" data-viewer-action="spin">
          üß≠ –ê–≤—Ç–æ–æ–±–µ—Ä—Ç–∞–Ω–Ω—è
        </button>
        <button type="button" class="vt-btn" data-viewer-action="wire">
          üï∏ Wireframe
        </button>
        <button type="button" class="vt-btn" data-viewer-action="grid">
          ‚ñ§ –°—ñ—Ç–∫–∞
        </button>
        <button type="button" class="vt-btn" data-viewer-action="dark">
          üåë –¢–µ–º–Ω–µ —Å–≤—ñ—Ç–ª–æ
        </button>
        <button type="button" class="vt-btn" data-viewer-action="light">
          üåï –Ø—Å–∫—Ä–∞–≤–µ —Å–≤—ñ—Ç–ª–æ
        </button>
      </div>

      <div id="viewer"
           class="viewer"
           data-item-id="{{ item.id }}"
           data-src="{{ main_src or '' }}"></div>
      <span id="status" class="viewer-status"></span>

      <div class="viewer-actions">
        {% if item.is_free %}
          <button id="btnPrimary" class="btn primary" data-mode="free">
            ‚¨á –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
          </button>
        {% else %}
          <button id="btnPrimary" class="btn primary" data-mode="paid">
            üí≥ –ö—É–ø–∏—Ç–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
          </button>
        {% endif %}

        <button id="btnFav" class="btn">‚òÜ –í –æ–±—Ä–∞–Ω–µ</button>
        <a id="btnOpenRaw" class="btn ghost" target="_blank" rel="noopener">
          –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª
        </a>
        <button id="btnCopyLink" class="btn ghost" type="button">
          üîó –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        </button>

        {# –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∞ #}
        {% if g.user and item.author_id and g.user.id == item.author_id %}
          <a href="/market/edit/{{ item.id }}" class="btn ghost edit-link">
            ‚úè –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–æ–¥–µ–ª—å
          </a>
        {% endif %}
      </div>

      {# Why this model? - Social proof #}
      {% set has_social_proof = (item.prints_count or 0) > 0 or (item.reviews_count or 0) > 0 or (item.followers_count or 0) > 0 %}
      {% if has_social_proof %}
        <div class="social-proof" style="margin-top: 1rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
          <div style="font-weight: 600; margin-bottom: 0.5rem; color: #667eea;">‚ú® Why this model?</div>
          <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.9rem;">
            {% if (item.prints_count or 0) > 0 %}
              <span style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="filter: grayscale(0);">üñ®Ô∏è</span>
                <strong>{{ item.prints_count }}</strong> real print{{ 's' if item.prints_count != 1 else '' }}
              </span>
            {% endif %}
            {% if (item.reviews_count or 0) > 0 %}
              <span style="display: flex; align-items: center; gap: 0.25rem;">
                <span>‚≠ê</span>
                <strong>{{ item.reviews_count }}</strong> review{{ 's' if item.reviews_count != 1 else '' }}
                {% if (item.verified_reviews_count or 0) > 0 %}
                  <span style="color: #10b981; font-size: 0.85em;">({{ item.verified_reviews_count }} ‚úì verified)</span>
                {% endif %}
              </span>
            {% endif %}
            {% if (item.followers_count or 0) > 0 %}
              <span style="display: flex; align-items: center; gap: 0.25rem;">
                <span>üë§</span>
                <strong>{{ item.followers_count }}</strong> follower{{ 's' if item.followers_count != 1 else '' }}
              </span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </section>

    <!-- ====== –û–ü–ò–° + –ì–ê–õ–ï–†–ï–Ø ====== -->
    <section class="desc-card">
      {% set cover_src = item.cover_url or item.cover or (item.photos[0] if item.photos) %}
      <div class="cover">
        <img src="{{ cover_src or '/static/img/placeholder_stl.jpg' }}"
             alt="{{ item.title }}"
             loading="lazy"
             onerror="this.onerror=null;this.src='/static/img/placeholder_stl.jpg'">
      </div>

      {% if item.photos and item.photos|length %}
      <div class="gallery">
        {% for img in item.photos %}
          <img src="{{ img }}" alt="preview" loading="lazy"
               onerror="this.onerror=null;this.src='/static/img/placeholder_stl.jpg'">
        {% endfor %}
      </div>
      {% endif %}

      {# –¢–µ–≥–∏ —è–∫ —á—ñ–ø—Å–∏ #}
      {% set tags_str = item.tags or '' %}
      {% set tags = tags_str.split(',') if tags_str else [] %}
      {% if tags %}
        <div class="tags">
          {% for t in tags %}
            {% set tt = t.strip() %}
            {% if tt %}
              <a href="{{ url_for('market.page_market') }}?q={{ tt }}" class="tag">#{{ tt }}</a>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <div class="desc">
        {{ item.description or item.desc or '–ù–µ–º–∞—î –æ–ø–∏—Å—É' }}
      </div>

      {% include "market/_owner_panel.html" ignore missing %}
    </section>

    <!-- ====== –í–Ü–î–ì–£–ö–ò ====== -->
    <section class="reviews-card">
      <h2>–í—ñ–¥–≥—É–∫–∏</h2>

      <form id="reviewForm" class="review-form">
        <label class="rev-label">
          –û—Ü—ñ–Ω–∫–∞:
          <select name="rating" id="revRating">
            <option value="5">5 ‚Äî üíé</option>
            <option value="4">4 ‚Äî üëç</option>
            <option value="3">3 ‚Äî üôÇ</option>
            <option value="2">2 ‚Äî üòê</option>
            <option value="1">1 ‚Äî üëé</option>
          </select>
        </label>
        <textarea id="revText" rows="3" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫..."></textarea>
        <button class="btn" id="btnSendReview" type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        <span id="revMsg" class="muted"></span>
      </form>

      <div class="reviews-list" id="reviewsList">
        {% for r in item.reviews or [] %}
          <div class="rev">
            <div class="r-head">
              <strong>{{ r.user.name if r.user else '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á' }}</strong>
              <span>‚òÖ {{ r.rating }}</span>
              <span class="muted">
                {% if r.created_at %}
                  {% if r.created_at is string %}
                    {{ r.created_at[:10] }}
                  {% else %}
                    {{ r.created_at.strftime('%Y-%m-%d') }}
                  {% endif %}
                {% endif %}
              </span>
            </div>
            <div class="r-text">{{ r.text }}</div>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>

  <!-- ====== –ê–í–¢–û–† ====== -->
  <section id="author" class="author-card">
    <img class="avatar"
         src="{{ item.owner.avatar_url if item.owner and item.owner.avatar_url else '/static/img/user.jpg' }}"
         alt="author">
    <div class="a-meta">
      <div class="name">{{ item.owner.name if item.owner else '‚Äî' }}</div>
      <div class="bio muted">
        {{ item.owner.bio if item.owner and item.owner.bio else '3D-–¥–∏–∑–∞–π–Ω–µ—Ä' }}
      </div>
      {% if item.author_id %}
        <div class="author-actions">
          <span class="followers-count" data-author-id="{{ item.author_id }}">0 followers</span>
          {% if item.is_owner %}
            <button class="follow-btn" disabled>Your model</button>
          {% else %}
            <button class="follow-btn" data-author-id="{{ item.author_id }}">Follow</button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </section>

  <!-- ====== PRINTED BY USERS (MAKES) ====== -->
  <section class="makes-section" id="makes-section" data-item-id="{{ item.id }}">
    <h2>Printed by Users</h2>
    <p class="subtitle">Community prints of this model</p>
    
    <!-- Upload form (visible only if logged in) -->
    {% if session.get('user_id') %}
    <div class="make-upload-form">
      <h3>Share your print!</h3>
      <form id="makeUploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="makeImage">Photo of your print</label>
          <input type="file" id="makeImage" name="image" accept="image/*" required>
        </div>
        <div class="form-group">
          <label for="makeCaption">Caption (optional)</label>
          <textarea id="makeCaption" name="caption" rows="3" maxlength="500" placeholder="Tell us about your print..."></textarea>
        </div>
        <button type="submit" class="btn-primary">Add Make</button>
      </form>
    </div>
    {% endif %}

    <!-- Makes grid -->
    <div id="makesGrid" class="makes-grid"></div>
    
    <!-- Empty state -->
    <div id="makesEmpty" class="makes-empty" style="display:none;">
      <div class="empty-icon">üì∑</div>
      <p>No prints yet. Be the first to share!</p>
    </div>
  </section>

  <!-- ====== REVIEWS V2 ====== -->
  <section class="reviews-section" id="reviews-section" data-item-id="{{ item.id }}">
    <h2>Reviews</h2>
    <p class="subtitle">What users think about this model</p>
    
    <!-- Review form (visible only if logged in) -->
    {% if session.get('user_id') %}
    <div class="review-form-container">
      <h3>Leave a review</h3>
      <form id="reviewForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="reviewRating">Rating</label>
          <select id="reviewRating" name="rating" required>
            <option value="">Select rating</option>
            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
            <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
            <option value="2">‚≠ê‚≠ê Poor</option>
            <option value="1">‚≠ê Bad</option>
          </select>
        </div>
        <div class="form-group">
          <label for="reviewText">Your review</label>
          <textarea id="reviewText" name="text" rows="4" maxlength="1000" placeholder="Share your experience with this model..."></textarea>
        </div>
        <div class="form-group">
          <label for="reviewImage">Add photo (optional)</label>
          <input type="file" id="reviewImage" name="image" accept="image/*">
        </div>
        <button type="submit" class="btn-primary">Submit Review</button>
      </form>
    </div>
    {% endif %}

    <!-- Reviews list -->
    <div id="reviewsList" class="reviews-list"></div>
    
    <!-- Empty state -->
    <div id="reviewsEmpty" class="reviews-empty" style="display:none;">
      <div class="empty-icon">üí¨</div>
      <p>No reviews yet. Be the first to review!</p>
    </div>
  </section>

  <!-- ====== –°–•–û–ñ–Ü –ú–û–î–ï–õ–Ü ====== -->
  <section class="related">
    <h2>–°—Ö–æ–∂—ñ –º–æ–¥–µ–ª—ñ</h2>
    <div id="related-grid" class="grid"></div>
  </section>
</article>

<style>
  .detail-wrap{
    max-width:1200px;
    margin:0 auto;
    padding:16px 16px 32px;
  }
  .crumbs{
    display:flex;
    gap:6px;
    align-items:center;
    color:var(--muted,#9fb0d4);
    font-size:13px;
    margin-bottom:4px;
  }
  .crumbs a{color:var(--muted,#9fb0d4);text-decoration:none;}
  .crumbs a:hover{text-decoration:underline;}

  .detail-head .title{
    margin:8px 0 6px 0;
    font-size:26px;
    font-weight:700;
  }
  .detail-head .meta{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    color:var(--muted,#9fb0d4);
    font-size:13px;
  }
  .detail-head .price{
    font-weight:700;
  }
  .detail-head .price.free{
    color:#22c55e;
  }
  .detail-head .sep{
    opacity:.6;
  }
  .detail-head .author{
    color:var(--muted,#9fb0d4);
    text-decoration:none;
  }
  .detail-head .author:hover{
    text-decoration:underline;
  }

  .detail-grid{
    display:grid;
    grid-template-columns:1.4fr .9fr;
    gap:16px;
    margin-top:14px;
  }
  @media(max-width:980px){
    .detail-grid{grid-template-columns:1fr;}
  }

  .viewer-card,
  .desc-card,
  .reviews-card{
    background:var(--card,#11141b);
    border:1px solid var(--line,#1b2131);
    border-radius:12px;
    padding:12px;
  }

  /* Toolbar */
  .viewer-toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-bottom:8px;
  }
  .vt-btn{
    border-radius:999px;
    border:1px solid var(--line,#1b2131);
    background:#0f172a;
    color:#e5e7eb;
    font-size:11px;
    padding:4px 8px;
    cursor:pointer;
    opacity:.9;
  }
  .vt-btn:hover{opacity:1;}

  .viewer{
    height:520px;
    background:#020617;
    border-radius:10px;
    border:1px solid var(--line,#1b2131);
    overflow:hidden;
  }
  .viewer-status{
    display:block;
    margin-top:6px;
    color:var(--muted,#9fb0d4);
    font-size:12px;
  }

  .viewer-actions{
    display:flex;
    gap:8px;
    margin-top:10px;
    flex-wrap:wrap;
  }
  .btn{
    background:var(--card,#11141b);
    border:1px solid var(--line,#1b2131);
    color:var(--text,#e8eaed);
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-size:13px;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .btn.primary{
    background:var(--accent,#5b66ff);
    border-color:var(--accent,#5b66ff);
    color:#fff;
  }
  .btn.ghost{
    opacity:.85;
  }
  .btn:hover{
    filter:brightness(1.05);
  }
  .edit-link{
    margin-left:auto;
  }

  .cover img{
    width:100%;
    height:220px;
    object-fit:cover;
    border-radius:8px;
    border:1px solid var(--line,#1b2131);
  }
  .gallery{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:8px;
    margin-top:8px;
  }
  .gallery img{
    width:100%;
    height:110px;
    object-fit:cover;
    border-radius:8px;
    border:1px solid var(--line,#1b2131);
  }

  .tags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:10px;
  }
  .tag{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    background:#020617;
    border:1px solid #1e293b;
    color:#e5e7eb;
    text-decoration:none;
  }
  .tag:hover{
    background:#0f172a;
  }

  .desc{
    margin-top:10px;
    white-space:pre-wrap;
    font-size:14px;
    line-height:1.4;
  }

  .reviews-card h2{
    margin:0 0 8px 0;
    font-size:18px;
  }
  .review-form{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:flex-start;
    margin-bottom:10px;
    font-size:13px;
  }
  .rev-label{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .review-form textarea{
    flex:1;
    min-width:220px;
    background:transparent;
    border:1px solid var(--line,#1b2131);
    border-radius:10px;
    color:var(--text,#e8eaed);
    padding:8px;
    font-size:13px;
  }
  .reviews-list .rev{
    border-top:1px solid var(--line,#1b2131);
    padding:10px 0;
    font-size:13px;
  }
  .reviews-list .rev:first-child{
    border-top:none;
  }
  .r-head{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:4px;
  }

  .author-card{
    display:flex;
    gap:12px;
    align-items:center;
    margin-top:16px;
    background:var(--card,#11141b);
    border:1px solid var(--line,#1b2131);
    border-radius:12px;
    padding:12px;
  }
  .author-card .avatar{
    width:56px;
    height:56px;
    border-radius:50%;
    border:1px solid var(--line,#1b2131);
    object-fit:cover;
  }
  .a-meta .name{
    font-weight:600;
    margin-bottom:2px;
  }
  .author-actions{
    display:flex;
    align-items:center;
    gap:12px;
    margin-top:8px;
  }
  .followers-count{
    font-size:13px;
    color:var(--muted,#9fb0d4);
  }
  .follow-btn{
    padding:6px 16px;
    border-radius:8px;
    border:1px solid var(--btn,#1a73e8);
    background:transparent;
    color:var(--btn,#1a73e8);
    font-size:13px;
    font-weight:500;
    cursor:pointer;
    transition:all 0.2s;
  }
  .follow-btn:hover{
    background:var(--btn,#1a73e8);
    color:white;
  }
  .follow-btn.following{
    background:var(--btn,#1a73e8);
    color:white;
    border-color:var(--btn,#1a73e8);
  }
  .follow-btn:disabled{
    opacity:0.6;
    cursor:not-allowed;
    background:var(--card,#11141b);
    border-color:var(--line,#1b2131);
    color:var(--muted,#9fb0d4);
  }
  .follow-btn:disabled:hover{
    background:var(--card,#11141b);
  }
  .follow-btn.self-follow{
    background:var(--muted,#9fb0d4);
    border-color:var(--muted,#9fb0d4);
    color:var(--bg,#0f1115);
    cursor:default;
    opacity:0.7;
  }

  .related{
    margin-top:24px;
  }
  .related h2{
    margin:0 0 10px 0;
    font-size:18px;
  }
  .related .grid{
    display:grid;
    gap:16px;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  }
  .rel-item{
    display:flex;
    flex-direction:column;
    background:var(--card,#11141b);
    border:1px solid var(--line,#1b2131);
    border-radius:12px;
    overflow:hidden;
    text-decoration:none;
    color:inherit;
  }
  .rel-item img{
    width:100%;
    height:150px;
    object-fit:cover;
  }
  .rel-title{
    padding:8px 10px;
    font-size:13px;
  }

  .muted{
    color:var(--muted,#9fb0d4);
  }

  @media(max-width:768px){
    .detail-wrap{padding:12px 12px 24px;}
    .viewer{height:380px;}
  }

  /* =========================================================
     FIX: –í‚Äô–Æ–í–ï–† –ù–ï –ú–ê–Ñ –ü–†–ê–í–ê "–í–ò–ù–û–°–ò–¢–ò–°–¨" –í–ü–†–ê–í–û
     1) canvas –∑–∞–≤–∂–¥–∏ 100% –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
     2) box-sizing —â–æ–± border/padding –Ω–µ –¥–∞–≤–∞–ª–∏ overflow
     ========================================================= */
  .detail-wrap, .detail-grid, .viewer-card, .desc-card, .reviews-card, .viewer{
    box-sizing: border-box;
    max-width: 100%;
  }
  #viewer, .viewer{
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    position: relative;
  }
  #viewer canvas, .viewer canvas{
    display:block;
    width:100% !important;
    height:100% !important;
    max-width:100% !important;
  }
</style>

<link rel="stylesheet" href="{{ url_for('static', filename='css/makes.css') }}">

<script type="module">
  const viewerEl   = document.getElementById('viewer');
  const statusEl   = document.getElementById('status');
  const btnOpenRaw = document.getElementById('btnOpenRaw');
  const btnCopy    = document.getElementById('btnCopyLink');
  const rawSrc     = viewerEl?.dataset?.src || null;
  const itemId     = Number(viewerEl?.dataset?.itemId || {{ item.id }});

  // –õ—ñ–Ω–∫ "–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª"
  if (btnOpenRaw) {
    if (rawSrc) { btnOpenRaw.href = rawSrc; }
    else { btnOpenRaw.style.display = 'none'; }
  }

  // –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
  if (btnCopy) {
    btnCopy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        btnCopy.textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ';
        setTimeout(() => btnCopy.textContent = 'üîó –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è', 1200);
      } catch (e) {
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.');
      }
    });
  }

  // –û–±—Ä–∞–Ω–µ
  const btnFav = document.getElementById('btnFav');
  if (btnFav) {
    btnFav.addEventListener('click', async () => {
      try {
        const r = await fetch('/api/market/fav', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId })
        });
        const j = await r.json().catch(() => null);
        if (r.status === 401) {
          alert('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ.');
          return;
        }
        if (j && j.ok) {
          btnFav.textContent = j.fav ? '‚òÖ –í –æ–±—Ä–∞–Ω–æ–º—É' : '‚òÜ –í –æ–±—Ä–∞–Ω–µ';
        }
      } catch (e) { console.error(e); }
    });
  }

  // –ö—É–ø–∏—Ç–∏ / —Å–∫–∞—á–∞—Ç–∏ (–æ–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è free/paid)
  const primaryBtn = document.getElementById('btnPrimary');
  if (primaryBtn) {
    primaryBtn.addEventListener('click', async () => {
      primaryBtn.disabled = true;
      const oldText = primaryBtn.textContent;
      primaryBtn.textContent = '...';

      try {
        const r = await fetch('/api/market/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId })
        });
        if (r.status === 401) {
          alert('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–µ–ª—å.');
          return;
        }
        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—É / –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.');
          return;
        }
        // free
        if (j.free && j.download_url) {
          // –õ–æ–≥ –ø–æ–¥—ñ—ó
          fetch('/api/market/track', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'download', item_id: itemId })
          }).catch(() => {});
          window.location.href = j.download_url;
          return;
        }
        // Stripe / —ñ–Ω—à–∞ –æ–ø–ª–∞—Ç–∞
        if (j.url) {
          window.location.href = j.url;
          return;
        }
        alert('–î–µ–º–æ-—Ä–µ–∂–∏–º: –æ–ø–ª–∞—Ç–∞ —â–µ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞.');
      } catch (e) {
        console.error(e);
        alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.');
      } finally {
        primaryBtn.disabled = false;
        primaryBtn.textContent = oldText;
      }
    });
  }

  // –í—ñ–¥–≥—É–∫–∏
  const form = document.getElementById('reviewForm');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const rating = Number(document.getElementById('revRating').value || 5);
      const text   = String(document.getElementById('revText').value || '').trim();
      const msg    = document.getElementById('revMsg');
      msg.textContent = '';

      try {
        const r = await fetch('/api/market/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId, rating, text })
        });
        if (r.status === 401) {
          msg.textContent = '–£–≤—ñ–π–¥–∏, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.';
          return;
        }
        const j = await r.json().catch(() => null);
        if (j && j.ok) {
          msg.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úî';
          setTimeout(() => location.reload(), 700);
        } else {
          msg.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.';
        }
      } catch (err) {
        console.error(err);
        msg.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.';
      }
    });
  }

  // –°—Ö–æ–∂—ñ –º–æ–¥–µ–ª—ñ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î /api/market/items/related, —è–∫—É –º–∏ –¥–æ–¥–∞–ª–∏ –≤ market_api)
  (async () => {
    const grid = document.getElementById('related-grid');
    if (!grid) return;

    try {
      const r = await fetch(`/api/market/items/related?item_id=${itemId}`);
      if (!r.ok) return;
      const arr = await r.json().catch(() => []);
      if (!Array.isArray(arr) || !arr.length) return;

      grid.innerHTML = arr.map(it => `
        <a href="/item/${it.slug || it.id}" class="rel-item">
          <img src="${it.cover_url || '/static/img/placeholder_stl.jpg'}"
               alt="${it.title}" loading="lazy">
          <div class="rel-title">${it.title}</div>
        </a>
      `).join('');
    } catch (e) {
      console.error(e);
    }
  })();

  // =========================
  // FIX helpers (–ª–æ–∫–∞–ª—å–Ω–æ)
  // =========================
  function clampViewerCanvas(container, ctx) {
    if (!container) return;
    container.style.width = "100%";
    container.style.maxWidth = "100%";
    container.style.overflow = "hidden";

    const canvas =
      container.querySelector("canvas") ||
      (ctx && ctx.renderer && ctx.renderer.domElement) ||
      null;

    if (canvas) {
      canvas.style.display = "block";
      canvas.style.width = "100%";
      canvas.style.height = "100%";
      canvas.style.maxWidth = "100%";
    }

    try {
      // —è–∫—â–æ –≤ initViewer —î resize() ‚Äî –≤–∏–∫–ª–∏—á–µ–º–æ –π–æ–≥–æ (–Ω–µ –º—ñ–Ω—è—î —Ñ—É–Ω–∫—Ü—ñ—ó)
      if (ctx && typeof ctx.resize === "function") ctx.resize();
    } catch (_) {}
  }

  // 3D viewer —á–µ—Ä–µ–∑ stl_viewer.js
  if (viewerEl && rawSrc) {
    (async () => {
      try {
        // GUARD #1: —è–∫—â–æ —Ö—Ç–æ—Å—å —É–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ static/market/js/viewer.js)
        if (window.MARKET_VIEWER) {
          clampViewerCanvas(viewerEl, window.MARKET_VIEWER);
          return;
        }

        // GUARD #2: —è–∫—â–æ –≤ #viewer –≤–∂–µ —î canvas ‚Äî –∑–Ω–∞—á–∏—Ç—å init —É–∂–µ –±—É–≤
        if (viewerEl.querySelector("canvas")) {
          clampViewerCanvas(viewerEl, null);
          return;
        }

        statusEl.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ 3D-–º–æ–¥–µ–ª—å...';
        const { initViewer } = await import('/static/js/stl_viewer.js');
        const ctx = await initViewer({
          containerId: 'viewer',
          statusId: 'status',
        });

        // –í–ê–ñ–õ–ò–í–û: –≤–∏—Å—Ç–∞–≤–ª—è—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–æ, —â–æ–± —ñ–Ω—à—ñ —Å–∫—Ä–∏–ø—Ç–∏ –Ω–µ —Ä–æ–±–∏–ª–∏ –¥—É–±–ª—å-init
        window.MARKET_VIEWER = ctx;

        // –ü—Ä–∏—Ç–∏—Å–∫–∞—î–º–æ canvas –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è init
        clampViewerCanvas(viewerEl, ctx);

        const resp = await fetch(rawSrc);
        const blob = await resp.blob();
        const file = new File([blob], 'model.stl');
        await ctx.loadAnyFromFile(file);

        // –ü—Ä–∏—Ç–∏—Å–∫–∞—î–º–æ —â–µ —Ä–∞–∑ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        clampViewerCanvas(viewerEl, ctx);

        statusEl.textContent = '–ì–æ—Ç–æ–≤–æ. –û–±–µ—Ä—Ç–∞–π –º–æ–¥–µ–ª–ª—é –º–∏—à–∫–æ—é.';

        // —Ç—É–ª–±–∞—Ä
        document.querySelectorAll('.vt-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.viewerAction;
            if (!action || !ctx || !ctx.controls) return;
            ctx.handleAction?.(action);
            // –ø—ñ—Å–ª—è –¥—ñ–π —ñ–Ω–∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω clamp
            clampViewerCanvas(viewerEl, ctx);
          });
        });
      } catch (err) {
        console.error(err);
        if (statusEl) statusEl.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ 3D-–ø—Ä–µ–≤ º—é.';
      }
    })();
  } else if (statusEl) {
    statusEl.textContent = 'STL-—Ñ–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.';
  }

  // ========================================
  // Proof Score Panel - Load async
  // ========================================
  (async function loadProofScore() {
    const itemId = {{ item.id }};
    const panel = document.getElementById('proofScorePanel');
    const scoreEl = document.getElementById('proofScoreValue');
    const metricsEl = document.getElementById('proofMetrics');
    const warningsEl = document.getElementById('proofWarnings');
    
    if (!panel || !scoreEl || !metricsEl || !warningsEl) return;
    
    try {
      const res = await fetch(`/api/item/${itemId}/printability`);
      const data = await res.json();
      
      if (!data.ok) {
        console.debug('Proof score unavailable:', data.error);
        return;
      }
      
      // Show panel
      panel.style.display = 'block';
      
      // Update score badge
      scoreEl.textContent = data.proof_score ?? '‚Äî';
      scoreEl.className = 'score ' + getScoreClass(data.proof_score);
      
      // Update metrics
      const p = data.printability || {};
      const metricsHTML = `
        <p><strong>Triangles:</strong> ${p.triangles ?? '‚Äî'}</p>
        <p><strong>Bounding Box:</strong> ${formatBbox(p.bbox_mm)}</p>
        <p><strong>Volume:</strong> ${formatVolume(p.volume_mm3)}</p>
        <p><strong>Est. Weight (PLA):</strong> ${formatWeight(p.weight_g)}</p>
        <p><strong>Overhang:</strong> ${p.overhang_percent ? p.overhang_percent.toFixed(1) + '%' : '‚Äî'}</p>
      `;
      metricsEl.innerHTML = metricsHTML;
      
      // Update warnings
      if (p.warnings && p.warnings.length > 0) {
        const warningsHTML = '<h4>‚ö†Ô∏è Warnings:</h4><ul>' +
          p.warnings.map(w => `<li>${formatWarning(w)}</li>`).join('') +
          '</ul>';
        warningsEl.innerHTML = warningsHTML;
      }
      
    } catch (err) {
      console.error('Failed to load proof score:', err);
    }
  })();

  function getScoreClass(score) {
    if (score >= 80) return 'excellent';
    if (score >= 60) return 'good';
    if (score >= 40) return 'fair';
    return 'poor';
  }

  function formatBbox(bbox) {
    if (!bbox || bbox.length !== 3) return '‚Äî';
    return `${bbox[0].toFixed(1)} √ó ${bbox[1].toFixed(1)} √ó ${bbox[2].toFixed(1)} mm`;
  }

  function formatVolume(vol) {
    if (!vol) return '‚Äî';
    return `${(vol / 1000).toFixed(2)} cm¬≥`;
  }

  function formatWeight(w) {
    if (!w) return '‚Äî';
    return `${w.toFixed(1)} g`;
  }

  function formatWarning(w) {
    const labels = {
      'non_manifold': 'Non-manifold geometry (edges not paired)',
      'degenerate_faces': 'Degenerate triangles detected',
      'volume_unreliable': 'Volume calculation may be inaccurate',
      'empty_mesh': 'Empty mesh or parse error'
    };
    return labels[w] || w;
  }
</script>

<!-- Makes functionality -->
<script src="{{ url_for('static', filename='market/js/makes.js') }}"></script>

<!-- Reviews functionality -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/reviews.css') }}">
<script src="{{ url_for('static', filename='market/js/reviews_v2.js') }}"></script>

<!-- Follow functionality -->
<script src="{{ url_for('static', filename='market/js/follow.js') }}"></script>

<!-- Slice hints functionality -->
<script src="{{ url_for('static', filename='market/js/slice_hints.js') }}"></script>
{% endblock %}
