{% extends "market/layout.html" %}
{% set market_page = 'detail' %}

{% block market_body %}
<article class="detail-wrap">
  <!-- –•–ª—ñ–±–Ω—ñ –∫—Ä–∏—Ö—Ç–∏ -->
  <nav class="crumbs">
    <a href="{{ url_for('market.page_market') }}">Market</a>
    <span>/</span>
    <span>{{ item.title }}</span>
  </nav>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –±–∞–∑–æ–≤–∞ –º–µ—Ç–∞ -->
  <header class="detail-head">
    <h1 class="title">{{ item.title }}</h1>
    <div class="meta">
      <span>‚òÖ {{ item.rating or '‚Äî' }} ({{ item.ratings_cnt or 0 }})</span>
      <span>‚¨áÔ∏è {{ item.downloads or 0 }}</span>
      {% if item.price_cents and not item.is_free %}
        <span class="price">{{ (item.price_cents/100)|round(2) }} PLN</span>
      {% else %}
        <span class="price free">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</span>
      {% endif %}
      <span class="sep">‚Ä¢</span>
      <a class="author" href="#author">–ê–≤—Ç–æ—Ä: {{ item.owner.name if item.owner else '‚Äî' }}</a>
    </div>
  </header>

  <div class="detail-grid">
    <!-- –í º—é–≤–µ—Ä -->
    <section class="viewer-card">
      <div id="viewer"
           class="viewer"
           data-item-id="{{ item.id }}"
           data-src="{{ item.main_model_url or (item.files_json and (item.files_json|safe)) }}"></div>
      <span id="status" class="viewer-status"></span>

      <div class="viewer-actions">
        {% if item.is_free or not item.price_cents %}
          <button id="btnDownload" class="btn primary">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        {% else %}
          <button id="btnBuy" class="btn primary">üí≥ –ö—É–ø–∏—Ç–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        {% endif %}
        <button id="btnFav" class="btn">‚òÜ –í –æ–±—Ä–∞–Ω–µ</button>
        <a id="btnOpenRaw" class="btn ghost" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª</a>
      </div>
    </section>

    <!-- –û–ø–∏—Å + –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
    <section class="desc-card">
      <div class="cover">
        <img src="{{ item.cover_url or '/static/img/placeholder_stl.jpg' }}" alt="{{ item.title }}"
             onerror="this.onerror=null;this.src='/static/img/placeholder_stl.jpg'">
      </div>

      {% if item.photos and item.photos|length %}
      <div class="gallery">
        {% for img in item.photos %}
          <img src="{{ img }}" alt="preview" loading="lazy"
               onerror="this.onerror=null;this.src='/static/img/placeholder_stl.jpg'">
        {% endfor %}
      </div>
      {% endif %}

      <div class="desc">
        {{ (item.description or '–ù–µ–º–∞—î –æ–ø–∏—Å—É') }}
      </div>

      {% include "market/_owner_panel.html" ignore missing %}
    </section>

    <!-- –í—ñ–¥–≥—É–∫–∏ -->
    <section class="reviews-card">
      <h2>–í—ñ–¥–≥—É–∫–∏</h2>

      <form id="reviewForm" class="review-form">
        <label>
          –û—Ü—ñ–Ω–∫–∞:
          <select name="rating" id="revRating">
            <option value="5">5 ‚Äî üíé</option>
            <option value="4">4 ‚Äî üëç</option>
            <option value="3">3 ‚Äî üôÇ</option>
            <option value="2">2 ‚Äî üòê</option>
            <option value="1">1 ‚Äî üëé</option>
          </select>
        </label>
        <textarea id="revText" rows="3" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫..."></textarea>
        <button class="btn" id="btnSendReview" type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        <span id="revMsg" class="muted"></span>
      </form>

      <div class="reviews-list" id="reviewsList">
        {% for r in item.reviews or [] %}
          <div class="rev">
            <div class="r-head">
              <strong>{{ r.user.name if r.user else '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á' }}</strong>
              <span>‚òÖ {{ r.rating }}</span>
              <span class="muted">{{ r.created_at.strftime('%Y-%m-%d') if r.created_at else '' }}</span>
            </div>
            <div class="r-text">{{ r.text }}</div>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>

  <!-- –ê–≤—Ç–æ—Ä -->
  <section id="author" class="author-card">
    <img class="avatar" src="{{ item.owner.avatar_url if item.owner and item.owner.avatar_url else '/static/img/user.jpg' }}" alt="author">
    <div class="a-meta">
      <div class="name">{{ item.owner.name if item.owner else '‚Äî' }}</div>
      <div class="bio muted">{{ item.owner.bio if item.owner and item.owner.bio else '3D-–¥–∏–∑–∞–π–Ω–µ—Ä' }}</div>
    </div>
  </section>
</article>

<style>
  .detail-wrap{max-width:1200px;margin:0 auto;padding:16px}
  .crumbs{display:flex;gap:6px;align-items:center;color:var(--muted)}
  .detail-head .title{margin:8px 0 6px 0}
  .detail-head .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted)}
  .detail-head .price{font-weight:700}
  .detail-head .price.free{color:#22c55e}
  .detail-grid{display:grid;grid-template-columns:1.4fr .9fr;gap:16px;margin-top:14px}
  @media(max-width:980px){.detail-grid{grid-template-columns:1fr}}
  .viewer-card,.desc-card,.reviews-card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .viewer{height:520px;background:#0b0f15;border-radius:10px;border:1px solid var(--line)}
  .viewer-status{display:block;margin-top:6px;color:var(--muted)}
  .viewer-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{opacity:.85}
  .cover img{width:100%;height:220px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .gallery img{width:100%;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  .desc{margin-top:10px;white-space:pre-wrap}
  .reviews-card h2{margin:0 0 8px 0}
  .review-form{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .review-form textarea{flex:1;min-width:240px;background:transparent;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px}
  .reviews-list .rev{border-top:1px solid var(--line);padding:10px 0}
  .reviews-list .rev:first-child{border-top:none}
  .r-head{display:flex;gap:10px;align-items:center}
  .author-card{display:flex;gap:12px;align-items:center;margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .author-card .avatar{width:56px;height:56px;border-radius:50%;border:1px solid var(--line);object-fit:cover}
  .muted{color:var(--muted)}
</style>

<script type="module">
  // 1) –ü—ñ–¥—Å—Ç–∞–≤–ª—è—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π src —É –∫–Ω–æ–ø–∫—É "–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª"
  const viewerEl = document.getElementById('viewer');
  const statusEl = document.getElementById('status');
  const btnOpenRaw = document.getElementById('btnOpenRaw');
  const rawSrc = viewerEl?.dataset?.src || null;
  if (btnOpenRaw) {
    if (rawSrc) { btnOpenRaw.href = rawSrc.startsWith('/') ? rawSrc : rawSrc; }
    else { btnOpenRaw.style.display = 'none'; }
  }

  // 2) –û–±—Ä–∞–Ω–µ
  const btnFav = document.getElementById('btnFav');
  if (btnFav) {
    btnFav.addEventListener('click', async ()=>{
      try{
        const r = await fetch('/api/market/fav', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ item_id: {{ item.id }} })
        });
        const j = await r.json();
        if (j && j.ok){
          btnFav.textContent = j.fav ? '‚òÖ –í –æ–±—Ä–∞–Ω–æ–º—É' : '‚òÜ –í –æ–±—Ä–∞–Ω–µ';
        } else if (r.status === 401){
          alert('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ.');
        }
      }catch(e){ console.error(e); }
    });
  }

  // 3) Checkout / Download
  const btnBuy = document.getElementById('btnBuy');
  const btnDownload = document.getElementById('btnDownload');

  if (btnBuy){
    btnBuy.addEventListener('click', async ()=>{
      try{
        const r = await fetch('/api/market/checkout', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ item_id: {{ item.id }} })
        });
        const j = await r.json();
        if (j.free && j.download_url){
          window.location.href = j.download_url;
          return;
        }
        if (j.url){ window.location.href = j.url; return; } // Stripe session
        alert('–î–µ–º–æ-—Ä–µ–∂–∏–º: –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞.');
      }catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—É.'); }
    });
  }

  if (btnDownload){
    btnDownload.addEventListener('click', ()=>{
      if (!rawSrc){ alert('–§–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.'); return; }
      fetch(`/api/item/{{ item.id }}/download`, { method:'POST' }).catch(()=>{});
      window.open(rawSrc, '_blank');
    });
  }

  // 4) –í—ñ–¥–≥—É–∫
  const form = document.getElementById('reviewForm');
  if (form){
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const rating = Number(document.getElementById('revRating').value || 5);
      const text = String(document.getElementById('revText').value || '').trim();
      const msg = document.getElementById('revMsg'); msg.textContent = '';
      try{
        const r = await fetch('/api/market/review', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ item_id: {{ item.id }}, rating, text })
        });
        if (r.status === 401) { msg.textContent = '–£–≤—ñ–π–¥–∏, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.'; return; }
        const j = await r.json();
        if (j.ok){
          msg.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úî';
          setTimeout(()=>location.reload(), 700);
        } else {
          msg.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.';
        }
      }catch(err){ console.error(err); msg.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.'; }
    });
  }
</script>
{% endblock %}
