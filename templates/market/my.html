{% extends "base.html" %}

{% block title %}–ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è ‚Äî Proofly STL Market{% endblock %}

{% block content %}
<div class="market-page my-market-page" data-market-root data-market-page="my">
  <!-- –í–µ—Ä—Ö–Ω—ñ–π –±–∞—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
  <div class="market-topbar">
    <div class="left">
      <h1 class="market-h1">–ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h1>
      <p class="market-sub">
        –¢—É—Ç —Ç–∏ –∫–µ—Ä—É—î—à —É—Å—ñ–º–∞ —Å–≤–æ—ó–º–∏ –º–æ–¥–µ–ª—è–º–∏: —Ä–µ–¥–∞–≥—É—î—à –Ω–∞–∑–≤–∏, —Ü—ñ–Ω–∏, –æ–±–∫–ª–∞–¥–∏–Ω–∫–∏, –æ–ø–∏—Å —Ç–∞ —Ñ–∞–π–ª–∏.
      </p>

      <div class="market-badges" id="my-stats">
        <span class="badge">
          <span class="badge-label">–û–≥–æ–ª–æ—à–µ–Ω—å</span>
          <span class="badge-value" id="my-stat-items">0</span>
        </span>
        <span class="badge">
          <span class="badge-label">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å</span>
          <span class="badge-value" id="my-stat-downloads">0</span>
        </span>
        <span class="badge">
          <span class="badge-label">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥</span>
          <span class="badge-value" id="my-stat-rating">0.0‚òÖ</span>
        </span>
      </div>
    </div>

    <div class="right">
      <a href="{{ url_for('market.page_market_upload') }}" class="btn btn-primary big">
        ‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –º–æ–¥–µ–ª—å
      </a>

      <a href="/profile"
         class="btn btn-secondary">
        üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
      </a>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–∏–π layout: —Ñ—ñ–ª—å—Ç—Ä–∏ –∑–ª—ñ–≤–∞, —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–∞ -->
  <div class="market-layout">
    <aside class="market-sidebar">
      <h2 class="sidebar-title">–§—ñ–ª—å—Ç—Ä–∏</h2>

      <div class="sidebar-block">
        <label for="my-sort" class="lbl">–°–æ—Ä—Ç—É–≤–∞—Ç–∏</label>
        <select id="my-sort" class="inp" data-filter-sort>
          <option value="new" selected>–ù–æ–≤—ñ —Å–ø–æ—á–∞—Ç–∫—É</option>
          <option value="downloads">–ó–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º–∏</option>
          <option value="price_asc">–¶—ñ–Ω–∞: –≤—ñ–¥ –¥–µ—à–µ–≤–∏—Ö</option>
          <option value="price_desc">–¶—ñ–Ω–∞: –≤—ñ–¥ –¥–æ—Ä–æ–≥–∏—Ö</option>
        </select>
      </div>

      <div class="sidebar-block">
        <label class="lbl">–¢–∏–ø</label>
        <div class="chips" id="my-free-filter">
          <button data-free="all"  data-show="all"  class="chip active">–£—Å—ñ</button>
          <button data-free="free" data-show="free" class="chip">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ</button>
          <button data-free="paid" data-show="paid" class="chip">–ü–ª–∞—Ç–Ω—ñ</button>
        </div>
      </div>

      <div class="sidebar-block">
        <label class="lbl">–ü–æ—à—É–∫ –ø–æ –º–æ—ó—Ö –º–æ–¥–µ–ª—è—Ö</label>
        <input type="text" id="my-search" class="inp" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: dragon, stand, toy‚Ä¶">
      </div>

      <div class="sidebar-block hint">
        <strong>–ü–æ—Ä–∞–¥–∞:</strong> –Ω–∞—Ç–∏—Å–Ω–∏ –ø–æ –∫–∞—Ä—Ç—Ü—ñ, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø—É–±–ª—ñ—á–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –º–æ–¥–µ–ª—ñ, –∞–±–æ –ø–æ —ñ–∫–æ–Ω—Ü—ñ ‚úèÔ∏è –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.
      </div>
    </aside>

    <main class="market-main">
      <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º -->
      <div class="my-toolbar">
        <div class="left">
          <span id="my-counter-text">–ó–Ω–∞–π–¥–µ–Ω–æ 0 –æ–≥–æ–ª–æ—à–µ–Ω—å</span>
        </div>
        <div class="right">
          <button id="my-refresh" class="btn btn-ghost">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
      </div>

      <!-- notice –¥–ª—è market.js -->
      <div class="market-notice" data-market-notice style="display:none;"></div>

      <!-- –ü–æ—Ä–æ–∂–Ω—ñ–π —Å—Ç–∞–Ω -->
      <div id="my-empty" class="my-empty" style="display:none;">
        <div class="icon">üì≠</div>
        <h2>–£ —Ç–µ–±–µ —â–µ –Ω–µ–º–∞—î –æ–≥–æ–ª–æ—à–µ–Ω—å</h2>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂ –ø–µ—Ä—à—É –º–æ–¥–µ–ª—å, –Ω–∞–ª–∞—à—Ç—É–π —Ü—ñ–Ω—É —Ç–∞ –æ–±–∫–ª–∞–¥–∏–Ω–∫—É, —ñ –≤–æ–Ω–∞ –≤—ñ–¥—Ä–∞–∑—É –∑‚Äô—è–≤–∏—Ç—å—Å—è —Ç—É—Ç.</p>
        <a href="{{ url_for('market.page_market_upload') }}" class="btn btn-primary">
          ‚ûï –î–æ–¥–∞—Ç–∏ –ø–µ—Ä—à—É –º–æ–¥–µ–ª—å
        </a>
      </div>

      <!-- –ì—Ä—ñ–¥ –º–æ—ó—Ö –º–æ–¥–µ–ª–µ–π -->
      <div id="my-grid" class="market-grid" data-market-grid>
        {# –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î JS —á–µ—Ä–µ–∑ API /api/my/items #}
      </div>

      <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è (JS —Å–∞–º –º–∞–ª—é—î –∫–Ω–æ–ø–∫–∏) -->
      <div id="my-pagination" class="pagination" data-market-pagination>
      </div>
    </main>
  </div>

  {# ===================== –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –û–ì–û–õ–û–®–ï–ù–ù–Ø ===================== #}
  <div id="my-edit-backdrop" class="modal-backdrop" style="display:none;"></div>
  <div id="my-edit-modal" class="modal" style="display:none;">
    <div class="modal-inner">
      <div class="modal-header">
        <h2 id="my-edit-title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
        <button type="button" class="modal-close" id="my-edit-close">‚úï</button>
      </div>

      <form id="my-edit-form">
        <input type="hidden" id="my-edit-id">

        <div class="form-row">
          <label class="lbl" for="my-edit-name">–ù–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ</label>
          <input type="text" id="my-edit-name" class="inp" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Dragon Guardian V2">
        </div>

        <div class="form-row two">
          <div>
            <label class="lbl" for="my-edit-price">–¶—ñ–Ω–∞ (PLN)</label>
            <input type="number" step="1" min="0" id="my-edit-price" class="inp" placeholder="0 = –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ">
          </div>
          <div>
            <label class="lbl" for="my-edit-format">–§–æ—Ä–º–∞—Ç</label>
            <select id="my-edit-format" class="inp">
              <option value="stl">STL</option>
              <option value="obj">OBJ</option>
              <option value="gltf">GLTF</option>
              <option value="glb">GLB</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <label class="lbl" for="my-edit-tags">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
          <input type="text" id="my-edit-tags" class="inp" placeholder="dragon, fantasy, statue‚Ä¶">
        </div>

        <div class="form-row">
          <label class="lbl" for="my-edit-desc">–û–ø–∏—Å</label>
          <textarea id="my-edit-desc" class="inp" rows="4"
                    placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏ –º–æ–¥–µ–ª—å, —Ä–æ–∑–º—ñ—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥—Ä—É–∫—É..."></textarea>
        </div>

        <div class="form-row two">
          <div>
            <label class="lbl" for="my-edit-cover">–û–±–∫–ª–∞–¥–∏–Ω–∫–∞ (URL)</label>
            <input type="text" id="my-edit-cover" class="inp" placeholder="/media/user_xxx/covers/cover.jpg">
            <p class="hint-small">–ó–º—ñ–Ω–∏—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –º–æ–∂–Ω–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∞–±–æ –æ–∫—Ä–µ–º–∏–π –∞–ø–ª–æ–∞–¥.</p>
          </div>
          <div class="preview-wrap">
            <span class="lbl">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</span>
            <div class="cover-preview">
              <img id="my-edit-cover-preview" src="/static/img/placeholder_stl.jpg" alt="Cover preview">
            </div>
          </div>
        </div>

        <div class="form-row">
          <label class="lbl" for="my-edit-main-url">–û—Å–Ω–æ–≤–Ω–∏–π STL / —Ñ–∞–π–ª</label>
          <input type="text" id="my-edit-main-url" class="inp" placeholder="/media/user_xxx/models/model.stl">
        </div>

        <div class="form-row">
          <label class="lbl" for="my-edit-extra-urls">–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏ (JSON –º–∞—Å–∏–≤ –∞–±–æ —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ Enter)</label>
          <textarea id="my-edit-extra-urls" class="inp" rows="3"
                    placeholder='["/media/.../support.stl","/media/.../alt_pose.stl"]'></textarea>
        </div>

        <div class="form-row footer-row">
          <div class="left">
            <button type="button" class="btn btn-danger-outline" id="my-edit-delete">
              üóë –í–∏–¥–∞–ª–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
            </button>
          </div>
          <div class="right">
            <button type="button" class="btn btn-ghost" id="my-edit-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button type="submit" class="btn btn-primary" id="my-edit-save">
              üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
            </button>
          </div>
        </div>

        <div class="form-row" id="my-edit-status" style="display:none;">
          <p class="status-text"></p>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
  .my-market-page{max-width:1200px;margin:0 auto;padding:24px 16px 40px}
  .market-topbar{display:flex;justify-content:space-between;gap:24px;margin-bottom:24px;align-items:flex-start}
  .market-h1{margin:0;font-size:26px}
  .market-sub{margin:6px 0 14px;color:#9ca3af;font-size:14px}
  .market-badges{display:flex;flex-wrap:wrap;gap:8px}
  .market-badges .badge{background:#111827;border:1px solid #1f2933;border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:6px;font-size:12px}
  .badge-label{color:#9ca3af}
  .badge-value{color:#e5e7eb;font-weight:600}
  .market-topbar .right{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end}
  .btn.big{padding:10px 18px;font-size:14px}
  .market-layout{display:grid;grid-template-columns:260px minmax(0,1fr);gap:22px}
  .market-sidebar{background:#050816;border-radius:14px;padding:14px 14px 18px;border:1px solid #111827}
  .sidebar-title{margin:0 0 12px;font-size:15px}
  .sidebar-block{margin-bottom:14px}
  .sidebar-block .lbl{display:block;margin-bottom:4px;font-size:12px;color:#9ca3af}
  .inp{width:100%;background:#020617;border-radius:10px;border:1px solid:#111827;padding:8px 10px;font-size:13px;color:#e5e7eb;outline:none}
  .inp:focus{border-color:#6366f1}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border-radius:999px;border:1px solid #111827;background:#020617;color:#9ca3af;font-size:12px;padding:5px 10px;cursor:pointer}
  .chip.active{background:#4f46e5;color:#f9faf–±;border-color:#4f46e5}
  .sidebar-block.hint{font-size:12px;color:#9ca3af;background:#020617;border-radius:10px;padding:8px 10px;border:1px dashed #111827}
  .market-main{min-height:260px}
  .my-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:13px;color:#9ca3af}
  .my-empty{text–∞–Ω–∫-center;padding:40px 10px;border-radius:14px;background:#020617;border:1px dashed #1f2933;margin-top:10px}
  .my-empty .icon{font-size:30px;margin-bottom:8px}
  .my-empty h2{margin:0 0 6px;font-size:18px}
  .my-empty p{margin:0 0 12px;color:#9ca3af;font-size:13px}
  .market-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;margin-top:10px}

  /* üî• –§–Ü–ö–° –ö–ê–†–¢–ò–ù–û–ö –£ –ú–û–á–• –û–ì–û–õ–û–®–ï–ù–ù–Ø–• */
  .my-market-page #my-grid img{
    max-width:100%;
    height:auto;
    max-height:260px;          /* —â–æ–± –Ω–µ –±—É–ª–∏ –≥—ñ–≥–∞–Ω—Ç—Å—å–∫—ñ */
    object-fit:contain;        /* –Ω–µ —Ä—ñ–∂–µ, –Ω–µ —Ç—è–≥–Ω–µ */
    border-radius:10px;
    display:block;
    margin:0 auto;
    background:#020617;
  }

  .pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:18px;font-size:13px;color:#9ca3af}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:60}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:70}
  .modal-inner{width:100%;max-width:640px;background:#020617;border-radius:16px;border:1px solid #1f2933;padding:18px 18px 16px;box-shadow:0 18px 40px rgba(0,0,0,.75)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .modal-header h2{margin:0;font-size:18px}
  .modal-close{border:none;background:transparent;color:#9ca3af;font-size:18px;cursor:pointer}
  .form-row{margin-bottom:12px}
  .form-row.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form-row .lbl{display:block;margin-bottom:4px;font-size:12px;color:#9ca3af}
  textarea.inp{resize:vertical;min-height:70px}
  .preview-wrap{display:flex;flex-direction:column;gap:6px}
  .cover-preview{border-radius:10px;overflow:hidden;border:1px solid:#111827;background:#020617;display:flex;align-items:center;justify-content:center;min-height:110px}
  .cover-preview img{max-width:100%;max-height:180px;display:block}
  .hint-small{margin-top:4px;font-size:11px;color:#6b7280}
  .footer-row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:4px}
  .status-text{font-size:13px}
  .btn{border-radius:999px;border:1px solid #1f2933;background:#020617;color:#e5e7eb;font-size:13px;padding:6px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:5px;text-decoration:none}
  .btn-primary{background:#4f46e5;border-color:#4f46e5;color:#f9fafb}
  .btn-secondary{background:#111827;border-color:#1f2933}
  .btn-ghost{background:transparent;border-color:#1f2933;color:#9ca3af}
  .btn-danger-outline{background:transparent;border-color:#ef4444;color:#fca5a5}
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:scale(.98)}
  @media (max-width:900px){
    .market-layout{grid-template-columns:1fr}
    .market-topbar{flex-direction:column}
    .market-topbar .right{justify-content:flex-start}
  }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  window.MARKET_MY_CONFIG = {
    apiList: "{{ url_for('market.api_my_items') }}",
    apiItem: "{{ url_for('market.api_item', item_id=0)[:-1] }}", // –±–∞–∑–æ–≤–∏–π —à–ª—è—Ö /api/item/
    apiDelete: "/api/item/",   // + id + "/delete"
    apiUpdate: "/api/item/",   // + id + "/update"
    pageSize: 24
  };
  // –ø—ñ–¥–∫–∞–∂–µ market.js, —â–æ —Ü–µ "my"-—Å—Ç–æ—Ä—ñ–Ω–∫–∞
  document.body.dataset.marketPage = "my";
</script>
<script type="module" src="{{ url_for('static', filename='market/js/market.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/market_listeners.js') }}"></script>
{% endblock %}
