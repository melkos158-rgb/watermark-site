{% extends "base.html" %}
{% block title %}–ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è ‚Äî STL Market{% endblock %}

{% block content %}
<div class="wrap">
  <header>
    <div class="brand">üß© STL Market ‚Äî –ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>

    <div class="search-box" style="opacity:.85">
      <input id="q" placeholder="–ü–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ/—Ç–µ–≥–∞—Ö —Å–µ—Ä–µ–¥ –º–æ—ó—Ö‚Ä¶" />
      <button class="btn" id="btnSearch">üîç</button>
      <div id="search-suggest" class="suggest-box" style="display:none;"></div>
    </div>

    <div class="toolbar">
      <a href="/market" class="btn">‚Üê –ù–∞ —Ä–∏–Ω–æ–∫</a>
      <a href="{{ url_for('market.page_upload') }}" class="btn primary">+ –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å</a>
    </div>
  </header>

  <div class="profile-summary">
    <img src="{{ g.user.avatar or url_for('static', filename='img/avatar_default.png') }}" alt="Avatar" class="avatar">
    <div>
      <h2>{{ g.user.username or '–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å' }}</h2>
      <p class="muted">–†—ñ–≤–µ–Ω—å: <strong>{{ g.user.level or 1 }}</strong> ‚Ä¢ PXP: {{ g.user.pxp or 0 }}</p>
    </div>
  </div>

  <div class="controls">
    <label>–°–æ—Ä—Ç—É–≤–∞—Ç–∏:
      <select id="sort">
        <option value="new">–ù–æ–≤—ñ</option>
        <option value="price_asc">–¶—ñ–Ω–∞ ‚Üë</option>
        <option value="price_desc">–¶—ñ–Ω–∞ ‚Üì</option>
      </select>
    </label>
  </div>

  <div id="notice" class="notice" style="display:none"></div>

  <div id="grid" class="grid"></div>
  <div id="sentinel" class="sentinel"></div>
</div>

<style>
  :root {
    --bg:#0f1116; --card:#141923; --muted:#8792a7;
    --line:#232a3a; --text:#e7ebf4; --accent:#3b82f6; --danger:#ef4444;
  }
  .wrap{max-width:1280px;margin:0 auto;padding:16px;}
  header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;}
  .brand{font-weight:800;font-size:18px;letter-spacing:.3px;}
  .search-box{flex:1;display:flex;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:6px;position:relative;}
  .search-box input{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;outline:none;}
  .toolbar{display:flex;gap:8px}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .15s;}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
  .btn:hover{background:var(--accent);color:#fff;}
  .btn:active{transform:scale(.98);}
  .btn.danger{border-color:var(--danger); color:#fff; background:var(--danger);}
  .btn.ghost{opacity:.85}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;}
  select{background:var(--card);border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px 10px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px;}
  .item{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;transition:transform .15s, box-shadow .15s;}
  .item:hover{transform:translateY(-2px);box-shadow:0 0 15px rgba(59,130,246,.15);}
  .thumb{width:100%;aspect-ratio:4/3;object-fit:cover;border-bottom:1px solid var(--line);}
  .meta{padding:10px;display:flex;flex-direction:column;gap:4px;}
  .title{font-weight:700;}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 6px;border-radius:999px;color:var(--muted);}
  .muted{color:var(--muted);font-size:13px;}
  .price{font-weight:700;}
  .actions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
  .empty{text-align:center;color:var(--muted);padding:20px;}
  .notice{margin:8px 0;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);}
  .sentinel{height:1px}
  @media(max-width:700px){
    header{flex-direction:column;align-items:stretch;}
    .search-box{flex:none;}
    .toolbar{justify-content:space-between}
  }

  .profile-summary{
    display:flex;
    align-items:center;
    gap:12px;
    margin:12px 0 16px 0;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 14px;
  }
  .avatar{
    width:56px;height:56px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid var(--line);
  }

  .suggest-box{
    position:absolute;
    top:110%;
    left:0;
    right:0;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:8px;
    overflow:hidden;
    z-index:10;
  }
  .suggest-item{
    padding:6px 10px;
    color:var(--text);
    cursor:pointer;
    transition:background .15s;
  }
  .suggest-item:hover{
    background:var(--accent);
    color:#fff;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const q = document.getElementById('q');
  const suggest = document.getElementById('search-suggest');
  let timer;
  q.addEventListener('input', ()=>{
    clearTimeout(timer);
    const val = q.value.trim();
    if(!val){ suggest.style.display='none'; return; }
    timer = setTimeout(async ()=>{
      const r = await fetch(`/api/search_suggest?q=${encodeURIComponent(val)}&owner=me`);
      if(!r.ok) return;
      const arr = await r.json().catch(()=>[]);
      if(!Array.isArray(arr) || !arr.length){ suggest.style.display='none'; return; }
      suggest.innerHTML = arr.map(x=>`<div class='suggest-item'>${x}</div>`).join('');
      suggest.style.display='block';
    }, 300);
  });
  suggest.addEventListener('click', e=>{
    if(e.target.classList.contains('suggest-item')){
      q.value = e.target.textContent.trim();
      suggest.style.display='none';
      document.getElementById('btnSearch').click();
    }
  });
});
</script>

<script type="module">
// (–æ—Å–Ω–æ–≤–Ω–∏–π JS —è–∫ —É —Ç–µ–±–µ ‚Äî –Ω–µ –∑–º—ñ–Ω—é–≤–∞–≤)
{{ super() }}
</script>
{% endblock %}
