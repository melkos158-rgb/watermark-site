{% extends "base.html" %}

{% block title %}–ú–µ–Ω–µ–¥–∂–µ—Ä –ª—ñ—Ü–µ–Ω–∑—ñ–π ‚Äî Proofly STL{% endblock %}

{% block content %}
<style>
  .lic-wrap{
    max-width:1200px;
    margin:24px auto 40px;
    padding:0 12px;
  }
  .lic-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:18px;
  }
  .lic-title{
    font-size:22px;
    font-weight:600;
  }
  .lic-sub{
    font-size:13px;
    opacity:.8;
    margin-top:4px;
  }
  .lic-badges{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:8px;
  }
  .lic-badge{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #1f2937;
    background:#020617;
    opacity:.85;
  }

  .lic-layout{
    display:grid;
    grid-template-columns:minmax(0,1.2fr) minmax(0,1.4fr);
    gap:16px;
    align-items:start;
  }
  @media(max-width:1100px){
    .lic-layout{
      grid-template-columns:1fr;
    }
  }

  .lic-card{
    background:#0f1117;
    border:1px solid #242735;
    border-radius:12px;
    padding:14px 16px;
  }
  .lic-card h2{
    margin:0 0 10px 0;
    font-size:18px;
  }
  .lic-card h3{
    margin:12px 0 6px;
    font-size:15px;
  }
  .lic-help{
    font-size:12px;
    opacity:.8;
    margin-top:4px;
  }

  .lic-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    margin-bottom:8px;
  }

  .lic-input,
  .lic-select,
  .lic-textarea{
    background:#050712;
    border:1px solid #252a3a;
    border-radius:8px;
    padding:6px 10px;
    color:#e2e8f0;
    font-size:13px;
    width:100%;
    box-sizing:border-box;
  }
  .lic-select{
    border-radius:999px;
    padding:4px 10px;
    width:auto;
  }
  .lic-textarea{
    resize:vertical;
    min-height:80px;
  }
  .lic-search{
    flex:1 1 auto;
  }

  .lic-btn{
    border-radius:999px;
    border:1px solid #2563eb;
    background:#1d3a7f;
    padding:6px 14px;
    font-size:13px;
    cursor:pointer;
    color:#e5f0ff;
    display:inline-flex;
    align-items:center;
    gap:4px;
    transition:background .12s,border-color .12s,transform .06s;
  }
  .lic-btn.secondary{
    border-color:#374151;
    background:#111827;
    color:#e5e7eb;
  }
  .lic-btn.danger{
    border-color:#b91c1c;
    background:#7f1d1d;
  }
  .lic-btn:active{
    transform:translateY(1px);
  }
  .lic-btn:disabled{
    opacity:.6;
    cursor:default;
  }

  .lic-list{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    max-height:460px;
    overflow:auto;
  }
  .lic-item{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #1f2937;
    background:#020617;
    display:grid;
    grid-template-columns:minmax(0,1.5fr) minmax(0,1.2fr) auto;
    gap:8px;
    align-items:center;
    cursor:pointer;
    transition:border-color .12s,background .12s,transform .06s;
  }
  .lic-item:hover{
    border-color:#2563eb;
    background:#020817;
  }
  .lic-item.active{
    border-color:#22c55e;
    background:#022c22;
  }
  .lic-item-name{
    font-size:14px;
    font-weight:500;
  }
  .lic-item-meta{
    font-size:11px;
    opacity:.85;
  }
  .lic-item-tags{
    font-size:11px;
    opacity:.8;
  }
  .lic-item-actions{
    display:flex;
    gap:6px;
    justify-content:flex-end;
  }
  .lic-tag-pill{
    display:inline-flex;
    align-items:center;
    padding:1px 6px;
    border-radius:999px;
    border:1px solid #1f2937;
    margin-right:4px;
  }

  .lic-grid{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:8px;
  }
  @media(max-width:800px){
    .lic-grid{
      grid-template-columns:1fr;
    }
  }
  .lic-field label{
    display:block;
    font-size:12px;
    opacity:.9;
    margin-bottom:3px;
  }

  .lic-switch-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
  }
  .lic-switch{
    display:flex;
    align-items:center;
    gap:4px;
    font-size:12px;
    background:#020617;
    border-radius:999px;
    padding:3px 8px;
    border:1px solid #1f2937;
  }
  .lic-switch input{
    margin:0;
  }

  .lic-status{
    font-size:12px;
    opacity:.8;
    margin-top:6px;
  }

  .lic-preview{
    font-size:13px;
    background:#020617;
    border-radius:8px;
    padding:10px;
    border:1px dashed #1f2937;
    margin-top:8px;
  }
  .lic-preview h4{
    margin:0 0 6px 0;
    font-size:14px;
  }
  .lic-preview ul{
    padding-left:18px;
    margin:4px 0;
    font-size:12px;
  }
  .lic-preview-code{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:11px;
    opacity:.9;
    background:#020617;
    padding:3px 6px;
    border-radius:999px;
    border:1px solid #1f2937;
  }
</style>

<div class="lic-wrap">
  <header class="lic-header">
    <div>
      <div class="lic-title">–ú–µ–Ω–µ–¥–∂–µ—Ä –ª—ñ—Ü–µ–Ω–∑—ñ–π STL/3D</div>
      <div class="lic-sub">
        –°—Ç–≤–æ—Ä—é–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω—ñ –ª—ñ—Ü–µ–Ω–∑—ñ—ó –¥–ª—è STL-—Ñ–∞–π–ª—ñ–≤: –æ—Å–æ–±–∏—Å—Ç–µ/–∫–æ–º–µ—Ä—Ü—ñ–π–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è,
        —Ä–µ–º—ñ–∫—Å–∏, –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂ –¥—Ä—É–∫—ñ–≤ —Ç–æ—â–æ. –î–∞–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑–º–æ–∂—É—Ç—å –ª–µ–≥–∫–æ –≤–∏–±–∏—Ä–∞—Ç–∏
        –ª—ñ—Ü–µ–Ω–∑—ñ—é –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –º–æ–¥–µ–ª—ñ ‚Äî —è–∫ –Ω–∞ Cults / Printables, —Ç—ñ–ª—å–∫–∏ –±—ñ–ª—å—à —Ä–æ–∑—É–º–Ω–æ.
      </div>
      <div class="lic-badges">
        <div class="lic-badge">üìú Proofly License</div>
        <div class="lic-badge">üßë‚Äçüé® –ê–≤—Ç–æ—Ä—Å—å–∫—ñ –ø—Ä–∞–≤–∞</div>
        <div class="lic-badge">üí∞ –ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ –¥—Ä—É–∫–∏</div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
      <button id="lic-btn-new" class="lic-btn">Ôºã –ù–æ–≤–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è</button>
      <div class="lic-help" style="max-width:220px;text-align:right;">
        –ê–∫—Ç–∏–≤–Ω–∞ ¬´–¥–µ—Ñ–æ–ª—Ç–Ω–∞¬ª –ª—ñ—Ü–µ–Ω–∑—ñ—è –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏—Å—è –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –Ω–æ–≤–∏—Ö STL.
      </div>
    </div>
  </header>

  <div class="lic-layout">
    <!-- –õ–Ü–í–ê –ö–û–õ–û–ù–ö–ê: —Å–ø–∏—Å–æ–∫ -->
    <section class="lic-card">
      <h2>–õ—ñ—Ü–µ–Ω–∑—ñ—ó –º–∞—Ä–∫–µ—Ç—É</h2>
      <div class="lic-row">
        <input id="lic-search" class="lic-input lic-search" type="text" placeholder="–ü–æ—à—É–∫: Proofly personal, Proofly commercial, CC‚Ä¶">
        <select id="lic-filter-type" class="lic-select">
          <option value="">–¢–∏–ø: –≤—Å—ñ</option>
          <option value="proofly">Proofly</option>
          <option value="cc">Creative Commons</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div id="lic-list" class="lic-list"></div>
      <div id="lic-list-empty" class="lic-help" style="margin-top:8px;display:none;">
        –ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó. –°—Ç–≤–æ—Ä–∏ —Ö–æ—á–∞ –±:
        <strong>Proofly Personal</strong> —Ç–∞ <strong>Proofly Commercial</strong>.
      </div>
    </section>

    <!-- –ü–†–ê–í–ê –ö–û–õ–û–ù–ö–ê: —Ñ–æ—Ä–º–∞ + –ø—Ä–µ–≤ º—é -->
    <section class="lic-card">
      <h2 id="lic-form-title">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—ó</h2>
      <div class="lic-help">
        –ù–∞–∑–≤–∞ –π –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –ø–æ—Ä—É—á –∑ –º–æ–¥–µ–ª–ª—é. –î–µ—Ç–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç ‚Äî –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ª—ñ—Ü–µ–Ω–∑—ñ—ó.
      </div>

      <form id="lic-form" autocomplete="off" style="margin-top:10px;">
        <input type="hidden" id="lic-id">

        <div class="lic-grid">
          <div class="lic-field">
            <label>–ù–∞–∑–≤–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—ó</label>
            <input id="lic-name" class="lic-input" placeholder="Proofly Personal, Proofly Commercial, CC-BY-NC‚Ä¶">
          </div>
          <div class="lic-field">
            <label>–ö–æ–¥ / —Å–ª–∞–≥</label>
            <input id="lic-code" class="lic-input" placeholder="proofly-personal, proofly-commercial‚Ä¶">
            <div class="lic-help">–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É URL —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö –ø–æ—Å–∏–ª–∞–Ω–Ω—è—Ö.</div>
          </div>
        </div>

        <div class="lic-grid">
          <div class="lic-field">
            <label>–¢–∏–ø –ª—ñ—Ü–µ–Ω–∑—ñ—ó</label>
            <select id="lic-type" class="lic-input">
              <option value="proofly">Proofly (–≤–ª–∞—Å–Ω–∏–π —à–∞–±–ª–æ–Ω)</option>
              <option value="cc">Creative Commons</option>
              <option value="custom">Custom / —ñ–Ω—à—ñ</option>
            </select>
          </div>
          <div class="lic-field">
            <label>–ö–æ—Ä–æ—Ç–∫–∏–π –ø—ñ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input id="lic-short" class="lic-input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Personal use only / –ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ –¥—Ä—É–∫–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ‚Ä¶">
          </div>
        </div>

        <div class="lic-field" style="margin-top:6px;">
          <label>–ü—É–±–ª—ñ—á–Ω–∏–π –æ–ø–∏—Å (–∫–æ—Ä–æ—Ç–∫–æ)</label>
          <textarea id="lic-summary" class="lic-textarea" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–æ, –ª—é–¥—Å—å–∫–æ—é –º–æ–≤–æ—é, —â–æ –º–æ–∂–Ω–∞ –π —â–æ –Ω–µ –º–æ–∂–Ω–∞ —Ä–æ–±–∏—Ç–∏ –∑ –º–æ–¥–µ–ª–ª—é."></textarea>
        </div>

        <h3>–ü—Ä–∞–≤–∞ –π –æ–±–º–µ–∂–µ–Ω–Ω—è</h3>
        <div class="lic-switch-row">
          <label class="lic-switch">
            <input id="lic-allow-print" type="checkbox" checked>
            <span>‚úÖ –î–æ–∑–≤–æ–ª–µ–Ω–æ –¥—Ä—É–∫—É–≤–∞—Ç–∏ –¥–ª—è –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</span>
          </label>
          <label class="lic-switch">
            <input id="lic-allow-commercial" type="checkbox">
            <span>üí∞ –î–æ–∑–≤–æ–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç–∏ –Ω–∞–¥—Ä—É–∫–æ–≤–∞–Ω—ñ –º–æ–¥–µ–ª—ñ</span>
          </label>
          <label class="lic-switch">
            <input id="lic-allow-remix" type="checkbox">
            <span>üß© –î–æ–∑–≤–æ–ª–µ–Ω–æ —Ä–µ–º—ñ–∫—Å–∏ / –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó</span>
          </label>
          <label class="lic-switch">
            <input id="lic-allow-redistribute" type="checkbox">
            <span>üåê –î–æ–∑–≤–æ–ª–µ–Ω–æ –ø–æ—à–∏—Ä–µ–Ω–Ω—è STL (share)</span>
          </label>
        </div>

        <div class="lic-switch-row" style="margin-top:6px;">
          <label class="lic-switch">
            <input id="lic-require-attrib" type="checkbox" checked>
            <span>üñã –û–±–æ–≤ º—è–∑–∫–æ–≤–æ –≤–∫–∞–∑—É–≤–∞—Ç–∏ –∞–≤—Ç–æ—Ä–∞</span>
          </label>
          <label class="lic-switch">
            <input id="lic-require-linkback" type="checkbox" checked>
            <span>üîó –õ—ñ–Ω–∫ –Ω–∞ Proofly / –∞–≤—Ç–æ—Ä–∞</span>
          </label>
          <label class="lic-switch">
            <input id="lic-share-alike" type="checkbox">
            <span>‚ôª –†–µ–º—ñ–∫—Å–∏ ‚Äî –ø—ñ–¥ —Ç—ñ—î—é –∂ –ª—ñ—Ü–µ–Ω–∑—ñ—î—é</span>
          </label>
        </div>

        <div class="lic-grid" style="margin-top:8px;">
          <div class="lic-field">
            <label>–ú–∞–∫—Å. –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–º–µ—Ä—Ü—ñ–π–Ω–∏—Ö –¥—Ä—É–∫—ñ–≤ (0 = –±–µ–∑ –ª—ñ–º—ñ—Ç—É)</label>
            <input id="lic-max-prints" class="lic-input" type="number" min="0" step="1" placeholder="0">
          </div>
          <div class="lic-field">
            <label>–Æ—Ä–∏—Å–¥–∏–∫—Ü—ñ—è / —Ä–µ–≥—ñ–æ–Ω (–æ–ø—Ü—ñ–π–Ω–æ)</label>
            <input id="lic-region" class="lic-input" placeholder="Worldwide, EU, US, UA‚Ä¶">
          </div>
        </div>

        <h3>–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç (legal)</h3>
        <div class="lic-field">
          <label>–î–µ—Ç–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç –ª—ñ—Ü–µ–Ω–∑—ñ—ó</label>
          <textarea id="lic-body" class="lic-textarea" rows="6" placeholder="–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç –ª—ñ—Ü–µ–Ω–∑—ñ—ó, —è–∫–∏–π –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π –Ω–∞ –æ–∫—Ä–µ–º—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ. –ú–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º, —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç CC —ñ –º–∏ –¥–∞—î–º–æ –ª—ñ–Ω–∫."></textarea>
          <div class="lic-help">
            –î–ª—è Creative Commons –º–æ–∂–Ω–∞ –≤–∫–∞–∑–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–æ (CC BY-NC-SA 4.0) —Ç–∞ –¥–æ–¥–∞—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π –ª—ñ–Ω–∫.
          </div>
        </div>

        <div class="lic-row" style="justify-content:space-between;margin-top:12px;">
          <div>
            <button type="button" id="lic-btn-save" class="lic-btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button type="button" id="lic-btn-duplicate" class="lic-btn secondary">‚ßâ –î—É–±–ª—é–≤–∞—Ç–∏</button>
          </div>
          <div>
            <button type="button" id="lic-btn-set-default" class="lic-btn secondary">‚≠ê –ó—Ä–æ–±–∏—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ—é</button>
            <button type="button" id="lic-btn-delete" class="lic-btn danger">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
          </div>
        </div>

        <div id="lic-status" class="lic-status"></div>

        <div class="lic-preview" id="lic-preview">
          <h4>–ü—Ä–µ–≤ º—é –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –º–æ–¥–µ–ª—ñ</h4>
          <div style="margin-bottom:4px;">
            <span id="lic-preview-name" style="font-weight:600;">(–Ω–∞–∑–≤–∞)</span>
            <span id="lic-preview-code" class="lic-preview-code" style="margin-left:6px;">code</span>
          </div>
          <div id="lic-preview-short" style="font-size:12px;opacity:.9;margin-bottom:4px;">
            (–∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å)
          </div>
          <ul id="lic-preview-list"></ul>
        </div>
      </form>
    </section>
  </div>
</div>

<script type="module">
  const $ = (id) => document.getElementById(id);

  const listEl = $("lic-list");
  const listEmptyEl = $("lic-list-empty");
  const searchEl = $("lic-search");
  const filterTypeEl = $("lic-filter-type");

  const form = $("lic-form");
  const formTitleEl = $("lic-form-title");

  const fId = $("lic-id");
  const fName = $("lic-name");
  const fCode = $("lic-code");
  const fType = $("lic-type");
  const fShort = $("lic-short");
  const fSummary = $("lic-summary");
  const fAllowPrint = $("lic-allow-print");
  const fAllowCommercial = $("lic-allow-commercial");
  const fAllowRemix = $("lic-allow-remix");
  const fAllowRedistribute = $("lic-allow-redistribute");
  const fRequireAttrib = $("lic-require-attrib");
  const fRequireLinkback = $("lic-require-linkback");
  const fShareAlike = $("lic-share-alike");
  const fMaxPrints = $("lic-max-prints");
  const fRegion = $("lic-region");
  const fBody = $("lic-body");

  const btnNew = $("lic-btn-new");
  const btnSave = $("lic-btn-save");
  const btnDuplicate = $("lic-btn-duplicate");
  const btnDelete = $("lic-btn-delete");
  const btnSetDefault = $("lic-btn-set-default");

  const statusEl = $("lic-status");

  const prevName = $("lic-preview-name");
  const prevCode = $("lic-preview-code");
  const prevShort = $("lic-preview-short");
  const prevList = $("lic-preview-list");

  let allLicenses = [];
  let defaultLicenseId = null;
  let currentSelectedId = null;
  let isLoading = false;

  function escapeHtml(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  function setStatus(msg, kind = "info") {
    if (!statusEl) return;
    const color =
      kind === "error" ? "#f97373" :
      kind === "success" ? "#4ade80" :
      "#e5e7eb";
    statusEl.textContent = msg || "";
    statusEl.style.color = color;
  }

  function apiFetch(url, options = {}) {
    const opts = {
      headers:{
        "Content-Type":"application/json",
        ...(options.headers || {})
      },
      credentials:"same-origin",
      ...options
    };
    return fetch(url, opts).then(async (res) => {
      let data;
      try{
        data = await res.json();
      }catch(e){
        throw new Error("Invalid JSON from server");
      }
      if(!res.ok || data.ok === false){
        const msg = (data && data.error) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    });
  }

  function toNumber(val) {
    if(val === "" || val == null) return null;
    const n = Number(val);
    return Number.isFinite(n) ? n : null;
  }

  function clearForm() {
    if(formTitleEl) formTitleEl.textContent = "–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—ó";
    fId.value = "";
    fName.value = "";
    fCode.value = "";
    fType.value = "proofly";
    fShort.value = "";
    fSummary.value = "";
    fAllowPrint.checked = true;
    fAllowCommercial.checked = false;
    fAllowRemix.checked = false;
    fAllowRedistribute.checked = false;
    fRequireAttrib.checked = true;
    fRequireLinkback.checked = true;
    fShareAlike.checked = false;
    fMaxPrints.value = "";
    fRegion.value = "";
    fBody.value = "";
    currentSelectedId = null;
    updatePreview();
  }

  function fillForm(lic) {
    if(!lic) return;
    if(formTitleEl) formTitleEl.textContent = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: " + (lic.name || "–ª—ñ—Ü–µ–Ω–∑—ñ—è");

    fId.value = lic.id ?? "";
    fName.value = lic.name || "";
    fCode.value = lic.code || "";
    fType.value = lic.type || "proofly";
    fShort.value = lic.short_title || "";
    fSummary.value = lic.summary || "";

    fAllowPrint.checked = !!lic.allow_print;
    fAllowCommercial.checked = !!lic.allow_commercial;
    fAllowRemix.checked = !!lic.allow_remix;
    fAllowRedistribute.checked = !!lic.allow_redistribute;

    fRequireAttrib.checked = lic.require_attribution !== false;
    fRequireLinkback.checked = lic.require_linkback !== false;
    fShareAlike.checked = !!lic.share_alike;

    fMaxPrints.value = lic.max_prints != null ? String(lic.max_prints) : "";
    fRegion.value = lic.region || "";
    fBody.value = lic.body || "";

    updatePreview();
  }

  function formToObject() {
    return {
      id: fId.value || null,
      name: fName.value.trim(),
      code: fCode.value.trim(),
      type: fType.value || "proofly",
      short_title: fShort.value.trim(),
      summary: fSummary.value.trim(),
      allow_print: !!fAllowPrint.checked,
      allow_commercial: !!fAllowCommercial.checked,
      allow_remix: !!fAllowRemix.checked,
      allow_redistribute: !!fAllowRedistribute.checked,
      require_attribution: !!fRequireAttrib.checked,
      require_linkback: !!fRequireLinkback.checked,
      share_alike: !!fShareAlike.checked,
      max_prints: toNumber(fMaxPrints.value),
      region: fRegion.value.trim() || null,
      body: fBody.value.trim() || null
    };
  }

  function updatePreview() {
    const lic = formToObject();
    prevName.textContent = lic.name || "(–Ω–∞–∑–≤–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—ó)";
    prevCode.textContent = lic.code || "code";

    prevShort.textContent =
      lic.short_title ||
      lic.summary ||
      "–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Ç–æ–≥–æ, —â–æ –º–æ–∂–Ω–∞ –π —â–æ –Ω–µ –º–æ–∂–Ω–∞ —Ä–æ–±–∏—Ç–∏ –∑ –º–æ–¥–µ–ª–ª—é.";

    const bullets = [];

    if(lic.allow_print){
      bullets.push("–î–æ–∑–≤–æ–ª–µ–Ω–æ –¥—Ä—É–∫ –¥–ª—è –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.");
    }else{
      bullets.push("–î—Ä—É–∫ –¥–ª—è –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π (–¥—É–∂–µ –∂–æ—Ä—Å—Ç–∫–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è).");
    }

    if(lic.allow_commercial){
      if(lic.max_prints && lic.max_prints > 0){
        bullets.push(`–î–æ–∑–≤–æ–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç–∏ –¥–æ ${lic.max_prints} –∫–æ–º–µ—Ä—Ü—ñ–π–Ω–∏—Ö –¥—Ä—É–∫—ñ–≤ –∑ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–¥–±–∞–Ω–Ω—è.`);
      }else{
        bullets.push("–î–æ–∑–≤–æ–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç–∏ –Ω–∞–¥—Ä—É–∫–æ–≤–∞–Ω—ñ –º–æ–¥–µ–ª—ñ (–±–µ–∑ –ª—ñ–º—ñ—Ç—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ).");
      }
    }else{
      bullets.push("–ü—Ä–æ–¥–∞–∂ –Ω–∞–¥—Ä—É–∫–æ–≤–∞–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π (—Ç—ñ–ª—å–∫–∏ non-commercial).");
    }

    if(lic.allow_remix){
      bullets.push("–î–æ–∑–≤–æ–ª–µ–Ω–æ —Ä–µ–º—ñ–∫—Å–∏ —Ç–∞ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –º–æ–¥–µ–ª—ñ.");
      if(lic.share_alike){
        bullets.push("–†–µ–º—ñ–∫—Å–∏ –º–∞—é—Ç—å –ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏—Å—è –ø—ñ–¥ —Ç—ñ—î—é –∂ –ª—ñ—Ü–µ–Ω–∑—ñ—î—é (share-alike).");
      }
    }else{
      bullets.push("–†–µ–º—ñ–∫—Å–∏ —Ç–∞ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –º–æ–¥–µ–ª—ñ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ.");
    }

    if(lic.allow_redistribute){
      bullets.push("–î–æ–∑–≤–æ–ª–µ–Ω–æ –ø–æ—à–∏—Ä—é–≤–∞—Ç–∏ STL-—Ñ–∞–π–ª (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —É–º–æ–≤ –ª—ñ—Ü–µ–Ω–∑—ñ—ó).");
    }else{
      bullets.push("–ü–æ—à–∏—Ä–µ–Ω–Ω—è STL-—Ñ–∞–π–ª—É –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ (—Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ Proofly).");
    }

    if(lic.require_attribution){
      bullets.push("–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑—É–≤–∞—Ç–∏ –∞–≤—Ç–æ—Ä–∞ –º–æ–¥–µ–ª—ñ —É –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è—Ö / –æ–ø–∏—Å–∞—Ö.");
    }else{
      bullets.push("–í–∫–∞–∑—É–≤–∞—Ç–∏ –∞–≤—Ç–æ—Ä–∞ –Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ (attribution –Ω–µ required).");
    }

    if(lic.require_linkback){
      bullets.push("–ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ª–∏—à–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ Proofly / —Å—Ç–æ—Ä—ñ–Ω–∫—É –º–æ–¥–µ–ª—ñ.");
    }

    if(lic.region){
      bullets.push("–Æ—Ä–∏—Å–¥–∏–∫—Ü—ñ—è / —Ä–µ–≥—ñ–æ–Ω: " + lic.region + ".");
    }

    prevList.innerHTML = bullets.map(b => `<li>${escapeHtml(b)}</li>`).join("");
  }

  function renderList() {
    const q = (searchEl && searchEl.value.trim().toLowerCase()) || "";
    const typeFilter = filterTypeEl && filterTypeEl.value || "";

    const filtered = allLicenses.filter((lic) => {
      const hay = (
        (lic.name || "") +
        " " + (lic.code || "") +
        " " + (lic.summary || "") +
        " " + (lic.type || "")
      ).toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(typeFilter && lic.type !== typeFilter) return false;
      return true;
    });

    listEl.innerHTML = "";
    if(filtered.length === 0){
      if(listEmptyEl) listEmptyEl.style.display = "block";
      return;
    }
    if(listEmptyEl) listEmptyEl.style.display = "none";

    filtered.forEach((lic) => {
      const item = document.createElement("div");
      item.className = "lic-item";
      if(lic.id === defaultLicenseId){
        item.classList.add("active");
      }

      const typeLabel =
        lic.type === "proofly" ? "Proofly" :
        lic.type === "cc" ? "Creative Commons" :
        "Custom";

      const tags = [];
      if(lic.allow_commercial) tags.push("Commercial OK");
      if(lic.allow_remix) tags.push("Remix OK");
      if(lic.allow_redistribute) tags.push("Redistribute STL");
      if(lic.share_alike) tags.push("Share-alike");
      if(lic.max_prints && lic.max_prints > 0) tags.push(`‚â§${lic.max_prints} prints`);

      item.innerHTML = `
        <div>
          <div class="lic-item-name">${escapeHtml(lic.name || "(–±–µ–∑ –Ω–∞–∑–≤–∏)")}</div>
          <div class="lic-item-meta">
            ${escapeHtml(lic.code || "")}
            ¬∑ ${escapeHtml(typeLabel)}
          </div>
        </div>
        <div class="lic-item-tags">
          ${
            tags.length
              ? tags.map(t => `<span class="lic-tag-pill">${escapeHtml(t)}</span>`).join("")
              : '<span style="opacity:.7;">–ë–µ–∑ –º–∞—Ä–∫–µ—Ä—ñ–≤</span>'
          }
        </div>
        <div class="lic-item-actions">
          ${
            lic.id === defaultLicenseId
              ? '<span style="font-size:11px;opacity:.9;">–î–µ—Ñ–æ–ª—Ç–Ω–∞</span>'
              : '<button type="button" class="lic-btn secondary lic-btn-set-default" data-id="' +
                String(lic.id) + '">‚≠ê –î–µ—Ñ–æ–ª—Ç</button>'
          }
        </div>
      `;

      item.addEventListener("click", (ev) => {
        const target = ev.target;
        if(target && target.classList && target.classList.contains("lic-btn-set-default")){
          const id = target.getAttribute("data-id");
          if(id) setDefaultLicense(id);
          ev.stopPropagation();
          return;
        }

        currentSelectedId = lic.id;
        fillForm(lic);
        renderList();
      });

      listEl.appendChild(item);
    });
  }

  function loadAll() {
    isLoading = true;
    setStatus("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ–π‚Ä¶");
    return apiFetch("/api/licenses")
      .then((data) => {
        allLicenses = data.items || [];
        defaultLicenseId = data.default_id || null;
        renderList();
        if(!allLicenses.length){
          setStatus("–î–æ–¥–∞–π –ø–µ—Ä—à—É –ª—ñ—Ü–µ–Ω–∑—ñ—é –¥–ª—è STL-–º–∞—Ä–∫–µ—Ç—É.", "info");
        }else{
          setStatus(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –ª—ñ—Ü–µ–Ω–∑—ñ–π: ${allLicenses.length}`, "success");
        }
      })
      .catch((err) => {
        console.error(err);
        setStatus(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${err.message}`, "error");
      })
      .finally(() => {
        isLoading = false;
      });
  }

  function saveLicense() {
    if(isLoading) return;
    const lic = formToObject();

    if(!lic.name){
      setStatus("–í–∫–∞–∂–∏ –Ω–∞–∑–≤—É –ª—ñ—Ü–µ–Ω–∑—ñ—ó.", "error");
      fName.focus();
      return;
    }
    if(!lic.code){
      setStatus("–í–∫–∞–∂–∏ –∫–æ–¥ / —Å–ª–∞–≥ –ª—ñ—Ü–µ–Ω–∑—ñ—ó.", "error");
      fCode.focus();
      return;
    }

    const hasId = !!lic.id;
    const url = hasId ? `/api/licenses/${encodeURIComponent(lic.id)}` : "/api/licenses";
    const method = hasId ? "PUT" : "POST";

    isLoading = true;
    setStatus(hasId ? "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ—ó‚Ä¶" : "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó‚Ä¶");

    apiFetch(url, {
      method,
      body: JSON.stringify(lic)
    })
      .then((data) => {
        const saved = data.item;
        const defId = data.default_id ?? defaultLicenseId;
        defaultLicenseId = defId;

        const idx = allLicenses.findIndex(l => String(l.id) === String(saved.id));
        if(idx >= 0){
          allLicenses[idx] = saved;
        }else{
          allLicenses.push(saved);
        }

        currentSelectedId = saved.id;
        fillForm(saved);
        renderList();

        setStatus(hasId ? "–õ—ñ—Ü–µ–Ω–∑—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–æ." : "–õ—ñ—Ü–µ–Ω–∑—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ.", "success");
      })
      .catch((err) => {
        console.error(err);
        setStatus(`–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${err.message}`, "error");
      })
      .finally(() => {
        isLoading = false;
      });
  }

  function deleteLicense() {
    const id = fId.value;
    if(!id){
      setStatus("–ù–µ–º–∞—î —â–æ –≤–∏–¥–∞–ª—è—Ç–∏ ‚Äî –ª—ñ—Ü–µ–Ω–∑—ñ—è —â–µ –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–∞.", "error");
      return;
    }
    if(!window.confirm("–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ª—ñ—Ü–µ–Ω–∑—ñ—é? –ú–æ–¥–µ–ª—ñ, —è–∫—ñ —ó—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å, –º–æ–∂—É—Ç—å –ø–æ—Ç—Ä–µ–±—É–≤–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.")){
      return;
    }

    isLoading = true;
    setStatus("–í–∏–¥–∞–ª–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ—ó‚Ä¶");
    apiFetch(`/api/licenses/${encodeURIComponent(id)}`, {
      method:"DELETE"
    })
      .then((data) => {
        allLicenses = allLicenses.filter(l => String(l.id) !== String(id));
        if(defaultLicenseId && String(defaultLicenseId) === String(id)){
          defaultLicenseId = data.next_default_id || null;
        }
        clearForm();
        renderList();
        setStatus("–õ—ñ—Ü–µ–Ω–∑—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ.", "success");
      })
      .catch((err) => {
        console.error(err);
        setStatus(`–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ${err.message}`, "error");
      })
      .finally(() => {
        isLoading = false;
      });
  }

  function setDefaultLicense(id) {
    if(isLoading) return;
    isLoading = true;
    setStatus("–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó‚Ä¶");
    apiFetch(`/api/licenses/${encodeURIComponent(id)}/set_default`, {
      method:"POST",
      body: JSON.stringify({})
    })
      .then((data) => {
        defaultLicenseId = data.default_id || id;
        renderList();
        setStatus("–î–µ—Ñ–æ–ª—Ç–Ω–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–∞.", "success");
      })
      .catch((err) => {
        console.error(err);
        setStatus(`–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó: ${err.message}`, "error");
      })
      .finally(() => {
        isLoading = false;
      });
  }

  // ====== –ü–æ–¥—ñ—ó ======
  if(btnNew){
    btnNew.addEventListener("click", () => {
      clearForm();
      if(formTitleEl) formTitleEl.textContent = "–ù–æ–≤–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è";
      setStatus("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó.", "info");
    });
  }
  if(btnSave){
    btnSave.addEventListener("click", (ev) => {
      ev.preventDefault();
      saveLicense();
    });
  }
  if(btnDuplicate){
    btnDuplicate.addEventListener("click", (ev) => {
      ev.preventDefault();
      const lic = formToObject();
      fId.value = "";
      if(lic.name){
        fName.value = lic.name + " (–∫–æ–ø—ñ—è)";
      }
      if(formTitleEl) formTitleEl.textContent = "–ù–æ–≤–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è (–∫–æ–ø—ñ—è)";
      setStatus("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É —Ñ–æ—Ä–º—É. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ó–±–µ—Ä–µ–≥—Ç–∏¬ª, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –ª—ñ—Ü–µ–Ω–∑—ñ—é.", "info");
      updatePreview();
    });
  }
  if(btnDelete){
    btnDelete.addEventListener("click", (ev) => {
      ev.preventDefault();
      deleteLicense();
    });
  }
  if(btnSetDefault){
    btnSetDefault.addEventListener("click", (ev) => {
      ev.preventDefault();
      const id = fId.value;
      if(!id){
        setStatus("–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—é, –ø–æ—Ç—ñ–º –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ —ó—ó –¥–µ—Ñ–æ–ª—Ç–Ω–æ—é.", "error");
        return;
      }
      setDefaultLicense(id);
    });
  }

  if(searchEl){
    searchEl.addEventListener("input", () => {
      renderList();
    });
  }
  if(filterTypeEl){
    filterTypeEl.addEventListener("change", () => {
      renderList();
    });
  }

  // –ü—Ä–µ–≤ º—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
  [
    fName, fCode, fShort, fSummary, fAllowPrint, fAllowCommercial,
    fAllowRemix, fAllowRedistribute, fRequireAttrib, fRequireLinkback,
    fShareAlike, fMaxPrints, fRegion
  ].forEach((el) => {
    if(!el) return;
    el.addEventListener("input", updatePreview);
    el.addEventListener("change", updatePreview);
  });

  // –°—Ç–∞—Ä—Ç
  clearForm();
  loadAll();
</script>
{% endblock %}
