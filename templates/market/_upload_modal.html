<div id="upload-modal" class="modal" hidden>
  <div class="modal-box">
    <button class="modal-close" aria-label="Close" data-close>&times;</button>
    <h3>{{ _('–î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å') }}</h3>

        <form id="upload-form"
          action="#"
          method="post"
          enctype="multipart/form-data"
          novalidate
          data-upload-endpoint="/api/market/upload"
          data-draft-endpoint="/api/market/items/draft">
      <label>{{ _('–ù–∞–∑–≤–∞') }}
        <input type="text" name="title" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Flexi Dragon">
      </label>

      <label>{{ _('–û–ø–∏—Å') }}
        <textarea name="description" rows="4" placeholder="–û–ø–∏—à–∏ –º–æ–¥–µ–ª—å, –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ, –º–∞—Å—à—Ç–∞–± —Ç–æ—â–æ..."></textarea>
      </label>

      <label>{{ _('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è') }}
        <select name="category_slug">
          <option value="">{{ _('–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó') }}</option>
          {% for c in (g.market_categories or []) %}
            <option value="{{ c.slug }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label class="drop" id="fileDrop">
        {{ _('–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –º–æ–¥–µ–ª—ñ (STL/OBJ/GLTF/ZIP)') }}
        <input type="file" name="file" accept=".stl,.obj,.gltf,.glb,.zip" required>
      </label>

      <label class="drop">
        {{ _('–û–±–∫–ª–∞–¥–∏–Ω–∫–∞ (–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)') }}
        <input type="file" name="cover" accept="image/*">
      </label>

      <label class="drop">
        {{ _('–í—ñ–¥–µ–æ (mp4/webm/quicktime)') }}
        <input type="file" name="video" accept="video/mp4,video/webm,video/quicktime">
      </label>

      <div id="ai-tags" class="ai-tags muted"></div>

      <label class="row">
        <input type="checkbox" name="is_free" value="1" id="is_free" checked>
        <span>{{ _('–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ') }}</span>
      </label>

      <div class="row price-row" id="price_row" hidden>
        <label style="display:flex;gap:8px;align-items:center">
          <span>{{ _('–¶—ñ–Ω–∞ (—É —Ü–µ–Ω—Ç–∞—Ö)') }}</span>
          <input type="number" min="0" step="1" name="price_cents" placeholder="500">
        </label>
      </div>

      <div class="actions">
        <button class="btn" type="button" data-close>{{ _('–°–∫–∞—Å—É–≤–∞—Ç–∏') }}</button>
        <button class="btn primary" type="submit">{{ _('–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏') }}</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('upload-modal');
  const priceRow = document.getElementById('price_row');
  const isFree = document.getElementById('is_free');
  const aiTags = document.getElementById('ai-tags');
  const fileInput = document.querySelector('#fileDrop input[type="file"]');


  // Only manual close logic remains
  function close(){ modal.hidden = true; document.body.style.overflow = ''; }

  document.addEventListener('click', (e)=>{
    if (e.target.matches('[data-close]') || e.target.classList.contains('modal')) close();
  });

  if (isFree){
    const sync = ()=>{ priceRow.hidden = isFree.checked; };
    isFree.addEventListener('change', sync); sync();
  }

  // AI AutoTag ‚Äî –≥–µ–Ω–µ—Ä—É—î —Ç–µ–≥–∏ –∑ –Ω–∞–∑–≤–∏ –ø—Ä–∏ –≤–≤–æ–¥—ñ
  const titleInput = document.querySelector('input[name="title"]');
  let timer;
  if (titleInput && aiTags){
    titleInput.addEventListener('input', ()=>{
      clearTimeout(timer);
      const val = titleInput.value.trim();
      if(!val){ aiTags.innerHTML = ''; return; }
      aiTags.innerHTML = 'ü§ñ –ê–Ω–∞–ª—ñ–∑...';
      timer = setTimeout(async ()=>{
        try{
          const r = await fetch(`/api/autotag?q=${encodeURIComponent(val)}`);
          if(!r.ok) throw new Error('no');
          const arr = await r.json().catch(()=>[]);
          if(Array.isArray(arr) && arr.length){
            aiTags.innerHTML = 'AI-—Ç–µ–≥–∏: ' + arr.map(x=>`<span class="tag">${x}</span>`).join(' ');
          } else aiTags.innerHTML = '';
        }catch{ aiTags.innerHTML = ''; }
      }, 400);
    });
  }

  // Drag-and-drop —Å—Ç–∏–ª—å
  const drop = document.getElementById('fileDrop');
  if(drop){
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=>drop.classList.remove('drag'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('drag');
      if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
    });
  }
})();
</script>

<style>
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:block;z-index:1000}
.modal[hidden]{display:none}
.modal-box{
  width:min(680px, 92vw);
  margin:6vh auto;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  padding:16px;
  color:var(--text);
  position:relative;
  animation:pop .25s ease;
}
@keyframes pop{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
.modal-close{
  position:absolute; right:10px; top:8px;
  background:transparent; border:none; color:var(--text);
  font-size:22px; cursor:pointer;
}
label{display:flex;flex-direction:column;gap:6px;margin:8px 0}
input[type="text"], textarea, select, input[type="number"]{
  background:transparent; border:1px solid var(--line);
  color:var(--text); border-radius:10px; padding:8px 10px; outline:none;
  transition:border .15s, box-shadow .15s;
}
input:focus, textarea:focus, select:focus{
  border-color:var(--accent);
  box-shadow:0 0 10px rgba(59,130,246,.3);
}
.drop{
  border:1px dashed var(--line);
  border-radius:10px;
  padding:10px;
  transition:border .15s, background .15s;
}
.drop.drag{
  border-color:var(--accent);
  background:rgba(59,130,246,.1);
}
.row{display:flex;gap:8px;align-items:center}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{
  background:var(--card);border:1px solid var(--line);color:var(--text);
  padding:8px 12px;border-radius:10px;cursor:pointer;transition:all .15s;
}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn:hover{background:var(--accent);color:#fff;}
.ai-tags{margin-top:6px;font-size:13px;}
.ai-tags .tag{display:inline-block;margin-right:5px;padding:2px 6px;border-radius:6px;background:rgba(59,130,246,.15);color:var(--text);font-size:12px;}
</style>
