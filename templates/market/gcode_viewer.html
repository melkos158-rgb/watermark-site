{% extends "base.html" %}

{% block title %}G-code Viewer ‚Äî Proofly STL{% endblock %}

{% block content %}
<style>
  .gcode-layout{
    max-width:1200px;
    margin:24px auto 40px;
    padding:0 12px;
    display:grid;
    grid-template-columns:320px minmax(0,1fr) 320px;
    gap:16px;
    align-items:start;
  }
  @media (max-width:1100px){
    .gcode-layout{
      grid-template-columns:1fr;
    }
  }
  .gcode-card{
    background:#0f1117;
    border:1px solid #242735;
    border-radius:12px;
    padding:14px 16px;
  }
  .gcode-card h1,
  .gcode-card h2{
    margin:0 0 10px 0;
    font-size:18px;
  }
  .gcode-card h1{
    font-size:20px;
  }
  .gcode-help{
    font-size:12px;
    opacity:.8;
    margin-top:6px;
  }
  .gcode-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:10px;
  }
  .gcode-row label{
    font-size:13px;
    opacity:.9;
  }
  .gcode-input{
    background:#050712;
    border:1px solid #252a3a;
    border-radius:8px;
    padding:6px 10px;
    color:#e2e8f0;
    font-size:13px;
    width:100%;
    box-sizing:border-box;
  }
  .gcode-btn{
    border-radius:999px;
    border:1px solid #2563eb;
    background:#1d3a7f;
    padding:6px 14px;
    font-size:13px;
    cursor:pointer;
    color:#e5f0ff;
    display:inline-flex;
    align-items:center;
    gap:4px;
    transition:background .12s,border-color .12s,transform .06s;
  }
  .gcode-btn.secondary{
    border-color:#374151;
    background:#111827;
    color:#e5e7eb;
  }
  .gcode-btn:active{
    transform:translateY(1px);
  }
  .gcode-btn:disabled{
    opacity:.6;
    cursor:default;
  }

  #gcode-canvas{
    width:100%;
    height:420px;
    border-radius:12px;
    border:1px solid #242735;
    background:#020617;
    display:block;
  }

  .gcode-controls{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    font-size:13px;
  }
  .gcode-layer-slider{
    flex:1 1 140px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .gcode-layer-slider input[type="range"]{
    flex:1;
  }
  .gcode-layer-label{
    min-width:120px;
    text-align:right;
    font-variant-numeric:tabular-nums;
    opacity:.9;
  }

  .gcode-select{
    background:#050712;
    border:1px solid #252a3a;
    border-radius:999px;
    padding:4px 10px;
    font-size:13px;
    color:#e2e8f0;
  }

  #gcode-status{
    margin-top:8px;
    font-size:12px;
    opacity:.8;
  }

  #gcode-stats{
    font-size:13px;
  }
  .gcode-stats-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:6px;
  }
  .gcode-stats-grid div strong{
    font-weight:600;
  }

  .gcode-badges{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin:6px 0 4px;
  }
  .gcode-badge{
    font-size:11px;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid #1f2937;
    background:#020617;
    opacity:.8;
  }

  .gcode-warnings{
    margin-top:12px;
    border-top:1px dashed #272c3f;
    padding-top:8px;
  }
  .gcode-warnings ul{
    padding-left:18px;
    margin:4px 0 0;
    font-size:12px;
  }
</style>

<div class="gcode-layout">
  <!-- –õ–Ü–í–ê –ö–û–õ–û–ù–ö–ê: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è + —Ä–µ–∂–∏–º–∏ -->
  <section class="gcode-card">
    <h1>G-code Viewer</h1>
    <div class="gcode-help">
      –ó–∞–≤–∞–Ω—Ç–∞–∂ G-code –∑ —Å–ª–∞–π—Å–µ—Ä–∞ (PrusaSlicer, Cura, OrcaSlicer, Bambu Studio —Ç–æ—â–æ) —ñ –ø–æ–¥–∏–≤–∏—Å—å,
      —è–∫ –±—É–¥–µ –¥—Ä—É–∫—É–≤–∞—Ç–∏—Å—è –º–æ–¥–µ–ª—å ‚Äî –ø–æ—à–∞—Ä–æ–≤–æ, –≤ —Ä–æ–∑—Ä—ñ–∑–∞—Ö —ñ –∑ –±–∞–∑–æ–≤–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
    </div>

    <div style="margin-top:12px">
      <label style="font-size:13px;opacity:.9;">G-code —Ñ–∞–π–ª (.gcode)</label>
      <input id="gcode-file" class="gcode-input" type="file" accept=".gcode">
      <div class="gcode-help">–ù–∞–π—à–≤–∏–¥—à–∏–π —Å–ø–æ—Å—ñ–±: –ø—Ä–æ—Å—Ç–æ –µ–∫—Å–ø–æ—Ä—Ç—É–π G-code –∑—ñ —Å–ª–∞–π—Å–µ—Ä–∞ —ñ –∫–∏–Ω—å —Å—é–¥–∏.</div>
    </div>

    <div style="margin-top:12px">
      <label style="font-size:13px;opacity:.9;">G-code –ø–æ URL</label>
      <div class="gcode-row">
        <input id="gcode-url" class="gcode-input" type="text" placeholder="https://‚Ä¶/file.gcode">
        <button id="gcode-load-url" class="gcode-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
      </div>
      <div class="gcode-help">–ü—Ä–∞—Ü—é—î, —è–∫—â–æ —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—É–±–ª—ñ—á–Ω–æ (CORS/HTTPS).</div>
    </div>

    <div style="margin-top:16px">
      <label style="font-size:13px;opacity:.9;">–ö–æ–ª—å–æ—Ä–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</label>
      <div class="gcode-row" style="align-items:center">
        <select id="gcode-color-mode" class="gcode-select">
          <option value="byLayer">–ü–æ —à–∞—Ä–∞—Ö</option>
          <option value="bySpeed">–ü–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ</option>
          <option value="byExtrusion">–ü–æ –µ–∫—Å—Ç—Ä—É–∑—ñ—ó</option>
        </select>
      </div>
      <div class="gcode-help">
        <strong>–ü–æ —à–∞—Ä–∞—Ö</strong> ‚Äî –≤—ñ–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—É—î –ø—Ä–æ–≥—Ä–µ—Å –ø–æ –≤–∏—Å–æ—Ç—ñ.<br>
        <strong>–ü–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ</strong> ‚Äî –∑–Ω–∞—Ö–æ–¥—å –¥—ñ–ª—è–Ω–∫–∏ –∑ —Ä—ñ–∑–∫–æ—é –∑–º—ñ–Ω–æ—é F.<br>
        <strong>–ü–æ –µ–∫—Å—Ç—Ä—É–∑—ñ—ó</strong> ‚Äî –ø—ñ–¥—Å–≤—ñ—á—É—î "–∂–∏—Ä–Ω—ñ" –¥—ñ–ª—è–Ω–∫–∏, –¥–µ –±–∞–≥–∞—Ç–æ –ø–ª–∞—Å—Ç–∏–∫—É.
      </div>
    </div>

    <div id="gcode-status"></div>
  </section>

  <!-- –¶–ï–ù–¢–†: canvas + –∫–æ–Ω—Ç—Ä–æ–ª -->
  <section class="gcode-card">
    <h2>–ü—Ä–µ–≤ º—é —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</h2>
    <canvas id="gcode-canvas"></canvas>

    <div class="gcode-controls">
      <div class="gcode-layer-slider">
        <input id="gcode-layer" type="range" min="0" max="0" value="0">
        <div class="gcode-layer-label">
          <span id="gcode-layer-label">- / -</span>
        </div>
      </div>

      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button id="gcode-play" class="gcode-btn">‚ñ∂Ô∏è –ü–ª–µ–π</button>
        <button id="gcode-pause" class="gcode-btn secondary">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
        <button id="gcode-reset" class="gcode-btn secondary">‚ü≤ –°–∫–∏–Ω—É—Ç–∏</button>
      </div>
    </div>

    <div class="gcode-help">
      –ö–æ–ª–µ—Å–æ –º–∏—à—ñ ‚Äî –º–∞—Å—à—Ç–∞–±, drag ‚Äî –ø–∞–Ω–æ—Ä–∞–º–∞ (—á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä–Ω—ñ –∂–µ—Å—Ç–∏, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ 2D canvas).
      –û–∫—Ä–µ–º–∏–π 3D-G-code-–≤ º—é–≤–µ—Ä –º–æ–∂–Ω–∞ –±—É–¥–µ –¥–æ–¥–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ, –∞–ª–µ –Ω–∞–≤—ñ—Ç—å —Ç–∞–∫–∏–π 2D-—Ä–µ–∂–∏–º –¥–∞—î
      —Ç–æ–ø–æ–≤–∏–π UX –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ G-code –ø–µ—Ä–µ–¥ –¥—Ä—É–∫–æ–º.
    </div>
  </section>

  <!-- –ü–†–ê–í–ê –ö–û–õ–û–ù–ö–ê: –º–µ—Ç—Ä–∏–∫–∏ -->
  <section class="gcode-card">
    <h2>–ú–µ—Ç—Ä–∏–∫–∏ G-code</h2>

    <div class="gcode-badges">
      <div class="gcode-badge">‚è± –û—Ü—ñ–Ω–∫–∞ —á–∞—Å—É –¥—Ä—É–∫—É</div>
      <div class="gcode-badge">üì¶ –ì–∞–±–∞—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—ñ</div>
      <div class="gcode-badge">üßµ –§—ñ–ª–∞–º–µ–Ω—Ç (—É–º–æ–≤–Ω–æ)</div>
    </div>

    <div id="gcode-stats"></div>

    <div class="gcode-warnings" id="gcode-warnings" style="display:none">
      <div style="font-size:12px;opacity:.8;margin-bottom:2px;">–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è:</div>
      <ul id="gcode-warnings-list"></ul>
    </div>

    <div class="gcode-help">
      –ó–∞—Ä–∞–∑ –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Ö—É—î —Å–∞–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ –æ—Å–Ω–æ–≤—ñ G-code. –î–æ–¥–∞—Ç–∫–æ–≤–æ –º–∏ –º–æ–∂–µ–º–æ
      –∑–∞–≤ º—è–∑–∞—Ç–∏ —Ü–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –∞–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä (<code>/api/gcode/metrics</code>)
      —ñ –±—É–¥—É–≤–∞—Ç–∏ –±—ñ–ª—å—à –≥–ª–∏–±–æ–∫—É –∞–Ω–∞–ª—ñ—Ç–∏–∫—É (–ø—Ä–æ–±–ª–µ–º–Ω—ñ –∑–æ–Ω–∏, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ñ –∑–º—ñ–Ω–∏, —Ä–µ—Ç—Ä–∞–∫—Ç–∏ —Ç–æ—â–æ).
    </div>
  </section>
</div>

<script type="module">
  import { initGCodeViewer } from "{{ url_for('static', filename='js/gcode_viewer.js') }}";

  document.addEventListener("DOMContentLoaded", () => {
    const api = initGCodeViewer({
      canvasId: "gcode-canvas",
      fileInputId: "gcode-file",
      urlInputId: "gcode-url",
      urlButtonId: "gcode-load-url",
      layerSliderId: "gcode-layer",
      layerLabelId: "gcode-layer-label",
      statsContainerId: "gcode-stats",
      playButtonId: "gcode-play",
      pauseButtonId: "gcode-pause",
      resetButtonId: "gcode-reset",
      colorModeSelectId: "gcode-color-mode",
      statusId: "gcode-status",
    });

    // (–ó–∞ –±–∞–∂–∞–Ω–Ω—è–º –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É —Ç—É—Ç –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ /api/gcode/metrics
    //  –¥–ª—è –±—ñ–ª—å—à –≤–∞–∂–∫–æ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ.)
  });
</script>
{% endblock %}
