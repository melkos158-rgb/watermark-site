{% extends "market/layout.html" %}

{# 
  –°—Ç–æ—Ä—ñ–Ω–∫–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –∞–≤—Ç–æ—Ä–∞ STL-–º–æ–¥–µ–ª–µ–π.
  –ü—Ä–∞—Ü—é—î –ø–æ–≤–µ—Ä—Ö market/layout.html —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±–ª–æ–∫ market_main.
#}

{% block market_main %}

  {# –ë–µ–∑–ø–µ—á–Ω—ñ –¥–µ—Ñ–æ–ª—Ç–∏, —è–∫—â–æ –±–µ–∫ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤ stats #}
  {% set s = stats if stats is defined else {
    'total_views': 0,
    'total_downloads': 0,
    'total_sales': 0,
    'ctr': 0,
    'avg_price': 0,
    'top_items': []
  } %}

  <section class="market-stats">
    <header class="stats-header">
      <h1>–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
      <p class="muted">
        –ü–µ—Ä–µ–≥–ª—è–¥–∏, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –ø–æ–∫—É–ø–∫–∏ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–≤–æ—ó—Ö –º–æ–¥–µ–ª–µ–π –Ω–∞ Proofly STL Market.
      </p>

      <div class="stats-range-switch">
        <button class="btn tiny stats-range-btn active" data-range="7d">7 –¥–Ω—ñ–≤</button>
        <button class="btn tiny stats-range-btn" data-range="30d">30 –¥–Ω—ñ–≤</button>
        <button class="btn tiny stats-range-btn" data-range="90d">90 –¥–Ω—ñ–≤</button>
        <button class="btn tiny stats-range-btn" data-range="all">–ó–∞ –≤–µ—Å—å —á–∞—Å</button>
      </div>
    </header>

    <!-- KPI –∫–∞—Ä—Ç–∫–∏ -->
    <section class="stats-kpi-grid">
      <article class="stats-card">
        <div class="stats-label">–ü–µ—Ä–µ–≥–ª—è–¥–∏</div>
        <div class="stats-value">{{ s.total_views }}</div>
        <div class="stats-sub" data-kpi="views_delta">Œî –∑–∞ –ø–µ—Ä—ñ–æ–¥: ‚Äì</div>
      </article>

      <article class="stats-card">
        <div class="stats-label">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>
        <div class="stats-value">{{ s.total_downloads }}</div>
        <div class="stats-sub" data-kpi="downloads_delta">Œî –∑–∞ –ø–µ—Ä—ñ–æ–¥: ‚Äì</div>
      </article>

      <article class="stats-card">
        <div class="stats-label">–ü—Ä–æ–¥–∞–∂—ñ</div>
        <div class="stats-value">{{ s.total_sales }}</div>
        <div class="stats-sub" data-kpi="sales_delta">Œî –∑–∞ –ø–µ—Ä—ñ–æ–¥: ‚Äì</div>
      </article>

      <article class="stats-card">
        <div class="stats-label">CTR (–ø–µ—Ä–µ–≥–ª—è–¥ ‚Üí –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)</div>
        <div class="stats-value">
          {{ "%.1f"|format(s.ctr or 0) }}%
        </div>
        <div class="stats-sub">
          –ù–∞—Å–∫—ñ–ª—å–∫–∏ –¥–æ–±—Ä–µ –ø—Ä–∞—Ü—é—é—Ç—å –ø—Ä–µ–≤‚Äô—é —Ç–∞ –æ–ø–∏—Å.
        </div>
      </article>

      <article class="stats-card">
        <div class="stats-label">–°–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞</div>
        <div class="stats-value">
          {{ "%.2f"|format(s.avg_price or 0) }} z≈Ç
        </div>
        <div class="stats-sub">
          –°–µ—Ä–µ–¥–Ω—è –≤–∞—Ä—Ç—ñ—Å—Ç—å —Ç–≤–æ—ó—Ö –ø–ª–∞—Ç–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π.
        </div>
      </article>
    </section>

    <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
    <section class="stats-charts">
      <div class="stats-chart-card">
        <h2>–ü–µ—Ä–µ–≥–ª—è–¥–∏ vs –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h2>
        <p class="muted">
          –î–æ–ø–æ–º–∞–≥–∞—î –±–∞—á–∏—Ç–∏, —è–∫—ñ –¥–Ω—ñ –ø—Ä–∏–Ω–æ—Å—è—Ç—å –º–∞–∫—Å–∏–º—É–º —Ç—Ä–∞—Ñ—ñ–∫—É —Ç–∞ –¥—ñ–π.
        </p>
        <canvas
          id="chart-views-downloads"
          class="stats-chart"
          data-endpoint="/api/market/stats/timeseries">
        </canvas>
      </div>

      <div class="stats-chart-card">
        <h2>–ü–æ—à—É–∫–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ (heatmap)</h2>
        <p class="muted">
          –Ø–∫—ñ —Å–ª–æ–≤–∞ –ª—é–¥–∏ –≤–≤–æ–¥—è—Ç—å, –ø–µ—Ä—à –Ω—ñ–∂ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –Ω–∞ —Ç–≤–æ—ó –º–æ–¥–µ–ª—ñ.
        </p>
        <div
          id="search-heatmap"
          class="search-heatmap"
          data-endpoint="/api/market/stats/search_heatmap">
          <div class="placeholder muted">
            Heatmap –∑–∞–ø–∏—Ç—ñ–≤ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è‚Ä¶
          </div>
        </div>
      </div>
    </section>

    <!-- –¢–∞–±–ª–∏—Ü—è –¢–û–ü –º–æ–¥–µ–ª–µ–π -->
    <section class="stats-top-items">
      <h2>–¢–æ–ø –º–æ–¥–µ–ª–µ–π –∑–∞ –ø–µ—Ä—ñ–æ–¥</h2>
      <p class="muted">
        –°–æ—Ä—Ç—É—Ä—É–π –∑–∞ –ø–µ—Ä–µ–≥–ª—è–¥–∞–º–∏, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º–∏, –ø—Ä–æ–¥–∞–∂–∞–º–∏ –∞–±–æ CTR.
      </p>

      <div class="top-table-scroll">
        <table class="top-items-table">
          <thead>
            <tr>
              <th>#</th>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–ü–µ—Ä–µ–≥–ª—è–¥–∏</th>
              <th>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</th>
              <th>–ü—Ä–æ–¥–∞–∂—ñ</th>
              <th>CTR</th>
              <th>–î–æ—Ö—ñ–¥</th>
            </tr>
          </thead>
          <tbody id="top-items-body">
            {% if s.top_items and s.top_items|length %}
              {% for item in s.top_items %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>
                    <a href="{{ url_for('market.detail', item_id=item.id) }}" class="link">
                      {{ item.title }}
                    </a>
                  </td>
                  <td>{{ item.views }}</td>
                  <td>{{ item.downloads }}</td>
                  <td>{{ item.sales }}</td>
                  <td>{{ "%.1f"|format(item.ctr or 0) }}%</td>
                  <td>{{ "%.2f"|format(item.revenue or 0) }} z≈Ç</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="muted">
                  –ü–æ–∫–∏ —â–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö. –û–ø—É–±–ª—ñ–∫—É–π –∫—ñ–ª—å–∫–∞ –º–æ–¥–µ–ª–µ–π —ñ –ø–æ—á–Ω–∏ –∑–±–∏—Ä–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É üìà
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>
  </section>

{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  {# JS, —è–∫–∏–π –Ω–∞–º–∞–ª—é—î –≥—Ä–∞—Ñ—ñ–∫–∏ –π –ø—ñ–¥—Ç—è–≥–Ω–µ –¥–∞–Ω—ñ #}
  <script src="{{ url_for('static', filename='market/js/analytics.js') }}"></script>
{% endblock %}
