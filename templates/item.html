{% extends "base.html" %}

{% block title %}{{ item.title if item else "STL –º–æ–¥–µ–ª—å" }}{% endblock %}

{% block content %}
<div class="wrap">
  <a href="{{ url_for('market.page_market') }}" class="back">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Ä–∏–Ω–∫—É</a>

  <div class="card flex">
    <div class="left">
      <div class="glr">
        <div class="glr-stage" id="glrStage"></div>
        <div class="glr-btn glr-prev" id="glrPrev" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—î">‚Äπ</div>
        <div class="glr-btn glr-next" id="glrNext" aria-label="–ù–∞—Å—Ç—É–ø–Ω–µ">‚Ä∫</div>
        <div class="glr-thumbs" id="glrThumbs"></div>
      </div>
    </div>

    <div class="right">
      <div class="title">{{ item.title }}</div>

      <div class="tags">
        {% set _tags = (item.tags or '') %}
        {% for tag in (_tags.split(',') if _tags is string else _tags) %}
          {% if tag|string|trim %}<span class="tag">{{ tag|string|trim }}</span>{% endif %}
        {% endfor %}
      </div>

      <div class="price">
        {% if item.price == 0 %} –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ {% else %} {{ item.price }} PLN {% endif %}
      </div>

      <div class="muted">‚òÖ {{ item.rating if item.rating is not none else '‚Äî' }}</div>
      <p>{{ item.desc }}</p>

      <div class="stats">
        <div>üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å: <span id="dlCount">{{ item.downloads or 0 }}</span></div>
        <div>üí∞ –ó–∞—Ä–æ–±—ñ—Ç–æ–∫: {{ item.earnings or 0 }} PLN</div>
        <div>üß© –ú–æ–¥–µ–ª–µ–π: {{ item.items_count or 0 }}</div>
      </div>

      {% if item.price == 0 %}
        <a href="{{ item.url }}" id="btnDownload" class="btn primary">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ STL</a>
      {% else %}
        <button class="btn primary">üí≥ –ö—É–ø–∏—Ç–∏ STL</button>
      {% endif %}

      {# –ö–Ω–æ–ø–∫–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ (–ª–∏—à–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∞) #}
      {% if session.get('user_id') and item.user_id and session.get('user_id') == item.user_id %}
      <div class="owner-actions">
        <button class="btn" id="btnEdit" data-id="{{ item.id }}">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
        <button class="btn danger" id="btnDelete" data-id="{{ item.id }}">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
        <div class="muted" id="ownerMsg" style="margin-top:6px;"></div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="author">
    <img src="{{ item.author_avatar or '/static/img/user.jpg' }}" alt="–ê–≤—Ç–æ—Ä">
    <div>
      <div><strong>{{ item.author_name or '–ê–≤—Ç–æ—Ä' }}</strong></div>
      <div class="muted">{{ item.author_bio or '3D-–¥–∏–∑–∞–π–Ω–µ—Ä' }}</div>
    </div>
  </div>
</div>

<style>
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .back{color:var(--muted);display:inline-block;margin-bottom:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:20px}
  .flex{display:flex;gap:16px;flex-wrap:wrap}
  .left{flex:1 1 520px;min-width:320px}
  .right{flex:1 1 300px;min-width:260px;display:flex;flex-direction:column;gap:10px}
  .glr{position:relative;border:1px solid var(--line);border-radius:12px;background:#0c0f16}
  .glr-stage{position:relative;width:100%;height:420px;overflow:hidden;border-radius:12px}
  .glr-slide{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:0}
  .glr-slide.active{display:flex;z-index:1}
  .glr-slide img{max-width:100%;max-height:100%;object-fit:contain;background:#0b0e14;display:block}
  .glr-slide svg{width:60%;max-width:560px;aspect-ratio:4/3}
  .glr-stl{width:100%;height:100%}
  .glr-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(20,25,35,.85);
    border:1px solid var(--line);color:#fff;width:38px;height:38px;border-radius:10px;display:flex;
    align-items:center;justify-content:center;cursor:pointer;user-select:none;z-index:2}
  .glr-btn:hover{background:rgba(45,55,75,.95)}
  .glr-prev{left:10px}.glr-next{right:10px}
  .glr-thumbs{display:flex;gap:8px;padding:10px;overflow:auto}
  .glr-thumbs img.gthumb,.glr-thumbs .gthumb-stl{
    width:70px;height:56px;border-radius:8px;border:1px solid var(--line);object-fit:cover;cursor:pointer;
    opacity:.9;flex:0 0 auto;background:#0b0e14;display:block;position:static !important}
  .glr-thumbs .active{outline:2px solid var(--accent);opacity:1}
  .title{font-size:22px;font-weight:800}
  .price{font-weight:700;color:var(--accent)}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:13px;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
  .stats{display:flex;gap:20px;margin-top:8px;color:var(--muted);font-size:14px}
  .author{display:flex;align-items:center;gap:10px;margin-top:12px;background:var(--card);border:1px solid var(--line);padding:10px;border-radius:10px}
  .author img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  .owner-actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  @media(max-width:700px){ .glr-stage{height:340px} }
</style>
{% endblock %}

{% block scripts %}
<!-- import map –¥–ª—è three —Ç–∞ –∞–¥–¥–æ–Ω—ñ–≤ -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/"
  }
}
</script>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { STLLoader } from 'three/addons/loaders/STLLoader.js';

  // ---- —Å–ª—É–∂–±–æ–≤—ñ ----
  const ITEM_ID = {{ item.id | tojson }};
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};
  const ITEM_USER_ID = {{ (item.user_id or none) | tojson }};
  const IS_OWNER = !!(CURRENT_USER_ID && ITEM_USER_ID && Number(CURRENT_USER_ID) === Number(ITEM_USER_ID));

  function makeInlinePlaceholder() {
    const ns = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(ns, 'svg');
    svg.setAttribute('viewBox', '0 0 800 600'); svg.setAttribute('role','img');
    const defs=document.createElementNS(ns,'defs');
    const lg=document.createElementNS(ns,'linearGradient');
    lg.id='g'; lg.setAttribute('x1','0'); lg.setAttribute('y1','0'); lg.setAttribute('x2','1'); lg.setAttribute('y2','1');
    const s1=document.createElementNS(ns,'stop'); s1.setAttribute('offset','0'); s1.setAttribute('stop-color','#0b0e14');
    const s2=document.createElementNS(ns,'stop'); s2.setAttribute('offset','1'); s2.setAttribute('stop-color','#141923');
    lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); svg.appendChild(defs);
    const rect=document.createElementNS(ns,'rect'); rect.setAttribute('width','100%'); rect.setAttribute('height','100%'); rect.setAttribute('fill','url(#g)');
    svg.appendChild(rect);
    const text=document.createElementNS(ns,'text'); text.setAttribute('x','400'); text.setAttribute('y','300'); text.setAttribute('text-anchor','middle');
    text.setAttribute('fill','#8993a8'); text.setAttribute('font-size','28'); text.textContent='–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è';
    svg.appendChild(text);
    return svg;
  }

  // ----- –¥–∞–Ω—ñ –∑ —à–∞–±–ª–æ–Ω—É -----
  const cover = {{ (item.cover or '') | tojson }};
  const urlSTL = {{ (item.url or '') | tojson }};
  let photosRaw = {{ (item.photos or '[]') | tojson }};
  let photos = [];
  try { photos = Array.isArray(photosRaw) ? photosRaw : JSON.parse(photosRaw || '[]'); } catch { photos = []; }
  photos = (photos || []).filter(Boolean).map(s => String(s).trim()).filter(Boolean);
  if (cover && !photos.includes(cover)) photos.unshift(cover);

  const slides = [
    ...photos.map(src => ({ type:'img', src })),
    ...(urlSTL ? [{ type:'stl', src:urlSTL }] : [])
  ];
  if (!slides.length) slides.push({type:'img', src:''});

  const stage  = document.getElementById('glrStage');
  const thumbs = document.getElementById('glrThumbs');
  const prevBtn = document.getElementById('glrPrev');
  const nextBtn = document.getElementById('glrNext');

  let idx = 0;
  let stlInited = false;

  function makeImgSlide(src) {
    const s = document.createElement('div'); s.className = 'glr-slide';
    if (src) {
      const img = document.createElement('img');
      img.loading='eager'; img.decoding='async'; img.src=src; img.alt='preview';
      img.onerror = () => { s.innerHTML=''; s.appendChild(makeInlinePlaceholder()); };
      s.appendChild(img);
    } else {
      s.appendChild(makeInlinePlaceholder());
    }
    return s;
  }

  function makeStlSlide() {
    const s = document.createElement('div'); s.className='glr-slide';
    const holder=document.createElement('div'); holder.className='glr-stl'; holder.id='stl-holder';
    s.appendChild(holder); return s;
  }

  const slideEls = slides.map(sl => sl.type==='img' ? makeImgSlide(sl.src) : makeStlSlide());
  slideEls.forEach(el => stage.appendChild(el));

  slides.forEach((sl,i)=>{
    if (sl.type==='img') {
      if (sl.src) {
        const t=document.createElement('img'); t.src=sl.src; t.alt='thumb'; t.className='gthumb';
        t.addEventListener('error',()=>{ const ph=makeInlinePlaceholder(); ph.style.width='70px'; ph.style.height='56px'; t.replaceWith(ph); });
        t.addEventListener('click',()=>go(i)); thumbs.appendChild(t);
      } else {
        const ph=makeInlinePlaceholder(); ph.style.width='70px'; ph.style.height='56px';
        ph.style.border='1px solid var(--line)'; ph.style.borderRadius='8px';
        ph.style.cursor='pointer'; ph.addEventListener('click',()=>go(i)); thumbs.appendChild(ph);
      }
    } else {
      const t=document.createElement('div'); t.className='gthumb-stl'; t.title='STL';
      t.style.display='grid'; t.style.placeItems='center'; t.textContent='STL';
      t.addEventListener('click',()=>go(i)); thumbs.appendChild(t);
    }
  });

  function markActive(){
    slideEls.forEach((el,i)=> el.classList.toggle('active', i===idx));
    [...thumbs.children].forEach((el,i)=> el.classList.toggle('active', i===idx));
    if (slides[idx]?.type==='stl' && !stlInited){ stlInited=true; initSTL(); }
  }
  function go(newIdx){ if (!slides.length) return; idx=(newIdx+slides.length)%slides.length; markActive(); }

  prevBtn.onclick=()=>go(idx-1);
  nextBtn.onclick=()=>go(idx+1);

  let sx=null;
  stage.addEventListener('pointerdown',e=>{ sx=e.clientX; });
  stage.addEventListener('pointerup',e=>{ if(sx==null)return; const dx=e.clientX-sx; sx=null; if(Math.abs(dx)>40)(dx>0?prevBtn.onclick():nextBtn.onclick()); });

  slideEls[0].classList.add('active');
  setTimeout(()=>go(0),0);

  // ---------- STL ----------
  function initSTL(){
    if(!urlSTL) return;
    const container=document.getElementById('stl-holder'); if(!container) return;

    const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b0e14);
    const camera=new THREE.PerspectiveCamera(60,1,0.01,1000); camera.position.set(1,0.6,1.5);
    const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.outputColorSpace=THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    const controls=new OrbitControls(camera,renderer.domElement); controls.enableDamping=true;
    scene.add(new THREE.AmbientLight(0xffffff,0.6)); const dir=new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(2,2,2); scene.add(dir);

    const loader=new STLLoader();
    loader.load(urlSTL,(geo)=>{
      const mat=new THREE.MeshStandardMaterial({color:0x9aa7c7,roughness:.8,metalness:.1});
      const mesh=new THREE.Mesh(geo,mat); if(geo.computeVertexNormals) geo.computeVertexNormals(); scene.add(mesh);
      const box=new THREE.Box3().setFromObject(mesh); const size=box.getSize(new THREE.Vector3()); const center=box.getCenter(new THREE.Vector3());
      mesh.position.sub(center); camera.position.set(size.x*1.2+0.6,size.y*1.2+0.4,size.z*1.5+0.8); controls.update();
    });

    function resize(){ const w=container.clientWidth||container.offsetWidth||600; const h=container.clientHeight||420;
      renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
    new ResizeObserver(resize).observe(container); resize();

    (function loop(){ requestAnimationFrame(loop); controls.update(); renderer.render(scene,camera); })();
  }

  // ---------- –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å + –≤–ª–∞—Å–Ω–∏—Ü—å–∫—ñ –∫–Ω–æ–ø–∫–∏ ----------
  const dlBtn = document.getElementById('btnDownload');
  const dlCountEl = document.getElementById('dlCount');
  if (dlBtn) {
    dlBtn.addEventListener('click', async (e)=>{
      // —è–∫—â–æ –ø—Ä—è–º–æ <a href> ‚Äî –ø–µ—Ä–µ—Ö–æ–ø–ª—é—î–º–æ, —Ä–∞—Ö—É—î–º–æ, —Ç–æ–¥—ñ –π–¥–µ–º–æ –Ω–∞ —Ñ–∞–π–ª
      e.preventDefault();
      try{
        await fetch(`/api/item/${ITEM_ID}/download`, { method:'POST' });
        // –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–∏–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
        if (dlCountEl) dlCountEl.textContent = String(Number(dlCountEl.textContent||0)+1);
      }catch{}
      // –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ñ–∞–π–ª –ø—ñ—Å–ª—è –∑–∞–ø–∏—Ç—É (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ä–∞—Ö—É–Ω–æ—á–æ–∫ –Ω–µ –≤–¥–∞–≤—Å—è)
      const url = {{ (item.url or '') | tojson }};
      if (url) window.location.href = url;
    });
  }

  if (IS_OWNER){
    const msg = document.getElementById('ownerMsg');
    const btnEdit = document.getElementById('btnEdit');
    const btnDelete = document.getElementById('btnDelete');

    btnEdit?.addEventListener('click', ()=>{
      // —è–∫—â–æ —É —Ç–µ–±–µ —î –æ–∫—Ä–µ–º–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ‚Äî –º—ñ–Ω—è–π —à–ª—è—Ö —Ç—É—Ç
      window.location.href = `/edit/${ITEM_ID}`;
    });

    btnDelete?.addEventListener('click', async ()=>{
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –±–µ–∑–ø–æ–≤–æ—Ä–æ—Ç–Ω–æ?')) return;
      try{
        const r = await fetch(`/api/item/${ITEM_ID}/delete`, { method:'POST' });
        const j = await r.json().catch(()=>({}));
        if (r.ok && j.ok){
          msg.textContent = '–í–∏–¥–∞–ª–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ —Ä–∏–Ω–æ–∫‚Ä¶';
          setTimeout(()=>{ window.location.href = '{{ url_for("market.page_market") }}'; }, 600);
        } else {
          msg.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ (–º–æ–∂–ª–∏–≤–æ, –Ω–µ–º–∞—î —Ä–æ—É—Ç—É –∞–±–æ –ø—Ä–∞–≤).';
        }
      }catch(err){
        console.error(err);
        msg.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.';
      }
    });
  }
</script>
{% endblock %}
