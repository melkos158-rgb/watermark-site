{% extends "base.html" %}

{% block title %}{{ item.title if item else "STL –º–æ–¥–µ–ª—å" }}{% endblock %}

{% block content %}
<div class="wrap">
  <a href="{{ url_for('market.page_market') }}" class="back">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Ä–∏–Ω–∫—É</a>

  <div class="card flex">
    <div class="left">
      <div class="glr">
        <div class="glr-stage" id="glrStage"></div>
        <button type="button" class="glr-btn glr-prev" id="glrPrev" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—î">‚Äπ</button>
        <button type="button" class="glr-btn glr-next" id="glrNext" aria-label="–ù–∞—Å—Ç—É–ø–Ω–µ">‚Ä∫</button>
        <div class="glr-thumbs" id="glrThumbs" aria-label="–ú—ñ–Ω—ñ–∞—Ç—é—Ä–∏"></div>
      </div>
    </div>

    <div class="right">
      <div class="title">{{ item.title }}</div>

      <div class="tags">
        {% set _tags = (item.tags or '') %}
        {% for tag in (_tags.split(',') if _tags is string else _tags) %}
          {% if tag|string|trim %}<span class="tag">{{ tag|string|trim }}</span>{% endif %}
        {% endfor %}
      </div>

      <div class="price">
        {% if item.price == 0 %} –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ {% else %} {{ item.price }} PLN {% endif %}
      </div>

      <div class="muted">‚òÖ {{ item.rating if item.rating is not none else '‚Äî' }}</div>
      <p>{{ item.desc }}</p>

      <div class="stats">
        <div>üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å: {{ item.downloads or 0 }}</div>
        <div>üí∞ –ó–∞—Ä–æ–±—ñ—Ç–æ–∫: {{ item.earnings or 0 }} PLN</div>
        <div>üß© –ú–æ–¥–µ–ª–µ–π: {{ item.items_count or 0 }}</div>
      </div>

      {# --- –ì–û–õ–û–í–ù–ï: –±–µ—Ä–µ–º–æ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–π URL –∑ –º–æ–¥–µ–ª—ñ (ZIP -> STL main -> –ø–µ—Ä—à–∏–π extra) --- #}
      {% set prefer_url = item.preferred_download_url
                          or item.stl_main_url
                          or (item.stl_extra[0] if item.stl_extra else None) %}
      {% set zip_url = item.zip_url %}

      {% if item.price == 0 %}
        <!-- –ì–û–õ–û–í–ù–ê –ö–ù–û–ü–ö–ê: –∫–∞—á–∞—î ZIP, –∞ —è–∫—â–æ –Ω–µ–º–∞ ‚Äî STL -->
        {% if prefer_url %}
          <a href="{{ prefer_url }}" id="btnDownload" download class="btn primary">
            ‚¨áÔ∏è {{ '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ZIP' if zip_url else '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ STL' }}
          </a>
        {% endif %}

        <!-- –î–û–î–ê–¢–ö–û–í–ê: –∑–∞–≤–∂–¥–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∞–º–µ –Ω–∞ ZIP, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î -->
        {% if zip_url %}
          <a href="{{ zip_url }}" id="btnZipOnly" download class="btn"
             title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–∞–º–µ ZIP-–∞—Ä—Ö—ñ–≤">
            üóúÔ∏è ZIP-–∞—Ä—Ö—ñ–≤
          </a>
        {% endif %}

        {% if not prefer_url %}
          <div class="muted">–ù–µ–º–∞—î —Ñ–∞–π–ª—É –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.</div>
        {% endif %}
        <div class="muted" style="margin-top:6px">
          –ü–µ—Ä–µ–≥–ª—è–¥ STL/—Ñ–æ—Ç–æ –∑–≤–µ—Ä—Ö—É ‚Äî –ª–∏—à–µ –ø–µ—Ä–µ–≥–ª—è–¥. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ ZIP (—è–∫—â–æ —î), –∞–±–æ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–∏–π STL.
        </div>
      {% else %}
        <button class="btn primary" disabled title="–û–ø–ª–∞—Ç–∞ –ø–æ–∫–∏ —â–æ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞">üí≥ –ö—É–ø–∏—Ç–∏ STL</button>
      {% endif %}
    </div>
  </div>

  <div class="author">
    <img src="{{ item.author_avatar or '/static/img/user.jpg' }}" alt="–ê–≤—Ç–æ—Ä">
    <div>
      <div><strong>{{ item.author_name or '–ê–≤—Ç–æ—Ä' }}</strong></div>
      <div class="muted">{{ item.author_bio or '3D-–¥–∏–∑–∞–π–Ω–µ—Ä' }}</div>
    </div>
  </div>
</div>

<style>
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .back{color:var(--muted);display:inline-block;margin-bottom:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:20px}
  .flex{display:flex;gap:16px;flex-wrap:wrap}
  .left{flex:1 1 520px;min-width:320px}
  .right{flex:1 1 300px;min-width:260px;display:flex;flex-direction:column;gap:10px}

  .glr{position:relative;border:1px solid var(--line);border-radius:12px;background:#0c0f16}
  .glr-stage{position:relative;width:100%;height:420px;overflow:hidden;border-radius:12px}
  .glr-slide{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:0}
  .glr-slide.active{display:flex;z-index:1}
  .glr-slide img{max-width:100%;max-height:100%;object-fit:contain;background:#0b0e14;display:block}
  .glr-slide svg{width:60%;max-width:560px;aspect-ratio:4/3}
  .glr-stl{width:100%;height:100%}

  .glr-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(20,25,35,.85);
    border:1px solid var(--line);color:#fff;width:38px;height:38px;border-radius:10px;display:flex;
    align-items:center;justify-content:center;cursor:pointer;user-select:none;z-index:2}
  .glr-btn:hover{background:rgba(45,55,75,.95)}
  .glr-prev{left:10px}.glr-next{right:10px}

  .glr-thumbs{display:flex;gap:8px;padding:10px;overflow:auto;border-top:1px solid var(--line)}
  .gthumb-btn{border:1px solid var(--line);border-radius:8px;background:#0b0e14;color:var(--text);
    width:74px;height:56px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:.92;flex:0 0 auto}
  .gthumb-btn:focus-visible{outline:2px solid var(--accent)}
  .gthumb-btn.active{outline:2px solid var(--accent);opacity:1}
  .gthumb-btn img{width:100%;height:100%;object-fit:cover;border-radius:6px}
  .gthumb-stl-label{font-size:12px;opacity:.9}

  .title{font-size:22px;font-weight:800}
  .price{font-weight:700;color:var(--accent)}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:13px;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .stats{display:flex;gap:20px;margin-top:8px;color:var(--muted);font-size:14px}
  .author{display:flex;align-items:center;gap:10px;margin-top:12px;background:var(--card);border:1px solid var(--line);padding:10px;border-radius:10px}
  .author img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  @media(max-width:700px){ .glr-stage{height:340px} }
</style>
{% endblock %}

{% block scripts %}
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/"
  }
}
</script>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { STLLoader } from 'three/addons/loaders/STLLoader.js';

  // ---------- helpers ----------
  const qs = (s) => document.querySelector(s);
  const qsa = (s) => Array.from(document.querySelectorAll(s));
  function makeInlinePlaceholder(){
    const ns='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(ns,'svg'); svg.setAttribute('viewBox','0 0 800 600'); svg.setAttribute('role','img');
    const defs=document.createElementNS(ns,'defs');
    const lg=document.createElementNS(ns,'linearGradient'); lg.id='g'; lg.setAttribute('x1','0'); lg.setAttribute('y1','0'); lg.setAttribute('x2','1'); lg.setAttribute('y2','1');
    const s1=document.createElementNS(ns,'stop'); s1.setAttribute('offset','0'); s1.setAttribute('stop-color','#0b0e14');
    const s2=document.createElementNS(ns,'stop'); s2.setAttribute('offset','1'); s2.setAttribute('stop-color','#141923');
    lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); svg.appendChild(defs);
    const rect=document.createElementNS(ns,'rect'); rect.setAttribute('width','100%'); rect.setAttribute('height','100%'); rect.setAttribute('fill','url(#g)'); svg.appendChild(rect);
    const text=document.createElementNS(ns,'text'); text.setAttribute('x','400'); text.setAttribute('y','300'); text.setAttribute('text-anchor','middle'); text.setAttribute('fill','#8993a8'); text.setAttribute('font-size','28'); text.textContent='–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è'; svg.appendChild(text);
    return svg;
  }
  function uniq5(arr){ return Array.from(new Set((arr||[]).filter(Boolean))).slice(0,5); }

  // ---------- data ----------
  const cover = {{ (item.cover or item.cover_url or '') | tojson }};
  const photosFromItem = {{ item.photos | tojson }};              // –º–æ–∂–µ –±—É—Ç–∏ –º–∞—Å–∏–≤ –∞–±–æ –æ–±‚Äô—î–∫—Ç {images, stl}
  const galleryUrls    = {{ (item.gallery_urls or '[]') | tojson }};
  const stlMain        = {{ (item.url or item.stl_url or item.stl_main_url or '') | tojson }};
  const stlFromItem    = {{ (item.stl_files or '[]') | tojson }}; // –º–æ–∂–µ –≤–∂–µ –±—É—Ç–∏ –º–∞—Å–∏–≤ STL

  // –í–∏—Ç—è–≥—É—î–º–æ —Ñ–æ—Ç–æ –π STL –∑ —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤
  let images = [];
  let stlList = [];

  if (Array.isArray(photosFromItem)) {
    images = photosFromItem;
  } else if (photosFromItem && typeof photosFromItem === 'object') {
    images = Array.isArray(photosFromItem.images) ? photosFromItem.images : [];
    stlList = Array.isArray(photosFromItem.stl) ? photosFromItem.stl : [];
  }

  // –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∂–µ—Ä–µ–ª–∞ (—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å)
  if (!images?.length && Array.isArray(galleryUrls)) images = galleryUrls;
  if (Array.isArray(stlFromItem) && stlFromItem.length) stlList = stlList.concat(stlFromItem);

  // –¥–æ–¥–∞—î–º–æ cover —ñ –≥–æ–ª–æ–≤–Ω–∏–π STL
  if (cover) images = [cover, ...images];
  if (stlMain) stlList = [stlMain, ...stlList];

  // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏ —Ç–∞ –æ–±–º–µ–∂—É—î–º–æ 5
  images  = uniq5(images);
  stlList = uniq5(stlList);

  // ---------- builders ----------
  function makeImgSlide(src){
    const s=document.createElement('div'); s.className='glr-slide';
    if (src){
      const img=document.createElement('img'); img.src=src; img.alt='preview'; img.decoding='async'; img.loading='eager';
      img.onerror=()=>{ s.innerHTML=''; s.appendChild(makeInlinePlaceholder()); };
      s.appendChild(img);
    } else { s.appendChild(makeInlinePlaceholder()); }
    return s;
  }
  function makeStlSlide(id){
    const s=document.createElement('div'); s.className='glr-slide';
    const holder=document.createElement('div'); holder.className='glr-stl'; holder.id=id;
    s.appendChild(holder); return s;
  }
  function thumbButton(content, label){
    const b=document.createElement('button');
    b.type='button'; b.className='gthumb-btn'; b.setAttribute('aria-label', label||'');
    if (content instanceof HTMLElement) b.appendChild(content); else b.textContent = content;
    return b;
  }

  // ---------- build ----------
  const stage   = qs('#glrStage');
  const thumbs  = qs('#glrThumbs');
  const prevBtn = qs('#glrPrev');
  const nextBtn = qs('#glrNext');

  const slides = [
    ...images.map(src => ({type:'img', src})),
    ...stlList.map((src,i)=>({type:'stl', src, id:`stl-holder-${i}`, label:`STL ${i+1}`}))
  ];
  if (!slides.length) slides.push({type:'img', src:''});

  const slideEls = slides.map(sl => sl.type==='img' ? makeImgSlide(sl.src) : makeStlSlide(sl.id));
  slideEls.forEach(el => stage.appendChild(el));

  // thumbs
  slides.forEach((sl,i)=>{
    if (sl.type==='img'){
      const img=document.createElement('img'); img.src=sl.src; img.alt='thumb';
      const btn=thumbButton(img, '–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ñ–æ—Ç–æ');
      btn.addEventListener('click',()=>go(i));
      btn.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); go(i);} });
      thumbs.appendChild(btn);
    } else {
      const span=document.createElement('span'); span.className='gthumb-stl-label'; span.textContent=sl.label||'STL';
      const btn=thumbButton(span, '–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ STL');
      btn.addEventListener('click',()=>go(i));
      btn.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); go(i);} });
      thumbs.appendChild(btn);
    }
  });

  // ---------- nav / state ----------
  let idx=0;
  const stlInited=new Set();

  function markActive(){
    slideEls.forEach((el,i)=> el.classList.toggle('active', i===idx));
    qsa('.gthumb-btn').forEach((b,i)=> b.classList.toggle('active', i===idx));
    const activeThumb = qsa('.gthumb-btn')[idx];
    if (activeThumb) activeThumb.scrollIntoView({block:'nearest', inline:'nearest', behavior:'smooth'});
    initSTL(idx);
  }
  function go(newIdx){
    if (!slides.length) return;
    idx = (newIdx + slides.length) % slides.length;
    markActive();
  }

  prevBtn.addEventListener('click',()=>go(idx-1));
  nextBtn.addEventListener('click',()=>go(idx+1));

  // —Å–≤–∞–π–ø (–Ω–µ –ø—ñ–¥ —á–∞—Å STL –≤–∑–∞—î–º–æ–¥—ñ—ó)
  let sx=null;
  stage.addEventListener('pointerdown',e=>{
    const isSTL = slides[idx]?.type==='stl';
    if (isSTL || e.target.closest('.glr-stl')) return;
    sx=e.clientX;
  });
  stage.addEventListener('pointerup',e=>{
    const isSTL = slides[idx]?.type==='stl';
    if (isSTL || e.target.closest('.glr-stl')) return;
    if (sx==null) return;
    const dx=e.clientX-sx; sx=null;
    if (Math.abs(dx)>40) (dx>0 ? prevBtn.click() : nextBtn.click());
  });

  // init
  slideEls[0].classList.add('active');
  markActive();

  // ---------- STL init ----------
  function initSTL(i){
    const sl=slides[i];
    if (!sl || sl.type!=='stl' || stlInited.has(i)) return;
    stlInited.add(i);

    const container = document.getElementById(sl.id);
    if (!container) return;

    const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b0e14);
    const camera=new THREE.PerspectiveCamera(60,1,0.01,1000); camera.position.set(1,0.6,1.5);
    const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.outputColorSpace=THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    ['pointerdown','pointerup','pointermove','wheel','touchstart','touchend','mousedown','mouseup','mousemove','click']
      .forEach(ev=>renderer.domElement.addEventListener(ev, ev2=>ev2.stopPropagation(), {passive:false}));

    const controls=new OrbitControls(camera,renderer.domElement); controls.enableDamping=true;
    scene.add(new THREE.AmbientLight(0xffffff,0.6));
    const dir=new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(2,2,2); scene.add(dir);

    const loader=new STLLoader();
    loader.load(sl.src,(geo)=>{
      const mat=new THREE.MeshStandardMaterial({color:0x9aa7c7,roughness:.8,metalness:.1});
      const mesh=new THREE.Mesh(geo,mat);
      if(geo.computeVertexNormals) geo.computeVertexNormals();
      scene.add(mesh);
      const box=new THREE.Box3().setFromObject(mesh);
      const size=box.getSize(new THREE.Vector3());
      const center=box.getCenter(new THREE.Vector3());
      mesh.position.sub(center);
      camera.position.set(size.x*1.2+0.6, size.y*1.2+0.4, size.z*1.5+0.8);
      controls.update();
    });

    function resize(){
      const w=container.clientWidth||container.offsetWidth||600;
      const h=container.clientHeight||420;
      renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix();
    }
    new ResizeObserver(resize).observe(container); resize();

    (function loop(){ requestAnimationFrame(loop); controls.update(); renderer.render(scene,camera); })();
  }

  // ---------- download counter (free items) ----------
  const btnDownload = document.getElementById('btnDownload');
  const btnZipOnly  = document.getElementById('btnZipOnly');
  async function trackAndGo(a){
    if (!a) return;
    try { await fetch(`/api/item/{{ item.id }}/download`, {method:'POST'}); } catch(e){}
    window.location.href = a.href;
  }
  if (btnDownload) btnDownload.addEventListener('click', (e)=>{ e.preventDefault(); trackAndGo(btnDownload); });
  if (btnZipOnly)  btnZipOnly.addEventListener('click', (e)=>{ e.preventDefault(); trackAndGo(btnZipOnly ); });
</script>
{% endblock %}
