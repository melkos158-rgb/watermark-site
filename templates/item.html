{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ item.title if item else "STL –º–æ–¥–µ–ª—å" }}</title>

  <style>
    :root{
      --bg:#0f1116;--card:#141923;--line:#232a3a;
      --text:#e7ebf4;--muted:#8993a8;--accent:#3b82f6;
    }
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:15px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .back{color:var(--muted);display:inline-block;margin-bottom:12px;}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:12px;
      padding:14px;margin-bottom:20px;
    }
    .flex{display:flex;gap:16px;flex-wrap:wrap;}
    .imgbox{
      flex:1 1 350px;min-width:300px;
    }
    .thumb{
      width:100%;border-radius:10px;object-fit:cover;
    }
    .viewer{
      width:100%;height:350px;background:#111;border-radius:10px;
      margin-top:10px;overflow:hidden;border:1px solid var(--line);
    }
    .details{flex:1 1 300px;display:flex;flex-direction:column;gap:8px;}
    .title{font-size:22px;font-weight:800;}
    .price{font-weight:700;color:var(--accent);}
    .tags{display:flex;gap:6px;flex-wrap:wrap;}
    .tag{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:13px;color:var(--muted);}
    .muted{color:var(--muted);font-size:13px;}
    .btn{
      background:var(--card);border:1px solid var(--line);
      color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;
      font-weight:600;
    }
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
    .btn:active{transform:scale(.97);}
    .author{
      display:flex;align-items:center;gap:10px;margin-top:12px;
      background:var(--card);border:1px solid var(--line);padding:10px;border-radius:10px;
    }
    .author img{width:48px;height:48px;border-radius:50%;object-fit:cover;}
    .stats{display:flex;gap:20px;margin-top:8px;color:var(--muted);font-size:14px;}
    @media(max-width:700px){
      .flex{flex-direction:column;}
      .viewer{height:300px;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- –§–Ü–ö–°: –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π endpoint —É blueprint "market" -->
  <a href="{{ url_for('market.page_market') }}" class="back">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Ä–∏–Ω–∫—É</a>

  <div class="card flex">
    <div class="imgbox">
      <img src="{{ item.cover or '/static/img/placeholder_stl.jpg' }}" alt="{{ item.title }}" class="thumb">
      <div class="viewer" id="viewer"></div>
    </div>
    <div class="details">
      <div class="title">{{ item.title }}</div>

      <div class="tags">
        {# —Ç–µ–≥–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Ä—è–¥–∫–æ–º "a,b,c" ‚Äî —Ä–æ–∑—ñ–±'—î–º–æ –ø–æ –∫–æ–º–∞—Ö–∞—Ö #}
        {% set _tags = (item.tags or '') %}
        {% for tag in (_tags.split(',') if _tags is string else _tags) %}
          {% if tag|string|trim %}
            <span class="tag">{{ tag|string|trim }}</span>
          {% endif %}
        {% endfor %}
      </div>

      <div class="price">
        {% if item.price == 0 %}
          –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ
        {% else %}
          {{ item.price }} PLN
        {% endif %}
      </div>

      <div class="muted">‚òÖ {{ item.rating if item.rating is not none else '‚Äî' }}</div>
      <p>{{ item.desc }}</p>

      <div class="stats">
        <div>üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å: {{ item.downloads or 0 }}</div>
        <div>üí∞ –ó–∞—Ä–æ–±—ñ—Ç–æ–∫: {{ item.earnings or 0 }} PLN</div>
        <div>üß© –ú–æ–¥–µ–ª–µ–π: {{ item.items_count or 0 }}</div>
      </div>

      {% if item.price == 0 %}
        <a href="{{ item.url }}" download class="btn primary">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ STL</a>
      {% else %}
        <button class="btn primary">üí≥ –ö—É–ø–∏—Ç–∏ STL</button>
      {% endif %}
    </div>
  </div>

  <div class="author">
    <img src="{{ item.author_avatar or '/static/img/user.jpg' }}" alt="–ê–≤—Ç–æ—Ä">
    <div>
      <div><strong>{{ item.author_name or '–ê–≤—Ç–æ—Ä' }}</strong></div>
      <div class="muted">{{ item.author_bio or '3D-–¥–∏–∑–∞–π–Ω–µ—Ä' }}</div>
    </div>
  </div>
</div>

<!-- 3D –ø–µ—Ä–µ–≥–ª—è–¥ STL -->
<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js';
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/controls/OrbitControls.js';
  import { STLLoader } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/STLLoader.js';

  const container = document.getElementById('viewer');
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);
  const camera = new THREE.PerspectiveCamera(60, 1, 0.01, 1000);
  camera.position.set(1, 0.6, 1.5);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  container.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(2,2,2);
  scene.add(dir);

  const loader = new STLLoader();
  loader.load("{{ item.url }}", (geo)=>{
    const mat = new THREE.MeshStandardMaterial({color:0x9aa7c7,roughness:.8,metalness:.1});
    const mesh = new THREE.Mesh(geo,mat);
    if (geo.computeVertexNormals) geo.computeVertexNormals();
    scene.add(mesh);

    const box = new THREE.Box3().setFromObject(mesh);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());
    mesh.position.sub(center);
    camera.position.set(size.x*1.2 + 0.6, size.y*1.2 + 0.4, size.z*1.5 + 0.8);
    controls.update();
  });

  function resize(){
    const w = container.clientWidth || container.offsetWidth;
    const h = container.clientHeight || 350;
    renderer.setSize(w,h,false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  new ResizeObserver(resize).observe(container); resize();

  (function loop(){ requestAnimationFrame(loop); controls.update(); renderer.render(scene,camera); })();
</script>
</body>
</html>
{% endblock %}
