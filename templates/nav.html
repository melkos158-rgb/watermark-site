<nav class="navbar">
  <div class="nav-wrap">
    <!-- БУРГЕР (видимий лише на мобілці) -->
    <button class="burger" id="burger" aria-label="Меню" aria-expanded="false">☰</button>

    <!-- ЛОГО + НАЗВА -->
    <a href="{{ url_for('index') }}" class="brand" aria-label="На головну">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
      <span class="wordmark" aria-label="Proofly">Proofly</span>
    </a>

    <!-- ЛІВІ КНОПКИ -->
    <a class="nav-btn {{ 'active' if request.endpoint=='index' else '' }}" href="{{ url_for('index') }}">Головна</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='stl' else '' }}" href="{{ url_for('stl') }}">STL3D</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='video' else '' }}" href="{{ url_for('video') }}">Video</a>

    <!-- DROPDOWN: Photo -->
    <div class="nav-dropdown" data-dd>
      <button
        class="nav-btn dd-trigger {{ 'active' if request.endpoint in ['photo','enhance','edit_photo'] else '' }}"
        type="button"
        aria-expanded="false"
      >
        Photo <span class="dd-caret" aria-hidden="true"></span>
      </button>
      <div class="dd-menu" role="menu">
        <a class="dd-item {{ 'active' if request.endpoint=='photo' else '' }}" href="{{ url_for('photo') }}">Photo — Gallery / Tools</a>
        <a class="dd-item {{ 'active' if request.endpoint=='enhance' else '' }}" href="{{ url_for('enhance') }}">Photo Enhance</a>
        <a class="dd-item {{ 'active' if request.endpoint=='edit_photo' else '' }}" href="{{ url_for('edit_photo') }}">Edit Photo</a>
      </div>
    </div>

    <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint=='market.page_market') else '' }}"
       href="{{ url_for('market.page_market') }}">Market</a>

    <!-- ПРАВИЙ БЛОК -->
    <div class="nav-right" style="display:flex; align-items:center; gap:10px; margin-left:auto">
      <select id="themeSelect" aria-label="Тема" class="theme-select">
        <option value="main">Main</option>
        <option value="cat">Cat</option>
        <option value="hellowen">Hellowen</option>
        <option value="minecraft">Minecraft</option>
      </select>

      {% set has_user =
           (g is defined and g.user) or
           (session and session.get('user_id')) or
           (current_user is defined and current_user.is_authenticated) %}

      {% if has_user %}
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('top100')) else '' }}"
           href="{{ url_for('profile.top100') }}">Top-100</a>
        <span class="sep" aria-hidden="true">|</span>
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('donate')) else '' }}"
           href="{{ url_for('profile.donate') }}">Donate</a>
        <span class="sep" aria-hidden="true">|</span>

        <a class="nav-btn {{ 'active' if (request.path == '/profile') else '' }}"
           href="/profile">Профіль</a>

        {% if session.is_admin %}
          <span class="sep" aria-hidden="true">|</span>
          <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint=='admin_panel') else '' }}"
             href="{{ url_for('admin_panel') }}">Admin</a>
        {% endif %}

        <span class="user-chip" style="opacity:.8">
          {{ (g.user.name if g is defined and g.user and g.user.name
              else (current_user.name if current_user is defined and current_user.is_authenticated and current_user.name
              else (g.user.email if g is defined and g.user and g.user.email
              else (current_user.email if current_user is defined and current_user.is_authenticated else '')))) }}
          {% if g is defined and g.user and (g.user.pxp is not none) %} • PXP: {{ g.user.pxp }}{% endif %}
        </span>

        <a class="nav-btn" href="{{ url_for('auth.logout') }}">Вийти</a>
      {% else %}
        <a class="nav-btn {{ 'active' if request.endpoint=='auth.login' else '' }}"
           href="{{ url_for('auth.login') }}">Увійти</a>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Портал для дропдаунів (щоб поверх усіх шарів) -->
<div id="nav-portal" style="position:fixed;left:0;top:0;width:0;height:0;z-index:2147483647;pointer-events:none;"></div>

<!-- ОВЕРЛЕЙ І ВИЇЗНЕ МЕНЮ ДЛЯ МОБІЛКИ -->
<div class="drawer-overlay" id="drawerOverlay" hidden></div>
<aside class="drawer" id="mobileMenu" aria-hidden="true">
  <div class="drawer-head">
    <button class="drawer-close" id="drawerClose" aria-label="Закрити">✕</button>
    <strong>Меню</strong>
  </div>

  <nav class="drawer-links">
    <a href="{{ url_for('index') }}"     class="{{ 'active' if request.endpoint=='index' else '' }}">Головна</a>
    <a href="{{ url_for('stl') }}"       class="{{ 'active' if request.endpoint=='stl' else '' }}">STL3D</a>
    <a href="{{ url_for('video') }}"     class="{{ 'active' if request.endpoint=='video' else '' }}">Video</a>
    <a href="{{ url_for('photo') }}"      class="{{ 'active' if request.endpoint=='photo' else '' }}">Photo — Gallery / Tools</a>
    <a href="{{ url_for('enhance') }}"    class="{{ 'active' if request.endpoint=='enhance' else '' }}">Photo Enhance</a>
    <a href="{{ url_for('edit_photo') }}" class="{{ 'active' if request.endpoint=='edit_photo' else '' }}">Edit Photo</a>
    <a href="{{ url_for('market.page_market') }}" class="{{ 'active' if (request.endpoint and request.endpoint=='market.page_market') else '' }}">Market</a>

    <hr>

    <div class="drawer-theme">
      <label for="themeSelectDrawer">Тема</label>
      <select id="themeSelectDrawer">
        <option value="main">Main</option>
        <option value="cat">Cat</option>
        <option value="hellowen">Hellowen</option>
        <option value="minecraft">Minecraft</option>
      </select>
    </div>

    <hr>

    {% if has_user %}
      <a href="{{ url_for('profile.top100') }}"  class="{{ 'active' if (request.endpoint and request.endpoint.endswith('top100')) else '' }}">Top-100</a>
      <a href="{{ url_for('profile.donate') }}"  class="{{ 'active' if (request.endpoint and request.endpoint.endswith('donate')) else '' }}">Donate</a>
      <a href="/profile"                         class="{{ 'active' if (request.path == '/profile') else '' }}">Профіль</a>
      {% if session.is_admin %}
        <a href="{{ url_for('admin_panel') }}"   class="{{ 'active' if (request.endpoint and request.endpoint=='admin_panel') else '' }}">Admin</a>
      {% endif %}
      <a href="{{ url_for('auth.logout') }}">Вийти</a>
    {% else %}
      <a href="{{ url_for('auth.login') }}" class="{{ 'active' if request.endpoint=='auth.login' else '' }}">Увійти</a>
    {% endif %}
  </nav>
</aside>

<script>
  (function(){
    var THEME_MAP = {
      main:      "{{ url_for('static', filename='themes/main.css') }}",
      cat:       "{{ url_for('static', filename='themes/cat.css') }}",
      hellowen:  "{{ url_for('static', filename='themes/hellowen.css') }}",
      minecraft: "{{ url_for('static', filename='themes/minecraft.css') }}"
    };

    function applyTheme(v){
      var base = THEME_MAP[v] || THEME_MAP.main;
      var head = document.getElementsByTagName('head')[0];
      var old  = document.getElementById('theme-css');

      var link = document.createElement('link');
      link.rel  = 'stylesheet';
      link.id   = 'theme-css';
      link.href = base + '?v=' + Date.now();

      if (old && old.parentNode) old.parentNode.removeChild(old);
      head.appendChild(link);

      localStorage.setItem('theme', v);
      document.documentElement.setAttribute('data-theme', v);
    }

    var select = document.getElementById('themeSelect');
    var saved  = localStorage.getItem('theme') || 'main';
    if (select) select.value = (saved in THEME_MAP) ? saved : 'main';
    applyTheme(saved);
    if (select) select.addEventListener('change', function(){ applyTheme(this.value); });

    var selectDrawer = document.getElementById('themeSelectDrawer');
    if (selectDrawer){
      selectDrawer.value = localStorage.getItem('theme') || 'main';
      selectDrawer.addEventListener('change', function(){
        applyTheme(this.value);
        if (select) select.value = this.value;
      });
    }

    var burger = document.getElementById('burger');
    var drawer = document.getElementById('mobileMenu');
    var overlay= document.getElementById('drawerOverlay');
    var close  = document.getElementById('drawerClose');

    function openDrawer(){
      drawer.classList.add('open');
      overlay.hidden = false;
      document.body.style.overflow = 'hidden';
      burger.setAttribute('aria-expanded','true');
      drawer.setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      overlay.hidden = true;
      document.body.style.overflow = '';
      burger.setAttribute('aria-expanded','false');
      drawer.setAttribute('aria-hidden','true');
    }

    burger && burger.addEventListener('click', openDrawer);
    overlay && overlay.addEventListener('click', closeDrawer);
    close && close.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && drawer.classList.contains('open')) closeDrawer();
    });
  })();

  /* Дропдаун Photo — портал у body, щоб НІХТО його не перекривав */
  (function(){
    var root   = document.querySelector('[data-dd]');
    if(!root) return;

    var btn    = root.querySelector('.dd-trigger');
    var menu   = root.querySelector('.dd-menu');
    var portal = document.getElementById('nav-portal');
    var inPortal = false;

    function placeMenu(){
      if(!btn || !menu || !portal) return;
      var r = btn.getBoundingClientRect();
      portal.style.pointerEvents = 'none';
      menu.style.position = 'fixed';
      menu.style.left = r.left + 'px';
      menu.style.top  = (r.bottom + 6) + 'px';
      menu.style.display = 'block';
      menu.style.zIndex  = '2147483647';
      portal.appendChild(menu);
      inPortal = true;
      btn.setAttribute('aria-expanded','true');
    }

    function restoreMenu(){
      if(inPortal && root && menu){
        menu.removeAttribute('style');
        root.appendChild(menu);
      }
      inPortal = false;
      btn && btn.setAttribute('aria-expanded','false');
      root.classList.remove('open');
    }

    function toggle(){
      if(inPortal){ restoreMenu(); }
      else { root.classList.add('open'); placeMenu(); }
    }

    btn && btn.addEventListener('click', function(e){
      e.stopPropagation();
      toggle();
    });

    // Закриття при кліку поза меню
    document.addEventListener('click', function(e){
      if(!inPortal) return;
      if(menu && !menu.contains(e.target) && btn && !btn.contains(e.target)){
        restoreMenu();
      }
    });

    // Закриття по Escape
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape') restoreMenu();
    });

    // Підлаштувати позицію при скролі/ресайзі
    ['scroll','resize'].forEach(ev=>{
      window.addEventListener(ev, function(){
        if(!inPortal) return;
        placeMenu();
      }, { passive:true });
    });
  })();
</script>

{% if request.endpoint not in ["auth.login", "auth.register", "auth.logout"] %}
  {% include "chat.html" %}
{% endif %}

<style>
/* ====== НАВІГАЦІЯ ====== */
.navbar{
  position:sticky;
  top:0;
  z-index:2147483647;
  background:#0b0d12;
  border-bottom:1px solid #1b2131;
  overflow:visible;
  isolation:isolate;
}
.nav-wrap{
  max-width:1368px;
  margin:0 auto;
  display:flex;
  align-items:center;
  flex-wrap:nowrap;
  white-space:nowrap;
  gap:6px;
  padding:6px 10px 6px 4px;
  min-height:72px;
  overflow-x:auto;
  overflow-y:visible;
}

/* бургер (десктоп приховано) */
.burger{
  display:none;
  font-size:20px;line-height:1;
  border:1px solid #1b2131;background:transparent;color:#e8eaed;
  border-radius:10px;width:38px;height:38px;cursor:pointer
}

/* ЛОГО + НАЗВА */
.brand{display:flex;align-items:center;gap:8px;padding:0 2px;border-radius:10px;border:1px solid transparent;text-decoration:none}
.brand img{height:44px;width:auto;display:block;object-fit:contain;filter:drop-shadow(0 4px 10px rgba(173,92,255,.25))}
.wordmark{
  font-weight:900;letter-spacing:.25px;line-height:1;font-size:22px;text-transform:capitalize;
  background:linear-gradient(90deg,#ff3cac 0%, #784ba0 45%, #2b86c5 100%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 12px rgba(123,162,255,.22);
  transition:transform .15s ease, letter-spacing .15s ease, filter .15s ease;
}
.brand:hover .wordmark{transform:translateY(-1px);letter-spacing:.4px;filter:brightness(1.08)}

/* КНОПКИ */
.nav-btn{ padding:7px 11px !important; font-size:14.5px !important; margin:0 !important; white-space:nowrap; }

/* селект теми */
.theme-select{ height:30px; border-radius:8px; padding:0 8px; font-size:14px; background:transparent; color:#e8eaed; border:1px solid #1b2131; }

/* роздільники */
.sep{opacity:.7}

/* правий блок */
.nav-right{gap:8px !important}

/* Dropdown (базові стилі) — тепер реальне меню летить у портал, тож тут лиш мінімум */
.nav-dropdown{ position:relative; display:inline-block; }
.dd-trigger{ display:inline-flex; align-items:center; gap:6px; }
.dd-caret{
  display:inline-block; width:0; height:0;
  border-left:5px solid transparent; border-right:5px solid transparent;
  border-top:6px solid var(--text, #e8eaed);
  transition:transform .15s ease;
}
.nav-dropdown.open .dd-caret{ transform:rotate(180deg); }

.dd-menu{
  /* ці властивості будуть перезаписані JS (fixed + координати) */
  background:var(--card, #101522);
  border:1px solid #1b2131;
  border-radius:10px;
  padding:6px;
  box-shadow:0 8px 24px rgba(0,0,0,.35);
  display:none;
}
.dd-item{ display:block; padding:10px 12px; border-radius:8px; color:var(--text, #e8eaed); text-decoration:none; white-space:nowrap; }
.dd-item:hover{ background:var(--chip, #182034); }

/* При малій ширині — моб. варіант */
@media (max-width: 1360px){
  .user-chip{display:none}
  .sep{display:none}
}
@media (max-width: 1280px){
  .nav-btn{padding:6px 10px !important;font-size:14px !important}
  .brand img{height:42px}
  .wordmark{font-size:21px}
}
@media (max-width: 768px){
  .nav-wrap > .nav-btn, .nav-right, .nav-dropdown{ display:none !important; }
  .burger{ display:inline-flex; align-items:center; justify-content:center; }
  .brand img{height:38px}
  .wordmark{font-size:20px}
  .nav-wrap{ min-height:64px; padding-left:8px; }
}
@media (min-width: 769px){
  .drawer, .drawer-overlay{ display:none !important; }
}
</style>
