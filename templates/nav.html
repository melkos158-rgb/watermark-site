<nav class="navbar">
  <div class="nav-wrap">
    <!-- ЛІВО: завжди видимі -->
    <a class="nav-btn {{ 'active' if request.endpoint=='index' else '' }}" href="{{ url_for('index') }}">Головна</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='stl' else '' }}" href="{{ url_for('stl') }}">STL3D</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='video' else '' }}" href="{{ url_for('video') }}">Video</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='enhance' else '' }}" href="{{ url_for('enhance') }}">Photo Enhance</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='edit_photo' else '' }}" href="{{ url_for('edit_photo') }}">Edit Photo</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='photo' else '' }}" href="{{ url_for('photo') }}">Photo</a>

    <!-- ПРАВО: перемикач тем + вкладки після входу -->
    <div style="display:flex; align-items:center; gap:12px; margin-left:auto">
      <!-- Перемикач тем -->
      <select id="themeSelect" aria-label="Тема" style="height:32px; border-radius:8px; padding:0 8px;">
        <option value="main">Main</option>
        <option value="cat">Cat</option>
        <option value="hellowen">Hellowen</option>
        <option value="minecraft">Minecraft</option>
      </select>

      {% set has_user =
           (g is defined and g.user) or
           (session and session.get('user_id')) or
           (current_user is defined and current_user.is_authenticated) %}

      {% if has_user %}
        <!-- Top-100 / Donate у blueprint 'profile' -->
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('top100')) else '' }}"
           href="{{ url_for('profile.top100') }}">Top-100</a>
        <span aria-hidden="true">|</span>
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('donate')) else '' }}"
           href="{{ url_for('profile.donate') }}">Donate</a>
        <span aria-hidden="true">|</span>

        <!-- Профіль: прямий шлях -->
        <a class="nav-btn {{ 'active' if (request.path == '/profile') else '' }}"
           href="/profile">Профіль</a>

        <!-- (NEW) Спроба додати банер (працює лише для ТОП-1; іншим бекенд відмовить коректно) -->
        <span aria-hidden="true">|</span>
        <a class="nav-btn" href="{{ url_for('ad_upload') }}">Додати банер</a>

        <!-- (NEW) Посилання на адмінку тільки для адміністратора -->
        {% if session.is_admin %}
          <span aria-hidden="true">|</span>
          <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint=='admin_panel') else '' }}"
             href="{{ url_for('admin_panel') }}">Admin</a>
        {% endif %}

        <span style="opacity:.8">
          {{ (g.user.name if g is defined and g.user and g.user.name
              else (current_user.name if current_user is defined and current_user.is_authenticated and current_user.name
              else (g.user.email if g is defined and g.user and g.user.email
              else (current_user.email if current_user is defined and current_user.is_authenticated else '')))) }}
          {% if g is defined and g.user and (g.user.pxp is not none) %} • PXP: {{ g.user.pxp }}{% endif %}
        </span>

        <a class="nav-btn" href="{{ url_for('auth.logout') }}">Вийти</a>
      {% else %}
        <a class="nav-btn {{ 'active' if request.endpoint=='auth.login' else '' }}"
           href="{{ url_for('auth.login') }}">Увійти</a>
      {% endif %}
    </div>
  </div>
</nav>

<script>
  (function(){
    var THEME_MAP = {
      main:      "{{ url_for('static', filename='themes/main.css') }}",
      cat:       "{{ url_for('static', filename='themes/cat.css') }}",
      hellowen:  "{{ url_for('static', filename='themes/hellowen.css') }}",
      minecraft: "{{ url_for('static', filename='themes/minecraft.css') }}"
    };

    var select = document.getElementById('themeSelect');
    var saved  = localStorage.getItem('theme') || 'main';
    if (select) select.value = (saved in THEME_MAP) ? saved : 'main';

    function applyTheme(v){
      var base = THEME_MAP[v] || THEME_MAP.main;
      var head = document.getElementsByTagName('head')[0];
      var old  = document.getElementById('theme-css');

      // створюємо новий <link>, щоб він став ОСТАННІМ у <head> (найвища пріоритетність)
      var link = document.createElement('link');
      link.rel  = 'stylesheet';
      link.id   = 'theme-css';
      link.href = base + '?v=' + Date.now(); // кеш-бастер

      if (old && old.parentNode) old.parentNode.removeChild(old);
      head.appendChild(link);

      localStorage.setItem('theme', v);
      document.documentElement.setAttribute('data-theme', v);
    }

    // одразу застосувати збережену тему
    applyTheme(saved);

    if (select) {
      select.addEventListener('change', function(){
        applyTheme(this.value);
      });
    }
  })();
</script>
