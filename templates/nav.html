<nav class="navbar">
  <div class="nav-wrap">
    <!-- –õ–Ü–í–û: –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º—ñ -->
    <a class="nav-btn {{ 'active' if request.endpoint=='index' else '' }}" href="{{ url_for('index') }}">–ì–æ–ª–æ–≤–Ω–∞</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='stl' else '' }}" href="{{ url_for('stl') }}">STL3D</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='video' else '' }}" href="{{ url_for('video') }}">Video</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='enhance' else '' }}" href="{{ url_for('enhance') }}">Photo Enhance</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='edit_photo' else '' }}" href="{{ url_for('edit_photo') }}">Edit Photo</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='photo' else '' }}" href="{{ url_for('photo') }}">Photo</a>

    <!-- –ü–†–ê–í–û: –ø–µ—Ä–µ–º–∏–∫–∞—á —Ç–µ–º + –≤–∫–ª–∞–¥–∫–∏ –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É -->
    <div style="display:flex; align-items:center; gap:12px; margin-left:auto">
      <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Ç–µ–º -->
      <select id="themeSelect" aria-label="–¢–µ–º–∞" style="height:32px; border-radius:8px; padding:0 8px;">
        <option value="main">Main</option>
        <option value="cat">Cat</option>
        <option value="hellowen">Hellowen</option>
        <option value="minecraft">Minecraft</option>
      </select>

      {% set has_user =
           (g is defined and g.user) or
           (session and session.get('user_id')) or
           (current_user is defined and current_user.is_authenticated) %}

      {% if has_user %}
        <!-- Top-100 / Donate —É blueprint 'profile' -->
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('top100')) else '' }}"
           href="{{ url_for('profile.top100') }}">Top-100</a>
        <span aria-hidden="true">|</span>
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('donate')) else '' }}"
           href="{{ url_for('profile.donate') }}">Donate</a>
        <span aria-hidden="true">|</span>

        <!-- –ü—Ä–æ—Ñ—ñ–ª—å: –ø—Ä—è–º–∏–π —à–ª—è—Ö -->
        <a class="nav-btn {{ 'active' if (request.path == '/profile') else '' }}"
           href="/profile">–ü—Ä–æ—Ñ—ñ–ª—å</a>

        <!-- Admin —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        {% if session.is_admin %}
          <span aria-hidden="true">|</span>
          <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint=='admin_panel') else '' }}"
             href="{{ url_for('admin_panel') }}">Admin</a>
        {% endif %}

        <span style="opacity:.8">
          {{ (g.user.name if g is defined and g.user and g.user.name
              else (current_user.name if current_user is defined and current_user.is_authenticated and current_user.name
              else (g.user.email if g is defined and g.user and g.user.email
              else (current_user.email if current_user is defined and current_user.is_authenticated else '')))) }}
          {% if g is defined and g.user and (g.user.pxp is not none) %} ‚Ä¢ PXP: {{ g.user.pxp }}{% endif %}
        </span>

        <a class="nav-btn" href="{{ url_for('auth.logout') }}">–í–∏–π—Ç–∏</a>
      {% else %}
        <a class="nav-btn {{ 'active' if request.endpoint=='auth.login' else '' }}"
           href="{{ url_for('auth.login') }}">–£–≤—ñ–π—Ç–∏</a>
      {% endif %}
    </div>
  </div>
</nav>

<script>
  (function(){
    var THEME_MAP = {
      main:      "{{ url_for('static', filename='themes/main.css') }}",
      cat:       "{{ url_for('static', filename='themes/cat.css') }}",
      hellowen:  "{{ url_for('static', filename='themes/hellowen.css') }}",
      minecraft: "{{ url_for('static', filename='themes/minecraft.css') }}"
    };

    var select = document.getElementById('themeSelect');
    var saved  = localStorage.getItem('theme') || 'main';
    if (select) select.value = (saved in THEME_MAP) ? saved : 'main';

    function applyTheme(v){
      var base = THEME_MAP[v] || THEME_MAP.main;
      var head = document.getElementsByTagName('head')[0];
      var old  = document.getElementById('theme-css');

      // —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π <link>, —â–æ–± –≤—ñ–Ω —Å—Ç–∞–≤ –û–°–¢–ê–ù–ù–Ü–ú —É <head> (–Ω–∞–π–≤–∏—â–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—Å—Ç—å)
      var link = document.createElement('link');
      link.rel  = 'stylesheet';
      link.id   = 'theme-css';
      link.href = base + '?v=' + Date.now(); // –∫–µ—à-–±–∞—Å—Ç–µ—Ä

      if (old && old.parentNode) old.parentNode.removeChild(old);
      head.appendChild(link);

      localStorage.setItem('theme', v);
      document.documentElement.setAttribute('data-theme', v);
    }

    // –æ–¥—Ä–∞–∑—É –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—É —Ç–µ–º—É
    applyTheme(saved);

    if (select) {
      select.addEventListener('change', function(){
        applyTheme(this.value);
      });
    }
  })();
</script>

{# ====== –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –ß–ê–¢: –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—Ä—ñ–∑—å, –æ–∫—Ä—ñ–º login/register/logout ====== #}
{% if request.endpoint not in ["auth.login", "auth.register", "auth.logout"] %}
  <style>
    /* ===== Telegram-like chat ===== */
    .chat-fab{
      position:fixed; left:16px; bottom:calc(env(safe-area-inset-bottom) + 16px);
      width:52px;height:52px;border-radius:50%;
      border:1px solid var(--line); background:var(--card); color:var(--ink);
      display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9999;
      box-shadow:0 8px 24px rgba(0,0,0,.35); font-size:22px;
    }
    .chat-fab:hover{ filter:brightness(1.05) }

    .chat-panel{
      position:fixed; left:16px; bottom:calc(env(safe-area-inset-bottom) + 78px);
      width:340px; max-height:480px; z-index:9999; overflow:hidden;
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.45); display:none;
    }
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--nav-bg);border-bottom:1px solid var(--line)}
    .chat-head b{font-size:14px}

    .chat-body{
      height:340px; overflow:auto; padding:12px 12px 10px;
      display:flex; flex-direction:column; gap:10px;
      background:
        radial-gradient(1200px 500px at 100% -20%, rgba(255,255,255,.04), transparent 60%),
        radial-gradient(1200px 600px at -30% 110%, rgba(255,255,255,.04), transparent 60%),
        var(--card);
    }

    .chat-row{ display:flex; align-items:flex-end; gap:8px; max-width:92%; }
    .chat-row.me{ margin-left:auto; justify-content:flex-end; }

    .chat-avatar{
      width:28px;height:28px;border-radius:50%;object-fit:cover;
      flex:0 0 28px;background:#2a2f3b;border:1px solid var(--line);
    }

    .chat-bubble{
      position:relative;
      padding:8px 36px 8px 10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;             /* —á—É–∂—ñ */
      color:#111;
      box-shadow:0 1px 2px rgba(0,0,0,.12);
      line-height:1.28;
      word-break:break-word;
      white-space:pre-wrap;
    }
    .chat-row.me .chat-bubble{
      background:#5ec06a;          /* —Å–≤–æ—ó */
      border-color:rgba(0,0,0,.15);
      color:#fff;
    }

    .chat-bubble:after{
      content:"";
      position:absolute; bottom:-1px; left:-6px;
      width:12px;height:12px;
      background:inherit;
      border-left:1px solid var(--line);
      border-bottom:1px solid var(--line);
      transform:rotate(45deg);
      border-bottom-left-radius:3px;
    }
    .chat-row.me .chat-bubble:after{
      left:auto; right:-6px;
      border-left:none; border-bottom:none;
      border-right:1px solid rgba(0,0,0,.15);
      border-top:1px solid rgba(0,0,0,.15);
    }

    .chat-meta{ display:flex; align-items:center; gap:6px; margin:0 0 2px; font-size:12px; opacity:.9; }
    .chat-name{ font-weight:600; color:#2b6fb8; text-decoration:none; }
    .chat-row.me .chat-name{ color:#eaf7ff; }

    .chat-time{
      position:absolute; right:10px; bottom:6px;
      font-size:11px; opacity:.85; color:inherit;
      font-variant-numeric: tabular-nums;
    }

    .chat-form{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--card)}
    .chat-form input{flex:1;background:var(--bg);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;outline:none}
    .chat-form button{background:var(--btn);border:0;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}

    @media (max-width:700px){
      .chat-panel{ width:min(94vw, 360px); }
      .chat-fab{ left:12px; }
    }
  </style>

  <!-- FAB —ñ –ø–∞–Ω–µ–ª—å -->
  <div class="chat-fab" id="chatFab" title="–ß–∞—Ç">üí¨</div>
  <div class="chat-panel" id="chatPanel" aria-live="polite"
       data-uid="{{ (g.user.id if g is defined and g.user else (current_user.id if current_user is defined and current_user.is_authenticated else '')) }}">
    <div class="chat-head">
      <b>–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç</b>
      <button id="chatClose" style="background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:16px">‚úï</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <form class="chat-form" id="chatForm" autocomplete="off">
      <input id="chatInput" type="text" maxlength="500" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" />
      <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    </form>
  </div>

  <script>
    (function(){
      const API_FETCH = "/chat/fetch";
      const API_POST  = "/chat/post";
      const fab   = document.getElementById("chatFab");
      const panel = document.getElementById("chatPanel");
      const close = document.getElementById("chatClose");
      const body  = document.getElementById("chatBody");
      const form  = document.getElementById("chatForm");
      const input = document.getElementById("chatInput");

      const CURRENT_UID = panel?.getAttribute('data-uid') || "";
      let lastId = null;
      let timer  = null;

      function esc(s){return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
      function avatarFor(){ return "/static/default-avatar.png"; } // –ø—ñ–¥—Å—Ç–∞–≤–∏—à url –∞–≤–∞—Ç–∞—Ä–∞, –∫–æ–ª–∏ –¥–æ–¥–∞—Å–∏ –≤ DTO

      function append(msg){
        const isMe = (msg.user_id != null && String(msg.user_id) === String(CURRENT_UID));

        const row = document.createElement("div");
        row.className = "chat-row" + (isMe ? " me" : "");

        const avatar = document.createElement("img");
        avatar.className = "chat-avatar";
        avatar.src = avatarFor(msg);
        avatar.alt = "avatar";

        const bubble = document.createElement("div");
        bubble.className = "chat-bubble";
        bubble.innerHTML = `
          <div class="chat-meta">
            <a class="chat-name" href="/profile/${msg.user_id || ''}" ${msg.user_id? '' : 'tabindex="-1"'}>${esc(msg.user_name||"–ì—ñ—Å—Ç—å")}</a>
          </div>
          <div class="chat-text">${esc(msg.text||"")}</div>
          <span class="chat-time">${esc(msg.time||"")}</span>
        `;

        if (isMe) {
          row.appendChild(bubble);   // —Å–≤–æ—ó: –±—É–ª—å–±–∞—à–∫–∞ –ª—ñ–≤—ñ—à–µ, –∞–≤–∞—Ç–∞—Ä –ø—Ä–∞–≤–æ—Ä—É—á
          row.appendChild(avatar);
        } else {
          row.appendChild(avatar);   // —á—É–∂—ñ: –∞–≤–∞—Ç–∞—Ä –ª—ñ–≤–æ—Ä—É—á
          row.appendChild(bubble);
        }

        body.appendChild(row);
        body.scrollTop = body.scrollHeight;
        lastId = msg.id;
      }

      function fetchInit(){
        fetch(API_FETCH).then(r=>r.json()).then(d=>{
          if(!d.ok) return;
          body.innerHTML = "";
          d.messages.forEach(append);
        }).catch(()=>{});
      }
      function fetchNew(){
        const url = lastId ? `${API_FETCH}?since_id=${lastId}` : API_FETCH;
        fetch(url).then(r=>r.json()).then(d=>{
          if(!d.ok) return;
          d.messages.forEach(append);
        }).catch(()=>{});
      }

      fab.onclick = () => {
        panel.style.display = "block";
        if(!timer){
          fetchInit();
          timer = setInterval(fetchNew, 2500);
        }
      };
      close.onclick = () => {
        panel.style.display = "none";
        if(timer){ clearInterval(timer); timer = null; }
      };

      form.addEventListener("submit", (e)=>{
        e.preventDefault();
        const text = input.value.trim();
        if(!text) return;
        input.value = "";
        fetch(API_POST, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ text })
        }).then(r=>r.json()).then(()=>{ fetchNew(); }).catch(()=>{});
      });
    })();
  </script>
{% endif %}
