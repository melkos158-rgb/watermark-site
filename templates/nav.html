<nav class="navbar">
  <div class="nav-wrap">
    <!-- БУРГЕР (видимий лише на мобілці) -->
    <button class="burger" id="burger" aria-label="Меню" aria-expanded="false">☰</button>

    <!-- ЛОГО -->
    <a href="{{ url_for('index') }}" class="brand" aria-label="На головну">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
    </a>

    <!-- ЛІВО: завжди видимі -->
    <a class="nav-btn {{ 'active' if request.endpoint=='index' else '' }}" href="{{ url_for('index') }}">Головна</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='stl' else '' }}" href="{{ url_for('stl') }}">STL3D</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='video' else '' }}" href="{{ url_for('video') }}">Video</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='enhance' else '' }}" href="{{ url_for('enhance') }}">Photo Enhance</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='edit_photo' else '' }}" href="{{ url_for('edit_photo') }}">Edit Photo</a>
    <a class="nav-btn {{ 'active' if request.endpoint=='photo' else '' }}" href="{{ url_for('photo') }}">Photo</a>

    <!-- Market -->
    <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint=='market.page_market') else '' }}"
       href="{{ url_for('market.page_market') }}">Market</a>

    <!-- ПРАВО: перемикач тем + вкладки після входу -->
    <div class="nav-right" style="display:flex; align-items:center; gap:12px; margin-left:auto">
      <!-- Перемикач тем -->
      <select id="themeSelect" aria-label="Тема" style="height:32px; border-radius:8px; padding:0 8px;">
        <option value="main">Main</option>
        <option value="cat">Cat</option>
        <option value="hellowen">Hellowen</option>
        <option value="minecraft">Minecraft</option>
      </select>

      {% set has_user =
           (g is defined and g.user) or
           (session and session.get('user_id')) or
           (current_user is defined and current_user.is_authenticated) %}

      {% if has_user %}
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('top100')) else '' }}"
           href="{{ url_for('profile.top100') }}">Top-100</a>
        <span aria-hidden="true">|</span>
        <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint.endswith('donate')) else '' }}"
           href="{{ url_for('profile.donate') }}">Donate</a>
        <span aria-hidden="true">|</span>

        <a class="nav-btn {{ 'active' if (request.path == '/profile') else '' }}"
           href="/profile">Профіль</a>

        {% if session.is_admin %}
          <span aria-hidden="true">|</span>
          <a class="nav-btn {{ 'active' if (request.endpoint and request.endpoint=='admin_panel') else '' }}"
             href="{{ url_for('admin_panel') }}">Admin</a>
        {% endif %}

        <span style="opacity:.8">
          {{ (g.user.name if g is defined and g.user and g.user.name
              else (current_user.name if current_user is defined and current_user.is_authenticated and current_user.name
              else (g.user.email if g is defined and g.user and g.user.email
              else (current_user.email if current_user is defined and current_user.is_authenticated else '')))) }}
          {% if g is defined and g.user and (g.user.pxp is not none) %} • PXP: {{ g.user.pxp }}{% endif %}
        </span>

        <a class="nav-btn" href="{{ url_for('auth.logout') }}">Вийти</a>
      {% else %}
        <a class="nav-btn {{ 'active' if request.endpoint=='auth.login' else '' }}"
           href="{{ url_for('auth.login') }}">Увійти</a>
      {% endif %}
    </div>
  </div>
</nav>

<!-- ОВЕРЛЕЙ І ВИЇЗНЕ МЕНЮ ДЛЯ МОБІЛКИ -->
<div class="drawer-overlay" id="drawerOverlay" hidden></div>
<aside class="drawer" id="mobileMenu" aria-hidden="true">
  <div class="drawer-head">
    <button class="drawer-close" id="drawerClose" aria-label="Закрити">✕</button>
    <strong>Меню</strong>
  </div>

  <nav class="drawer-links">
    <a href="{{ url_for('index') }}"     class="{{ 'active' if request.endpoint=='index' else '' }}">Головна</a>
    <a href="{{ url_for('stl') }}"       class="{{ 'active' if request.endpoint=='stl' else '' }}">STL3D</a>
    <a href="{{ url_for('video') }}"     class="{{ 'active' if request.endpoint=='video' else '' }}">Video</a>
    <a href="{{ url_for('enhance') }}"   class="{{ 'active' if request.endpoint=='enhance' else '' }}">Photo Enhance</a>
    <a href="{{ url_for('edit_photo') }}"class="{{ 'active' if request.endpoint=='edit_photo' else '' }}">Edit Photo</a>
    <a href="{{ url_for('photo') }}"     class="{{ 'active' if request.endpoint=='photo' else '' }}">Photo</a>
    <a href="{{ url_for('market.page_market') }}" class="{{ 'active' if (request.endpoint and request.endpoint=='market.page_market') else '' }}">Market</a>

    <hr>

    <div class="drawer-theme">
      <label for="themeSelectDrawer">Тема</label>
      <select id="themeSelectDrawer">
        <option value="main">Main</option>
        <option value="cat">Cat</option>
        <option value="hellowen">Hellowen</option>
        <option value="minecraft">Minecraft</option>
      </select>
    </div>

    <hr>

    {% if has_user %}
      <a href="{{ url_for('profile.top100') }}"  class="{{ 'active' if (request.endpoint and request.endpoint.endswith('top100')) else '' }}">Top-100</a>
      <a href="{{ url_for('profile.donate') }}"  class="{{ 'active' if (request.endpoint and request.endpoint.endswith('donate')) else '' }}">Donate</a>
      <a href="/profile"                         class="{{ 'active' if (request.path == '/profile') else '' }}">Профіль</a>
      {% if session.is_admin %}
        <a href="{{ url_for('admin_panel') }}"   class="{{ 'active' if (request.endpoint and request.endpoint=='admin_panel') else '' }}">Admin</a>
      {% endif %}
      <a href="{{ url_for('auth.logout') }}">Вийти</a>
    {% else %}
      <a href="{{ url_for('auth.login') }}" class="{{ 'active' if request.endpoint=='auth.login' else '' }}">Увійти</a>
    {% endif %}
  </nav>
</aside>

<script>
  (function(){
    /* ===== ТЕМИ ===== */
    var THEME_MAP = {
      main:      "{{ url_for('static', filename='themes/main.css') }}",
      cat:       "{{ url_for('static', filename='themes/cat.css') }}",
      hellowen:  "{{ url_for('static', filename='themes/hellowen.css') }}",
      minecraft: "{{ url_for('static', filename='themes/minecraft.css') }}"
    };

    function applyTheme(v){
      var base = THEME_MAP[v] || THEME_MAP.main;
      var head = document.getElementsByTagName('head')[0];
      var old  = document.getElementById('theme-css');

      var link = document.createElement('link');
      link.rel  = 'stylesheet';
      link.id   = 'theme-css';
      link.href = base + '?v=' + Date.now();

      if (old && old.parentNode) old.parentNode.removeChild(old);
      head.appendChild(link);

      localStorage.setItem('theme', v);
      document.documentElement.setAttribute('data-theme', v);
    }

    var select = document.getElementById('themeSelect');
    var saved  = localStorage.getItem('theme') || 'main';
    if (select) select.value = (saved in THEME_MAP) ? saved : 'main';
    applyTheme(saved);
    if (select) {
      select.addEventListener('change', function(){ applyTheme(this.value); });
    }

    /* ===== ДУБЛЮЄМО В ДРОВЕРІ ===== */
    var selectDrawer = document.getElementById('themeSelectDrawer');
    if (selectDrawer){
      selectDrawer.value = localStorage.getItem('theme') || 'main';
      selectDrawer.addEventListener('change', function(){
        applyTheme(this.value);
        if (select) select.value = this.value;
      });
    }

    /* ===== БУРГЕР / ДРОВЕР ===== */
    var burger = document.getElementById('burger');
    var drawer = document.getElementById('mobileMenu');
    var overlay= document.getElementById('drawerOverlay');
    var close  = document.getElementById('drawerClose');

    function openDrawer(){
      drawer.classList.add('open');
      overlay.hidden = false;
      document.body.style.overflow = 'hidden';
      burger.setAttribute('aria-expanded','true');
      drawer.setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      overlay.hidden = true;
      document.body.style.overflow = '';
      burger.setAttribute('aria-expanded','false');
      drawer.setAttribute('aria-hidden','true');
    }

    burger && burger.addEventListener('click', openDrawer);
    overlay && overlay.addEventListener('click', closeDrawer);
    close && close.addEventListener('click', closeDrawer);

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && drawer.classList.contains('open')) closeDrawer();
    });
  })();
</script>

{% if request.endpoint not in ["auth.login", "auth.register", "auth.logout"] %}
  {% include "chat.html" %}
{% endif %}

<style>
/* ====== НАВІГАЦІЯ ====== */
.navbar{position:sticky;top:0;z-index:50;background:#0b0d12;border-bottom:1px solid #1b2131}
.nav-wrap{
  max-width:1120px;
  margin:0 auto;
  display:flex;
  align-items:center;
  gap:14px;
  padding:8px 14px;
  min-height:76px;           /* більше місця під великий логотип */
}

/* бургер: за замовчуванням ПРИХОВАНИЙ (видно лише на мобілці) */
.burger{
  display:none;
  font-size:22px;line-height:1;
  border:1px solid #1b2131;background:transparent;color:#e8eaed;
  border-radius:10px;width:44px;height:44px;cursor:pointer
}

/* ЛОГО — значно більше на десктопі */
.brand{display:flex;align-items:center;padding:0 4px;border-radius:10px;border:1px solid transparent}
.brand img{
  height:64px;             /* було 40px → зробив 64px */
  width:auto;display:block;
  object-fit:contain;
}

/* Дровер + оверлей */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:saturate(120%) blur(2px);z-index:60}
.drawer{position:fixed;inset:0 auto 0 0;width:82%;max-width:360px;background:#11141b;border-right:1px solid #1b2131;transform:translateX(-100%);transition:transform .28s ease;z-index:70;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.drawer-head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #1b2131}
.drawer-close{width:38px;height:38px;border:1px solid #1b2131;border-radius:10px;background:transparent;color:#e8eaed;cursor:pointer}
.drawer-links{display:flex;flex-direction:column;gap:2px;padding:8px 14px 24px;overflow-y:auto;min-height:0}
.drawer-links a{padding:12px 6px;border-bottom:1px solid #1b2131;color:#e8eaed;text-decoration:none;font-size:17px}
.drawer-links a.active{color:#7aa2ff}
.drawer-theme{display:flex;align-items:center;gap:10px;padding:8px 6px}
.drawer-theme select{height:38px;border-radius:8px;padding:0 8px;background:#0b0d12;color:#e8eaed;border:1px solid #1b2131}

/* МОБІЛЬНИЙ ВИГЛЯД */
@media (max-width: 768px){
  .nav-wrap > .nav-btn,
  .nav-right{ display:none !important; }
  .burger{ display:inline-flex; align-items:center; justify-content:center; }
  .brand img{height:42px;}   /* трохи менше на мобілці, але помітне */
  .nav-wrap{ min-height:64px; }
}

/* ДЕСКТОП: дровер не потрібен */
@media (min-width: 769px){
  .drawer, .drawer-overlay{ display:none !important; }
}
</style>
