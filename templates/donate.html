<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ PXP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    :root{--bg:#0f1115;--card:#11141b;--line:#1b2131;--ink:#e8eaed;--muted:#9fb0d4;--btn:#1c64ec}
    body{background:var(--bg);color:var(--ink);margin:0}
    .navbar{background:#0b0d12;border-bottom:1px solid var(--line)}
    .nav-wrap{max-width:980px;margin:0 auto;display:flex;gap:14px;align-items:center;padding:10px 22px}
    .nav-link{color:#c7d2fe;text-decoration:none;font-weight:600;opacity:.85}
    .nav-link.active,.nav-link:hover{opacity:1}
    .balance{margin-left:auto;color:var(--muted);font-weight:700}
    .wrap{max-width:980px;margin:0 auto;padding:18px 22px 40px}
    .page-title{font-size:24px;margin:8px 0 6px}
    .sub{color:var(--muted);margin-bottom:14px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .row{display:flex;align-items:center;gap:10px}
    .coin{width:28px;height:28px;border-radius:50%;display:inline-block;background:#222 center/cover no-repeat;flex:0 0 28px}
    .btn{padding:10px 14px;background:var(--btn);color:#fff;border:0;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.gray{background:#23293a;color:#dbe5ff}
    .input{padding:10px 12px;background:#0f131c;border:1px solid var(--line);border-radius:10px;color:var(--ink)}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:16px 0}
    .small{font-size:12px}

    /* ‚ñº –ù–æ–≤–µ: —Ç–∞–±–∏ —Ç–∞ —Å–µ–∫—Ü—ñ—è Stripe */
    .tabs{display:flex;gap:8px;margin:10px 0 16px}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#11141b;color:#fff;cursor:pointer;font-weight:700}
    .tab.active{background:var(--btn);border-color:var(--btn)}
    #card-section,#crypto-section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:16px}
    #payment-element{margin:12px 0}
    #card-msg{color:#c9e0ff}
  </style>
</head>
<body>
  {% include 'nav.html' %}

  <div class="wrap">
    <h1 class="page-title">–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ PXP</h1>
    <div class="sub">–û–±–µ—Ä–∏ —Å–ø–æ—Å—ñ–± –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è. 1$ = 1 PXP üêæ</div>

    <!-- ‚ñº –î–≤—ñ –∫–Ω–æ–ø–∫–∏: –∫–∞—Ä—Ç–∫–∞ / –∫—Ä–∏–ø—Ç–æ -->
    <div class="tabs">
      <button id="tab-card" class="tab active">üí≥ –ö–∞—Ä—Ç–∫–∞ (Visa / Mastercard)</button>
      <button id="tab-crypto" class="tab">ü™ô –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</button>
    </div>

    <!-- ‚ñº –°–µ–∫—Ü—ñ—è –∫–∞—Ä—Ç–∫–∏ (Stripe Payment Element) -->
    <section id="card-section">
      <h2 style="margin:0 0 8px">–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –∫–∞—Ä—Ç–∫–æ—é</h2>
      <div class="sub">–í–∫–∞–∂–∏ —Å—É–º—É —É PLN (–º—ñ–Ω—ñ–º—É–º 2 PLN) —Ç–∞ –æ–ø–ª–∞—Ç–∏ –∫–∞—Ä—Ç–∫–æ—é. –ö–æ—à—Ç–∏ –ø—ñ–¥—É—Ç—å –Ω–∞ –±–∞–ª–∞–Ω—Å Proofly.</div>

      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input id="amount" class="input" type="number" min="2" step="1" value="10" style="width:140px">
        <span>PLN</span>
        <button id="payBtn" class="btn" type="button">–û–ø–ª–∞—Ç–∏—Ç–∏ –∫–∞—Ä—Ç–∫–æ—é</button>
      </div>

      <!-- Stripe –ø–æ–∫–∞–∂–µ —Ç—É—Ç –ø–æ–ª–µ –≤–≤–æ–¥—É –∫–∞—Ä—Ç–∫–∏ -->
      <div id="payment-element"></div>
      <div id="card-msg" class="small"></div>
    </section>

    <!-- ‚ñº –°–µ–∫—Ü—ñ—è –∫—Ä–∏–ø—Ç–∏ (—Ç–≤—ñ–π —ñ—Å–Ω—É—é—á–∏–π –±–ª–æ–∫ –±–µ–∑ –∑–º—ñ–Ω –ª–æ–≥—ñ–∫–∏) -->
    <section id="crypto-section" style="display:none">
      <h2 style="margin:0 0 8px">–ü–æ–ø–æ–≤–Ω–∏—Ç–∏ –∫—Ä–∏–ø—Ç–æ—é</h2>
      <div class="sub">–û–±–µ—Ä–∏ –º–µ—Ä–µ–∂—É. –ê–¥—Ä–µ—Å–∞ –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏¬ª. 1$ = 1 PXP üêæ</div>

      <div class="grid">
        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/eth.png')"></span>
            <b>Ethereum (ETH / USDT / USDC)</b>
          </div>
          <button class="btn copy" data-addr="0x4a9f82ea442cc3cc8f0d3c3513d1d5ec632b4d52">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
          <div class="small muted">EVM-–∞–¥—Ä–µ—Å–∞</div>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/bnb.png')"></span>
            <b>BNB Chain (BNB / USDT / USDC)</b>
          </div>
          <button class="btn copy" data-addr="0x4a9f82ea442cc3cc8f0d3c3513d1d5ec632b4d52">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
          <div class="small muted">EVM-–∞–¥—Ä–µ—Å–∞</div>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/trx.png')"></span>
            <b>TRON (TRX / USDT-TRC20)</b>
          </div>
          <button class="btn copy" data-addr="TGWftd99jzw6t2yZZ6V1jhkiJiXfqN3mvb">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/btc.png')"></span>
            <b>Bitcoin (BTC)</b>
          </div>
          <button class="btn copy" data-addr="bc1qeg8p4ucqxjj4pt2rdwgtejyhhwtzxq7ts4pm9d">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/sol.png')"></span>
            <b>Solana (SOL)</b>
          </div>
          <button class="btn copy" data-addr="7zQNzgS8Ahrmm4GDytAuhZqM4t9Pz2kL3FPicdva2KA9">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/xrp.png')"></span>
            <b>XRP (Ripple)</b>
          </div>
          <button class="btn copy" data-addr="rNW1PSoT1H4SiQMUaH7fBLkX9X8Sge7Rqf">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/sui.png')"></span>
            <b>Sui (SUI)</b>
          </div>
          <button class="btn copy" data-addr="0x1947571d58da0a80e9f98f0ffb4bab09329df1be06f5c7a8bf464d58d5f2d0c5">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>

        <div class="card">
          <div class="row">
            <span class="coin" style="background-image:url('/static/icons/ton.png')"></span>
            <b>TON</b>
          </div>
          <button class="btn copy" data-addr="UQDXw7DLhGHyxx9bbrmiiVbuxUTyFW8vNqBtZyZ3aS2mzdS5">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è: –∑–∞—Ä–∞–∑ –ø—ñ–¥—Ç—Ä–∏–º—É—î–º–æ ETH/BNB/TRON -->
      <h3>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ PXP</h3>
      <div class="sub">–ü—ñ—Å–ª—è –ø–µ—Ä–µ–∫–∞–∑—É –≤—Å—Ç–∞–≤ —Å–≤—ñ–π <b>TX hash</b> ‚Äî –º–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –≤ –±–ª–æ–∫—á–µ–π–Ω—ñ —ñ –Ω–∞—Ä–∞—Ö—É—î–º–æ PXP.</div>

      <div class="row" style="gap:8px;flex-wrap:wrap">
        <select id="network" class="input" style="min-width:180px">
          <option value="ETH">Ethereum (USDT/USDC)</option>
          <option value="BNB">BNB Chain (USDT/USDC)</option>
          <option value="TRON">TRON (USDT-TRC20)</option>
        </select>
        <input id="tx" class="input" placeholder="TX hash (0x... –∞–±–æ Tron txid)" style="flex:1;min-width:260px">
        <button id="verify" class="btn" type="button">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        <a href="{{ url_for('profile.profile') }}" class="btn gray">–î–æ –ø—Ä–æ—Ñ—ñ–ª—é</a>
      </div>
      <div id="vmsg" class="muted" style="margin-top:8px"></div>
    </section>
  </div>

<!-- ‚ñº Stripe.js (–¥–ª—è –∫–∞—Ä—Ç–∫–∏) -->
<script src="https://js.stripe.com/v3/"></script>

<script>
  // ====== –¢–∞–±–∏ (–±–µ–∑ –∑–º—ñ–Ω–∏ —Ç–≤–æ—ó—Ö —Ñ—É–Ω–∫—Ü—ñ–π) ======
  const tabCard = document.getElementById('tab-card');
  const tabCrypto = document.getElementById('tab-crypto');
  const secCard = document.getElementById('card-section');
  const secCrypto = document.getElementById('crypto-section');
  function setTab(which){
    if(which==='card'){
      tabCard.classList.add('active'); tabCrypto.classList.remove('active');
      secCard.style.display='block';   secCrypto.style.display='none';
    }else{
      tabCrypto.classList.add('active'); tabCard.classList.remove('active');
      secCrypto.style.display='block';   secCard.style.display='none';
    }
  }
  tabCard.onclick=()=>setTab('card');
  tabCrypto.onclick=()=>setTab('crypto');

  // ====== Stripe Payment Element (–Ω–æ–≤–∞ –ª–æ–≥—ñ–∫–∞, —ñ—Å–Ω—É—é—á—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–∏–∂—á–µ –Ω–µ —á—ñ–ø–∞—é) ======
  const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY|e }}");
  let elements, paymentElement, clientSecret = null;

  async function initElement(amountPln){
    const resp = await fetch("/create-payment-intent", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({amount: amountPln})
    });
    const data = await resp.json();
    clientSecret = data.clientSecret;
    elements = stripe.elements({ clientSecret });
    paymentElement = elements.create("payment");
    document.getElementById("payment-element").innerHTML = "";
    paymentElement.mount("#payment-element");
  }
  // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤—É —Å—É–º—É
  initElement(parseInt(document.getElementById('amount').value || "10"));

  document.getElementById("payBtn").addEventListener("click", async ()=>{
    const amount = Math.max(parseInt(document.getElementById('amount').value||"2"),2);
    await initElement(amount);
    const {error} = await stripe.confirmPayment({
      elements,
      confirmParams:{ return_url: window.location.origin + "/success" }
    });
    document.getElementById("card-msg").textContent = error ? (error.message || "Payment error") : "";
  });

  // ====== –¢–≤–æ—ó —ñ—Å–Ω—É—é—á—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–ù–ï –ó–ú–Ü–ù–Æ–Æ) ======
  // –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å
  document.querySelectorAll('.copy').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const addr = btn.dataset.addr;
      try{
        await navigator.clipboard.writeText(addr);
        btn.textContent = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úî';
      }catch{
        const ta=document.createElement('textarea'); ta.value=addr; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        btn.textContent = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úî';
      }
      setTimeout(()=>btn.textContent='–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏',1200);
    });
  });

  // –ê–≤—Ç–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
  document.getElementById('verify').addEventListener('click', async ()=>{
    const network = document.getElementById('network').value;
    const tx = document.getElementById('tx').value.trim();
    const vmsg = document.getElementById('vmsg');
    if(!tx){ vmsg.textContent='–í—Å—Ç–∞–≤ —Å–≤—ñ–π TX hash'; return; }
    vmsg.textContent='–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ‚Ä¶';
    try{
      const r = await fetch('/api/crypto/verify', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({network, tx})
      });
      const data = await r.json();
      if(!data.ok){ vmsg.textContent = '–ü–æ–º–∏–ª–∫–∞: '+(data.error||''); return; }
      if(data.credited_pxp>0){
        vmsg.textContent = `–ó–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ: ${data.usd}$ ‚Üí +${data.credited_pxp} PXP ‚úÖ (–ø–µ—Ä–µ–π–¥–∏ —É –ø—Ä–æ—Ñ—ñ–ª—å)`;
      }else{
        vmsg.textContent = '–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é —â–µ –Ω–µ –≤–∏–¥–Ω–æ / –Ω–µ –Ω–∞ –Ω–∞—à—É –∞–¥—Ä–µ—Å—É / –Ω–µ —Å—Ç–µ–π–±–ª-—Ç–æ–∫–µ–Ω.';
      }
    }catch(e){ vmsg.textContent='–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.'; }
  });
</script>
</body>
</html>
