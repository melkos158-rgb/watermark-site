{% extends "base.html" %}

{% block content %}
{# SAFE defaults: —è–∫—â–æ admin_metrics –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ #}
{% set am = admin_metrics if admin_metrics is defined else {
  'total_users': 0, 'online_now': 0, 'monthly_visitors': 0
} %}

<style>
  .admin-wrap{max-width:900px;margin:28px auto;padding:20px;background:#171922;border-radius:14px}
  .admin-h1{margin:0 0 16px 0}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:#0f1117;border:1px solid #242735;border-radius:12px;padding:16px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .banner-preview{position:relative;border-radius:12px;overflow:hidden;border:1px solid #2a2e3d}
  .banner-preview img{width:100%;height:120px;object-fit:cover;display:block}
  .hint{opacity:.8;margin-top:6px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;text-decoration:none;border:0;cursor:pointer}
  .btn-primary{background:#1d4ed8;color:#fff}
  .btn-danger{background:#b91c1c;color:#fff}
  .btn-warn{background:#a16207;color:#fff}
  .btn-ghost{background:#1f2430;color:#dbe3ff;border:1px solid #2b3244}
  input[type="file"], input[type="url"]{width:100%;padding:10px;border-radius:10px;background:#0d111a;border:1px solid #2a2e3d;color:#e6ecff}
  input[type="email"], input[type="number"]{width:100%;padding:10px;border-radius:10px;background:#0d111a;border:1px solid #2a2e3d;color:#e6ecff}
  label{display:block;margin:8px 0 6px}
  .checkline{display:flex;gap:14px;align-items:center;margin-top:10px}

  /* DASHBOARD-–º–µ—Ç—Ä–∏–∫–∏ */
  .stats-row{display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;gap:20px;margin:10px 0 4px}
  .stat-box{text-align:center;flex:1;min-width:140px;padding:8px}
  .stat-value{font-size:56px;font-weight:800;color:#fff;line-height:1.1}
  .stat-label{font-size:16px;opacity:.85;margin-top:6px}
  @media (max-width:560px){.stat-value{font-size:42px}}

  /* ===== –Ü–ù–¢–ï–†–ê–ö–¢–ò–í–ù–ò–ô –†–ï–î–ê–ö–¢–û–† –ë–ê–ù–ï–†–ê (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥) ===== */
  .editor-wrap{margin-top:12px}
  .editor-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .editor-toolbar .btn{padding:6px 10px;border-radius:8px}
  .banner-editor{
    position:relative;
    border:1px dashed #3b4257;
    background:#0b0f17;
    border-radius:12px;
    overflow:hidden;
    width:100%;
    min-width:260px;
    height:220px;                 /* —Å—Ç–∞—Ä—Ç–æ–≤–∞ –≤–∏—Å–æ—Ç–∞ –ø—ñ–¥ 5:1 (—É–º–æ–≤–Ω–æ 1100√ó220) */
    resize:both;                  /* –∑–º—ñ–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    cursor:grab;
    outline:none;
  }
  .banner-editor:active{cursor:grabbing}
  .banner-editor img{
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%) scale(1);
    transform-origin:center center;
    max-width:none;
    will-change:transform;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }
</style>

<div class="admin-wrap">
  <h1 class="admin-h1">–ê–¥–º—ñ–Ω-–∫–∞–±—ñ–Ω–µ—Ç</h1>

  <!-- –ü–æ—Ç–æ—á–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –±–∞–Ω–µ—Ä (—â–æ –±–∞—á–∞—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑–∞—Ä–∞–∑) -->
  <div class="card">
    <h2>–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–Ω–µ—Ä –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π</h2>
    {% set _src = banner.image_path %}
    {% if _src and not _src.startswith('http') %}
      {% set _src = url_for('static', filename=_src) %}
    {% endif %}
    <div class="banner-preview" style="margin-top:10px">
      <!-- cache-bust: –¥–æ–¥–∞—î–º–æ id —ñ –±–∞–∑–æ–≤–∏–π —à–ª—è—Ö, src –∑ ?t= -->
      <img id="activeBanner"
           data-base="{{ _src }}"
           src="{{ _src }}?t={{ request.args.get('t','') }}"
           alt="Active banner">
    </div>
    {% if banner.link_url %}
      <div class="hint">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø—Ä–∏ –∫–ª—ñ–∫—É: <code>{{ banner.link_url }}</code></div>
    {% else %}
      <div class="hint">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–µ –∑–∞–¥–∞–Ω–æ.</div>
    {% endif %}
  </div>

  <!-- –ó–∞–º—ñ–Ω–∞ –î–ï–§–û–õ–¢–ù–û–ì–û –±–∞–Ω–µ—Ä–∞ (–∞–¥–º—ñ–Ω) -->
  <div class="card">
    <h2>–ó–º—ñ–Ω–∏—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –±–∞–Ω–µ—Ä</h2>
    <p class="hint">–¶–µ–π –±–∞–Ω–µ—Ä –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è, —è–∫—â–æ TOP-1 —â–µ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–≤ —Å–≤—ñ–π –∞–±–æ –π–æ–≥–æ –ø–µ—Ä–µ–≥–Ω–∞–ª–∏.</p>
    <form id="formDefaultBanner" action="{{ url_for('admin_banner_default') }}" method="post" enctype="multipart/form-data" style="margin-top:10px">
      <label>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (.png/.jpg/.jpeg/.webp), –±–∞–∂–∞–Ω–æ ~5:1 (–Ω–∞–ø—Ä., 1100√ó220)</label>
      <input id="fileBanner" type="file" name="image" accept=".png,.jpg,.jpeg,.webp" required>

      <!-- –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–µ–≤‚Äô—é-—Ä–µ–¥–∞–∫—Ç–æ—Ä (—Ç—ñ–ª—å–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥; —Ñ–∞–π–ª –Ω–∞ –±–µ–∫ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è —è–∫ —î) -->
      <div id="editorWrap" class="editor-wrap" style="display:none">
        <div class="editor-toolbar">
          <button class="btn btn-ghost" type="button" id="btnZoomOut">‚Äì</button>
          <button class="btn btn-ghost" type="button" id="btnZoomIn">+</button>
          <button class="btn btn-ghost" type="button" id="btnCenter">–¶–µ–Ω—Ç—Ä</button>
          <button class="btn btn-ghost" type="button" id="btnReset">Reset</button>
        </div>
        <div id="bannerEditor" class="banner-editor" tabindex="0" aria-label="–†–µ–¥–∞–∫—Ç–æ—Ä –±–∞–Ω–µ—Ä–∞ (–∫–æ–ª–µ—Å–∏–∫–æ–º –º–∞—Å—à—Ç–∞–±, –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –º–∏—à–∫–æ—é, —Ç—è–≥–Ω–∏ –∑–∞ –∫—Ä–∞—ó –¥–ª—è –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—É)">
          <img id="bannerImage" alt="Banner preview">
        </div>
        <div class="hint">–ö–æ–ª–µ—Å–∏–∫–æ ‚Äî –º–∞—Å—à—Ç–∞–±; –∑–∞—Ç–∏—Å–Ω–∏ —Ç–∞ –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –º–∏—à–∫–æ—é ‚Äî –ø–æ–∑–∏—Ü—ñ—è; —Ç—è–≥–Ω–∏ –∑–∞ –∫—Ä–∞–π/–∫—É—Ç ‚Äî –∑–º—ñ–Ω—é—î—à —Ä–æ–∑–º—ñ—Ä –æ–±–ª–∞—Å—Ç—ñ.</div>
      </div>

      <label style="margin-top:12px">–û–ø—Ü—ñ–π–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (URL) –ø—Ä–∏ –∫–ª—ñ–∫—É</label>
      <input type="url" name="link_url" placeholder="https://...">
      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" type="submit">–û–Ω–æ–≤–∏—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –±–∞–Ω–µ—Ä</button>
        <a class="btn btn-ghost" href="{{ url_for('index') }}">–í—ñ–¥–∫—Ä–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω—É</a>
      </div>
    </form>
  </div>

  <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –±–∞–Ω–µ—Ä–æ–º TOP-1 -->
  <div class="card">
    <h2>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –±–∞–Ω–µ—Ä–æ–º TOP-1</h2>
    <p class="hint">–Ø–∫—â–æ TOP-1 —Ä–æ–∑–º—ñ—Å—Ç–∏–≤ –Ω–µ–±–∞–∂–∞–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ‚Äî –≤–∏–º–∫–Ω–∏ –π–æ–≥–æ. –ü–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –±–∞–Ω–µ—Ä.</p>
    <form action="{{ url_for('admin_disable_top_banner') }}" method="post" class="actions">
      <button class="btn btn-danger" type="submit">–í–∏–º–∫–Ω—É—Ç–∏ –±–∞–Ω–µ—Ä TOP-1</button>
      <a class="btn btn-ghost" href="{{ url_for('ad_upload') }}">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±–∞–Ω–µ—Ä —è–∫ TOP-1</a>
    </form>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∞–π—Ç—É (dashboard) -->
  <div class="card">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∞–π—Ç—É</h2>
    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-value">{{ am.monthly_visitors }}</div>
        <div class="stat-label">–≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">{{ am.total_users }}</div>
        <div class="stat-label">–∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">{{ am.online_now }}</div>
        <div class="stat-label">–æ–Ω–ª–∞–π–Ω</div>
      </div>
      <!-- üîπ 4-–π –ª—ñ—á–∏–ª—å–Ω–∏–∫: —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∑–∞ –º—ñ—Å—è—Ü—å -->
      <div class="stat-box">
        <div class="stat-value">{{ am.monthly_visitors }}</div>
        <div class="stat-label">—É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∑–∞ –º—ñ—Å—è—Ü—å</div>
      </div>
    </div>
    <div class="hint">–¶—ñ –¥–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏.</div>
  </div>

  <!-- –†–µ–π—Ç–∏–Ω–≥ –∑–∞ –º—ñ—Å—è—Ü—å (–ø–æ–∫–∏ –±–µ–∑ –±–µ–∫–µ–Ω–¥—É) -->
  <div class="card">
    <h2>–†–µ–π—Ç–∏–Ω–≥ –∑–∞ –º—ñ—Å—è—Ü—å</h2>
    <p class="hint">–°–∫–∏–¥–∞–Ω–Ω—è <code>pxp_month</code> –ø–æ—Ç—Ä–µ–±—É—î —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –µ–Ω–¥–ø–æ–π–Ω—Ç–∞. –ó–∞—Ä–∞–∑ –∫–Ω–æ–ø–∫–∞ –ª–∏—à–µ –ø–æ–≤—ñ–¥–æ–º–ª—è—î.</p>
    <div class="actions">
      <button class="btn btn-warn" type="button"
              onclick="alert('–î—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –µ–Ω–¥–ø–æ–π–Ω—Ç admin_reset_month');">
        –°–∫–∏–Ω—É—Ç–∏ –º—ñ—Å—è—á–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥
      </button>
    </div>
  </div>

  <!-- –ù–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è PXP –∑–∞ email (–ø–æ–∫–∏ –±–µ–∑ –±–µ–∫–µ–Ω–¥—É) -->
  <div class="card">
    <h2>–ù–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ PXP –∑–∞ email</h2>
    <p class="hint">–î–ª—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–µ–Ω –µ–Ω–¥–ø–æ–π–Ω—Ç –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ. –§–æ—Ä–º–∞ –ø–æ–∫–∏ —â–æ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è.</p>
    <form onsubmit="alert('–î—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –µ–Ω–¥–ø–æ–π–Ω—Ç admin_pxp_add'); return false;" style="margin-top:10px">
      <label>Email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (Gmail)</label>
      <input type="email" name="email" placeholder="user@gmail.com" required>

      <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å PXP</label>
      <input type="number" name="amount" min="1" step="1" value="10" required>

      <div class="checkline">
        <label><input type="checkbox" name="add_total" checked> –î–æ–¥–∞—Ç–∏ –≤ –∑–∞–≥–∞–ª—å–Ω–∏–π PXP</label>
        <label><input type="checkbox" name="add_month" checked> –î–æ–¥–∞—Ç–∏ –≤ PXP —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è</label>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" type="submit">–ù–∞—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== JS: —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–µ–≤'—é + –ø—Ä–æ–±–∏—Ç—Ç—è –∫–µ—à—É –±–∞–Ω–µ—Ä–∞ ===== -->
<script>
/* === –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–µ–≤'—é-—Ä–µ–¥–∞–∫—Ç–æ—Ä === */
(function(){
  const fileInput   = document.getElementById('fileBanner');
  const wrap        = document.getElementById('editorWrap');
  const editor      = document.getElementById('bannerEditor');
  const img         = document.getElementById('bannerImage');
  const btnIn       = document.getElementById('btnZoomIn');
  const btnOut      = document.getElementById('btnZoomOut');
  const btnCenter   = document.getElementById('btnCenter');
  const btnReset    = document.getElementById('btnReset');

  if(!fileInput || !editor || !img) return;

  let scale = 1;
  let dx = 0, dy = 0;
  let dragging = false;
  let startX = 0, startY = 0;

  function applyTransform(){
    img.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(${scale})`;
  }
  function centerImage(){ dx = 0; dy = 0; applyTransform(); }
  function resetAll(){ scale = 1; dx = 0; dy = 0; applyTransform(); }

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      img.src = ev.target.result;
      wrap.style.display = 'block';
      resetAll();
      img.onload = () => resetAll();
    };
    reader.readAsDataURL(file);
  });

  editor.addEventListener('wheel', (e) => {
    e.preventDefault();
    const step = 0.08;
    scale += (e.deltaY < 0 ? step : -step);
    scale = Math.min(Math.max(scale, 0.2), 5);
    applyTransform();
  }, { passive:false });

  editor.addEventListener('mousedown', (e) => { dragging = true; startX = e.clientX; startY = e.clientY; });
  window.addEventListener('mouseup', () => dragging = false);
  window.addEventListener('mousemove', (e) => {
    if(!dragging) return;
    dx += (e.clientX - startX);
    dy += (e.clientY - startY);
    startX = e.clientX; startY = e.clientY;
    applyTransform();
  });

  btnIn && btnIn.addEventListener('click', () => { scale = Math.min(scale + 0.1, 5); applyTransform(); });
  btnOut && btnOut.addEventListener('click', () => { scale = Math.max(scale - 0.1, 0.2); applyTransform(); });
  btnCenter && btnCenter.addEventListener('click', centerImage);
  btnReset && btnReset.addEventListener('click', resetAll);

  editor.addEventListener('keydown', (e) => {
    if(e.key === '+' || e.key === '='){ scale = Math.min(scale + 0.1, 5); applyTransform(); }
    if(e.key === '-' || e.key === '_'){ scale = Math.max(scale - 0.1, 0.2); applyTransform(); }
    if(e.key === ' '){ e.preventDefault(); centerImage(); }
  });
})();

/* === –ü—Ä–æ–±–∏—Ç—Ç—è –∫–µ—à—É –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞–Ω–µ—Ä–∞ === */
(function(){
  // 1) –î–æ–¥–∞—î–º–æ ?t=<timestamp> –¥–æ action —Ñ–æ—Ä–º–∏ –ø—Ä–∏ —Å–∞–±–º—ñ—Ç—ñ
  const f = document.getElementById('formDefaultBanner');
  if (f) {
    f.addEventListener('submit', function(){
      const ts = Date.now();
      if (!this.action.includes('?')) this.action += '?t=' + ts;
      else this.action += '&t=' + ts;
    });
  }
  // 2) –Ø–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –±–µ–∑ t, –≤—Å–µ –æ–¥–Ω–æ –ø—ñ–¥–º—ñ–Ω—è—î–º–æ src –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞–Ω–µ—Ä–∞
  const img = document.getElementById('activeBanner');
  if (img) {
    const url = new URL(window.location.href);
    const t = url.searchParams.get('t') || Date.now();
    img.src = img.dataset.base + '?t=' + t;
  }
})();
</script>
{% endblock %}
