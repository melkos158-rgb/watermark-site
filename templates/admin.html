{% extends "base.html" %}

{% block content %}
{# SAFE defaults: якщо admin_metrics відсутній у контексті #}
{% set am = admin_metrics if admin_metrics is defined else {
  'total_users': 0, 'online_now': 0, 'monthly_visitors': 0
} %}

<style>
  .admin-wrap{max-width:900px;margin:28px auto;padding:20px;background:#171922;border-radius:14px}
  .admin-h1{margin:0 0 16px 0}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:#0f1117;border:1px solid #242735;border-radius:12px;padding:16px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .banner-preview{position:relative;border-radius:12px;overflow:hidden;border:1px solid #2a2e3d}
  .banner-preview img{width:100%;height:120px;object-fit:cover;display:block}
  .hint{opacity:.8;margin-top:6px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;text-decoration:none;border:0;cursor:pointer}
  .btn-primary{background:#1d4ed8;color:#fff}
  .btn-danger{background:#b91c1c;color:#fff}
  .btn-warn{background:#a16207;color:#fff}
  .btn-ghost{background:#1f2430;color:#dbe3ff;border:1px solid #2b3244}
  input[type="file"], input[type="url"]{width:100%;padding:10px;border-radius:10px;background:#0d111a;border:1px solid #2a2e3d;color:#e6ecff}
  input[type="email"], input[type="number"]{width:100%;padding:10px;border-radius:10px;background:#0d111a;border:1px solid #2a2e3d;color:#e6ecff}
  label{display:block;margin:8px 0 6px}
  .checkline{display:flex;gap:14px;align-items:center;margin-top:10px}

  /* DASHBOARD-метрики (три великі цифри) */
  .stats-row{display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;gap:20px;margin:10px 0 4px}
  .stat-box{text-align:center;flex:1;min-width:140px;padding:8px}
  .stat-value{font-size:56px;font-weight:800;color:#fff;line-height:1.1}
  .stat-label{font-size:16px;opacity:.85;margin-top:6px}
  @media (max-width:560px){.stat-value{font-size:42px}}

  /* ======= ІНТЕРАКТИВНИЙ РЕДАКТОР БАНЕРА (тільки фронтенд) ======= */
  .editor-wrap{margin-top:12px}
  .editor-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .editor-toolbar .btn{padding:6px 10px;border-radius:8px}
  .banner-editor{
    position:relative;
    border:1px dashed #3b4257;
    background:#0b0f17;
    border-radius:12px;
    overflow:hidden;
    width:100%;
    min-width:260px;
    height:220px;                 /* стартова висота під 5:1 (умовно 1100×220) */
    resize:both;                  /* дозволяє тягнути за краї */
    cursor:grab;                  /* курсор як для перетягування */
    outline:none;
  }
  .banner-editor:active{cursor:grabbing}
  .banner-editor img{
    position:absolute;            /* вільне позиціювання всередині контейнера */
    top:50%; left:50%;
    transform:translate(-50%,-50%) scale(1);
    transform-origin:center center;
    max-width:none;               /* важливо для масштабування */
    will-change:transform;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;          /* щоб не ловити події на <img>, а на контейнері */
  }
</style>

<div class="admin-wrap">
  <h1 class="admin-h1">Адмін-кабінет</h1>

  <!-- Поточний активний банер (що бачать користувачі зараз) -->
  <div class="card">
    <h2>Поточний банер на головній</h2>
    {% set _src = banner.image_path %}
    {% if _src and not _src.startswith('http') %}
      {% set _src = url_for('static', filename=_src) %}
    {% endif %}
    <div class="banner-preview" style="margin-top:10px">
      <img src="{{ _src }}" alt="Active banner">
    </div>
    {% if banner.link_url %}
      <div class="hint">Посилання при кліку: <code>{{ banner.link_url }}</code></div>
    {% else %}
      <div class="hint">Посилання при кліку не задано.</div>
    {% endif %}
  </div>

  <!-- Заміна ДЕФОЛТНОГО банера (адмін) -->
  <div class="card">
    <h2>Змінити дефолтний банер</h2>
    <p class="hint">Цей банер показується, якщо TOP-1 ще не поставив свій або його перегнали.</p>
    <form action="{{ url_for('admin_banner_default') }}" method="post" enctype="multipart/form-data" style="margin-top:10px">
      <label>Зображення (.png/.jpg/.jpeg/.webp), бажано ~5:1 (напр., 1100×220)</label>
      <input id="fileBanner" type="file" name="image" accept=".png,.jpg,.jpeg,.webp" required>

      <!-- Інтерактивний прев’ю-редактор (тільки фронтенд; файл на бек відправиться як є) -->
      <div id="editorWrap" class="editor-wrap" style="display:none">
        <div class="editor-toolbar">
          <button class="btn btn-ghost" type="button" id="btnZoomOut">–</button>
          <button class="btn btn-ghost" type="button" id="btnZoomIn">+</button>
          <button class="btn btn-ghost" type="button" id="btnCenter">Центр</button>
          <button class="btn btn-ghost" type="button" id="btnReset">Reset</button>
        </div>
        <div id="bannerEditor" class="banner-editor" tabindex="0" aria-label="Редактор банера (колесиком масштаб, перетягни мишкою, тягни за краї для зміни розміру)">
          <img id="bannerImage" alt="Banner preview">
        </div>
        <div class="hint">Колесико — масштаб; затисни та перетягни мишкою — позиція; тягни за край/кут — змінюєш розмір області.</div>
      </div>

      <label style="margin-top:12px">Опційне посилання (URL) при кліку</label>
      <input type="url" name="link_url" placeholder="https://...">
      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" type="submit">Оновити дефолтний банер</button>
        <a class="btn btn-ghost" href="{{ url_for('index') }}">Відкрити головну</a>
      </div>
    </form>
  </div>

  <!-- Керування банером TOP-1 -->
  <div class="card">
    <h2>Керування банером TOP-1</h2>
    <p class="hint">Якщо TOP-1 розмістив небажане зображення — вимкни його. Повернеться дефолтний банер.</p>
    <form action="{{ url_for('admin_disable_top_banner') }}" method="post" class="actions">
      <button class="btn btn-danger" type="submit">Вимкнути банер TOP-1</button>
      <a class="btn btn-ghost" href="{{ url_for('ad_upload') }}">Завантажити банер як TOP-1</a>
    </form>
  </div>

  <!-- Статистика сайту (dashboard) -->
  <div class="card">
    <h2>Статистика сайту</h2>
    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-value">{{ am.monthly_visitors }}</div>
        <div class="stat-label">відвідувачів</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">{{ am.total_users }}</div>
        <div class="stat-label">зареєстрованих</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">{{ am.online_now }}</div>
        <div class="stat-label">онлайн</div>
      </div>
    </div>
    <div class="hint">Ці дані оновлюються при перезавантаженні сторінки.</div>
  </div>

  <!-- Рейтинг за місяць (поки без бекенду) -->
  <div class="card">
    <h2>Рейтинг за місяць</h2>
    <p class="hint">Скидання <code>pxp_month</code> потребує серверного ендпойнта. Зараз кнопка лише повідомляє.</p>
    <div class="actions">
      <button class="btn btn-warn" type="button"
              onclick="alert('Дія недоступна: відсутній серверний ендпойнт admin_reset_month');">
        Скинути місячний рейтинг
      </button>
    </div>
  </div>

  <!-- Нарахування PXP за email (поки без бекенду) -->
  <div class="card">
    <h2>Нарахувати PXP за email</h2>
    <p class="hint">Для нарахування потрібен ендпойнт на бекенді. Форма поки що не відправляється.</p>
    <form onsubmit="alert('Дія недоступна: відсутній серверний ендпойнт admin_pxp_add'); return false;" style="margin-top:10px">
      <label>Email користувача (Gmail)</label>
      <input type="email" name="email" placeholder="user@gmail.com" required>

      <label>Кількість PXP</label>
      <input type="number" name="amount" min="1" step="1" value="10" required>

      <div class="checkline">
        <label><input type="checkbox" name="add_total" checked> Додати в загальний PXP</label>
        <label><input type="checkbox" name="add_month" checked> Додати в PXP цього місяця</label>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" type="submit">Нарахувати</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= JS для інтерактивного прев'ю банера ======= -->
<script>
(function(){
  const fileInput   = document.getElementById('fileBanner');
  const wrap        = document.getElementById('editorWrap');
  const editor      = document.getElementById('bannerEditor');
  const img         = document.getElementById('bannerImage');
  const btnIn       = document.getElementById('btnZoomIn');
  const btnOut      = document.getElementById('btnZoomOut');
  const btnCenter   = document.getElementById('btnCenter');
  const btnReset    = document.getElementById('btnReset');

  if(!fileInput || !editor || !img) return;

  let scale = 1;
  let dx = 0, dy = 0;     // зсув у px відносно центру
  let dragging = false;
  let startX = 0, startY = 0;

  function applyTransform(){
    img.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(${scale})`;
  }

  function centerImage(){
    dx = 0; dy = 0;
    applyTransform();
  }

  function resetAll(){
    scale = 1; dx = 0; dy = 0;
    applyTransform();
  }

  // Показати прев’ю після вибору файлу
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      img.src = ev.target.result;
      wrap.style.display = 'block';
      resetAll();
      // Автоматично адаптуємо початковий масштаб під контейнер
      img.onload = () => {
        // нічого не міняємо у файлі — лише прев’ю
        resetAll();
      };
    };
    reader.readAsDataURL(file);
  });

  // Колесико — масштаб
  editor.addEventListener('wheel', (e) => {
    e.preventDefault();
    const step = 0.08;
    if (e.deltaY < 0) scale += step;
    else scale -= step;
    scale = Math.min(Math.max(scale, 0.2), 5);
    applyTransform();
  }, { passive:false });

  // Перетягування з затиснутою кнопкою миші
  editor.addEventListener('mousedown', (e) => {
    dragging = true;
    startX = e.clientX;
    startY = e.clientY;
  });
  window.addEventListener('mouseup', () => dragging = false);
  window.addEventListener('mousemove', (e) => {
    if(!dragging) return;
    const k = 1; // чутливість
    dx += (e.clientX - startX) / k;
    dy += (e.clientY - startY) / k;
    startX = e.clientX;
    startY = e.clientY;
    applyTransform();
  });

  // Кнопки керування
  btnIn && btnIn.addEventListener('click', () => { scale = Math.min(scale + 0.1, 5); applyTransform(); });
  btnOut && btnOut.addEventListener('click', () => { scale = Math.max(scale - 0.1, 0.2); applyTransform(); });
  btnCenter && btnCenter.addEventListener('click', centerImage);
  btnReset && btnReset.addEventListener('click', resetAll);

  // Клавіатура: +/- для масштабу, пробіл — центр
  editor.addEventListener('keydown', (e) => {
    if(e.key === '+' || e.key === '='){ scale = Math.min(scale + 0.1, 5); applyTransform(); }
    if(e.key === '-' || e.key === '_'){ scale = Math.max(scale - 0.1, 0.2); applyTransform(); }
    if(e.key === ' '){ e.preventDefault(); centerImage(); }
  });
})();
</script>
{% endblock %}
