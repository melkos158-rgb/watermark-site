{% extends "base.html" %}
{% block title %}Редагувати лот{% endblock %}

{% block content %}
<h1>Редагувати лот</h1>

<style>
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .w-1{flex:1;min-width:180px}
  .w-2{flex:2;min-width:260px}

  .section-title{font-weight:800;margin-bottom:6px}
  .note{color:var(--muted);font-size:12px}

  .list{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .chip{
    position:relative;display:flex;align-items:center;gap:6px;
    border:1px solid var(--line);background:#0d1118;padding:6px 8px;border-radius:10px;
    cursor:grab;user-select:none
  }
  .chip:active{cursor:grabbing}
  .chip img{width:64px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #1c2435}
  .chip .label{font-size:12px;color:#cfd6ea;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chip .handle{font-weight:700;opacity:.5}
  .chip .del{border:none;background:#0000;color:#fff;opacity:.6;font-weight:700;cursor:pointer}
  .chip .del:hover{opacity:1}
  .chip.cover::after{
    content:"COVER";position:absolute;top:-7px;right:-7px;font-size:10px;background:#1f6feb;color:#fff;
    padding:2px 5px;border-radius:6px;border:1px solid #1a4fbd
  }

  .tile-drop{
    width:100%;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;
    border:2px dashed #55607d;border-radius:12px;background:linear-gradient(180deg,#31384a,#252b39);
    cursor:pointer;position:relative;overflow:hidden;padding:14px
  }
  .tile-drop:hover{border-color:#7d8fbe}
  .badge{position:absolute;top:8px;right:10px;background:#0b0f18cc;color:#fff;border:1px solid #ffffff22;
    font-size:12px;border-radius:999px;padding:3px 8px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn-sm{font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:var(--card);color:var(--text);cursor:pointer}
  .btn-danger{background:#7f2a2a;color:#fff;border-color:#8a2f2f}
</style>

<div class="card" style="max-width:980px">
  <form id="editForm" enctype="multipart/form-data" novalidate>
    <div class="row">
      <div class="w-1">
        <label>Назва</label>
        <input id="title" name="title" required style="width:100%">
      </div>
      <div class="w-1">
        <label>Ціна (0 = безкоштовно)</label>
        <input id="price" name="price" type="number" min="0" value="0" required style="width:100%">
      </div>
      <div class="w-2">
        <label>Теги (через кому)</label>
        <input id="tags" name="tags" placeholder="dragon,toy,figure" style="width:100%">
      </div>
    </div>

    <div style="height:10px"></div>

    <label>Опис</label>
    <textarea id="desc" name="desc" rows="5" style="width:100%"></textarea>

    <div style="height:16px"></div>

    <!-- ================= STL ================= -->
    <div class="card">
      <div class="section-title">Існуючі STL (перетягни, щоб змінити порядок / видалити)</div>
      <div id="stlList" class="list"></div>
      <div class="note">Перший у списку — <b>основний STL</b>.</div>

      <div class="toolbar">
        <button class="btn-sm" type="button" id="stlAddUrlBtn">+ Додати STL за URL</button>
        <button class="btn-sm btn-danger" type="button" id="stlClearBtn">Очистити все</button>
      </div>

      <div style="height:10px"></div>
      <div class="tile-drop" id="stlDrop">
        <div style="text-align:center">
          <div style="font-weight:700;font-size:16px;color:#e4ecff">Додати нові 3D-файли (до 5)</div>
          <div class="note">Перетягни файли сюди або натисни для вибору</div>
        </div>
        <div class="badge" id="stlBadge">0/5</div>
        <input id="stlInput" type="file" accept=".stl,.obj,.ply,.gltf,.glb" multiple style="display:none">
      </div>

      <div class="section-title" style="margin-top:10px">Нові STL (черга на завантаження)</div>
      <div id="stlPending" class="list"></div>
    </div>

    <div style="height:14px"></div>

    <!-- ================ PHOTOS ================ -->
    <div class="card">
      <div class="section-title">Існуючі фото (перетягни / видали)</div>
      <div id="imgList" class="list"></div>
      <div class="note">Перше фото стане <b>обкладинкою</b>.</div>

      <div class="toolbar">
        <button class="btn-sm" type="button" id="imgAddUrlBtn">+ Додати фото за URL</button>
        <button class="btn-sm btn-danger" type="button" id="imgClearBtn">Очистити все</button>
      </div>

      <div style="height:10px"></div>
      <div class="tile-drop" id="imgDrop">
        <div style="text-align:center">
          <div style="font-weight:700;font-size:16px;color:#e4ecff">Додати нові фото (до 5)</div>
          <div class="note">Перетягни файли сюди або натисни для вибору</div>
        </div>
        <div class="badge" id="imgBadge">0/5</div>
        <input id="imgInput" type="file" accept=".jpg,.jpeg,.png,.webp" multiple style="display:none">
      </div>

      <div class="section-title" style="margin-top:10px">Нові фото (черга на завантаження)</div>
      <div id="imgPending" class="list"></div>
    </div>

    <div style="height:12px"></div>

    <label style="display:flex;gap:8px;align-items:center">
      <input type="checkbox" id="deleteOld" checked>
      Після збереження видалити старий лот і замінити новим
    </label>

    <div style="height:12px"></div>
    <button class="btn primary" type="submit">Зберегти</button>
    <span id="msg" class="note" style="margin-left:8px"></span>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const ITEM_ID = parseInt((location.pathname.split('/').pop()||'0'),10)||0;
  const form = document.getElementById('editForm');
  const msg  = document.getElementById('msg');

  // поля
  const titleEl = document.getElementById('title');
  const priceEl = document.getElementById('price');
  const tagsEl  = document.getElementById('tags');
  const descEl  = document.getElementById('desc');

  // існуючі посилання
  let stlLinks = []; // [main, ...]
  let imgLinks = []; // [cover, ...]

  // нові файли (масиви File у потрібному порядку)
  let newStlFiles  = [];
  let newImgFiles  = [];

  const STL_LIMIT = 5, IMG_LIMIT = 5;

  // елементи UI
  const stlList   = document.getElementById('stlList');
  const imgList   = document.getElementById('imgList');
  const stlPending= document.getElementById('stlPending');
  const imgPending= document.getElementById('imgPending');

  const stlInput  = document.getElementById('stlInput');
  const imgInput  = document.getElementById('imgInput');
  const stlDrop   = document.getElementById('stlDrop');
  const imgDrop   = document.getElementById('imgDrop');
  const stlBadge  = document.getElementById('stlBadge');
  const imgBadge  = document.getElementById('imgBadge');

  const stlAddUrlBtn = document.getElementById('stlAddUrlBtn');
  const imgAddUrlBtn = document.getElementById('imgAddUrlBtn');
  const stlClearBtn  = document.getElementById('stlClearBtn');
  const imgClearBtn  = document.getElementById('imgClearBtn');

  // helpers
  const shortName = (u)=> (u||'').split('/').pop()?.split('?')[0]||u||'';
  const imgPreviewURL = (file)=> URL.createObjectURL(file);

  function chip({thumb,label,isCover, onDelete}){
    const el = document.createElement('div'); el.className='chip';
    if (isCover) el.classList.add('cover');
    if (thumb){
      const im=document.createElement('img'); im.src=thumb; el.appendChild(im);
    }
    const h = document.createElement('span'); h.className='handle'; h.textContent='≡';
    const lab = document.createElement('span'); lab.className='label'; lab.textContent = label;
    const del = document.createElement('button'); del.className='del'; del.type='button'; del.textContent='×';
    del.addEventListener('click', onDelete);
    el.appendChild(h); el.appendChild(lab); el.appendChild(del);
    el.draggable = true;
    return el;
  }

  function wireDnd(listEl, getArr, setArr){
    let dragEl=null, dragIdx=-1;
    listEl.addEventListener('dragstart', e=>{
      const node = e.target.closest('.chip'); if(!node) return;
      dragEl=node; dragIdx=[...listEl.children].indexOf(node);
      e.dataTransfer.setData('text/plain','x');
    });
    listEl.addEventListener('dragover', e=>{
      e.preventDefault();
      const node = e.target.closest('.chip'); if(!node || node===dragEl) return;
      const children=[...listEl.children];
      const overIdx = children.indexOf(node);
      if (overIdx>dragIdx) node.after(dragEl); else node.before(dragEl);
    });
    listEl.addEventListener('drop', ()=>{
      const children=[...listEl.children];
      const old = getArr();
      const labels = children.map(ch=> ch.querySelector('.label').textContent);
      const map = new Map(old.map(v=>[v.key,v]));
      const reordered = [];
      labels.forEach(l=>{ const v=map.get(l); if(v) reordered.push(v.val); });
      setArr(reordered);
      render();
    });
  }

  function render(){
    // існуючі STL
    stlList.innerHTML='';
    stlLinks.slice(0,STL_LIMIT).forEach((u,i)=>{
      const el = chip({
        thumb:null,
        label: shortName(u),
        isCover:false,
        onDelete: ()=>{ stlLinks.splice(i,1); render(); }
      });
      stlList.appendChild(el);
    });

    // існуючі фото
    imgList.innerHTML='';
    imgLinks.slice(0,IMG_LIMIT).forEach((u,i)=>{
      const el = chip({
        thumb:u,
        label: shortName(u),
        isCover: i===0,
        onDelete: ()=>{ imgLinks.splice(i,1); render(); }
      });
      imgList.appendChild(el);
    });

    // pending STL (файли)
    stlPending.innerHTML='';
    newStlFiles.slice(0,STL_LIMIT).forEach((f,i)=>{
      const el = chip({
        thumb:null,
        label: f.name,
        isCover:false,
        onDelete: ()=>{ newStlFiles.splice(i,1); updateBadges(); render(); }
      });
      stlPending.appendChild(el);
    });

    // pending Photos
    imgPending.innerHTML='';
    newImgFiles.slice(0,IMG_LIMIT).forEach((f,i)=>{
      const el = chip({
        thumb: imgPreviewURL(f),
        label: f.name,
        isCover: i===0,
        onDelete: ()=>{ newImgFiles.splice(i,1); updateBadges(); render(); }
      });
      imgPending.appendChild(el);
    });
  }

  wireDnd(stlList,
    ()=> stlLinks.map(v=>({key:shortName(v), val:v})),
    (arr)=>{ stlLinks = arr; }
  );
  wireDnd(imgList,
    ()=> imgLinks.map(v=>({key:shortName(v), val:v})),
    (arr)=>{ imgLinks = arr; }
  );
  wireDnd(stlPending,
    ()=> newStlFiles.map(v=>({key:v.name, val:v})),
    (arr)=>{ newStlFiles = arr; }
  );
  wireDnd(imgPending,
    ()=> newImgFiles.map(v=>({key:v.name, val:v})),
    (arr)=>{ newImgFiles = arr; }
  );

  function attachDrop(tile,input,limit,bagdeEl,onAdd){
    tile.addEventListener('click', ()=> input.click());
    ['dragenter','dragover'].forEach(ev=>tile.addEventListener(ev, e=>{e.preventDefault(); tile.style.borderColor='#7d8fbe'}));
    ['dragleave','drop'].forEach(ev=>tile.addEventListener(ev, e=>{e.preventDefault(); tile.style.borderColor='#55607d'}));
    tile.addEventListener('drop', e=>{
      if(e.dataTransfer && e.dataTransfer.files){
        const files=[...e.dataTransfer.files].slice(0,limit);
        onAdd(files); updateBadges(); render();
      }
    });
    input.addEventListener('change', ()=>{
      const files=[...input.files].slice(0,limit);
      onAdd(files); updateBadges(); render();
      input.value=''; // щоб можна було вибрати ті самі ще раз
    });
  }
  function updateBadges(){
    stlBadge.textContent = `${Math.min(newStlFiles.length,STL_LIMIT)}/${STL_LIMIT}`;
    imgBadge.textContent = `${Math.min(newImgFiles.length,IMG_LIMIT)}/${IMG_LIMIT}`;
  }

  attachDrop(stlDrop, stlInput, STL_LIMIT, stlBadge, (files)=>{
    const remaining = STL_LIMIT - newStlFiles.length;
    newStlFiles.push(...files.slice(0,remaining));
  });
  attachDrop(imgDrop, imgInput, IMG_LIMIT, imgBadge, (files)=>{
    const remaining = IMG_LIMIT - newImgFiles.length;
    newImgFiles.push(...files.slice(0,remaining));
  });

  // додавання URL
  stlAddUrlBtn.addEventListener('click', ()=>{
    if (stlLinks.length>=STL_LIMIT){ alert('Максимум 5 STL'); return; }
    const u = prompt('Встав URL STL/OBJ/PLY/GLTF/GLB:');
    if(!u) return;
    stlLinks.push(u.trim()); render();
  });
  imgAddUrlBtn.addEventListener('click', ()=>{
    if (imgLinks.length>=IMG_LIMIT){ alert('Максимум 5 фото'); return; }
    const u = prompt('Встав URL JPG/PNG/WEBP:');
    if(!u) return;
    imgLinks.push(u.trim()); render();
  });

  stlClearBtn.addEventListener('click', ()=>{ if(confirm('Очистити всі існуючі STL?')){ stlLinks=[]; render(); }});
  imgClearBtn.addEventListener('click', ()=>{ if(confirm('Очистити всі існуючі фото?')){ imgLinks=[]; render(); }});

  // завантажити поточний лот
  async function loadItem(){
    msg.textContent='Завантаження...';
    const r = await fetch(`/api/item/${ITEM_ID}`);
    if(!r.ok){ msg.textContent='Не знайдено.'; return; }
    const it = await r.json();

    titleEl.value = it.title||'';
    priceEl.value = it.price||0;
    tagsEl.value  = (it.tags||'');
    descEl.value  = it.desc||'';

    const photos = Array.isArray(it.photos) ? it.photos : (it.photos||[]);
    const stlExtras = it.stl_files || [];
    const mainStl = (it.url||it.stl_main_url||'');

    stlLinks = [mainStl, ...stlExtras].filter(Boolean).slice(0,STL_LIMIT);
    imgLinks = [];
    if (it.cover) imgLinks.push(it.cover);
    (photos||[]).forEach(p=>{ if(p && p!==imgLinks[0]) imgLinks.push(p); });
    imgLinks = imgLinks.slice(0,IMG_LIMIT);

    msg.textContent='';
    render();
    updateBadges();
  }
  loadItem();

  // сабміт
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent='';

    const tagsRaw = (tagsEl.value||'').trim();
    const tagsArr = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];

    try{
      if (newStlFiles.length || newImgFiles.length){
        // MULTIPART з урахуванням упорядкування pending-масивів
        const fd = new FormData();
        fd.set('title', titleEl.value||'');
        fd.set('price', String(+priceEl.value||0));
        fd.set('desc',  descEl.value||'');
        fd.set('format','stl');
        fd.set('tags', JSON.stringify(tagsArr));

        if (newStlFiles.length){
          fd.set('stl_file', newStlFiles[0], newStlFiles[0].name);
          for(let i=1;i<Math.min(newStlFiles.length,STL_LIMIT);i++){
            fd.append('stl_files', newStlFiles[i], newStlFiles[i].name);
          }
        } else if (stlLinks[0]) {
          // підстраховка, якщо файлів немає, але хочемо зберегти існуючий
          fd.set('stl_url', stlLinks[0]);
          stlLinks.slice(1,STL_LIMIT).forEach(u=> fd.append('stl_files', new File([], u)) ); // не обов’язково
        }

        if (newImgFiles.length){
          fd.set('cover_file', newImgFiles[0], newImgFiles[0].name);
          for(let i=1;i<Math.min(newImgFiles.length,IMG_LIMIT);i++){
            fd.append('gallery_files', newImgFiles[i], newImgFiles[i].name);
          }
        } else if (imgLinks[0]) {
          fd.set('cover_url', imgLinks[0]);
        }

        const r = await fetch('/api/upload', { method:'POST', body:fd, headers:{'Accept':'application/json'}});
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error||'upload failed');

        if (document.getElementById('deleteOld').checked){
          await fetch(`/api/item/${ITEM_ID}/delete`, { method:'POST' });
        }
        location.href = `/item/${j.id}`;
      } else {
        // JSON лише з перевпорядкуванням/видаленням існуючих
        const payload = {
          title: titleEl.value||'',
          price: +priceEl.value||0,
          desc:  descEl.value||'',
          format:'stl',
          tags:  tagsArr,
          url:   (stlLinks[0]||''),
          cover: (imgLinks[0]||''),
          photos: {
            images: imgLinks.slice(1,IMG_LIMIT),
            stl:    stlLinks.slice(1,STL_LIMIT)
          }
        };
        const r = await fetch('/api/upload', {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error||'save failed');

        if (document.getElementById('deleteOld').checked){
          await fetch(`/api/item/${ITEM_ID}/delete`, { method:'POST' });
        }
        location.href = `/item/${j.id}`;
      }
    }catch(err){
      console.error(err);
      msg.textContent='Помилка збереження.';
    }
  });
})();
</script>
{% endblock %}
