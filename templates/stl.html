<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>Online Tools ‚Äî STL/3D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- –õ–∏—à–µ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –ø—ñ–¥ –≤ º—é–≤–µ—Ä -->
  <style>
    /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—ñ–¥ three.js */
    #viewer{
      width:100%;
      height:62vh;          /* –∞–¥–∞–ø—Ç–∏–≤–Ω–æ */
      min-height:420px;     /* —â–æ–± –Ω–µ —Å—Ç–∏—Å–∫–∞–≤—Å—è –∑–∞–Ω–∞–¥—Ç–æ */
      background:#111;
      border:1px solid #e1e5ee;
      border-radius:10px;
      overflow:hidden;
    }
    #viewer canvas{display:block;width:100%;height:100%;}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:#667085;margin-top:6px}
    hr{border:none;border-top:1px solid #e9ecf2;margin:10px 0}
  </style>

  <!-- importmap: —Ñ—ñ–∫—Å—É—î –º–æ–¥—É–ª—ñ, —â–æ–± –Ω–µ –±—É–ª–æ "Failed to resolve module specifier 'three'" -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/",
      "stl/loader": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/STLLoader.js",
      "stl/exporter": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/exporters/STLExporter.js",
      "font/loader": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/FontLoader.js",
      "text/geometry": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/geometries/TextGeometry.js",

      /* ADDED: –ª–æ–∞–¥–µ—Ä–∏ —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ */
      "gltf/loader": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/GLTFLoader.js",
      "obj/loader":  "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/OBJLoader.js",
      "ply/loader":  "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/PLYLoader.js",

      /* ADDED: –µ–∫—Å–ø–æ—Ä—Ç–µ—Ä–∏ —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ */
      "gltf/exporter":"https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/exporters/GLTFExporter.js",
      "obj/exporter": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/exporters/OBJExporter.js",
      "ply/exporter": "https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/exporters/PLYExporter.js"
    }
  }
  </script>
</head>
<body>

 <!-- NAV -->
 {% include 'nav.html' %}



  <!-- –û—Å–Ω–æ–≤–Ω–∞ —Å—ñ—Ç–∫–∞ (—Ç–≤–æ—è .layout + .card) -->
  <div class="layout">

    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
  <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
<div class="card side">
  <h2>–ú–æ–¥–µ–ª—å</h2>

  <label>STL/3D —Ñ–∞–π–ª</label>
  <input id="file" type="file" accept=".stl,.obj,.ply,.gltf,.glb">
  <p class="help">–ü–µ—Ä–µ—Ç—è–≥–Ω–∏ —Ñ–∞–π–ª —É –ø–µ—Ä–µ–≥–ª—è–¥ –∞–±–æ –≤–∏–±–µ—Ä–∏ —Ç—É—Ç.</p>

  <div class="row" style="margin-top:10px">
    <button id="btnDemo"  class="btn primary">–î–µ–º–æ –∫—É–±</button>
    <button id="btnReset" class="btn ghost">–†–µ—Å–µ—Ç –∫–∞–º–µ—Ä–∏</button>
  </div>

  <div class="row">
    <button id="btnWire" class="btn ghost">Wireframe ON/OFF</button>
    <button id="btnClear" class="btn ghost">–û—á–∏—Å—Ç–∏—Ç–∏</button>
  </div>

  <p class="help">–ö–µ—Ä—É–≤–∞–Ω–Ω—è: –õ–ö–ú ‚Äî –æ–±–µ—Ä—Ç–∞—Ç–∏, –∫–æ–ª–µ—Å–æ ‚Äî –∑—É–º, Shift+–õ–ö–ú ‚Äî –ø–∞–Ω–æ—Ä–∞–º—É–≤–∞—Ç–∏.</p>

  <hr>

  <!-- üîπ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó -->
  <h3>–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó</h3>
  <div class="row">
    <button id="btnCenter" class="btn ghost">–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ + –ù–∞ —Å—Ç—ñ–ª</button>
    <button id="btnAutoOrient" class="btn ghost">–ê–≤—Ç–æ–æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è</button>
  </div>
  <label>–ú–∞—Å—à—Ç–∞–± (%)</label>
  <div class="row">
    <input id="scalePct" type="number" min="1" max="1000" value="100" style="width:100px">
    <button id="btnScaleApply" class="btn ghost">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
  </div>
  <label>–û–±–µ—Ä—Ç–∞–Ω–Ω—è (¬∞)</label>
  <div class="row">
    <button data-rot="x-90" class="btn ghost rot">X ¬±90</button>
    <button data-rot="y-90" class="btn ghost rot">Y ¬±90</button>
    <button data-rot="z-90" class="btn ghost rot">Z ¬±90</button>
  </div>
  <div class="row">
    <button data-mirror="x" class="btn ghost mirror">Mirror X</button>
    <button data-mirror="y" class="btn ghost mirror">Mirror Y</button>
    <button data-mirror="z" class="btn ghost mirror">Mirror Z</button>
  </div>

  <hr>

  <!-- üîπ Slice -->
  <h3>–†—ñ–∑–∞—Ç–∏ –ø–ª–æ—â–∏–Ω–æ—é</h3>
  <label>–í–∏—Å–æ—Ç–∞ (Y)</label>
  <input id="sliceY" type="range" min="-200" max="200" value="0">
  <label>–ö—É—Ç –Ω–∞–≤–∫–æ–ª–æ X</label>
  <input id="sliceAx" type="range" min="-90" max="90" value="0">
  <label>–ö—É—Ç –Ω–∞–≤–∫–æ–ª–æ Z</label>
  <input id="sliceAz" type="range" min="-90" max="90" value="0">
  <div class="row">
    <button id="btnSlicePreview" class="btn ghost">–ü—Ä–µ–≤‚Äô—é –ø–ª–æ—â–∏–Ω–∏</button>
    <button id="btnSliceApply" class="btn ghost">–†–æ–∑—Ä—ñ–∑–∞—Ç–∏ ‚Üí 2 —á–∞—Å—Ç–∏–Ω–∏</button>
  </div>

  <hr>

  <!-- üîπ Boolean -->
  <h3>Boolean-–æ–ø–µ—Ä–∞—Ü—ñ—ó</h3>
  <div class="row">
    <button data-prim="box" class="btn ghost prim">–ö—É–±</button>
    <button data-prim="cyl" class="btn ghost prim">–¶–∏–ª—ñ–Ω–¥—Ä</button>
    <button data-prim="sph" class="btn ghost prim">–°—Ñ–µ—Ä–∞</button>
  </div>
  <div class="row">
    <button id="btnUnion" class="btn ghost">Union</button>
    <button id="btnSubtract" class="btn ghost">Subtract</button>
    <button id="btnIntersect" class="btn ghost">Intersect</button>
  </div>

  <hr>

  <!-- üîπ Hollow -->
  <h3>Hollow (–ø–æ—Ä–æ–∂–Ω–∏–Ω–∞)</h3>
  <label>–¢–æ–≤—â–∏–Ω–∞ —Å—Ç—ñ–Ω–∫–∏ (–º–º)</label>
  <input id="hollowWall" type="number" min="0.6" max="5" step="0.2" value="1.2" style="width:110px">
  <div class="row">
    <button id="btnHollow" class="btn ghost">–ó—Ä–æ–±–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω–∏—Å—Ç–æ—é</button>
  </div>
  <label>–û—Ç–≤–æ—Ä–∏ –¥–ª—è –ø–æ–≤—ñ—Ç—Ä—è</label>
  <div class="row">
    <button data-vent="3" class="btn ghost vent">√ò3 –º–º</button>
    <button data-vent="5" class="btn ghost vent">√ò5 –º–º</button>
    <button data-vent="8" class="btn ghost vent">√ò8 –º–º</button>
  </div>

  <hr>

  <!-- üîπ –ì—Ä–∞–≤—ñ—Ä—É–≤–∞–Ω–Ω—è -->
  <h3>–ì—Ä–∞–≤—ñ—Ä—É–≤–∞–Ω–Ω—è / –¢–∏—Å–Ω–µ–Ω–Ω—è</h3>
  <div class="row">
    <button id="btnEngraveText" class="btn ghost">–¢–µ–∫—Å—Ç</button>
    <button id="btnEngravePNG" class="btn ghost">PNG-–ª–æ–≥–æ—Ç–∏–ø</button>
  </div>

  <hr>

  <!-- üîπ Simplify -->
  <h3>Simplify / Decimate</h3>
  <label>–ó–∞–ª–∏—à–∏—Ç–∏ % —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫—ñ–≤</label>
  <input id="simpKeep" type="range" min="5" max="100" value="60">
  <div class="row">
    <button id="btnSimplify" class="btn ghost">–°–ø—Ä–æ—â–µ–Ω–Ω—è</button>
  </div>

  <hr>

  <!-- üîπ Mix&Match -->
  <h3>Mix & Match</h3>
  <input id="addFile" type="file" accept=".stl,.obj,.ply,.gltf,.glb">
  <div class="row" style="margin-top:6px">
    <button id="btnUnionAll" class="btn ghost">Union –≤—Å—ñ—Ö</button>
  </div>
</div>

    <!-- –¶–µ–Ω—Ç—Ä -->
    <div class="card">
      <h2>–ü–µ—Ä–µ–≥–ª—è–¥</h2>
      <div id="viewer"></div>
      <div class="hint" id="status"></div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="card side">
      <h2>–ê–≤—Ç–æ—Ä—Å—Ç–≤–æ</h2>

      <label for="author">–ê–≤—Ç–æ—Ä (–¥–ª—è ASCII STL)</label>
      <input id="author" type="text" placeholder="¬© My Brand" value="¬© My Brand">

      <label style="margin-top:8px">
        <input id="metaToggle" type="checkbox" checked>
        –î–æ–¥–∞–≤–∞—Ç–∏ ¬´–∑–º—ñ–Ω–Ω–µ¬ª –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ —É –Ω–∞–∑–≤—É <code>solid</code> (ASCII STL)
      </label>

      <hr>

      <h2 style="margin-top:0">3D –≤–æ–¥—è–Ω–∏–π –∑–Ω–∞–∫</h2>

      <label for="wmText">–¢–µ–∫—Å—Ç</label>
      <input id="wmText" type="text" placeholder="Brand" value="Brand">

      <label for="wmSize">–†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É</label>
      <input id="wmSize" type="range" min="2" max="40" value="12">

      <label for="wmDepth">–ì–ª–∏–±–∏–Ω–∞ (–º–º)</label>
      <input id="wmDepth" type="range" min="1" max="10" value="3">

      <label for="wmAngle">–ö—É—Ç (¬∞)</label>
      <input id="wmAngle" type="range" min="-90" max="90" value="0">

      <label for="wmOffset">–í—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ –∫—Ä–∞—ó–≤ (%)</label>
      <input id="wmOffset" type="range" min="0" max="20" value="4">

      <div class="row" style="margin-top:8px">
        <button id="btnPreview" class="btn ghost">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</button>
        <button id="btnBake" class="btn ghost" disabled>–ó–∞–ø–µ–∫—Ç–∏ –≤ –º–æ–¥–µ–ª—å</button>
      </div>

      <hr>

      <div class="row">
        <button id="btnExportAscii" class="btn primary">–ï–∫—Å–ø–æ—Ä—Ç STL (ASCII)</button>
        <button id="btnExportBinary" class="btn ghost">–ï–∫—Å–ø–æ—Ä—Ç STL (Binary)</button>
      </div>

      <!-- ADDED: –±–ª–æ–∫ —à–≤–∏–¥–∫–æ—ó –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó/–µ–∫—Å–ø–æ—Ä—Ç—É -->
      <h3 style="margin-top:12px">–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è / –ï–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="row">
        <button id="btnExpGLB"  class="btn ghost">Export GLB</button>
        <button id="btnExpGLTF" class="btn ghost">Export GLTF</button>
      </div>
      <div class="row">
        <button id="btnExpOBJ"  class="btn ghost">Export OBJ</button>
        <button id="btnExpPLY"  class="btn ghost">Export PLY</button>
      </div>

      <p class="help">–§–∞–π–ª–∏ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: STL, OBJ, PLY, glTF/GLB.</p>
    </div>
  </div>

  <!-- JS (–º–æ–¥—É–ª—ñ —á–µ—Ä–µ–∑ importmap) -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader }     from 'stl/loader';
    import { STLExporter }   from 'stl/exporter';
    import { FontLoader }    from 'font/loader';
    import { TextGeometry }  from 'text/geometry';

    /* ADDED: —ñ–º–ø–æ—Ä—Ç–∏ –ª–æ–∞–¥–µ—Ä—ñ–≤/–µ–∫—Å–ø–æ—Ä—Ç–µ—Ä—ñ–≤ */
    import { GLTFLoader }    from 'gltf/loader';
    import { OBJLoader }     from 'obj/loader';
    import { PLYLoader }     from 'ply/loader';

    import { GLTFExporter }  from 'gltf/exporter';
    import { OBJExporter }   from 'obj/exporter';
    import { PLYExporter }   from 'ply/exporter';

    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');

    // ---- –°—Ü–µ–Ω–∞
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);

    const camera = new THREE.PerspectiveCamera(50, 1, 0.01, 1000);
    camera.position.set(1.2, 0.9, 1.8);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
    $('viewer').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // –°–≤—ñ—Ç–ª–æ + —Å—ñ—Ç–∫–∞
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(2,2,2); scene.add(dir);
    const grid = new THREE.GridHelper(10, 10, 0x3a4153, 0x262b39);
    grid.position.y = -0.001; scene.add(grid);

    // –ì—Ä—É–ø–∏
    const modelRoot = new THREE.Group(); scene.add(modelRoot);
    const watermarkGroup = new THREE.Group(); scene.add(watermarkGroup);

    // –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏
    const baseMaterial = new THREE.MeshStandardMaterial({ color:0x9aa7c7, roughness:.85, metalness:.05 });
    const wireMaterial = new THREE.MeshBasicMaterial({ color:0xffffff, wireframe:true });
    let wireframeOn = false;

    // –†–µ—Å–∞–π–∑
    function resize(){
      const cont = $('viewer');
      const w = cont.clientWidth || cont.parentElement.clientWidth || 800;
      const h = cont.clientHeight || Math.max(420, Math.round(w*0.62));
      renderer.setSize(w,h,false);
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
    }
    new ResizeObserver(resize).observe($('viewer')); window.addEventListener('resize', resize); resize();

    function fitCameraToObject(object, zoom=1.6){
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const fov = camera.fov * (Math.PI/180);
      let camZ = Math.abs(maxDim / (2*Math.tan(fov/2))) * zoom;
      camZ = Math.max(camZ, 0.1);
      camera.position.set(center.x+camZ*0.7, center.y+camZ*0.5, center.z+camZ);
      camera.near = camZ/100; camera.far = camZ*100; camera.updateProjectionMatrix();
      controls.target.copy(center); controls.update();
    }
    function resetCamera(){
      if (modelRoot.children.length) fitCameraToObject(modelRoot, 1.6);
      else { camera.position.set(1.2,0.9,1.8); controls.target.set(0,0,0); controls.update(); }
    }

    // –®—Ä–∏—Ñ—Ç –¥–ª—è 3D-—Ç–µ–∫—Å—Ç—É
    const fontLoader = new FontLoader();
    let font = null;
    fontLoader.load(
      'https://cdn.jsdelivr.net/npm/three@0.159/examples/fonts/helvetiker_regular.typeface.json',
      f => font = f,
      undefined,
      err => console.warn('–®—Ä–∏—Ñ—Ç –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è:', err)
    );

    // –õ–æ–∞–¥–µ—Ä–∏
    const stlLoader  = new STLLoader();
    const gltfLoader = new GLTFLoader();     // ADDED
    const objLoader  = new OBJLoader();      // ADDED
    const plyLoader  = new PLYLoader();      // ADDED

    function clearGroup(grp){
      while(grp.children.length){
        const m = grp.children.pop();
        m.geometry?.dispose?.(); m.material?.dispose?.();
      }
    }
    function clearAll(){ clearGroup(modelRoot); clearGroup(watermarkGroup); statusEl.textContent=''; }

    function addGeometry(geometry){
      geometry.computeVertexNormals?.();
      const mesh = new THREE.Mesh(geometry, wireframeOn ? wireMaterial : baseMaterial);
      modelRoot.add(mesh);
      fitCameraToObject(modelRoot, 1.6);
      $('btnBake').disabled = false;
    }

    // ADDED: –¥–æ–¥–∞–≤ –ø—ñ–¥—Ç—Ä–∏–º–∫—É Object3D (glTF/OBJ)
    function addObject(obj){
      // –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ —ñ –ø–æ–¥–≤—ñ–π–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏
      obj.traverse(n=>{
        if(n.isMesh){
          n.material = wireframeOn ? wireMaterial : baseMaterial.clone();
          n.material.side = THREE.DoubleSide;
          n.geometry?.computeVertexNormals?.();
        }
      });
      modelRoot.add(obj);
      // –ø–æ–∫–ª–∞—Å—Ç–∏ –Ω–∞ "—Å—Ç—ñ–ª" —ñ —Ü–µ–Ω—Ç—Ä
      const box = new THREE.Box3().setFromObject(modelRoot);
      const center = box.getCenter(new THREE.Vector3());
      const minY = box.min.y;
      modelRoot.position.sub(center);
      modelRoot.position.y -= minY; // lay-flat
      fitCameraToObject(modelRoot, 1.6);
      $('btnBake').disabled = true; // –∑–∞–ø—ñ–∫–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—î –¥–ª—è –æ–¥–Ω—ñ—î—ó —Å—ñ—Ç–∫–∏ ‚Äî –∑–∞–ª–∏—à–∞—é —è–∫ —î
    }

    // –Ü–°–ù–£–Æ–ß–ò–ô: —Ç—ñ–ª—å–∫–∏ STL
    function loadSTLFromFile(file){
      const url = URL.createObjectURL(file);
      stlLoader.load(url, (geom)=>{
        clearAll(); addGeometry(geom); URL.revokeObjectURL(url);
      }, undefined, (err)=>{
        console.error('STL load error:', err); alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ STL.');
      });
    }

    // ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û: —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    function loadAnyFromFile(file){
      const ext = file.name.split('.').pop().toLowerCase();
      const url = URL.createObjectURL(file);

      const done = ()=> URL.revokeObjectURL(url);

      const onError = (err)=>{
        console.error('Load error:', err);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞: STL, OBJ, PLY, glTF/GLB.');
        done();
      };

      if (ext === 'stl'){
        stlLoader.load(url, (geom)=>{ clearAll(); addGeometry(geom); done(); }, undefined, onError);
      } else if (ext === 'obj'){
        objLoader.load(url, (obj)=>{ clearAll(); addObject(obj); done(); }, undefined, onError);
      } else if (ext === 'ply'){
        plyLoader.load(url, (geom)=>{ geom.computeVertexNormals(); clearAll(); addGeometry(geom); done(); }, undefined, onError);
      } else if (ext === 'gltf' || ext === 'glb'){
        gltfLoader.load(url, (gltf)=>{ clearAll(); addObject(gltf.scene); done(); }, undefined, onError);
      } else {
        alert('–§–æ—Ä–º–∞—Ç –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è (–¥–æ—Å—Ç—É–ø–Ω—ñ: STL, OBJ, PLY, glTF/GLB).');
        done();
      }
    }

    // Drag&Drop
    (()=>{
      const dz = $('viewer').parentElement;
      dz.addEventListener('dragover', e=>{e.preventDefault(); dz.style.outline='2px dashed #6c63ff';});
      ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); dz.style.outline='none';}));
      dz.addEventListener('drop', e=>{
        const f = e.dataTransfer?.files?.[0];
        if (!f) return;
        // –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫—ñ–ª—å–∫–æ—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤
        if (/\.(stl|obj|ply|gltf|glb)$/i.test(f.name)) loadAnyFromFile(f);
        else alert('–ü—ñ–¥—Ç—Ä–∏–º–∫–∞: STL, OBJ, PLY, glTF/GLB.');
      });
    })();

    // UI
    $('file').addEventListener('change', ()=>{
      const f = $('file').files?.[0];
      if (f) loadAnyFromFile(f);
    });
    $('btnDemo').addEventListener('click', ()=>{
      clearAll();
      const g = new THREE.BoxGeometry(50,30,20);
      addGeometry(g);
    });
    $('btnReset').addEventListener('click', resetCamera);
    $('btnWire').addEventListener('click', ()=>{
      wireframeOn = !wireframeOn;
      modelRoot.traverse(o=>{ if (o.isMesh) o.material = wireframeOn?wireMaterial:baseMaterial; });
    });
    $('btnClear').addEventListener('click', ()=>{ clearAll(); $('file').value=''; resetCamera(); });

    // –ü—Ä–µ–≤‚Äô—é 3D-–≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫—É
    function previewWatermark(){
      if (!font){ alert('–®—Ä–∏—Ñ—Ç —â–µ –≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è. –°–ø—Ä–æ–±—É–π –∑–∞ –º–∏—Ç—å.'); return; }
      if (!modelRoot.children.length){ alert('–°–ø–µ—Ä—à—É –∑–∞–≤–∞–Ω—Ç–∞–∂ –º–æ–¥–µ–ª—å.'); return; }
      clearGroup(watermarkGroup);

      const text = $('wmText').value.trim() || 'Brand';
      const size = +$('wmSize').value;
      const depth= +$('wmDepth').value;
      const angle= (+$('wmAngle').value * Math.PI/180);
      const offsetP = +$('wmOffset').value / 100;

      const tg = new TextGeometry(text, { font, size, height:depth, curveSegments:8, bevelEnabled:false });
      tg.computeBoundingBox();
      const mat = new THREE.MeshStandardMaterial({ color:0xff4488, transparent:true, opacity:.65 });
      const mesh = new THREE.Mesh(tg, mat);

      // –ø–æ–∑–∏—Ü—ñ—è –Ω–∞ –≤–µ—Ä—Ö–Ω—ñ–π –≥—Ä–∞–Ω—ñ –º–æ–¥–µ–ª—ñ
      const mbox = new THREE.Box3().setFromObject(modelRoot);
      const msize = mbox.getSize(new THREE.Vector3());
      const margin = msize.length() * offsetP;

      mesh.rotation.set(0,0,angle);
      mesh.position.set(mbox.min.x + margin, mbox.max.y + 0.1, mbox.min.z + margin);

      watermarkGroup.add(mesh);
      statusEl.textContent = '–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –∑–Ω–∞–∫—É –∞–∫—Ç–∏–≤–Ω–∏–π (—Ä–æ–∂–µ–≤–∏–π –æ–± º—î–∫—Ç).';
    }
    $('btnPreview').addEventListener('click', previewWatermark);

    // –ó–∞–ø—ñ–∫–∞–Ω–Ω—è —É –≥–µ–æ–º–µ—Ç—Ä—ñ—é (–ø—Ä–æ—Å—Ç–µ –æ–± º—î–¥–Ω–∞–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π)
    function bakeWatermark(){
      if (!watermarkGroup.children.length){ alert('–ù–µ–º–∞—î –ø—Ä–µ–≤ º—é –∑–Ω–∞–∫—É. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª.'); return; }
      const base = modelRoot.children.find(o=>o.isMesh);
      if (!base){ alert('–ù–µ–º–∞—î –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –º–æ–¥–µ–ª—ñ.'); return; }

      const wm = watermarkGroup.children[0];
      wm.updateMatrixWorld(true);

      const baseGeo = base.geometry.clone();
      const wmGeo   = wm.geometry.clone().applyMatrix4(wm.matrixWorld);

      const aPos = baseGeo.getAttribute('position');
      const bPos = wmGeo.getAttribute('position');
      const pos  = new Float32Array(aPos.count*3 + bPos.count*3);
      pos.set(aPos.array, 0);
      pos.set(bPos.array, aPos.count*3);

      const merged = new THREE.BufferGeometry();
      merged.setAttribute('position', new THREE.BufferAttribute(pos, 3));
      merged.computeVertexNormals();

      base.geometry.dispose();
      base.geometry = merged;

      clearGroup(watermarkGroup);
      statusEl.textContent = '–ó–Ω–∞–∫ –∑–∞–ø–µ—á–µ–Ω–æ —É –≥–µ–æ–º–µ—Ç—Ä—ñ—é.';
    }
    $('btnBake').addEventListener('click', bakeWatermark);

    // –ï–∫—Å–ø–æ—Ä—Ç (—ñ—Å–Ω—É—é—á–∏–π STL)
    const stlExporter = new STLExporter();
    function download(name, data, bin=false){
      const blob = new Blob([data], {type: bin? 'application/octet-stream':'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = name; a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportSTL(isBinary){
      const mesh = modelRoot.children.find(o=>o.isMesh);
      if (!mesh){ alert('–ù–µ–º–∞—î –º–æ–¥–µ–ª—ñ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É.'); return; }

      if (!isBinary){
        const addMeta = $('metaToggle').checked;
        const author = ($('author').value||'').replace(/\s+/g,' ').trim();
        const prev = mesh.name;
        mesh.name = addMeta && author ? `author=${author}` : (prev || 'model');
        const ascii = stlExporter.parse(mesh, {binary:false});
        mesh.name = prev;
        download((author?author.replaceAll(' ','_')+'_':'')+'model_ascii.stl', ascii, false);
      } else {
        const buf = stlExporter.parse(mesh, {binary:true});
        download('model_binary.stl', buf, true);
      }
    }
    $('btnExportAscii').addEventListener('click', ()=>exportSTL(false));
    $('btnExportBinary').addEventListener('click', ()=>exportSTL(true));

    /* —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –µ–∫—Å–ø–æ—Ä—Ç—É ‚Äî –∑–±–∏—Ä–∞—î–º–æ –≤–∏–¥–∏–º—É –≥–µ–æ–º–µ—Ç—Ä—ñ—é –∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞–º–∏ */
    function getExportGroup(){
      if(!modelRoot || modelRoot.children.length===0){ alert('–ù–µ–º–∞ –º–æ–¥–µ–ª—ñ'); return null; }
      const group = new THREE.Group();
      modelRoot.updateMatrixWorld(true);
      modelRoot.traverse(n=>{
        if(n.isMesh && n.geometry){
          const g = n.geometry.clone();
          g.applyMatrix4(n.matrixWorld);
          group.add(new THREE.Mesh(g));
        }
      });
      if(!group.children.length){ alert('–ù–µ–º–∞ —Å—ñ—Ç–∫–∏'); return null; }
      return group;
    }

    /* –µ–∫—Å–ø–æ—Ä—Ç —É GLB/GLTF/OBJ/PLY */
    function exportGLB(){
      const root = getExportGroup(); if(!root) return;
      const ex = new GLTFExporter();
      ex.parse(root, (bin)=>{
        download('model.glb', bin, true);
      }, { binary:true, onlyVisible:true, trs:false });
    }
    function exportGLTF(){
      const root = getExportGroup(); if(!root) return;
      const ex = new GLTFExporter();
      ex.parse(root, (gltf)=>{
        const json = JSON.stringify(gltf);
        download('model.gltf', json, false);
      }, { binary:false, onlyVisible:true, trs:false, embedImages:true });
    }
    function exportOBJ(){
      const root = getExportGroup(); if(!root) return;
      const ex = new OBJExporter();
      const text = ex.parse(root);
      download('model.obj', text, false);
    }
    function exportPLY(){
      const root = getExportGroup(); if(!root) return;
      const ex = new PLYExporter();
      const text = ex.parse(root);
      download('model.ply', text, false);
    }

    // –æ–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó
    $('btnExpGLB') .addEventListener('click', exportGLB);
    $('btnExpGLTF').addEventListener('click', exportGLTF);
    $('btnExpOBJ') .addEventListener('click', exportOBJ);
    $('btnExpPLY') .addEventListener('click', exportPLY);

    // –†–µ–Ω–¥–µ—Ä
    (function loop(){
      requestAnimationFrame(loop);
      controls.update();
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>
