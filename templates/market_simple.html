{% extends "base.html" %}
{% block content %}

<div class="wrap">
  <header>
    <div class="brand">üß© STL Market (simple)</div>

    <div class="search-box">
      <input id="q" placeholder="–ü–æ—à—É–∫: dragon, stand, toy..." />
      <button class="btn" id="btnSearch">üîç</button>
    </div>

    <div class="toolbar">
      <button class="btn" id="btnMine">–ú–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
      <a href="{{ url_for('market.page_upload') }}" class="btn primary">+ –î–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å</a>
    </div>
  </header>

  <div class="controls">
    <label>–ü–æ–∫–∞–∑–∞—Ç–∏:
      <select id="filterFree">
        <option value="all">–£—Å—ñ</option>
        <option value="free">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ</option>
        <option value="paid">–ü–ª–∞—Ç–Ω—ñ</option>
      </select>
    </label>
    <label>–°–æ—Ä—Ç—É–≤–∞—Ç–∏:
      <select id="sort">
        <option value="new">–ù–æ–≤—ñ</option>
        <option value="price_asc">–¶—ñ–Ω–∞ ‚Üë</option>
        <option value="price_desc">–¶—ñ–Ω–∞ ‚Üì</option>
      </select>
    </label>
  </div>

  <!-- –°—Ç–∞—Ç—É—Å / –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
  <div id="status" class="status"></div>

  <!-- –°—ñ—Ç–∫–∞ –∫–∞—Ä—Ç–æ–∫ -->
  <div id="grid" class="grid"></div>

  <!-- –°–µ–Ω—Å–æ—Ä –¥–ª—è –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–≥–æ —Å–∫—Ä–æ–ª—É -->
  <div id="sentinel" class="sentinel"></div>
</div>

<style>
  :root {
    --bg:#0f1116; --card:#141923; --muted:#8792a7;
    --line:#232a3a; --text:#e7ebf4; --accent:#3b82f6; --danger:#ef4444;
  }
  .wrap{max-width:1280px;margin:0 auto;padding:16px;}
  header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;}
  .brand{font-weight:800;font-size:18px;letter-spacing:.3px;}
  .search-box{flex:1;display:flex;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:6px;}
  .search-box input{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;outline:none;}
  .toolbar{display:flex;gap:8px}
  .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
  .btn.active{outline:2px solid var(--accent)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px;}
  .item{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;}
  .thumb{width:100%;aspect-ratio:4/3;object-fit:cover;border-bottom:1px solid var(--line);}
  .meta{padding:10px;display:flex;flex-direction:column;gap:6px;}
  .title{font-weight:700;}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 6px;border-radius:999px;color:var(--muted);}
  .muted{color:var(--muted);font-size:13px;}
  .price{font-weight:700;}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .status{margin:8px 0;color:var(--muted)}
  .sentinel{height:1px}
</style>

<script type="module">
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};
  const grid = document.getElementById('grid');
  const q = document.getElementById('q');
  const filterFree = document.getElementById('filterFree');
  const sortSel = document.getElementById('sort');
  const btnSearch = document.getElementById('btnSearch');
  const btnMine = document.getElementById('btnMine');
  const statusEl = document.getElementById('status');
  const sentinel = document.getElementById('sentinel');

  // –°—Ç–∞–Ω
  let mode = 'all';           // 'all' | 'mine'
  let page = 1;
  const PER = 24;
  let more = true;
  let loading = false;
  let series = 0;             // —â–æ–± —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ —Å—Ç–∞—Ä—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

  // –ü–æ–¥—ñ—ó
  window.addEventListener('load', resetAndLoad);
  btnSearch.addEventListener('click', resetAndLoad);
  q.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); resetAndLoad(); }});
  filterFree.addEventListener('change', () => { if (mode==='all') resetAndLoad(); });
  sortSel.addEventListener('change', resetAndLoad);
  btnMine.addEventListener('click', () => {
    if (!CURRENT_USER_ID) return setStatus('–ü–æ—Ç—Ä—ñ–±–Ω–æ —É–≤—ñ–π—Ç–∏, —â–æ–± –±–∞—á–∏—Ç–∏ —Å–≤–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è.');
    mode = (mode === 'mine') ? 'all' : 'mine';
    btnMine.classList.toggle('active', mode === 'mine');
    resetAndLoad();
  });

  // –Ü–Ω—Ñ—ñ–Ω—ñ—Ç-—Å–∫—Ä–æ–ª
  const io = new IntersectionObserver(e => {
    for (const en of e) if (en.isIntersecting) loadNext();
  }, { rootMargin: '800px 0px' });
  io.observe(sentinel);

  function setStatus(t){ statusEl.textContent = t || ''; }

  function resetAndLoad(){
    series++;
    page = 1; more = true; loading = false;
    grid.innerHTML = '';
    setStatus('');
    loadNext();
  }

  async function loadNext(){
    if (!more || loading) return;
    loading = true;
    const now = series;

    // –ø—Ä–æ—Å—Ç–∏–π –ª–æ–∞–¥–µ—Ä
    const loader = document.createElement('div');
    loader.className = 'status';
    loader.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶';
    grid.appendChild(loader);

    try{
      const url = (mode === 'mine')
        ? `/api/my/items?page=${page}&per_page=${PER}`
        : `/api/items?` + new URLSearchParams({
            q: q.value || '',
            free: filterFree.value,
            page: String(page),
            per_page: String(PER)
          }).toString();

      const r = await fetch(url);

      if (now !== series) return; // —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏ ‚Äî —ñ–≥–Ω–æ—Ä–∏–º–æ

      if (!r.ok){
        if (loader.parentNode === grid) grid.removeChild(loader);
        if (mode==='mine' && r.status===401){
          grid.innerHTML = `<div class="status">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è, —â–æ–± –±–∞—á–∏—Ç–∏ —Å–≤–æ—ó –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è.</div>`;
        } else {
          grid.innerHTML = `<div class="status">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (${r.status}).</div>`;
        }
        more = false;
        return;
      }

      const data = await r.json().catch(()=> ({}));
      const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      const pages = Number(data.pages || 1);

      if (loader.parentNode === grid) grid.removeChild(loader);

      // –∫–ª—ñ—î–Ω—Ç—Å—å–∫–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
      if (sortSel.value === 'price_asc') items.sort((a,b)=>(+a.price||0)-(+b.price||0));
      else if (sortSel.value === 'price_desc') items.sort((a,b)=>(+b.price||0)-(+a.price||0));
      else items.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));

      append(items);

      page++;
      more = page <= pages && items.length > 0;

      if (!grid.children.length){
        grid.innerHTML = `<div class="status">${mode==='mine' ? '–£ —Ç–µ–±–µ —â–µ –Ω–µ–º–∞—î –æ–≥–æ–ª–æ—à–µ–Ω—å.' : '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.'}</div>`;
      }
    }catch(err){
      console.error(err);
      if (loader.parentNode === grid) grid.removeChild(loader);
      grid.innerHTML = `<div class="status">–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.</div>`;
      more = false;
    }finally{
      loading = false;
    }
  }

  function append(items){
    for (const it of items){
      const tags = Array.isArray(it.tags) ? it.tags
        : (typeof it.tags === 'string' ? it.tags.split(',').map(s=>s.trim()).filter(Boolean) : []);
      const cover = it.cover || '/static/img/placeholder_stl.jpg';

      const card = document.createElement('div');
      card.className = 'item';
      card.innerHTML = `
        <img class="thumb" loading="lazy" src="${cover}"
             onerror="this.onerror=null;this.src='/static/img/placeholder_stl.jpg';" alt="">
        <div class="meta">
          <div class="title">${escapeHtml(it.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏')}</div>
          <div class="tags">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
          <div class="muted">‚òÖ ${it.rating ?? '‚Äî'}</div>
          <div class="price">${(+it.price||0)===0 ? '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ' : (Number(it.price)+' PLN')}</div>
          <div class="actions">
            <button class="btn" data-open="${it.id}">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
            ${ ownerBtns(it) }
          </div>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  function ownerBtns(it){
    const owner = (mode==='mine') || (CURRENT_USER_ID && +it.user_id === +CURRENT_USER_ID);
    if (!owner) return '';
    return `
      <button class="btn" data-edit="${it.id}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
      <button class="btn danger" data-del="${it.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
    `;
  }

  grid.addEventListener('click', async (e)=>{
    const idOpen = e.target?.dataset?.open;
    if (idOpen) return location.assign(`/item/${idOpen}`);

    const idEdit = e.target?.dataset?.edit;
    if (idEdit) return location.assign(`/edit/${idEdit}`);

    const idDel = e.target?.dataset?.del;
    if (idDel){
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –±–µ–∑–ø–æ–≤–æ—Ä–æ—Ç–Ω–æ?')) return;
      try{
        const r = await fetch(`/api/item/${idDel}/delete`, { method:'POST' });
        const j = await r.json().catch(()=>({}));
        if (r.ok && j.ok){
          setStatus('–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ.');
          resetAndLoad();
        } else {
          setStatus('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ (–Ω–µ–º–∞—î –ø—Ä–∞–≤ –∞–±–æ –ø–æ–º–∏–ª–∫–∞).');
        }
      }catch(err){
        console.error(err);
        setStatus('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ.');
      }
    }
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
    ));
  }
</script>

{% endblock %}
