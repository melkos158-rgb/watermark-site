<style>
  /* ===== Telegram-like chat (compact height) ===== */
  .chat-fab{
    position:fixed; left:16px; bottom:calc(env(safe-area-inset-bottom) + 16px);
    width:52px;height:52px;border-radius:50%;
    border:1px solid var(--line); background:var(--card); color:var(--ink);
    display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9999;
    box-shadow:0 8px 24px rgba(0,0,0,.35); font-size:22px;
  }
  .chat-fab:hover{ filter:brightness(1.05) }

  .chat-panel{
    position:fixed; left:16px; bottom:calc(env(safe-area-inset-bottom) + 78px);
    width:340px; max-height:480px; z-index:9999; overflow:hidden;
    background:var(--card); border:1px solid var(--line); border-radius:14px;
    box-shadow:0 12px 28px rgba(0,0,0,.45); display:none;
  }
  .chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--nav-bg);border-bottom:1px solid var(--line)}
  .chat-head b{font-size:14px}

  .chat-body{
    height:340px; overflow:auto;
    padding:10px 10px 8px;
    display:flex; flex-direction:column;
    gap:6px; /* –º–µ–Ω—à–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—è –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ */
    background:
      radial-gradient(1200px 500px at 100% -20%, rgba(255,255,255,.04), transparent 60%),
      radial-gradient(1200px 600px at -30% 110%, rgba(255,255,255,.04), transparent 60%),
      var(--card);
  }

  .chat-row{ display:flex; align-items:flex-end; gap:8px; width:100%; }
  .chat-row.me{ margin-left:auto; justify-content:flex-end; }

  .chat-avatar{
    width:24px;height:24px; /* –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–µ */
    border-radius:50%;object-fit:cover;
    flex:0 0 24px;background:#2a2f3b;border:1px solid var(--line);
  }

  /* ===== –ë—É–ª—å–±–∞—à–∫–∏: –∫–æ–º–ø–∞–∫—Ç–Ω—ñ –ø–æ –í–ò–°–û–¢–Ü ===== */
  .chat-bubble{
    position:relative;
    box-sizing:border-box;
    display:inline-block;
    flex:0 0 auto;

    /* —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–≤—É–∑–∏—Ç–∏/—Ä–æ–∑—à–∏—Ä–∏—Ç–∏ ‚Äì –ø–æ–º—ñ–Ω—è–π max-width/width —Ç—É—Ç */
    max-width: 170px;

    padding:4px 20px 4px 8px;   /* –º–µ–Ω—à—ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –≤—ñ–¥—Å—Ç—É–ø–∏ */
    border-radius:14px;         /* —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à–µ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—ñ */
    border:1px solid var(--line);
    background:#fff;            /* —á—É–∂—ñ */
    color:#111;
    box-shadow:0 1px 2px rgba(0,0,0,.12);
    font-size:13px;             /* –¥—Ä—ñ–±–Ω—ñ—à–∏–π —à—Ä–∏—Ñ—Ç */
    line-height:1.15;           /* —â—ñ–ª—å–Ω—ñ—à–µ –º—ñ–∂ —Ä—è–¥–∫–∞–º–∏ */
    word-break:break-word; white-space:pre-wrap;
  }
  .chat-row.me .chat-bubble{
    background:#5ec06a;         /* —Å–≤–æ—ó */
    border-color:rgba(0,0,0,.15);
    color:#fff;
  }

  /* —Ö–≤–æ—Å—Ç–∏–∫–∏ */
  .chat-bubble:after{
    content:"";
    position:absolute; bottom:-1px; left:-6px;
    width:10px;height:10px;       /* –º–µ–Ω—à–∏–π —Ö–≤–æ—Å—Ç–∏–∫ */
    background:inherit;
    border-left:1px solid var(--line);
    border-bottom:1px solid var(--line);
    transform:rotate(45deg);
    border-bottom-left-radius:2px;
  }
  .chat-row.me .chat-bubble:after{
    left:auto; right:-6px;
    border-left:none; border-bottom:none;
    border-right:1px solid rgba(0,0,0,.15);
    border-top:1px solid rgba(0,0,0,.15);
  }

  /* –≤–µ—Ä—Ö–Ω—ñ–π —Ä—è–¥–æ–∫ –∑ —ñ–º‚Äô—è–º ‚Äì —â–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–∏–π */
  .chat-meta{
    display:flex; align-items:center; gap:6px;
    margin:0 0 1px; font-size:11px; opacity:.9;
  }
  .chat-name{ font-weight:600; color:#2b6fb8; text-decoration:none; }
  .chat-row.me .chat-name{ color:#eaf7ff; }

  /* —á–∞—Å –±–ª–∏–∂—á–µ –¥–æ –∫—Ä–∞—é —ñ –¥—Ä—ñ–±–Ω—ñ—à–∏–π */
  .chat-time{
    position:absolute; right:6px; bottom:3px;
    font-size:10px; opacity:.75; color:inherit;
    font-variant-numeric: tabular-nums;
  }

  .chat-form{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line);background:var(--card)}
  .chat-form input{flex:1;background:var(--bg);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;outline:none}
  .chat-form button{background:var(--btn);border:0;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}

  @media (max-width:700px){
    .chat-panel{ width:min(94vw, 360px); }
    .chat-fab{ left:12px; }
    .chat-bubble{ max-width: 200px; } /* –º–æ–±—ñ–ª—å–Ω–∏–π –º–æ–∂–Ω–∞ —Ç—Ä–æ—Ö–∏ —à–∏—Ä—à–µ */
  }
</style>

<!-- FAB —ñ –ø–∞–Ω–µ–ª—å -->
<div class="chat-fab" id="chatFab" title="–ß–∞—Ç">üí¨</div>
<div class="chat-panel" id="chatPanel" aria-live="polite"
     data-uid="{{ (g.user.id if g is defined and g.user else (current_user.id if current_user is defined and current_user.is_authenticated else '')) }}">
  <div class="chat-head">
    <b>–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç</b>
    <button id="chatClose" style="background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:16px">‚úï</button>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <form class="chat-form" id="chatForm" autocomplete="off">
    <input id="chatInput" type="text" maxlength="500" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" />
    <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
  </form>
</div>

<script>
  (function(){
    const API_FETCH = "/chat/fetch";
    const API_POST  = "/chat/post";
    const fab   = document.getElementById("chatFab");
    const panel = document.getElementById("chatPanel");
    const close = document.getElementById("chatClose");
    const body  = document.getElementById("chatBody");
    const form  = document.getElementById("chatForm");
    const input = document.getElementById("chatInput");

    const CURRENT_UID = panel?.getAttribute('data-uid') || "";
    let lastId = null;
    let timer  = null;

    function esc(s){return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    function append(msg){
      const isMe = (msg.user_id != null && String(msg.user_id) === String(CURRENT_UID));

      const row = document.createElement("div");
      row.className = "chat-row" + (isMe ? " me" : "");

      const avatar = document.createElement("img");
      avatar.className = "chat-avatar";
      avatar.src = "/static/default-avatar.png";
      avatar.alt = "avatar";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = `
        <div class="chat-meta">
          <a class="chat-name" href="/profile/${msg.user_id || ''}" ${msg.user_id? '' : 'tabindex="-1"'}>${esc(msg.user_name||"–ì—ñ—Å—Ç—å")}</a>
        </div>
        <div class="chat-text">${esc(msg.text||"")}</div>
        <span class="chat-time">${esc(msg.time||"")}</span>
      `;

      if (isMe) { row.appendChild(bubble); row.appendChild(avatar); }
      else      { row.appendChild(avatar); row.appendChild(bubble); }

      body.appendChild(row);
      body.scrollTop = body.scrollHeight;
      lastId = msg.id;
    }

    function fetchInit(){
      fetch(API_FETCH).then(r=>r.json()).then(d=>{
        if(!d.ok) return;
        body.innerHTML = "";
        d.messages.forEach(append);
      }).catch(()=>{});
    }
    function fetchNew(){
      const url = lastId ? `${API_FETCH}?since_id=${lastId}` : API_FETCH;
      fetch(url).then(r=>r.json()).then(d=>{
        if(!d.ok) return;
        d.messages.forEach(append);
      }).catch(()=>{});
    }

    fab.onclick = () => {
      panel.style.display = "block";
      if(!timer){
        fetchInit();
        timer = setInterval(fetchNew, 2500);
      }
    };
    close.onclick = () => {
      panel.style.display = "none";
      if(timer){ clearInterval(timer); timer = null; }
    };

    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      input.value = "";
      fetch(API_POST, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text })
      }).then(r=>r.json()).then(()=>{ fetchNew(); }).catch(()=>{});
    });
  })();
</script>
