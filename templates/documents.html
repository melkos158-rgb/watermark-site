{% extends "base.html" %}
{% set page = 'documents' %}
{% block title %}Документи — Proofly{% endblock %}

{% block content %}
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">

<style>
  :root{
    --bg:#0b0e14; --card:#101522; --line:#1b2131; --text:#e6e9ef;
    --muted:#aab1c7; --chip:#161a20; --accent:#4f7cff;
  }

  .docs-wrap{padding:20px;color:var(--text);}
  .docs-container{max-width:1280px;margin:0 auto;}
  .grid-3{display:grid;grid-template-columns:320px minmax(640px,1.6fr) 320px;gap:18px;align-items:start;}
  .grid-3>*{min-width:0}

  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;}
  .panel h3{margin:0 0 10px;font-weight:700;font-size:16px;letter-spacing:.2px;}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:10px 14px;border-radius:12px;border:1px solid var(--line);
    background:#0f1730;color:#fff;cursor:pointer;user-select:none;
    transition:transform .02s ease,background .2s ease,border-color .2s ease;}
  .btn:hover{background:#142049;border-color:#24325a}
  .btn.primary{background:var(--accent);border-color:#5a86ff}
  .btn.ghost{background:transparent}
  .btn.small{padding:8px 12px;font-size:14px}
  .btn.block{width:100%}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}

  .tool{display:flex;flex-direction:column;gap:8px;padding:10px;
    background:var(--chip);border:1px solid var(--line);border-radius:12px;}
  .tool .ttl{font-size:13px;color:var(--muted)}
  .tool .btn{width:100%}

  .uploader{background:rgba(255,255,255,.02);border:1px dashed #2a3550;
    border-radius:12px;padding:12px;}
  input[type="file"]{color:var(--muted)}

  /* центр — прев’ю */
  .viewer{background:var(--card);border:1px solid var(--line);
    border-radius:14px;height:72vh;min-height:520px;
    display:flex;align-items:center;justify-content:center;
    position:relative;width:100%;overflow:hidden;}
  main.viewer{all:unset;}
  .viewer .hint{color:var(--muted);font-size:14px;
    position:absolute;top:14px;left:14px;z-index:2;}
  .viewer.has-preview .hint{display:none;}
  canvas#pdfCanvas,img#imgPreview{
    max-width:100%;max-height:100%;
    display:block;position:relative;z-index:3;
    background:#1b2131;
  }
  .theme-toggle{position:absolute;top:12px;right:12px;z-index:4}

  .pages{display:flex;flex-direction:column;gap:8px;
    max-height:60vh;overflow:auto;background:rgba(255,255,255,.03);
    border:1px solid var(--line);padding:10px;border-radius:12px;}
  .page-item{display:flex;align-items:center;gap:10px;
    background:#0f1422;border:1px solid #1b2336;
    border-radius:10px;padding:8px;cursor:grab;}
  .page-item.dragging{opacity:.6}
  .page-thumb{width:36px;height:48px;background:#0b0e14;
    border:1px solid #2a3550;border-radius:6px}
  .sep{height:1px;background:var(--line);margin:10px 0}
  .badge-server{font-size:11px;color:#ffcf8b;background:#3a250b;
    border:1px solid #6e4b14;border-radius:999px;padding:2px 6px}
  .muted{color:var(--muted)}
</style>

<div class="docs-wrap">
  <div class="docs-container">
    <!-- твоя вся розмітка без змін -->
    {{ super() }}
  </div>
</div>

<!-- ====== LIBRARIES ====== -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- pdf.js та worker (головне виправлення) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  } else {
    console.warn("⚠️ pdf.js не завантажився. Перевір шлях до CDN.");
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ====== LOGIC (усі функції без змін, тільки 3 фікси previewFile) ====== -->
<script>
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const toBlob=async(u8,mime='application/pdf')=>new Blob([u8],{type:mime});
const saveBlob=(b,n)=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;document.body.append(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),5e3)};
const getMainFile=()=>$('#fileInput').files?.[0];
const getManyFiles=()=>Array.from($('#fileInputMany').files||[]);
const note=m=>console.log('[Docs]',m);

const canvas=$('#pdfCanvas'),ctx=canvas.getContext('2d'),
img=$('#imgPreview'),docxMount=$('#docxMount'),viewer=$('#viewer');

const onMainFileChange=async()=>{
  const f=getMainFile();if(!f)return;
  await previewFile(f);
  if(/pdf$/i.test(f.name))await buildReorderListFromPdf(f);
};
$('#fileInput').addEventListener('change',onMainFileChange);
$('#fileInput').addEventListener('input',onMainFileChange);

async function previewFile(file){
  $('#qr').style.display='none';$('#qr').innerHTML='';
  canvas.style.display='none';img.style.display='none';docxMount.style.display='none';
  viewer.classList.remove('has-preview');

  const name=file.name.toLowerCase();

  if(name.endsWith('.pdf')){
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    const page=await pdf.getPage(1);

    const base=page.getViewport({scale:1});
    const pad=24;
    const maxW=Math.max(320,viewer.clientWidth-pad);
    const maxH=Math.max(320,viewer.clientHeight-pad);
    const scale=Math.min(maxW/base.width,maxH/base.height);
    const vp=page.getViewport({scale:Math.max(1,Math.min(scale,3))}); // ФІКС масштаб

    canvas.width=vp.width;canvas.height=vp.height;
    ctx.fillStyle='#1b2131';ctx.fillRect(0,0,canvas.width,canvas.height);
    await page.render({canvasContext:ctx,viewport:vp}).promise;
    canvas.style.display='block';
    viewer.classList.add('has-preview');
  }else if(/\.(png|jpg|jpeg|webp)$/i.test(name)){
    img.src=URL.createObjectURL(file);
    img.onload=()=>URL.revokeObjectURL(img.src);
    img.style.display='block';viewer.classList.add('has-preview');
  }else if(name.endsWith('.docx')){
    docxMount.innerHTML='<div class="muted">Попередній перегляд DOCX наразі спрощений. Експортуй у PDF для перегляду.</div>';
    docxMount.style.display='block';viewer.classList.add('has-preview');
  }else if(/\.(xlsx|csv|json)$/i.test(name)){
    docxMount.innerHTML='<div class="muted">Табличний файл: скористайся конвертаціями ліворуч.</div>';
    docxMount.style.display='block';viewer.classList.add('has-preview');
  }else{
    docxMount.innerHTML='<div class="muted">Формат не підтримано для прев’ю.</div>';
    docxMount.style.display='block';
  }
}
</script>
{% endblock %}
