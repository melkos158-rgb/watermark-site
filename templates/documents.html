{% extends "base.html" %}
{% set page = 'documents' %}
{% block title %}Перегляд PDF — Proofly{% endblock %}

{% block content %}

<style>
  .wrap{max-width:960px;margin:24px auto;padding:0 12px;color:#e6e9ef}
  .row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  #viewer{border:1px solid #30384a;border-radius:10px;height:80vh;min-height:420px;
          display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;background:#101522}
  #hint{position:absolute;top:12px;left:12px;color:#aab1c7;font-size:14px}
  canvas{max-width:100%;max-height:100%}
</style>

<div class="wrap">
  <div class="row">
    <input id="fileInput" type="file" accept="application/pdf">
    <span id="fname" style="color:#aab1c7"></span>
  </div>

  <div id="viewer">
    <span id="hint">Виберіть PDF-файл для перегляду</span>
    <canvas id="pdfCanvas"></canvas>
  </div>
</div>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  (function ensurePdfJs(){
    function setWorker(url){
      try{ pdfjsLib.GlobalWorkerOptions.workerSrc = url; }catch(e){}
    }
    if (window.pdfjsLib){
      setWorker("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js");
    }else{
      var s=document.createElement('script');
      s.src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js";
      s.onload=()=>setWorker("https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js");
      document.head.appendChild(s);
    }
  })();
</script>

<script>
  const $ = s => document.querySelector(s);
  const canvas = $('#pdfCanvas');
  const ctx = canvas.getContext('2d');
  const viewer = $('#viewer');
  const hint = $('#hint');
  const fname = $('#fname');

  $('#fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f){ return; }
    fname.textContent = f.name;

    // читаємо як ArrayBuffer
    const buf = await f.arrayBuffer();

    // чекаємо, поки pdfjs завантажиться
    async function waitPdf() {
      return new Promise((res)=> {
        const i = setInterval(()=>{
          if (window.pdfjsLib){ clearInterval(i); res(); }
        }, 30);
      });
    }
    await waitPdf();

    // відкриваємо документ і рендеримо першу сторінку
    try{
      const pdf = await pdfjsLib.getDocument({data: buf}).promise;
      const page = await pdf.getPage(1);

      // підганяємо під розмір контейнера
      const base = page.getViewport({scale:1});
      const maxW = viewer.clientWidth - 16;
      const maxH = viewer.clientHeight - 16;
      const scale = Math.min(maxW / base.width, maxH / base.height);
      const vp = page.getViewport({scale: Math.max(0.25, Math.min(scale, 4))});

      canvas.width = vp.width;
      canvas.height = vp.height;

      hint.style.display = 'none';
      await page.render({canvasContext: ctx, viewport: vp}).promise;
    }catch(err){
      hint.textContent = 'Не вдалося відобразити PDF (' + (err?.message || err) + ')';
      hint.style.display = 'block';
      console.error(err);
    }
  });
</script>

{% endblock %}
