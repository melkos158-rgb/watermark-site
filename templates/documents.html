{% extends "base.html" %}
{% set page = 'documents' %}
{% block title %}Перегляд PDF — Proofly{% endblock %}

{% block content %}

<style>
  :root{ --bg:#0b0e14; --card:#101522; --text:#e6e9ef; --line:#1b2131 }
  body{ color:var(--text) }
  .wrap{
    max-width: 980px; margin: 24px auto; padding: 0 16px;
  }
  .bar{
    display:flex; gap:12px; align-items:center; margin-bottom:12px;
  }
  input[type="file"]{
    padding:8px; background:#0f1730; color:#e6e9ef; border:1px solid var(--line); border-radius:10px;
  }
  .viewer{
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    height: 78vh; min-height: 420px; display:flex; align-items:center; justify-content:center;
    position:relative; overflow:hidden;
  }
  .hint{ position:absolute; top:10px; left:12px; color:#aab1c7; font-size:14px }
  canvas{ max-width:100%; max-height:100%; display:none }
  .viewer.ready .hint{ display:none }
  .viewer.ready canvas{ display:block }
</style>

<div class="wrap">
  <div class="bar">
    <input id="pdfFile" type="file" accept="application/pdf">
  </div>

  <div class="viewer" id="viewer">
    <div class="hint">Виберіть PDF-файл, щоб побачити прев’ю (рендеримо першу сторінку).</div>
    <canvas id="pdfCanvas"></canvas>
  </div>
</div>

<!-- pdf.js з worker -->
<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  // Налаштування воркера
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  }

  const fileInput = document.getElementById('pdfFile');
  const viewer = document.getElementById('viewer');
  const canvas = document.getElementById('pdfCanvas');
  const ctx = canvas.getContext('2d');

  fileInput.addEventListener('change', async () => {
    const file = fileInput.files?.[0];
    if (!file) return;

    try{
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const page = await pdf.getPage(1);

      // Підігнати під вікно перегляду
      const base = page.getViewport({ scale: 1 });
      const pad = 24;
      const maxW = Math.max(320, viewer.clientWidth - pad);
      const maxH = Math.max(320, viewer.clientHeight - pad);
      const scale = Math.min(maxW / base.width, maxH / base.height);

      const vp = page.getViewport({ scale: scale });
      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);

      await page.render({ canvasContext: ctx, viewport: vp }).promise;

      viewer.classList.add('ready');
    }catch(err){
      console.error(err);
      alert('Не вдалося відрендерити PDF. Спробуйте інший файл.');
    }
  });
</script>

{% endblock %}
