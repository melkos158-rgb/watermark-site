{% extends "base.html" %}
{% set page = 'documents' %}
{% block title %}–î–æ–∫—É–º–µ–Ω—Ç–∏ ‚Äî Proofly{% endblock %}

{% block content %}
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">

<style>
  :root{ --bg:#0b0e14; --card:#101522; --line:#1b2131; --text:#e6e9ef; --muted:#aab1c7; --chip:#161a20; --accent:#4f7cff; }

  html{box-sizing:border-box} *,*:before,*:after{box-sizing:inherit}

  .docs-wrap{ padding:24px; color:var(--text); display:flex; justify-content:center; }
  .docs-container{ width:min(1240px, 100%); margin:0 auto; }

  .grid-3{ display:grid; grid-template-columns: 280px minmax(560px, 1fr) 280px; gap:20px; align-items:start; width:100%; }
  .grid-3 > * { min-width:0; }
  @media (max-width:1180px){ .grid-3{ grid-template-columns:260px minmax(520px,1fr) 260px; gap:18px } }
  @media (max-width:980px){ .grid-3{ grid-template-columns:1fr } }

  .panel{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; }
  .panel h3{ margin:0 0 10px; font-weight:700; font-size:16px; letter-spacing:.2px; }

  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line);
        background:#0f1730; color:#fff; cursor:pointer; user-select:none; transition:transform .02s ease, background .2s ease, border-color .2s ease; }
  .btn:hover{ background:#142049; border-color:#24325a } .btn.primary{ background:var(--accent); border-color:#5a86ff } .btn.ghost{ background:transparent }
  .btn.small{ padding:8px 12px; font-size:14px } .btn.block{ width:100% } .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px }

  .tool{ display:flex; flex-direction:column; gap:8px; padding:10px; background:var(--chip); border:1px solid var(--line); border-radius:12px; }
  .tool .ttl{ font-size:13px; color:var(--muted) } .tool .btn{ width:100% }
  .uploader{ background:rgba(255,255,255,.02); border:1px dashed #2a3550; border-radius:12px; padding:12px; }
  input[type="file"]{ color:var(--muted) }

  /* —Ü–µ–Ω—Ç—Ä ‚Äî –ø—Ä–µ–≤‚Äô—é/—Ä–µ–¥–∞–∫—Ç–æ—Ä */
  .viewer{ background:var(--card); border:1px solid var(--line); border-radius:14px; height:72vh; min-height:520px;
           display:flex; align-items:center; justify-content:center; position:relative; width:100%; overflow:hidden; padding-top:56px; }
  .viewer .hint{ color:var(--muted); font-size:14px; position:absolute; top:68px; left:14px; z-index:2; }
  .viewer.has-preview .hint{ display:none; }
  canvas#pdfCanvas, img#imgPreview{ max-width:100%; max-height:100%; display:block; position:relative; z-index:1; }
  .theme-toggle{ display:none !important; }

  /* –≤–µ—Ä—Ö–Ω—è —à–∞–ø–∫–∞-—ñ–∫–æ–Ω–∫–∏ */
  .viewer-bar{ position:absolute; inset:0 0 auto 0; height:56px; display:flex; align-items:center; gap:8px; padding:0 12px;
               background:rgba(255,255,255,.03); border-bottom:1px solid var(--line); border-top-left-radius:14px; border-top-right-radius:14px; z-index:5; }
  .viewer-bar .toolbtn{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--line);
                         background:#0f1730; font-size:18px; cursor:pointer; transition:transform .05s ease, background .2s ease, border-color .2s ease; }
  .viewer-bar .toolbtn:hover{ background:#142049; border-color:#24325a; transform:translateY(-1px) } .viewer-bar .toolbtn:active{ transform:translateY(0) }
  .viewer-bar .vr{ width:1px; height:28px; background:var(--line); margin:0 2px; } .viewer-bar .toolbtn[disabled]{ opacity:.45; cursor:not-allowed }

  /* === editor overlay === */
  .editor-layer{ position:absolute; inset:56px 0 0 0; display:none; align-items:center; justify-content:center; z-index:3; pointer-events:none; }
  .editor-stage{ position:relative; pointer-events:all; }
  .edit-toolbar{ position:absolute; top:8px; left:8px; display:flex; gap:8px; z-index:4; }
  .edit-toolbar .tbtn{ width:34px; height:34px; border-radius:8px; border:1px solid var(--line); background:#0f1730; display:inline-flex;
                       align-items:center; justify-content:center; font-size:18px; cursor:pointer; }
  .edit-toolbar .tbtn.active{ outline:2px solid var(--accent) }

  .edit-box{ position:absolute; min-width:80px; min-height:28px; padding:6px 8px; border:1px dashed #6b7bb8; border-radius:8px; background:rgba(0,0,0,.25);
             color:#fff; font:16px/1.35 "Inter", system-ui, Arial; cursor:move; }
  .edit-box[contenteditable="true"]:focus{ outline:none; border-style:solid; }
  .edit-img{ position:absolute; max-width:100%; max-height:100%; border:1px dashed #6b7bb8; border-radius:8px; cursor:move; }
  .hl-rect{ position:absolute; background:rgba(255,255,0,.22); border:1px solid rgba(255,255,0,.35); cursor:move; border-radius:4px; }

  .editor-pager{ position:absolute; bottom:12px; left:50%; transform:translateX(-50%); display:flex; gap:8px; align-items:center; z-index:4; }
  .editor-pager .pbtn{ width:34px; height:34px; border-radius:999px; border:1px solid var(--line); background:#0f1730; display:inline-flex; align-items:center; justify-content:center; }
  .editor-actions{ position:absolute; top:8px; right:8px; display:flex; gap:8px; z-index:4; }
  .editor-actions .act{ padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#0f1730; }

  .sep{ height:1px; background:var(--line); margin:10px 0 }
  .pages{ display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; background:rgba(255,255,255,.03); border:1px solid var(--line); padding:10px; border-radius:12px; }
  .page-item{ display:flex; align-items:center; gap:10px; background:#0f1422; border:1px solid #1b2336; border-radius:10px; padding:8px; cursor:grab; }
  .page-item.dragging{ opacity:.6 } .page-thumb{ width:36px; height:48px; background:#0b0e14; border:1px solid #2a3550; border-radius:6px }
  .badge-server{ font-size:11px; color:#ffcf8b; background:#3a250b; border:1px solid #6e4b14; border-radius:999px; padding:2px 6px } .muted{ color:var(--muted) }
</style>

<div class="docs-wrap">
  <div class="docs-container">
    <div class="grid-3">
      <!-- LEFT -->
      <aside class="panel">
        <h3>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó</h3>
        <div class="uploader">
          <div class="row"><label class="ttl">–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª</label><input id="fileInput" type="file" /></div>
          <div class="row"><label class="ttl">–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏ (–¥–ª—è Merge / Multi-photo)</label><input id="fileInputMany" type="file" multiple /></div>
        </div>

        <div class="sep"></div>

        <div class="tool"><div class="ttl">1) Image ‚Üí PDF</div><button class="btn block" id="btnImageToPdf">–°—Ç–≤–æ—Ä–∏—Ç–∏ PDF</button></div>
        <div class="tool"><div class="ttl">2) PDF ‚Üí Image</div><button class="btn block" id="btnPdfToImage">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤ PNG</button></div>
        <div class="tool"><div class="ttl">3) DOCX ‚Üí PDF</div><button class="btn block" id="btnDocxToPdf">–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏</button><small class="muted">–ë—Ä–∞—É–∑–µ—Ä–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ä–µ–Ω–¥–µ—Ä DOCX ‚Üí canvas ‚Üí PDF.</small></div>
        <div class="tool"><div class="ttl">4) PDF ‚Üí DOCX</div><button class="btn block" id="btnPdfToDocx">–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏</button><small class="muted">–ï–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—Å—Ç—É —Ç–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ —É .docx (–ø—Ä–æ—Å—Ç–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è).</small></div>
        <div class="tool"><div class="ttl">5) Excel / CSV ‚Üí PDF</div><button class="btn block" id="btnTableToPdf">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button></div>
        <div class="tool"><div class="ttl">6) PDF ‚Üí Excel / CSV</div><button class="btn block" id="btnPdfToCsv">–í–∏—Ç—è–≥–Ω—É—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ</button><small class="muted">–ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞–±–ª–∏—á–Ω–æ—ó —Ä–æ–∑–º—ñ—Ç–∫–∏ –∑ PDF (best-effort).</small></div>
        <div class="tool"><div class="ttl">19) Multi-photo ‚Üí PDF</div><button class="btn block" id="btnMultiPhotoToPdf">–°–∫–ª–µ—ó—Ç–∏ —Ñ–æ—Ç–æ –≤ PDF</button></div>
        <div class="tool"><div class="ttl">17) Convert JSON ‚Üî CSV ‚Üî XLS</div>
          <div class="row"><button class="btn small" id="btnJsonToCsv">JSON ‚Üí CSV</button><button class="btn small" id="btnCsvToXls">CSV ‚Üí XLSX</button><button class="btn small" id="btnXlsToCsv">XLSX ‚Üí CSV</button></div>
        </div>
        <div class="tool"><div class="ttl">16) Convert to ZIP</div><button class="btn block" id="btnZip">–£–ø–∞–∫—É–≤–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ</button></div>
        <div class="tool"><div class="ttl">18) Light / Dark Viewer</div><button class="btn block" id="btnThemeToggle">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É</button></div>
      </aside>

      <!-- CENTER -->
      <div class="viewer panel" id="viewer">
        <!-- –≤–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å -->
        <div class="viewer-bar">
          <button class="toolbtn" id="tb-editor" title="–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä üìù">üìù</button>
          <span class="vr"></span>
          <button class="toolbtn" id="tb-text" title="–î–æ–¥–∞—Ç–∏ —Ç–µ–∫—Å—Ç ‚úèÔ∏è">‚úèÔ∏è</button>
          <button class="toolbtn" id="tb-image" title="–î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è üñºÔ∏è">üñºÔ∏è</button>
          <button class="toolbtn" id="tb-highlight" title="–í–∏–¥—ñ–ª–µ–Ω–Ω—è ‚¨õ">üü®</button>
          <span class="vr"></span>
          <button class="toolbtn" id="tb-split" title="–†–æ–∑–¥—ñ–ª–∏—Ç–∏ ‚úÇÔ∏è">‚úÇÔ∏è</button>
          <button class="toolbtn" id="tb-merge" title="–ó–ª–∏—Ç–∏ üîó">üîó</button>
          <button class="toolbtn" id="tb-reorder" title="–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ ‚ÜïÔ∏è">‚ÜïÔ∏è</button>
          <span class="vr"></span>
          <button class="toolbtn" id="tb-export" title="PNG üñ®Ô∏è">üñ®Ô∏è</button>
          <button class="toolbtn" id="tb-compress" title="–°—Ç–∏—Å–Ω—É—Ç–∏ üóúÔ∏è">üóúÔ∏è</button>
        </div>

        <div class="hint">–û–±–µ—Ä–∏ —Ñ–∞–π–ª, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞: PDF, JPG, PNG, DOCX, XLSX, CSV.</div>

        <!-- —Ä–µ–¥–∞–∫—Ç–æ—Ä—Å—å–∫–∏–π —à–∞—Ä -->
        <div class="editor-layer" id="editorLayer">
          <div class="edit-toolbar" id="editToolbar">
            <button class="tbtn" id="toolSelect" title="–í–∏–¥—ñ–ª–µ–Ω–Ω—è (V)">üñ±Ô∏è</button>
            <button class="tbtn" id="toolText" title="–¢–µ–∫—Å—Ç (T)">‚úèÔ∏è</button>
            <button class="tbtn" id="toolImage" title="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (I)">üñºÔ∏è</button>
            <button class="tbtn" id="toolRect" title="–ñ–æ–≤—Ç–µ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è (R)">üü®</button>
          </div>
          <div class="editor-actions">
            <button class="act" id="actUndo">‚Ü∂</button>
            <button class="act" id="actRedo">‚Ü∑</button>
            <button class="act" id="actCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button class="act" id="actApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ ‚úÖ</button>
          </div>
          <div class="editor-pager">
            <button class="pbtn" id="pgPrev">‚óÄ</button>
            <div id="pgInfo" class="muted">1 / 1</div>
            <button class="pbtn" id="pgNext">‚ñ∂</button>
          </div>
          <div class="editor-stage" id="editorStage"></div>
        </div>

        <div class="theme-toggle">
          <span class="muted" style="margin-right:8px">–¢–µ–º–∞</span><button class="btn ghost small" id="btnThemeToggle2">üåô / ‚òÄÔ∏è</button>
        </div>

        <canvas id="pdfCanvas" style="display:none"></canvas>
        <img id="imgPreview" alt="" style="display:none"/>
        <div id="docxMount" style="display:none; max-width:95%; height:95%; overflow:auto"></div>
      </div>

      <!-- RIGHT -->
      <aside class="panel">
        <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ‚Ä¢ –Ü–Ω—à–µ</h3>
        <div class="tool"><div class="ttl">7) Merge PDF (–∑–ª–∏—Ç—Ç—è)</div><button class="btn block" id="btnMerge">–ó–ª–∏—Ç–∏ PDF</button></div>
        <div class="tool"><div class="ttl">8) Split PDF (–∑–∞ –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º —Å—Ç–æ—Ä—ñ–Ω–æ–∫)</div>
          <div class="row"><input id="splitRange" placeholder="–Ω–∞–ø—Ä. 1-3,5,8-9" class="btn ghost" style="flex:1; text-align:left"/><button class="btn" id="btnSplit">OK</button></div>
        </div>
        <div class="tool"><div class="ttl">9) Compress PDF</div><button class="btn block" id="btnCompress">–°—Ç–∏—Å–Ω—É—Ç–∏</button><small class="muted">–î–∞—É–Ω—Å–∫–µ–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω—å —É PDF (–≤–∏–∑–Ω–∞—á–∞—î–º–æ —è–∫—ñ—Å—Ç—å).</small></div>
        <div class="tool"><div class="ttl">10) Remove pages</div>
          <div class="row"><input id="removePages" placeholder="–Ω–∞–ø—Ä. 2,4,7" class="btn ghost" style="flex:1; text-align:left"/><button class="btn" id="btnRemovePages">–í–∏–¥–∞–ª–∏—Ç–∏</button></div>
        </div>
        <div class="tool"><div class="ttl">11) Reorder pages (drag & drop)</div><div id="reorderList" class="pages"></div><button class="btn block" id="btnApplyReorder" style="margin-top:8px">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫</button></div>
        <div class="tool"><div class="ttl">12) Add text / sign</div><div class="row"><input id="signText" class="btn ghost" placeholder="–¢–µ–∫—Å—Ç/–ø—ñ–¥–ø–∏—Å" style="flex:1; text-align:left"/></div><button class="btn block" id="btnAddText">–î–æ–¥–∞—Ç–∏ –Ω–∞ PDF</button></div>
        <div class="tool"><div class="ttl">13) Watermark</div><div class="row"><input id="wmText" class="btn ghost" placeholder="–í–æ–¥—è–Ω–∏–π –∑–Ω–∞–∫" style="flex:1; text-align:left"/></div><button class="btn block" id="btnWatermark">–ù–∞–∫–ª–∞—Å—Ç–∏</button></div>
        <div class="tool"><div class="ttl">14) Protect PDF <span class="badge-server">(server)</span></div><div class="row"><input id="pwdProtect" class="btn ghost" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1; text-align:left"/></div><button class="btn block" id="btnProtect" disabled>–ó–∞—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ (–ø–æ—Ç—Ä—ñ–±–µ–Ω –±–µ–∫–µ–Ω–¥)</button></div>
        <div class="tool"><div class="ttl">15) Unlock PDF <span class="badge-server">(server)</span></div><div class="row"><input id="pwdUnlock" class="btn ghost" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1; text-align:left"/></div><button class="btn block" id="btnUnlock" disabled>–ó–Ω—è—Ç–∏ –ø–∞—Ä–æ–ª—å (–ø–æ—Ç—Ä—ñ–±–µ–Ω –±–µ–∫–µ–Ω–¥)</button></div>
        <div class="tool"><div class="ttl">20) Share via link / QR</div><div class="row"><button class="btn" id="btnMakeLink">–õ—ñ–Ω–∫</button><button class="btn" id="btnMakeQR">QR</button></div><div id="qr" style="display:none; margin-top:8px"></div></div>
      </aside>
    </div>

    <div class="sep" style="margin-top:14px"></div>
    <div class="muted">–ü–æ—Ä–∞–¥–∞: –∑–∞–≤–∞–Ω—Ç–∞–∂ PDF —É ¬´–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª¬ª, –∞ –∫—ñ–ª—å–∫–∞ PDF/–∑–æ–±—Ä–∞–∂–µ–Ω—å ‚Äî —É ¬´–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏¬ª –¥–ª—è –∑–ª–∏—Ç—Ç—è/–±–∞–≥–∞—Ç–æ—Å—Ç–æ—Ä—ñ–Ω–∫–æ–≤–æ–≥–æ PDF.</div>
  </div>
</div>

<!-- ====== LIBRARIES ====== -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ====== LOGIC ====== -->
<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toBlob = async (u8, mime='application/pdf') => new Blob([u8], {type:mime});
const saveBlob = (blob, name) => { const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),5000); };
const getMainFile = () => $('#fileInput').files?.[0];
const getManyFiles = () => Array.from($('#fileInputMany').files || []);
const note = (msg) => console.log('[Docs]', msg);

/* ---------- preview ---------- */
const canvas = $('#pdfCanvas'); const ctx = canvas.getContext('2d');
const img = $('#imgPreview'); const docxMount = $('#docxMount'); const viewer = $('#viewer');

const editorLayer = $('#editorLayer'); const editorStage = $('#editorStage'); const pgInfo = $('#pgInfo');
let currPdfDoc = null, currPdfPages = 0, currPageIndex = 0, previewViewport = null;

/* –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤ –ø—Ä–µ–≤‚Äô—é */
async function renderPageForPreview(pdf, pageIndex=0){
  const page = await pdf.getPage(pageIndex+1);
  const base = page.getViewport({scale:1});
  const pad = 24;
  const maxW = Math.max(320, viewer.clientWidth - pad);
  const maxH = Math.max(320, viewer.clientHeight - pad - 56); // –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —à–∞–ø–∫–∏
  const scale = Math.min(maxW / base.width, maxH / base.height);
  const vp = page.getViewport({scale: Math.max(0.5, Math.min(scale, 3))});
  previewViewport = vp;
  canvas.width = vp.width; canvas.height = vp.height;
  await page.render({canvasContext: ctx, viewport: vp}).promise;
  canvas.style.display='block';
}

/* on file */
const onMainFileChange = async () => {
  const f = getMainFile(); if (!f) return;
  await previewFile(f);
  if (/pdf$/i.test(f.name)) await buildReorderListFromPdf(f);
};
$('#fileInput').addEventListener('change', onMainFileChange);
$('#fileInput').addEventListener('input', onMainFileChange);

async function previewFile(file){
  $('#qr').style.display='none'; $('#qr').innerHTML='';
  canvas.style.display='none'; img.style.display='none'; docxMount.style.display='none';
  viewer.classList.remove('has-preview'); editorLayer.style.display='none'; // –≤–∏—Ö—ñ–¥ —ñ–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, —è–∫—â–æ –±—É–≤

  const name = file.name.toLowerCase();

  if (name.endsWith('.pdf')){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: buf}).promise;
    currPdfDoc = pdf; currPdfPages = pdf.numPages; currPageIndex = 0;
    await renderPageForPreview(pdf, currPageIndex);
    pgInfo.textContent = `${currPageIndex+1} / ${currPdfPages}`;
    viewer.classList.add('has-preview');
  } else if (/\.(png|jpg|jpeg|webp)$/i.test(name)){
    img.src = URL.createObjectURL(file);
    img.onload = ()=> URL.revokeObjectURL(img.src);
    img.style.display='block';
    viewer.classList.add('has-preview');
  } else if (name.endsWith('.docx')){
    docxMount.innerHTML = '<div class="muted">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ DOCX –Ω–∞—Ä–∞–∑—ñ —Å–ø—Ä–æ—â–µ–Ω–∏–π. –ï–∫—Å–ø–æ—Ä—Ç—É–π —É PDF –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É.</div>';
    docxMount.style.display='block';
    viewer.classList.add('has-preview');
  } else if (/\.(xlsx|csv|json)$/i.test(name)){
    docxMount.innerHTML = '<div class="muted">–¢–∞–±–ª–∏—á–Ω–∏–π —Ñ–∞–π–ª: —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è–º–∏ –ª—ñ–≤–æ—Ä—É—á.</div>';
    docxMount.style.display='block';
    viewer.classList.add('has-preview');
  } else {
    docxMount.innerHTML = '<div class="muted">–§–æ—Ä–º–∞—Ç –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è –ø—Ä–µ–≤‚Äô—é.</div>';
    docxMount.style.display='block';
  }
}

/* ---------- theme ---------- */
function toggleTheme(){
  const root = document.documentElement;
  const isDark = getComputedStyle(root).getPropertyValue('--bg').trim() === '#0b0e14';
  if (isDark){ root.style.setProperty('--bg','#f5f7fb'); root.style.setProperty('--card','#ffffff'); root.style.setProperty('--line','#e5e8f0'); root.style.setProperty('--text','#0b1220'); root.style.setProperty('--chip','#f3f6ff'); }
  else { root.style.setProperty('--bg','#0b0e14'); root.style.setProperty('--card','#101522'); root.style.setProperty('--line','#1b2131'); root.style.setProperty('--text','#e6e9ef'); root.style.setProperty('--chip','#161a20'); }
  viewer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--card');
}
$('#btnThemeToggle').onclick = toggleTheme; $('#btnThemeToggle2').onclick = toggleTheme;

/* ---------- Toolbar quick proxy –¥–æ —ñ—Å–Ω—É—é—á–∏—Ö –¥—ñ–π ---------- */
[['#tb-image','#btnImageToPdf'], ['#tb-split','#btnSplit'], ['#tb-merge','#btnMerge'], ['#tb-reorder','#btnApplyReorder'], ['#tb-export','#btnPdfToImage'], ['#tb-compress','#btnCompress']]
.forEach(([a,b])=>{ const A=$(a), B=$(b); if (A&&B) A.addEventListener('click', ()=> B.click()); });

/* ===================== –í–ë–£–î–û–í–ê–ù–ò–ô –†–ï–î–ê–ö–¢–û–† ===================== */
let editMode = false;
let pageOverlays = {}; // pageIndex -> array of overlay nodes
let actionStack = [], redoStack = [];

function ensureStageSize(){
  // –ø—ñ–¥–≥–∞–Ω—è—î–º–æ —Ä–æ–∑–º—ñ—Ä —Å—Ü–µ–Ω–∏ –¥–æ canvas
  const rect = canvas.getBoundingClientRect();
  editorStage.style.width = canvas.width + 'px';
  editorStage.style.height = canvas.height + 'px';
  editorStage.style.transform = `scale(${rect.width/canvas.width})`;
  editorStage.style.transformOrigin = 'top left';
  // –ø–æ–∑–∏—Ü—ñ–æ–Ω—É—î–º–æ —Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–æ
  const viewerRect = viewer.getBoundingClientRect();
  const stageW = rect.width, stageH = rect.height;
  editorStage.style.marginLeft = (viewerRect.width - stageW)/2 + 'px';
}

function startEditor(){
  const f = getMainFile();
  if (!f || !/\.pdf$/i.test(f.name)) return alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å PDF —É ¬´–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª¬ª.');
  editMode = true; editorLayer.style.display='flex'; ensureStageSize();
  if (!pageOverlays[currPageIndex]) pageOverlays[currPageIndex] = [];
  renderOverlaysForPage(currPageIndex);
}
function exitEditor(){ editMode=false; editorLayer.style.display='none'; clearStage(); }
function clearStage(){ editorStage.innerHTML=''; }

function renderOverlaysForPage(idx){
  clearStage();
  (pageOverlays[idx]||[]).forEach(n=> editorStage.appendChild(n));
}

function addAction(node, type){ actionStack.push({node, type}); redoStack.length=0; }
$('#actUndo').onclick = ()=>{
  const a = actionStack.pop(); if (!a) return;
  if (a.type==='add'){ a.node.remove(); redoStack.push(a); }
};
$('#actRedo').onclick = ()=>{
  const a = redoStack.pop(); if (!a) return;
  if (a.type==='add'){ editorStage.appendChild(a.node); actionStack.push(a); }
};

function makeDraggable(el){
  let ox=0, oy=0, dragging=false;
  el.addEventListener('pointerdown', e=>{ dragging=true; ox=e.clientX - el.offsetLeft; oy=e.clientY - el.offsetTop; el.setPointerCapture(e.pointerId); });
  el.addEventListener('pointermove', e=>{
    if(!dragging) return;
    let x = e.clientX - ox, y = e.clientY - oy;
    x = Math.max(0, Math.min(x, editorStage.clientWidth - el.offsetWidth));
    y = Math.max(0, Math.min(y, editorStage.clientHeight - el.offsetHeight));
    el.style.left = x + 'px'; el.style.top = y + 'px';
  });
  el.addEventListener('pointerup', ()=> dragging=false);
}

/* —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ */
let activeTool = 'select';
function setTool(t){
  activeTool = t;
  $$('#editToolbar .tbtn').forEach(b=>b.classList.remove('active'));
  if (t==='text') $('#toolText').classList.add('active');
  if (t==='image') $('#toolImage').classList.add('active');
  if (t==='rect') $('#toolRect').classList.add('active');
  if (t==='select') $('#toolSelect').classList.add('active');
}
$('#toolSelect').onclick = ()=> setTool('select');
$('#toolText').onclick = ()=> setTool('text');
$('#toolImage').onclick = ()=> setTool('image');
$('#toolRect').onclick = ()=> setTool('rect');

editorStage.addEventListener('dblclick', e=>{
  if (activeTool!=='text') return;
  const box = document.createElement('div');
  box.className='edit-box'; box.contentEditable='true';
  box.style.left = (e.offsetX-60)+'px'; box.style.top = (e.offsetY-16)+'px';
  box.textContent = '–¢–µ–∫—Å—Ç';
  makeDraggable(box);
  editorStage.appendChild(box);
  (pageOverlays[currPageIndex] ||= []).push(box);
  addAction(box,'add');
  box.focus();
});

function addImageAtCenter(file){
  const url = URL.createObjectURL(file);
  const im = document.createElement('img'); im.className='edit-img'; im.src=url;
  im.onload = ()=>{
    const w = Math.min(im.naturalWidth, editorStage.clientWidth*0.6);
    const h = Math.min(im.naturalHeight, editorStage.clientHeight*0.6);
    im.style.width = w+'px'; im.style.height='auto';
    im.style.left = (editorStage.clientWidth - w)/2 + 'px';
    im.style.top = (editorStage.clientHeight - h)/2 + 'px';
  };
  makeDraggable(im);
  editorStage.appendChild(im);
  (pageOverlays[currPageIndex] ||= []).push(im);
  addAction(im,'add');
}
const hiddenImgInput = document.createElement('input'); hiddenImgInput.type='file'; hiddenImgInput.accept='image/*';
hiddenImgInput.onchange = e=>{ const f=e.target.files?.[0]; if (f) addImageAtCenter(f); hiddenImgInput.value=''; };
$('#toolImage').addEventListener('click', ()=>{ if(!editMode) startEditor(); hiddenImgInput.click(); });

let rectStart = null, tempRect = null;
editorStage.addEventListener('pointerdown', e=>{
  if (activeTool!=='rect') return;
  rectStart = {x:e.offsetX, y:e.offsetY};
  tempRect = document.createElement('div'); tempRect.className='hl-rect';
  tempRect.style.left = rectStart.x+'px'; tempRect.style.top = rectStart.y+'px';
  tempRect.style.width='1px'; tempRect.style.height='1px';
  editorStage.appendChild(tempRect);
});
editorStage.addEventListener('pointermove', e=>{
  if (!rectStart || !tempRect) return;
  const w = e.offsetX - rectStart.x, h = e.offsetY - rectStart.y;
  tempRect.style.width = Math.abs(w)+'px'; tempRect.style.height = Math.abs(h)+'px';
  tempRect.style.left = (w<0 ? e.offsetX : rectStart.x)+'px';
  tempRect.style.top = (h<0 ? e.offsetY : rectStart.y)+'px';
});
editorStage.addEventListener('pointerup', ()=>{
  if (!tempRect) return;
  makeDraggable(tempRect);
  (pageOverlays[currPageIndex] ||= []).push(tempRect);
  addAction(tempRect,'add');
  rectStart=null; tempRect=null;
});

/* —Å—Ç–æ—Ä—ñ–Ω–∫–∏ */
$('#pgPrev').onclick = async ()=>{ if(!currPdfDoc) return; currPageIndex = Math.max(0, currPageIndex-1); await renderPageForPreview(currPdfDoc, currPageIndex); pgInfo.textContent = `${currPageIndex+1} / ${currPdfPages}`; ensureStageSize(); renderOverlaysForPage(currPageIndex); };
$('#pgNext').onclick = async ()=>{ if(!currPdfDoc) return; currPageIndex = Math.min(currPdfPages-1, currPageIndex+1); await renderPageForPreview(currPdfDoc, currPageIndex); pgInfo.textContent = `${currPageIndex+1} / ${currPdfPages}`; ensureStageSize(); renderOverlaysForPage(currPageIndex); };

/* –∫–Ω–æ–ø–∫–∏ —à–∞–ø–∫–∏ */
$('#tb-editor').onclick = ()=> startEditor();
$('#tb-text').onclick = ()=> { if(!editMode) startEditor(); setTool('text'); };

/* –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤ PDF */
$('#actApply').onclick = async ()=>{
  const f = getMainFile(); if (!f) return;
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const srcU8 = new Uint8Array(await f.arrayBuffer());
  const pdf = await PDFDocument.load(srcU8);

  const helv = await pdf.embedFont(StandardFonts.Helvetica);

  for (let p=0; p<pdf.getPageCount(); p++){
    const page = pdf.getPage(p);
    const { width, height } = page.getSize();
    const ov = pageOverlays[p] || [];
    for (const el of ov){
      const left = parseFloat(el.style.left||'0'), top = parseFloat(el.style.top||'0');
      const elW = el.offsetWidth, elH = el.offsetHeight;

      // –º–∞—Å—à—Ç–∞–± –∑ –ø—Ä–µ–≤‚Äô—é —É PDF-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
      const kx = width / (previewViewport ? previewViewport.width : canvas.width);
      const ky = height / (previewViewport ? previewViewport.height : canvas.height);

      const px = left * kx;
      const py = ( (previewViewport ? previewViewport.height : canvas.height) - (top + elH) ) * ky;

      if (el.classList.contains('edit-box')){
        const txt = el.textContent || '';
        const size = 12;
        page.drawText(txt, { x: px+4, y: py+4, size, font: helv, color: rgb(1,1,1) });
      } else if (el.classList.contains('edit-img')){
        const blob = await fetch(el.src).then(r=>r.blob());
        const buf = new Uint8Array(await blob.arrayBuffer());
        let imgEmbed = null;
        try{ imgEmbed = await pdf.embedPng(buf); }catch{ imgEmbed = await pdf.embedJpg(buf); }
        const w = elW * kx, h = elH * ky;
        page.drawImage(imgEmbed, { x:px, y:py, width:w, height:h });
      } else if (el.classList.contains('hl-rect')){
        const w = elW * kx, h = elH * ky;
        page.drawRectangle({ x:px, y:py, width:w, height:h, color: rgb(1,1,0), opacity:0.22, borderColor: rgb(1,1,0), borderWidth:1 });
      }
    }
  }

  const outU8 = await pdf.save();
  saveBlob(await toBlob(outU8), (f.name.replace(/\.[^.]+$/,'')||'edited')+'-edited.pdf');
  exitEditor();
};
/* –°–∫–∞—Å—É–≤–∞—Ç–∏ */
$('#actCancel').onclick = ()=> exitEditor();

/* –∞–≤—Ç–æ-–ø—ñ–¥–≥—ñ–Ω —Å—Ü–µ–Ω–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É */
new ResizeObserver(()=>{ if(editMode) ensureStageSize(); }).observe(viewer);

/* ===================== –Ü–°–ù–£–Æ–ß–Ü –ö–ù–û–ü–ö–ò (–±–µ–∑ –∑–º—ñ–Ω) ===================== */
$('#btnImageToPdf').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.(png|jpg|jpeg|webp)$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { jsPDF } = window.jspdf; const imgData = await blobToDataURL(f);
  const pdf = new jsPDF({unit:'pt', format:'a4', compress:true}); const w = pdf.internal.pageSize.getWidth(); const h = pdf.internal.pageSize.getHeight();
  const dims = await imageDims(imgData); const scale = Math.min(w/dims.w, h/dims.h); const nw = dims.w * scale, nh = dims.h * scale;
  pdf.addImage(imgData, 0, (h-nh)/2, nw, nh); const blob = pdf.output('blob'); saveBlob(blob, fileStem(f.name)+'.pdf');
};

$('#btnMultiPhotoToPdf').onclick = async () => {
  const files = getManyFiles().filter(x=>/\.(png|jpg|jpeg|webp)$/i.test(x.name)); if (!files.length) return alert('–î–æ–¥–∞–π —Ñ–æ—Ç–æ —É ¬´–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏¬ª.');
  const { jsPDF } = window.jspdf; const pdf = new jsPDF({unit:'pt', format:'a4', compress:true}); let first = true;
  for (const f of files){ const data = await blobToDataURL(f); const dims = await imageDims(data);
    const w = pdf.internal.pageSize.getWidth(); const h = pdf.internal.pageSize.getHeight(); const scale = Math.min(w/dims.w, h/dims.h);
    const nw = dims.w * scale, nh = dims.h * scale; if (!first) pdf.addPage(); pdf.addImage(data, 0, (h-nh)/2, nw, nh); first = false; }
  const blob = pdf.output('blob'); saveBlob(blob, 'photos.pdf');
};

$('#btnPdfToImage').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const buf = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data: buf}).promise; const zip = new JSZip();
  for (let i=1;i<=pdf.numPages;i++){ const page = await pdf.getPage(i); const vp = page.getViewport({scale:2});
    const cnv = document.createElement('canvas'); cnv.width = vp.width; cnv.height = vp.height;
    await page.render({canvasContext: cnv.getContext('2d'), viewport: vp}).promise; const blob = await new Promise(res=>cnv.toBlob(res, 'image/png', 0.95));
    zip.file(`page-${i}.png`, blob); }
  zip.generateAsync({type:'blob'}).then(b=>saveBlob(b, fileStem(f.name)+'-pages.zip'));
};

$('#btnMerge').onclick = async () => {
  const files = getManyFiles().filter(x=>/\.pdf$/i.test(x.name)); if (files.length < 2) return alert('–î–æ–¥–∞–π —è–∫ –º—ñ–Ω—ñ–º—É–º 2 PDF —É ¬´–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏¬ª.');
  const { PDFDocument } = PDFLib; const out = await PDFDocument.create();
  for (const f of files){ const u8 = new Uint8Array(await f.arrayBuffer()); const doc = await PDFDocument.load(u8);
    const pages = await out.copyPages(doc, doc.getPageIndices()); pages.forEach(p=>out.addPage(p)); }
  const u8 = await out.save(); saveBlob(await toBlob(u8), 'merged.pdf');
};

$('#btnSplit').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const ranges = parseRanges($('#splitRange').value); if (!ranges.length) return alert('–í–∫–∞–∂–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏/–¥—ñ–∞–ø–∞–∑–æ–Ω–∏: –Ω–∞–ø—Ä. 1-3,5,8-9');
  const { PDFDocument } = PDFLib; const src = await PDFDocument.load(await f.arrayBuffer()); let idx = 1;
  for (const r of ranges){ const out = await PDFDocument.create(); const toCopy = []; for (let i=r[0]-1; i<=r[1]-1; i++) toCopy.push(i);
    const pages = await out.copyPages(src, toCopy); pages.forEach(p=>out.addPage(p)); const u8 = await out.save(); saveBlob(await toBlob(u8), `${fileStem(f.name)}-part${idx++}.pdf`); }
};

$('#btnRemovePages').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const nums = ($('#removePages').value || '').split(',').map(s=>parseInt(s.trim(),10)).filter(Boolean); if (!nums.length) return alert('–í–∫–∞–∂–∏ –Ω–æ–º–µ—Ä–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —á–µ—Ä–µ–∑ –∫–æ–º—É.');
  const { PDFDocument } = PDFLib; const pdf = await PDFDocument.load(await f.arrayBuffer());
  nums.sort((a,b)=>b-a).forEach(n=>{ if (n>=1 && n<=pdf.getPageCount()) pdf.removePage(n-1); });
  const u8 = await pdf.save(); saveBlob(await toBlob(u8), fileStem(f.name)+'-removed.pdf');
  await previewFile(new File([u8], 'temp.pdf', {type:'application/pdf'})); await buildReorderListFromPdf(new File([u8], 'temp.pdf', {type:'application/pdf'}));
};

let reorderState = [];
async function buildReorderListFromPdf(file){
  const buf = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const list = $('#reorderList'); list.innerHTML = ''; reorderState = Array.from({length: pdf.numPages}, (_,i)=>i+1);
  for (let i=1;i<=pdf.numPages;i++){
    const item = document.createElement('div'); item.className='page-item'; item.draggable=true; item.dataset.page=i;
    item.innerHTML = `<div class="page-thumb"></div><div>–°—Ç–æ—Ä—ñ–Ω–∫–∞ ${i}</div>`;
    item.addEventListener('dragstart', e=>{ item.classList.add('dragging'); e.dataTransfer.setData('text/plain', i);});
    item.addEventListener('dragend', ()=> item.classList.remove('dragging')); list.appendChild(item);
  }
  list.addEventListener('dragover', e=>{ e.preventDefault(); const dragging = list.querySelector('.dragging'); const after = getDragAfterElement(list, e.clientY);
    if (after == null) list.appendChild(dragging); else list.insertBefore(dragging, after); });
}
function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll('.page-item:not(.dragging)')];
  return els.reduce((closest, child)=>{ const box = child.getBoundingClientRect(); const offset = y - box.top - box.height/2;
    if (offset<0 && offset>closest.offset) return {offset, element: child}; else return closest; }, {offset: Number.NEGATIVE_INFINITY}).element;
}
$('#btnApplyReorder').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const order = $$('#reorderList .page-item').map(x=>parseInt(x.dataset.page,10)-1);
  const { PDFDocument } = PDFLib; const src = await PDFDocument.load(await f.arrayBuffer()); const out = await PDFDocument.create();
  const pages = await out.copyPages(src, order); pages.forEach(p=>out.addPage(p)); const u8 = await out.save(); saveBlob(await toBlob(u8), fileStem(f.name)+'-reordered.pdf');
};

$('#btnAddText').onclick = async () => {
  const txt = $('#signText').value || 'Sign'; const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { PDFDocument, StandardFonts, rgb } = PDFLib; const pdf = await PDFDocument.load(await f.arrayBuffer()); const font = await pdf.embedFont(StandardFonts.Helvetica);
  const pages = pdf.getPages(); pages.forEach(p=>{ const { width, height } = p.getSize(); p.drawText(txt, {x: width-200, y: 24, size: 12, font, color: rgb(0.1,0.6,1)}); });
  const u8 = await pdf.save(); saveBlob(await toBlob(u8), fileStem(f.name)+'-signed.pdf');
};

$('#btnWatermark').onclick = async () => {
  const txt = $('#wmText').value || 'PROOFLY'; const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { PDFDocument, StandardFonts, rgb } = PDFLib; const pdf = await PDFDocument.load(await f.arrayBuffer()); const font = await pdf.embedFont(StandardFonts.Helvetica);
  pdf.getPages().forEach(p=>{ const {width, height} = p.getSize(); p.drawText(txt, { x: width/4, y: height/2, size: 48, font, color: rgb(0.6,0.65,0.9), rotate: PDFLib.degrees(30), opacity: 0.15 }); });
  const u8 = await pdf.save(); saveBlob(await toBlob(u8), fileStem(f.name)+'-wm.pdf');
};

$('#btnCompress').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { PDFDocument } = PDFLib; const pdf = await PDFDocument.load(await f.arrayBuffer(), {ignoreEncryption:true});
  const u8 = await pdf.save({useObjectStreams:true}); saveBlob(await toBlob(u8), fileStem(f.name)+'-compressed.pdf');
};

/* —É—Ç–∏–ª—ñ—Ç–∏ */
function fileStem(name){ return name.replace(/\.[^.]+$/,''); }
function blobToDataURL(blob){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }
function imageDims(src){ return new Promise(res=>{ const im=new Image(); im.onload=()=>res({w:im.width,h:im.height}); im.src=src; }); }
function parseRanges(s){
  const parts = (s||'').split(',').map(x=>x.trim()).filter(Boolean); const out=[];
  for (const p of parts){ if (p.includes('-')){ const [a,b]=p.split('-').map(n=>parseInt(n,10)); if (a && b && a<=b) out.push([a,b]); }
    else { const n=parseInt(p,10); if (n) out.push([n,n]); } }
  return out;
}
</script>
{% endblock %}
