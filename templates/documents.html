{% extends "base.html" %}
{% set page = 'documents' %}
{% block title %}–î–æ–∫—É–º–µ–Ω—Ç–∏ ‚Äî Proofly{% endblock %}

{% block content %}
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">

<style>
  :root{
    --bg:#0b0e14; --card:#101522; --line:#1b2131; --text:#e6e9ef;
    --muted:#aab1c7; --chip:#161a20; --accent:#4f7cff;
  }

  /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä—ñ–≤–Ω–∏—Ö –≤—ñ–¥—Å—Ç—É–ø—ñ–≤ —ñ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è */
  .docs-wrap{
    padding:20px; color:var(--text);
  }
  .docs-container{
    max-width:1280px;   /* —Ä—ñ–≤–Ω–∞ —à–∏—Ä–∏–Ω–∞ –º–∞–∫–µ—Ç–∞ */
    margin:0 auto;      /* –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  }

  .grid-3{
    display:grid;
    grid-template-columns: 320px minmax(640px, 1.6fr) 320px; /* —Ü–µ–Ω—Ç—Ä ~20% –≤—É–∂—á–∏–π */
    gap:18px;
    align-items:start;
  }
  /* –Ω–µ –¥–∞—î–º–æ –∫–æ–ª–æ–Ω–∫–∞–º –ª–∞–º–∞—Ç–∏—Å—å */
  .grid-3 > * { min-width:0; }

  .panel{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:16px;
  }
  .panel h3{ margin:0 0 10px; font-weight:700; font-size:16px; letter-spacing:.2px; }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:12px; border:1px solid var(--line);
    background:#0f1730; color:#fff; cursor:pointer; user-select:none;
    transition:transform .02s ease, background .2s ease, border-color .2s ease;
  }
  .btn:hover{ background:#142049; border-color:#24325a }
  .btn.primary{ background:var(--accent); border-color:#5a86ff }
  .btn.ghost{ background:transparent }
  .btn.small{ padding:8px 12px; font-size:14px }
  .btn.block{ width:100% }
  .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px }

  .tool{
    display:flex; flex-direction:column; gap:8px; padding:10px;
    background:var(--chip); border:1px solid var(--line); border-radius:12px;
  }
  .tool .ttl{ font-size:13px; color:var(--muted) }
  .tool .btn{ width:100% }

  .uploader{
    background:rgba(255,255,255,.02);
    border:1px dashed #2a3550;
    border-radius:12px; padding:12px;
  }
  input[type="file"]{ color:var(--muted) }

  /* —Ü–µ–Ω—Ç—Ä ‚Äî –ø—Ä–µ–≤‚Äô—é */
  .viewer{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    height:72vh; min-height:520px;
    display:flex; align-items:center; justify-content:center;
    position:relative; width:100%; overflow:hidden;
  }
  /* —è–∫—â–æ —Ä–∞–ø—Ç–æ–º –≥–ª–æ–±–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ —á—ñ–ø–ª—è–ª–∏—Å—å –¥–æ <main> */
  main.viewer{ all:unset; }

  .viewer .hint{
    color:var(--muted); font-size:14px;
    position:absolute; top:14px; left:14px; z-index:2;
  }
  .viewer.has-preview .hint{ display:none; }

  canvas#pdfCanvas, img#imgPreview{
    max-width:100%; max-height:100%;
    display:block; position:relative; z-index:3;
  }
  .theme-toggle{ position:absolute; top:12px; right:12px; z-index:4 }

  /* –ø—Ä–∞–≤–∏–π ‚Äî reorder */
  .pages{
    display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto;
    background:rgba(255,255,255,.03); border:1px solid var(--line); padding:10px; border-radius:12px;
  }
  .page-item{
    display:flex; align-items:center; gap:10px; background:#0f1422; border:1px solid #1b2336;
    border-radius:10px; padding:8px; cursor:grab;
  }
  .page-item.dragging{ opacity:.6 }
  .page-thumb{ width:36px; height:48px; background:#0b0e14; border:1px solid #2a3550; border-radius:6px }
  .sep{ height:1px; background:var(--line); margin:10px 0 }

  .badge-server{ font-size:11px; color:#ffcf8b; background:#3a250b; border:1px solid #6e4b14;
    border-radius:999px; padding:2px 6px }
  .muted{ color:var(--muted) }
</style>

<div class="docs-wrap">
  <div class="docs-container">
    <div class="grid-3">
      <!-- LEFT -->
      <aside class="panel">
        <h3>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó</h3>

        <div class="uploader">
          <div class="row">
            <label class="ttl">–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª</label>
            <input id="fileInput" type="file" />
          </div>
          <div class="row">
            <label class="ttl">–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏ (–¥–ª—è Merge / Multi-photo)</label>
            <input id="fileInputMany" type="file" multiple />
          </div>
        </div>

        <div class="sep"></div>

        <div class="tool">
          <div class="ttl">1) Image ‚Üí PDF</div>
          <button class="btn block" id="btnImageToPdf">–°—Ç–≤–æ—Ä–∏—Ç–∏ PDF</button>
        </div>

        <div class="tool">
          <div class="ttl">2) PDF ‚Üí Image</div>
          <button class="btn block" id="btnPdfToImage">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤ PNG</button>
        </div>

        <div class="tool">
          <div class="ttl">3) DOCX ‚Üí PDF</div>
          <button class="btn block" id="btnDocxToPdf">–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏</button>
          <small class="muted">–ë—Ä–∞—É–∑–µ—Ä–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ä–µ–Ω–¥–µ—Ä DOCX ‚Üí canvas ‚Üí PDF.</small>
        </div>

        <div class="tool">
          <div class="ttl">4) PDF ‚Üí DOCX</div>
          <button class="btn block" id="btnPdfToDocx">–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏</button>
          <small class="muted">–ï–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—Å—Ç—É —Ç–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ —É .docx (–ø—Ä–æ—Å—Ç–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è).</small>
        </div>

        <div class="tool">
          <div class="ttl">5) Excel / CSV ‚Üí PDF</div>
          <button class="btn block" id="btnTableToPdf">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button>
        </div>

        <div class="tool">
          <div class="ttl">6) PDF ‚Üí Excel / CSV</div>
          <button class="btn block" id="btnPdfToCsv">–í–∏—Ç—è–≥–Ω—É—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ</button>
          <small class="muted">–ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞–±–ª–∏—á–Ω–æ—ó —Ä–æ–∑–º—ñ—Ç–∫–∏ –∑ PDF (best-effort).</small>
        </div>

        <div class="tool">
          <div class="ttl">19) Multi-photo ‚Üí PDF</div>
          <button class="btn block" id="btnMultiPhotoToPdf">–°–∫–ª–µ—ó—Ç–∏ —Ñ–æ—Ç–æ –≤ PDF</button>
        </div>

        <div class="tool">
          <div class="ttl">17) Convert JSON ‚Üî CSV ‚Üî XLS</div>
          <div class="row">
            <button class="btn small" id="btnJsonToCsv">JSON ‚Üí CSV</button>
            <button class="btn small" id="btnCsvToXls">CSV ‚Üí XLSX</button>
            <button class="btn small" id="btnXlsToCsv">XLSX ‚Üí CSV</button>
          </div>
        </div>

        <div class="tool">
          <div class="ttl">16) Convert to ZIP</div>
          <button class="btn block" id="btnZip">–£–ø–∞–∫—É–≤–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ</button>
        </div>

        <div class="tool">
          <div class="ttl">18) Light / Dark Viewer</div>
          <button class="btn block" id="btnThemeToggle">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É</button>
        </div>
      </aside>

      <!-- CENTER -->
      <div class="viewer panel" id="viewer">
        <div class="hint">–û–±–µ—Ä–∏ —Ñ–∞–π–ª, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞: PDF, JPG, PNG, DOCX, XLSX, CSV.</div>
        <div class="theme-toggle">
          <span class="muted" style="margin-right:8px">–¢–µ–º–∞</span>
          <button class="btn ghost small" id="btnThemeToggle2">üåô / ‚òÄÔ∏è</button>
        </div>
        <canvas id="pdfCanvas" style="display:none"></canvas>
        <img id="imgPreview" alt="" style="display:none"/>
        <div id="docxMount" style="display:none; max-width:95%; height:95%; overflow:auto"></div>
      </div>

      <!-- RIGHT -->
      <aside class="panel">
        <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ‚Ä¢ –Ü–Ω—à–µ</h3>

        <div class="tool">
          <div class="ttl">7) Merge PDF (–∑–ª–∏—Ç—Ç—è)</div>
          <button class="btn block" id="btnMerge">–ó–ª–∏—Ç–∏ PDF</button>
        </div>

        <div class="tool">
          <div class="ttl">8) Split PDF (–∑–∞ –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º —Å—Ç–æ—Ä—ñ–Ω–æ–∫)</div>
          <div class="row">
            <input id="splitRange" placeholder="–Ω–∞–ø—Ä. 1-3,5,8-9" class="btn ghost" style="flex:1; text-align:left"/>
            <button class="btn" id="btnSplit">OK</button>
          </div>
        </div>

        <div class="tool">
          <div class="ttl">9) Compress PDF</div>
          <button class="btn block" id="btnCompress">–°—Ç–∏—Å–Ω—É—Ç–∏</button>
          <small class="muted">–î–∞—É–Ω—Å–∫–µ–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω—å —É PDF (–≤–∏–∑–Ω–∞—á–∞—î–º–æ —è–∫—ñ—Å—Ç—å).</small>
        </div>

        <div class="tool">
          <div class="ttl">10) Remove pages</div>
          <div class="row">
            <input id="removePages" placeholder="–Ω–∞–ø—Ä. 2,4,7" class="btn ghost" style="flex:1; text-align:left"/>
            <button class="btn" id="btnRemovePages">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </div>
        </div>

        <div class="tool">
          <div class="ttl">11) Reorder pages (drag & drop)</div>
          <div id="reorderList" class="pages"></div>
          <button class="btn block" id="btnApplyReorder" style="margin-top:8px">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫</button>
        </div>

        <div class="tool">
          <div class="ttl">12) Add text / sign</div>
          <div class="row">
            <input id="signText" class="btn ghost" placeholder="–¢–µ–∫—Å—Ç/–ø—ñ–¥–ø–∏—Å" style="flex:1; text-align:left"/>
          </div>
          <button class="btn block" id="btnAddText">–î–æ–¥–∞—Ç–∏ –Ω–∞ PDF</button>
        </div>

        <div class="tool">
          <div class="ttl">13) Watermark</div>
          <div class="row">
            <input id="wmText" class="btn ghost" placeholder="–í–æ–¥—è–Ω–∏–π –∑–Ω–∞–∫" style="flex:1; text-align:left"/>
          </div>
          <button class="btn block" id="btnWatermark">–ù–∞–∫–ª–∞—Å—Ç–∏</button>
        </div>

        <div class="tool">
          <div class="ttl">14) Protect PDF <span class="badge-server">(server)</span></div>
          <div class="row">
            <input id="pwdProtect" class="btn ghost" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1; text-align:left"/>
          </div>
          <button class="btn block" id="btnProtect" disabled>–ó–∞—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ (–ø–æ—Ç—Ä—ñ–±–µ–Ω –±–µ–∫–µ–Ω–¥)</button>
        </div>

        <div class="tool">
          <div class="ttl">15) Unlock PDF <span class="badge-server">(server)</span></div>
          <div class="row">
            <input id="pwdUnlock" class="btn ghost" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1; text-align:left"/>
          </div>
          <button class="btn block" id="btnUnlock" disabled>–ó–Ω—è—Ç–∏ –ø–∞—Ä–æ–ª—å (–ø–æ—Ç—Ä—ñ–±–µ–Ω –±–µ–∫–µ–Ω–¥)</button>
        </div>

        <div class="tool">
          <div class="ttl">20) Share via link / QR</div>
          <div class="row">
            <button class="btn" id="btnMakeLink">–õ—ñ–Ω–∫</button>
            <button class="btn" id="btnMakeQR">QR</button>
          </div>
          <div id="qr" style="display:none; margin-top:8px"></div>
        </div>
      </aside>
    </div>

    <div class="sep" style="margin-top:14px"></div>
    <div class="muted">–ü–æ—Ä–∞–¥–∞: –∑–∞–≤–∞–Ω—Ç–∞–∂ PDF —É ¬´–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª¬ª, –∞ –∫—ñ–ª—å–∫–∞ PDF/–∑–æ–±—Ä–∞–∂–µ–Ω—å ‚Äî —É ¬´–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏¬ª –¥–ª—è –∑–ª–∏—Ç—Ç—è/–±–∞–≥–∞—Ç–æ—Å—Ç–æ—Ä—ñ–Ω–∫–æ–≤–æ–≥–æ PDF.</div>
  </div>
</div>

<!-- ====== LIBRARIES ====== -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ====== LOGIC ====== -->
<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toBlob = async (u8, mime='application/pdf') => new Blob([u8], {type:mime});
const saveBlob = (blob, name) => {
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
};
const getMainFile = () => $('#fileInput').files?.[0];
const getManyFiles = () => Array.from($('#fileInputMany').files || []);
const note = (msg) => console.log('[Docs]', msg);

/* ---------- preview ---------- */
const canvas = $('#pdfCanvas');
const ctx = canvas.getContext('2d');
const img = $('#imgPreview');
const docxMount = $('#docxMount');
const viewer = $('#viewer');

/* —Å–ø—Ä–∞—Ü—å–æ–≤—É—î —ñ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –≤–∏–±–æ—Ä—ñ —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ —Ñ–∞–π–ª—É */
const onMainFileChange = async () => {
  const f = getMainFile(); if (!f) return;
  await previewFile(f);
  if (/pdf$/i.test(f.name)) await buildReorderListFromPdf(f);
};
$('#fileInput').addEventListener('change', onMainFileChange);
$('#fileInput').addEventListener('input', onMainFileChange);

async function previewFile(file){
  $('#qr').style.display='none'; $('#qr').innerHTML='';
  canvas.style.display='none'; img.style.display='none'; docxMount.style.display='none';
  viewer.classList.remove('has-preview');

  const name = file.name.toLowerCase();

  if (name.endsWith('.pdf')){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: buf}).promise;
    const page = await pdf.getPage(1);

    /* –º–∞—Å—à—Ç–∞–±—É—î–º–æ –ø—ñ–¥ —Ä–µ–∞–ª—å–Ω—É –≤–∏–¥–∏–º—É –ø–ª–æ—â—É */
    const base = page.getViewport({scale:1});
    const pad = 24;
    const maxW = Math.max(320, viewer.clientWidth - pad);
    const maxH = Math.max(320, viewer.clientHeight - pad);
    const scale = Math.min(maxW / base.width, maxH / base.height);
    const vp = page.getViewport({scale: Math.max(0.5, Math.min(scale, 3))});

    canvas.width = vp.width; canvas.height = vp.height;
    await page.render({canvasContext: ctx, viewport: vp}).promise;
    canvas.style.display='block';
    viewer.classList.add('has-preview');
  } else if (/\.(png|jpg|jpeg|webp)$/i.test(name)){
    img.src = URL.createObjectURL(file);
    img.onload = ()=> URL.revokeObjectURL(img.src);
    img.style.display='block';
    viewer.classList.add('has-preview');
  } else if (name.endsWith('.docx')){
    docxMount.innerHTML = '<div class="muted">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ DOCX –Ω–∞—Ä–∞–∑—ñ —Å–ø—Ä–æ—â–µ–Ω–∏–π. –ï–∫—Å–ø–æ—Ä—Ç—É–π —É PDF –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É.</div>';
    docxMount.style.display='block';
    viewer.classList.add('has-preview');
  } else if (/\.(xlsx|csv|json)$/i.test(name)){
    docxMount.innerHTML = '<div class="muted">–¢–∞–±–ª–∏—á–Ω–∏–π —Ñ–∞–π–ª: —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è–º–∏ –ª—ñ–≤–æ—Ä—É—á.</div>';
    docxMount.style.display='block';
    viewer.classList.add('has-preview');
  } else {
    docxMount.innerHTML = '<div class="muted">–§–æ—Ä–º–∞—Ç –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º–∞–Ω–æ –¥–ª—è –ø—Ä–µ–≤‚Äô—é.</div>';
    docxMount.style.display='block';
  }
}

/* ---------- theme ---------- */
function toggleTheme(){
  const root = document.documentElement;
  const isDark = getComputedStyle(root).getPropertyValue('--bg').trim() === '#0b0e14';
  if (isDark){
    root.style.setProperty('--bg','#f5f7fb');
    root.style.setProperty('--card','#ffffff');
    root.style.setProperty('--line','#e5e8f0');
    root.style.setProperty('--text','#0b1220');
    root.style.setProperty('--chip','#f3f6ff');
  } else {
    root.style.setProperty('--bg','#0b0e14');
    root.style.setProperty('--card','#101522');
    root.style.setProperty('--line','#1b2131');
    root.style.setProperty('--text','#e6e9ef');
    root.style.setProperty('--chip','#161a20');
  }
  viewer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--card');
}
$('#btnThemeToggle').onclick = toggleTheme;
$('#btnThemeToggle2').onclick = toggleTheme;

/* ---------- —Ä–µ—à—Ç–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ (–±–µ–∑ –∑–º—ñ–Ω —Ñ—É–Ω–∫—Ü—ñ–π) ---------- */
$('#btnImageToPdf').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.(png|jpg|jpeg|webp)$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { jsPDF } = window.jspdf;
  const imgData = await blobToDataURL(f);
  const pdf = new jsPDF({unit:'pt', format:'a4', compress:true});
  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();
  const dims = await imageDims(imgData);
  const scale = Math.min(w/dims.w, h/dims.h);
  const nw = dims.w * scale, nh = dims.h * scale;
  pdf.addImage(imgData, 0, (h-nh)/2, nw, nh);
  const blob = pdf.output('blob');
  saveBlob(blob, fileStem(f.name)+'.pdf');
};

$('#btnMultiPhotoToPdf').onclick = async () => {
  const files = getManyFiles().filter(x=>/\.(png|jpg|jpeg|webp)$/i.test(x.name));
  if (!files.length) return alert('–î–æ–¥–∞–π —Ñ–æ—Ç–æ —É ¬´–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏¬ª.');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt', format:'a4', compress:true});
  let first = true;
  for (const f of files){
    const data = await blobToDataURL(f);
    const dims = await imageDims(data);
    const w = pdf.internal.pageSize.getWidth();
    const h = pdf.internal.pageSize.getHeight();
    const scale = Math.min(w/dims.w, h/dims.h);
    const nw = dims.w * scale, nh = dims.h * scale;
    if (!first) pdf.addPage();
    pdf.addImage(data, 0, (h-nh)/2, nw, nh);
    first = false;
  }
  const blob = pdf.output('blob');
  saveBlob(blob, 'photos.pdf');
};

$('#btnPdfToImage').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const buf = await f.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const zip = new JSZip();
  for (let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const vp = page.getViewport({scale:2});
    const cnv = document.createElement('canvas');
    cnv.width = vp.width; cnv.height = vp.height;
    await page.render({canvasContext: cnv.getContext('2d'), viewport: vp}).promise;
    const blob = await new Promise(res=>cnv.toBlob(res, 'image/png', 0.95));
    zip.file(`page-${i}.png`, blob);
  }
  zip.generateAsync({type:'blob'}).then(b=>saveBlob(b, fileStem(f.name)+'-pages.zip'));
};

$('#btnMerge').onclick = async () => {
  const files = getManyFiles().filter(x=>/\.pdf$/i.test(x.name));
  if (files.length < 2) return alert('–î–æ–¥–∞–π —è–∫ –º—ñ–Ω—ñ–º—É–º 2 PDF —É ¬´–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏¬ª.');
  const { PDFDocument } = PDFLib;
  const out = await PDFDocument.create();
  for (const f of files){
    const u8 = new Uint8Array(await f.arrayBuffer());
    const doc = await PDFDocument.load(u8);
    const pages = await out.copyPages(doc, doc.getPageIndices());
    pages.forEach(p=>out.addPage(p));
  }
  const u8 = await out.save();
  saveBlob(await toBlob(u8), 'merged.pdf');
};

$('#btnSplit').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const ranges = parseRanges($('#splitRange').value);
  if (!ranges.length) return alert('–í–∫–∞–∂–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏/–¥—ñ–∞–ø–∞–∑–æ–Ω–∏: –Ω–∞–ø—Ä. 1-3,5,8-9');
  const { PDFDocument } = PDFLib;
  const src = await PDFDocument.load(await f.arrayBuffer());
  let idx = 1;
  for (const r of ranges){
    const out = await PDFDocument.create();
    const toCopy = [];
    for (let i=r[0]-1; i<=r[1]-1; i++) toCopy.push(i);
    const pages = await out.copyPages(src, toCopy);
    pages.forEach(p=>out.addPage(p));
    const u8 = await out.save();
    saveBlob(await toBlob(u8), `${fileStem(f.name)}-part${idx++}.pdf`);
  }
};

$('#btnRemovePages').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const nums = ($('#removePages').value || '').split(',').map(s=>parseInt(s.trim(),10)).filter(Boolean);
  if (!nums.length) return alert('–í–∫–∞–∂–∏ –Ω–æ–º–µ—Ä–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —á–µ—Ä–µ–∑ –∫–æ–º—É.');
  const { PDFDocument } = PDFLib;
  const pdf = await PDFDocument.load(await f.arrayBuffer());
  nums.sort((a,b)=>b-a).forEach(n=>{
    if (n>=1 && n<=pdf.getPageCount()) pdf.removePage(n-1);
  });
  const u8 = await pdf.save();
  saveBlob(await toBlob(u8), fileStem(f.name)+'-removed.pdf');
  await previewFile(new File([u8], 'temp.pdf', {type:'application/pdf'}));
  await buildReorderListFromPdf(new File([u8], 'temp.pdf', {type:'application/pdf'}));
};

let reorderState = [];
async function buildReorderListFromPdf(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  const list = $('#reorderList'); list.innerHTML = '';
  reorderState = Array.from({length: pdf.numPages}, (_,i)=>i+1);
  for (let i=1;i<=pdf.numPages;i++){
    const item = document.createElement('div'); item.className='page-item'; item.draggable=true; item.dataset.page=i;
    item.innerHTML = `<div class="page-thumb"></div><div>–°—Ç–æ—Ä—ñ–Ω–∫–∞ ${i}</div>`;
    item.addEventListener('dragstart', e=>{ item.classList.add('dragging'); e.dataTransfer.setData('text/plain', i);});
    item.addEventListener('dragend', ()=> item.classList.remove('dragging'));
    list.appendChild(item);
  }
  list.addEventListener('dragover', e=>{
    e.preventDefault();
    const dragging = list.querySelector('.dragging');
    const after = getDragAfterElement(list, e.clientY);
    if (after == null) list.appendChild(dragging);
    else list.insertBefore(dragging, after);
  });
}
function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll('.page-item:not(.dragging)')];
  return els.reduce((closest, child)=>{
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if (offset<0 && offset>closest.offset) return {offset, element: child};
    else return closest;
  }, {offset: Number.NEGATIVE_INFINITY}).element;
}
$('#btnApplyReorder').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const order = $$('#reorderList .page-item').map(x=>parseInt(x.dataset.page,10)-1);
  const { PDFDocument } = PDFLib;
  const src = await PDFDocument.load(await f.arrayBuffer());
  const out = await PDFDocument.create();
  const pages = await out.copyPages(src, order);
  pages.forEach(p=>out.addPage(p));
  const u8 = await out.save();
  saveBlob(await toBlob(u8), fileStem(f.name)+'-reordered.pdf');
};

$('#btnAddText').onclick = async () => {
  const txt = $('#signText').value || 'Sign';
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const pdf = await PDFDocument.load(await f.arrayBuffer());
  const font = await pdf.embedFont(StandardFonts.Helvetica);
  const pages = pdf.getPages();
  pages.forEach(p=>{
    const { width, height } = p.getSize();
    p.drawText(txt, {x: width-200, y: 24, size: 12, font, color: rgb(0.1,0.6,1)});
  });
  const u8 = await pdf.save();
  saveBlob(await toBlob(u8), fileStem(f.name)+'-signed.pdf');
};

$('#btnWatermark').onclick = async () => {
  const txt = $('#wmText').value || 'PROOFLY';
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const pdf = await PDFDocument.load(await f.arrayBuffer());
  const font = await pdf.embedFont(StandardFonts.Helvetica);
  pdf.getPages().forEach(p=>{
    const {width, height} = p.getSize();
    p.drawText(txt, {
      x: width/4, y: height/2, size: 48, font,
      color: rgb(0.6,0.65,0.9), rotate: PDFLib.degrees(30), opacity: 0.15
    });
  });
  const u8 = await pdf.save();
  saveBlob(await toBlob(u8), fileStem(f.name)+'-wm.pdf');
};

$('#btnCompress').onclick = async () => {
  const f = getMainFile(); if (!f || !/\.pdf$/i.test(f.name)) return alert('–û–±–µ—Ä–∏ PDF —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—ñ');
  const { PDFDocument } = PDFLib;
  const pdf = await PDFDocument.load(await f.arrayBuffer(), {ignoreEncryption:true});
  const u8 = await pdf.save({useObjectStreams:true});
  saveBlob(await toBlob(u8), fileStem(f.name)+'-compressed.pdf');
};

/* —É—Ç–∏–ª—ñ—Ç–∏ */
function fileStem(name){ return name.replace(/\.[^.]+$/,''); }
function blobToDataURL(blob){
  return new Promise(res=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.readAsDataURL(blob); });
}
function imageDims(src){
  return new Promise(res=>{ const im = new Image(); im.onload = ()=> res({w: im.width, h: im.height}); im.src = src; });
}
function parseRanges(s){
  const parts = (s||'').split(',').map(x=>x.trim()).filter(Boolean);
  const out = [];
  for (const p of parts){
    if (p.includes('-')){
      const [a,b] = p.split('-').map(n=>parseInt(n,10));
      if (a && b && a<=b) out.push([a,b]);
    } else {
      const n = parseInt(p,10); if (n) out.push([n,n]);
    }
  }
  return out;
}
</script>
{% endblock %}
