<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}{{ title or 'PXP' }}{% endblock %}</title>

  <!-- 1) Глобальні стилі (каркас без кольорів) -->
  {% set u = safe_url_for('static', filename='style.css') %}
  {% if u %}<link rel="stylesheet" href="{{ u }}">{% endif %}

  <!-- 2) Додаткові базові стилі (покладаються на змінні теми) -->
  <style>
    :root{
      --bg:#0f1115;
      --ink:#e8eaed;
      --line:#1b2131;
      --card:#11141b;
      --muted:#9fb0d4;
      --btn:#1a73e8;
      --nav-bg:#0b0d12;
      --link:#8ab4ff;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui, Segoe UI, Roboto, Arial;
    }
    main{max-width:1100px;margin:16px auto;padding:0 20px}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}

    /* flash */
    .flash{margin:10px 0}
    .flash .item{
      background:color-mix(in srgb, var(--card) 88%, #1f2b45 12%);
      border:1px solid color-mix(in srgb, var(--line) 85%, #2a3b63 15%);
      color:color-mix(in srgb, var(--ink) 85%, #dbe5ff 15%);
      padding:10px;border-radius:10px;margin-bottom:8px
    }
  </style>

  <!-- 3) ТЕМА (МАЄ ЙТИ ПІСЛЯ КАРКАСА ТА INLINE-СТИЛЕЙ, щоб переважати кольорами) -->
  {% set u = safe_url_for('static', filename='themes/main.css') %}
  {% if u %}<link id="theme-css" rel="stylesheet" href="{{ u }}">{% endif %}
  <script>
    (function(){
      var saved = localStorage.getItem('theme') || 'main';
      var map = {
        main: '{{ safe_url_for("static", filename="themes/main.css") }}',
        cat: '{{ safe_url_for("static", filename="themes/cat.css") }}',
        hellowen: '{{ safe_url_for("static", filename="themes/hellowen.css") }}',
        minecraft: '{{ safe_url_for("static", filename="themes/minecraft.css") }}'
      };
      var el = document.getElementById('theme-css');
      if (el) el.href = map[saved] || map.main;
      document.documentElement.setAttribute('data-theme', saved);
    })();
  </script>

  <!-- === Favicon & app icons (static/icons/) === -->
  {% set u16 = safe_url_for('static', filename='icons/favicon-16x16.png') %}
  {% set u32 = safe_url_for('static', filename='icons/favicon-32x32.png') %}
  {% set u180 = safe_url_for('static', filename='icons/favicon-180x180.png') %}
  {% set u512 = safe_url_for('static', filename='icons/favicon-512x512.png') %}
  {% if u16 %}<link rel="icon" type="image/png" sizes="16x16" href="{{ u16 }}">{% endif %}
  {% if u32 %}<link rel="icon" type="image/png" sizes="32x32" href="{{ u32 }}">{% endif %}
  <!-- Apple touch: у репо файл названо favicon-180x180.png -->
  {% if u180 %}<link rel="apple-touch-icon" sizes="180x180" href="{{ u180 }}">{% endif %}
  {% if u512 %}<link rel="icon" type="image/png" sizes="512x512" href="{{ u512 }}">{% endif %}
  {% if u32 %}<link rel="shortcut icon" href="{{ u32 }}">{% endif %}
  <meta name="theme-color" content="#0f1724" />

  <!-- ✅ FIX: three.js у браузері (щоб import ... from "three" працював без bundler) -->
  {% set u = safe_url_for('static', filename='vendor/es-module-shims.js') %}
  {% if u %}<script defer src="{{ u }}"></script>{% endif %}
  <script type="importmap">
  {
    "imports": {
      "three": "/static/vendor/three/build/three.module.js",
      "three/addons/": "/static/vendor/three/examples/jsm/"
    }
  }
  </script>

  {% block extra_head %}{% endblock %}
</head>
<body>
  {% include 'nav.html' %}

  <main>
    {% with msgs = get_flashed_messages() %}
      {% if msgs %}
        <div class="flash">
          {% for m in msgs %}<div class="item">{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  {% block scripts %}{% endblock %}

  {# ЧАТ БІЛЬШЕ НЕ ВСТАВЛЯЄМО ТУТ.
     Він уже підключається в nav.html як {% include "chat.html" %} з умовою:
     not in ["auth.login","auth.register","auth.logout"] #}

  <!-- === i18n ядро: автопереклад усього DOM + підтримка 60+ мов === -->
  {% set u = safe_url_for('static', filename='vendor/i18next.min.js') %}
  {% if u %}<script defer src="{{ u }}"></script>{% endif %}
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    if (!window.i18next) {
      console.error("i18next missing (script not loaded) — skip translate init");
      return;
    }

    // ▼ Нормалізація мовного коду (ua -> uk)
    const normalizeLng = (lng) => (lng === 'ua' ? 'uk' : lng);

    const I18N_DIR = "/static/i18n/";
    const MISSING = new Set();
    const SKIP_TAGS = new Set(["SCRIPT","STYLE","TEXTAREA","CODE","PRE"]);
    const ATTRS = ["placeholder","title","aria-label","alt"];
    const RTL = new Set(["ar","fa","he","ur"]);
    const norm = s => (s||"").replace(/\s+/g," ").trim();

    function translateNode(node){
      if (node.nodeType === Node.TEXT_NODE){
        const raw = norm(node.nodeValue);
        if (!raw) return;
        if (i18next.exists(raw)) node.nodeValue = i18next.t(raw);
        else MISSING.add(raw);
        return;
      }
      if (node.nodeType !== Node.ELEMENT_NODE || SKIP_TAGS.has(node.tagName)) return;

      for (const a of ATTRS){
        if (node.hasAttribute(a)){
          const val = norm(node.getAttribute(a));
          if (val){
            if (i18next.exists(val)) node.setAttribute(a, i18next.t(val));
            else MISSING.add(val);
          }
        }
      }
      for (const child of Array.from(node.childNodes)) translateNode(child);
    }

    const applyAll = (root=document.body) => translateNode(root);

    const obs = new MutationObserver(muts=>{
      for (const m of muts){
        m.addedNodes?.forEach(n => { if (n.nodeType===1 || n.nodeType===3) applyAll(n); });
        if (m.type==="attributes" && ATTRS.includes(m.attributeName||"")) applyAll(m.target);
      }
    });

    async function loadDict(code){
      code = normalizeLng(code); // ✅ нормалізація ua -> uk
      const dict = await fetch(`${I18N_DIR}${code}.json`, {cache:"no-store"})
        .then(r=>r.ok?r.json():{}).catch(()=>({}));
      if (!i18next.isInitialized){
        await i18next.init({
          lng: code,
          ns: ['translation'],
          defaultNS: 'translation',
          resources: { [code]: { translation: dict } },
          keySeparator: false,
          nsSeparator: false
        });
      } else {
        // повністю оновлюємо бандл для мови
        i18next.removeResourceBundle(code, "translation");
        i18next.addResourceBundle(code, "translation", dict, true, true);
        await i18next.changeLanguage(code);
      }
      document.documentElement.setAttribute("lang", code);
      document.documentElement.setAttribute("dir", RTL.has(code) ? "rtl" : "ltr");
    }

    (async function start(){
      let lang = "uk";
      try{
        const js = await fetch("/api/lang/me",{cache:"no-store"}).then(r=>r.json());
        if (js && js.lang) lang = js.lang;
      }catch(e){}
      await loadDict(lang);
      applyAll(document.body);
      obs.observe(document.body,{subtree:true,childList:true,attributes:true,attributeFilter:ATTRS});

      // Глобальні хуки для свічера у nav.html:
      window.__i18nSetLang = async code => { await loadDict(code); applyAll(document.body); };
      window.__i18nMissing = () => Array.from(MISSING.values());
      window.__normalizeLng = normalizeLng; // ✅ експортуємо для nav.html
      // ✅ Безпечний експорт з root-параметром (щоб не сканувати весь DOM кожен раз)
      window.__i18nTranslate = (root = document.body) => {
        try { applyAll(root); } catch (e) { console.warn('i18n translate failed', e); }
      };
    })();
  });
  </script>

  <!-- === JS-маячок «живого» відвідувача для /api/visit === -->
  <script>
  (function(){
    function ping(){
      try{
        fetch("/api/visit", {
          method: "POST",
          keepalive: true,
          headers: {
            "Content-Type": "application/json",
            "X-Visit-Beacon": "1"
          },
          body: JSON.stringify({ path: location.pathname })
        });
      }catch(e){}
    }
    // логнемо одразу, коли вкладка видима
    if (document.visibilityState === "visible") ping();
    // і ще при поверненні у вкладку
    document.addEventListener("visibilitychange", function(){
      if (document.visibilityState === "visible") ping();
    });
  })();
  </script>
</body>
</html>
