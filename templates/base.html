<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}{{ title or 'PXP' }}{% endblock %}</title>

  <!-- 1) –¢–ï–ú–ò: –ª—ñ–Ω–∫, —è–∫–∏–π –º—ñ–Ω—è—î–º–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
  <link id="theme-css" rel="stylesheet" href="{{ url_for('static', filename='themes/dark.css') }}">
  <script>
    (function(){
      var saved = localStorage.getItem('theme') || 'dark';
      var map = {
        dark: '{{ url_for("static", filename="themes/dark.css") }}',
        light: '{{ url_for("static", filename="themes/light.css") }}',
        midnight: '{{ url_for("static", filename="themes/midnight.css") }}'
      };
      var el = document.getElementById('theme-css');
      if (el) el.href = map[saved] || map.dark;
      document.documentElement.setAttribute('data-theme', saved);
    })();
  </script>

  <!-- 2) –¢–≤–æ—ó –≥–ª–æ–±–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ (–ø–æ–≤–µ—Ä—Ö —Ç–µ–º–æ–≤–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –∑ —Ñ–∞–π–ª—ñ–≤ —Ç–µ–º —è–∫ –±–∞–∑—É */
    :root{
      /* –∑–∞–ø–∞—Å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ —Ñ–∞–π–ª —Ç–µ–º –Ω–µ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è */
      --bg:#0f1115;
      --ink:#e8eaed;
      --line:#1b2131;
      --card:#11141b;
      --muted:#9fb0d4;
      --btn:#1c64ec;
      --nav-bg:#0b0d12;
      --link:#8ab4ff;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,Segoe UI,Roboto,Arial
    }
    main{max-width:1100px;margin:16px auto;padding:0 20px}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}

    /* flash */
    .flash{margin:10px 0}
    .flash .item{
      background:color-mix(in srgb, var(--card) 88%, #1f2b45 12%);
      border:1px solid color-mix(in srgb, var(--line) 85%, #2a3b63 15%);
      color:color-mix(in srgb, var(--ink) 85%, #dbe5ff 15%);
      padding:10px;border-radius:10px;margin-bottom:8px
    }

    /* ===== Chat widget (bottom-left) ===== */
    .chat-fab{
      position:fixed; left:18px; bottom:18px; width:52px; height:52px;
      border-radius:50%; border:1px solid color-mix(in srgb, var(--line) 90%, #25304b 10%);
      background:color-mix(in srgb, var(--card) 85%, #1a1f2e 15%);
      color:var(--ink);
      display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:9999;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      font-size:22px;
    }
    .chat-fab:hover{filter:brightness(1.05)}
    .chat-panel{
      position:fixed; left:18px; bottom:80px; width:320px; max-height:420px;
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.45); display:none; z-index:9999;
      overflow:hidden;
    }
    .chat-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:var(--nav-bg); border-bottom:1px solid var(--line)}
    .chat-head b{font-size:14px}
    .chat-body{height:280px; overflow:auto; padding:10px 10px 0; display:flex; flex-direction:column; gap:8px}
    .chat-msg{background:color-mix(in srgb, var(--card) 85%, #111a2b 15%); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px}
    .chat-meta{opacity:.8; font-size:12px; margin-bottom:2px}
    .chat-form{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line); background:var(--card)}
    .chat-form input{
      flex:1; background:var(--bg); border:1px solid color-mix(in srgb, var(--line) 90%, #26324a 10%);
      color:var(--ink); border-radius:10px; padding:8px 10px; outline:none
    }
    .chat-form button{background:var(--btn); border:0; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer}
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>
  {% include 'nav.html' %}

  <main>
    {% with msgs = get_flashed_messages() %}
      {% if msgs %}
        <div class="flash">
          {% for m in msgs %}<div class="item">{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- ===== CHAT WIDGET ===== -->
  <div class="chat-fab" id="chatFab" title="–ß–∞—Ç">üí¨</div>

  <div class="chat-panel" id="chatPanel" aria-live="polite">
    <div class="chat-head">
      <b>–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Ç</b>
      <button id="chatClose" style="background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:16px">‚úï</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <form class="chat-form" id="chatForm" autocomplete="off">
      <input id="chatInput" type="text" maxlength="500" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" />
      <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    </form>
  </div>

  <script>
    // ===== –ì–ª–æ–±–∞–ª—å–Ω–∏–π —á–∞—Ç (pull –∫–æ–∂–Ω—ñ 2.5s) =====
    (function(){
      const API_FETCH = "/chat/fetch";
      const API_POST  = "/chat/post";
      const fab   = document.getElementById("chatFab");
      const panel = document.getElementById("chatPanel");
      const close = document.getElementById("chatClose");
      const body  = document.getElementById("chatBody");
      const form  = document.getElementById("chatForm");
      const input = document.getElementById("chatInput");

      let lastId = null;
      let timer  = null;

      function esc(s){return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
      function append(msg){
        const div = document.createElement("div");
        div.className = "chat-msg";
        div.innerHTML = `<div class="chat-meta">${esc(msg.user_name||"–ì—ñ—Å—Ç—å")} ‚Ä¢ ${msg.time||""}</div>${esc(msg.text)}`;
        body.appendChild(div);
        body.scrollTop = body.scrollHeight;
        lastId = msg.id;
      }
      function fetchInit(){
        fetch(API_FETCH).then(r=>r.json()).then(d=>{
          if(!d.ok) return;
          body.innerHTML = "";
          d.messages.forEach(append);
        }).catch(()=>{});
      }
      function fetchNew(){
        const url = lastId ? `${API_FETCH}?since_id=${lastId}` : API_FETCH;
        fetch(url).then(r=>r.json()).then(d=>{
          if(!d.ok) return;
          d.messages.forEach(append);
        }).catch(()=>{});
      }

      fab.onclick = () => {
        panel.style.display = "block";
        if(!timer){
          fetchInit();
          timer = setInterval(fetchNew, 2500);
        }
      };
      close.onclick = () => {
        panel.style.display = "none";
        if(timer){ clearInterval(timer); timer = null; }
      };

      form.addEventListener("submit", (e)=>{
        e.preventDefault();
        const text = input.value.trim();
        if(!text) return;
        input.value = "";
        fetch(API_POST, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ text })
        }).then(r=>r.json()).then(()=>{ fetchNew(); }).catch(()=>{});
      });
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>


