
<script>
  window.location.replace("/market/upload");
</script>
{% extends "base.html" %}
{% block content %}
<h1>+ –î–æ–¥–∞—Ç–∏ STL</h1>

<style>
  /* === LAYOUT === */
  .upload-layout{
    display:grid;
    grid-template-columns:minmax(0,2.1fr) minmax(320px,1fr);
    gap:26px;
    align-items:flex-start;
  }
  @media (max-width: 1024px){
    .upload-layout{ grid-template-columns:1fr; }
  }
  .upload-main .card{
    max-width:100%;
    background:linear-gradient(135deg, rgba(12,16,36,.96), rgba(8,11,26,.98));
    border-radius:22px;
    border:1px solid rgba(110,132,255,.25);
    box-shadow:0 24px 60px rgba(0,0,0,.75);
    padding:18px 20px 20px;
  }
  .upload-main label{
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:.06em;
    color:#9fa8ff;
  }
  .upload-main input,
  .upload-main textarea{
    border-radius:12px;
    border:1px solid #262d4f;
    background:#050819;
    color:#e5e9ff;
    padding:8px 10px;
    font-size:14px;
  }
  .upload-main input:focus,
  .upload-main textarea:focus{
    outline:none;
    border-color:#5b66ff;
    box-shadow:0 0 0 1px rgba(91,102,255,.45);
  }

  /* === STEPS TOP BAR === */
  .upload-steps{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:18px;
    padding:4px;
    border-radius:999px;
    background:radial-gradient(circle at 0 0,rgba(120,138,255,.15),transparent 45%),
               radial-gradient(circle at 100% 100%,rgba(165,95,255,.25),transparent 40%),
               #050818;
    border:1px solid #252c52;
  }
  .upload-step-pill{
    flex:1;
    min-width:120px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:7px 12px;
    border-radius:999px;
    font-size:11px;
    color:#aeb6ff;
    text-transform:uppercase;
    letter-spacing:.08em;
    cursor:default;
    transition:background .18s ease,color .18s ease, transform .18s ease;
  }
  .upload-step-pill span{
    width:18px;height:18px;
    border-radius:999px;
    background:#252d52;
    display:flex;align-items:center;justify-content:center;
    font-size:11px;
  }
  .upload-step-pill.active{
    background:linear-gradient(90deg,#5b66ff,#b574ff);
    color:#fff;
    box-shadow:0 0 0 1px rgba(255,255,255,.12),0 14px 35px rgba(51,64,188,.7);
    transform:translateY(-1px);
  }
  .upload-step-pill.active span{
    background:#050814;
  }

  /* === FIELDS / FIELDSETS === */
  .note-muted{ color:#9ea6c9; font-size:12px }
  .fieldset{
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid rgba(55,65,115,.95);
    background:linear-gradient(145deg,rgba(14,18,40,.97),rgba(8,10,24,1));
    box-shadow:0 16px 40px rgba(0,0,0,.7);
  }
  .fieldset legend{
    font-size:11px;
    letter-spacing:.09em;
    text-transform:uppercase;
    color:#8c97ff;
    padding:0 8px;
  }
  .list{
    font-size:13px;
    color:#cfd5ff;
    margin-top:8px;
    word-break:break-all;
  }

  /* === DROP ZONES === */
  .drop-tile{
    width:100%; aspect-ratio: 16/6; max-height:280px;
    display:flex; align-items:center; justify-content:center;
    border-radius:18px;
    position:relative;
    overflow:hidden;
    cursor:pointer;
    border:1px dashed rgba(115,132,219,.8);
    background:
      radial-gradient(circle at 0 0,rgba(120,138,255,.25),transparent 55%),
      radial-gradient(circle at 100% 100%,rgba(199,107,255,.32),transparent 52%),
      linear-gradient(180deg,#151b34 0%,#0b0f24 100%);
    box-shadow:0 18px 50px rgba(0,0,0,.85);
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
  }
  .drop-tile:hover{
    transform:translateY(-1px) scale(1.01);
    border-color:#c1c7ff;
    box-shadow:0 24px 65px rgba(0,0,0,.9);
  }
  .drop-center{ text-align:center; pointer-events:none; user-select:none; }
  .drop-title{
    font-size:19px;
    font-weight:700;
    letter-spacing:.04em;
    color:#edf1ff;
  }
  .drop-sub{
    font-size:13px;
    opacity:.9;
    margin-top:5px;
    color:#c0c7ff;
  }
  .badge{
    position:absolute; top:10px; right:12px;
    padding:4px 10px;
    border-radius:999px;
    font-size:11px;
    background:rgba(4,7,20,.92);
    color:#f7f7ff;
    border:1px solid rgba(191,200,255,.35);
    backdrop-filter:blur(8px);
  }
  .thumbs{
    display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
  }
  .thumb{
    width:100px; height:75px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid #252d52;
    background:#050814;
    box-shadow:0 10px 24px rgba(0,0,0,.8);
  }
  .thumb img{ width:100%; height:100%; object-fit:cover }

  /* === PRICE SWITCH === */
  .price-row{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .switch{
    position:relative;
    display:inline-block;
    width:44px;
    height:24px;
  }
  .switch input{ opacity:0;width:0;height:0; }
  .slider{
    position:absolute;
    inset:0;
    border-radius:999px;
    background:#232842;
    box-shadow:inset 0 0 0 1px rgba(96,110,187,.7);
    cursor:pointer;
    transition:.2s;
  }
  .slider:before{
    content:"";
    position:absolute;
    height:18px;width:18px;
    left:3px;top:3px;
    border-radius:50%;
    background:#f7f7ff;
    box-shadow:0 4px 10px rgba(0,0,0,.7);
    transition:.2s;
  }
  .switch input:checked + .slider{
    background:linear-gradient(90deg,#5b66ff,#e46bff);
    box-shadow:0 0 0 1px rgba(180,196,255,.9);
  }
  .switch input:checked + .slider:before{
    transform:translateX(18px);
  }
  .switch-label{
    font-size:13px;
    color:#d7dcff;
  }

  /* === TAGS CHIPS === */
  .tags-input{
    display:flex;
    align-items:center;
    flex-wrap:wrap;
    gap:6px;
    padding:6px 8px;
    min-height:40px;
    border-radius:12px;
    border:1px solid #283257;
    background:radial-gradient(circle at 0 0,rgba(95,122,255,.12),transparent 55%),
               #050819;
  }
  .tags-chips{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .tag-chip{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:3px 9px;
    border-radius:999px;
    font-size:11px;
    background:rgba(33,41,90,.96);
    color:#dde2ff;
    border:1px solid rgba(125,144,255,.7);
    box-shadow:0 8px 18px rgba(0,0,0,.8);
  }
  .tag-chip button{
    border:none;
    background:transparent;
    color:#9aa4d6;
    cursor:pointer;
    font-size:11px;
    padding:0;
    line-height:1;
  }
  .tags-input input{
    flex:1;
    min-width:120px;
    border:none;
    background:transparent;
    outline:none;
    font-size:13px;
    color:#e5e9ff;
  }

  /* === PREVIEW SIDE === */
  .upload-side{
    position:sticky;
    top:88px;
  }
  .upload-preview-card,
  .upload-tips-card{
    background:radial-gradient(circle at 0 0,rgba(148,101,255,.16),transparent 55%),
               radial-gradient(circle at 100% 100%,rgba(87,194,255,.16),transparent 55%),
               #050712;
    border-radius:20px;
    padding:16px 18px;
    border:1px solid rgba(82,100,201,.85);
    box-shadow:0 24px 60px rgba(0,0,0,.9);
  }
  .upload-tips-card{ margin-top:18px;font-size:13px;color:#cfd6ff; }
  .upload-tips-card ul{ padding-left:18px;margin:8px 0 0; }
  .upload-preview-card h3,
  .upload-tips-card h3{
    margin:0 0 8px;
    font-size:13px;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:#9fa8ff;
  }

  .preview-thumbnail{
    width:100%;
    aspect-ratio:4/3;
    border-radius:16px;
    background:#040614;
    border:1px solid #262c54;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    margin-bottom:10px;
    box-shadow:inset 0 0 0 1px rgba(10,14,40,.9);
  }
  .preview-thumbnail img{
    width:100%;height:100%;object-fit:cover;
  }
  .preview-placeholder-text{
    font-size:12px;
    color:#737aa7;
    text-align:center;
  }
  .preview-body{
    display:flex;flex-direction:column;gap:4px;
  }
  .preview-title{
    font-size:16px;
    font-weight:600;
    color:#eef1ff;
  }
  .preview-price{
    font-size:14px;
    font-weight:600;
  }
  .preview-price.free{ color:#7bffb7; }
  .preview-price.paid{ color:#ffd88a; }
  .preview-tags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
  }
  .preview-tag{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    background:#151a38;
    border:1px solid #353f73;
    color:#d8defe;
  }
</style>

<div class="upload-layout">

  <!-- –ª—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ -->
  <div class="upload-main">
    <div class="card">

      <!-- step bar -->
      <div class="upload-steps">
        <div class="upload-step-pill active"><span>1</span> –Ü–Ω—Ñ–æ</div>
        <div class="upload-step-pill"><span>2</span> –§–∞–π–ª–∏</div>
        <div class="upload-step-pill"><span>3</span> –û–ø–∏—Å & –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è</div>
      </div>

      <!-- —Ñ–æ—Ä–º–∞ -->
      <form id="uploadForm"
            method="post"
            action="/api/market/upload"
            enctype="multipart/form-data"
            novalidate>
        <label>–ù–∞–∑–≤–∞</label>
        <input id="title" name="title" required placeholder="Dragon, Phone stand‚Ä¶" style="width:100%">

        <div style="height:10px"></div>

        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <div style="flex:1; min-width:160px">
            <label>–¶—ñ–Ω–∞</label>
            <div class="price-row">
              <!-- changed name to "price" to match backend reading form.get("price") -->
              <input id="price" name="price" type="number" min="0" value="0" required style="width:100%">
              <label class="switch">
                <input type="checkbox" id="is_free" name="is_free" value="1">
                <span class="slider"></span>
              </label>
              <span class="switch-label">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</span>
            </div>
          </div>
          <div style="flex:2; min-width:220px">
            <label>–¢–µ–≥–∏</label>
            <div class="tags-input" id="tagsWrapper">
              <div class="tags-chips" id="tagsChips"></div>
              <input id="tagsInput" type="text" placeholder="dragon, toy, figure">
            </div>
            <!-- –±–µ–∫–µ–Ω–¥ —á–∏—Ç–∞—î name="tags" -->
            <input type="hidden" id="tagsHidden" name="tags">
            <div class="note-muted" style="margin-top:4px">Enter –∞–±–æ , —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ç–µ–≥. –ú–∞–∫—Å. 15 —Ç–µ–≥—ñ–≤.</div>
          </div>
        </div>

        <div style="height:14px"></div>

        <!-- –í–Ü–î–ï–û (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, 1 —Ñ–∞–π–ª) -->
        <fieldset class="fieldset">
          <legend>–í—ñ–¥–µ–æ-–ø—Ä–µ–≤ º—é (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, MP4/WebM/MOV)</legend>

          <!-- –ü—É–ª -->
          <input id="video_pool" type="file" accept=".mp4,.webm,.mov,video/mp4,video/webm,video/quicktime" style="display:none">

          <!-- –†–µ–∞–ª—å–Ω–µ –ø–æ–ª–µ –¥–ª—è –±–µ–∫–µ–Ω–¥—É -->
          <input id="video_file" name="video_file" type="file" accept=".mp4,.webm,.mov,video/mp4,video/webm,video/quicktime" style="display:none">

          <div id="video_tile" class="drop-tile" tabindex="0" aria-label="–î–æ–¥–∞–π –≤—ñ–¥–µ–æ-–ø—Ä–µ–≤ º—é">
            <div class="drop-center">
              <div class="drop-title">–î–æ–¥–∞–π –≤—ñ–¥–µ–æ-–ø—Ä–µ–≤ º—é</div>
              <div class="drop-sub">MP4 / WebM / MOV ‚Äî –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ (–¥–æ 1 –≤—ñ–¥–µ–æ, –¥–æ 60 —Å–µ–∫)</div>
            </div>
            <div id="video_badge" class="badge">‚Äî</div>
          </div>

          <div id="video_preview" class="thumbs"></div>
          <div class="note-muted" style="margin-top:6px">
            –í—ñ–¥–µ–æ-–ø—Ä–µ–≤ º—é –¥–æ–ø–æ–º–æ–∂–µ –ø–æ–∫—É–ø—Ü—è–º –∫—Ä–∞—â–µ –æ—Ü—ñ–Ω–∏—Ç–∏ –º–æ–¥–µ–ª—å. –ù–µ –±—ñ–ª—å—à–µ 60 —Å–µ–∫, –¥–æ 30 –ú–ë.
          </div>
        </fieldset>

        <!-- ZIP (–≥–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á—É–≤–∞–Ω–Ω—è) -->
        <fieldset class="fieldset">
          <legend>ZIP (–≥–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á—É–≤–∞–Ω–Ω—è, –Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</legend>

          <!-- –ü—É–ª ZIP -->
          <input id="zip_pool" type="file" accept=".zip" style="display:none">

          <!-- –†–µ–∞–ª—å–Ω–µ –ø–æ–ª–µ –¥–ª—è –±–µ–∫–µ–Ω–¥—É -->
          <input id="zip_file" name="zip_file" type="file" accept=".zip" style="display:none">

          <div id="zip_tile" class="drop-tile" tabindex="0" aria-label="–î–æ–¥–∞–π ZIP-–∞—Ä—Ö—ñ–≤">
            <div class="drop-center">
              <div class="drop-title">–î–æ–¥–∞–π ZIP-–∞—Ä—Ö—ñ–≤</div>
              <div class="drop-sub">ZIP ‚Äî –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ (—Ü–µ–π —Ñ–∞–π–ª –±—É–¥–µ –∫–∞—á–∞—Ç–∏—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º)</div>
            </div>
            <div id="zip_badge" class="badge">‚Äî</div>
          </div>

          <div id="zip_list" class="list"></div>
          <div class="note-muted" style="margin-top:6px">
            –Ø–∫—â–æ ZIP –Ω–µ –¥–æ–¥–∞–Ω–æ ‚Äî –ø—Ä–∏ —Å–∫–∞—á—É–≤–∞–Ω–Ω—ñ –ø—ñ–¥–µ –æ—Å–Ω–æ–≤–Ω–∏–π STL. STL/–§–æ—Ç–æ –Ω–∏–∂—á–µ ‚Äî –ª–∏—à–µ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Ç–æ–≤–∞—Ä—É.
          </div>
        </fieldset>

        <div style="height:14px"></div>

        <!-- 3D-–§–ê–ô–õ–ò (–æ–¥–Ω–∞ –ø–ª–∏—Ç–∫–∞, –¥–æ 5) -->
        <fieldset class="fieldset">
          <legend>3D-—Ñ–∞–π–ª–∏ (–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ, –¥–æ 5 ‚Äî –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É)</legend>

          <!-- –ü—É–ª (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ–±–∏—Ä–∞—î —Ç—É—Ç) -->
          <input id="stl_pool" type="file" multiple accept=".stl,.obj,.ply,.gltf,.glb" style="display:none" aria-required="true">

          <!-- –†–µ–∞–ª—å–Ω–µ –≥–æ–ª–æ–≤–Ω–µ –ø–æ–ª–µ –¥–ª—è –±–µ–∫–µ–Ω–¥—É: file -->
          <input id="stl_file"  name="file"  type="file" accept=".stl,.obj,.ply,.gltf,.glb" style="display:none">
          <!-- –¥–æ–¥–∞—Ç–∫–æ–≤—ñ ‚Äî —è–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–µ –∑–Ω–∞—î –ø—Ä–æ stl_files, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—ñ–≥–Ω–æ—Ä—É—î -->
          <input id="stl_files" name="stl_files" type="file" accept=".stl,.obj,.ply,.gltf,.glb" multiple style="display:none">

          <div id="stl_tile" class="drop-tile" tabindex="0" aria-label="–î–æ–¥–∞–π 3D-—Ñ–∞–π–ª–∏">
            <div class="drop-center">
              <div class="drop-title">–î–æ–¥–∞–π 3D-—Ñ–∞–π–ª–∏</div>
              <div class="drop-sub">STL / OBJ / PLY / GLTF / GLB ‚Äî –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ (–¥–æ 5)</div>
            </div>
            <div id="stl_badge" class="badge">0/5</div>
          </div>

          <div id="stl_list" class="list"></div>
          <div id="stl_file_hint" class="note-muted" style="margin-top:6px">–ü–µ—Ä—à–∏–π —Ñ–∞–π–ª —Å—Ç–∞–Ω–µ –æ—Å–Ω–æ–≤–Ω–∏–º –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É, —Ä–µ—à—Ç–∞ ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤—ñ.</div>
        </fieldset>

        <div style="height:14px"></div>

        <!-- –§–û–¢–û (–æ–¥–Ω–∞ –ø–ª–∏—Ç–∫–∞, –¥–æ 5) -->
        <fieldset class="fieldset">
          <legend>–§–æ—Ç–æ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ, –¥–æ 5 ‚Äî –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É)</legend>

          <!-- –ü—É–ª -->
          <input id="photo_pool" type="file" multiple accept=".jpg,.jpeg,.png,.webp" style="display:none">

          <!-- –†–µ–∞–ª—å–Ω—ñ –ø–æ–ª—è –¥–ª—è –±–µ–∫–µ–Ω–¥—É (—ñ–º–µ–Ω–∞ –ø—ñ–¥ –±–µ–∫–µ–Ω–¥: cover_file, gallery_files) -->
          <input id="cover_file"    name="cover_file" type="file" accept=".jpg,.jpeg,.png,.webp" style="display:none">
          <input id="gallery_files" name="gallery_files" type="file" accept=".jpg,.jpeg,.png,.webp" multiple style="display:none">

          <div id="photo_tile" class="drop-tile" tabindex="0" aria-label="–î–æ–¥–∞–π —Ñ–æ—Ç–æ">
            <div class="drop-center">
              <div class="drop-title">–î–æ–¥–∞–π —Ñ–æ—Ç–æ</div>
              <div class="drop-sub">JPG / PNG / WEBP ‚Äî –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ (–¥–æ 5)</div>
            </div>
            <div id="gal_badge" class="badge">0/5</div>
          </div>

          <div id="gallery_preview" class="thumbs"></div>
          <div id="gallery_note" class="note-muted" style="margin-top:6px">–ü–µ—Ä—à–µ —Ñ–æ—Ç–æ —Å—Ç–∞–Ω–µ –æ–±–∫–ª–∞–¥–∏–Ω–∫–æ—é, —Ä–µ—à—Ç–∞ ‚Äî –≤ –≥–∞–ª–µ—Ä–µ—é.</div>
        </fieldset>

        <div style="height:14px"></div>

        <label>–û–ø–∏—Å</label>
        <!-- –±–µ–∫–µ–Ω–¥ —á–µ–∫–∞—î desc -->
        <textarea id="desc" name="desc" rows="5" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –º–æ–¥–µ–ª—ñ‚Ä¶" style="width:100%"></textarea>

        <div style="height:14px"></div>

        <button class="btn primary" id="send" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <span id="msg" class="muted" style="margin-left:10px"></span>
      </form>
    </div>
  </div>

  <!-- –ø—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: live-–ø—Ä–µ–≤ º—é -->
  <aside class="upload-side">
    <div class="upload-preview-card">
      <h3>–ü—Ä–µ–≤ º—é –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h3>
      <div class="preview-thumbnail" id="previewThumbnail">
        <span class="preview-placeholder-text">–¢—É—Ç –∑‚Äô—è–≤–∏—Ç—å—Å—è —Ç–≤–æ—è –º–æ–¥–µ–ª—å (–ø–µ—Ä—à–µ —Ñ–æ—Ç–æ)</span>
      </div>
      <div class="preview-body">
        <div class="preview-title" id="previewTitle">–ù–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ</div>
        <div class="preview-price free" id="previewPrice">FREE</div>
        <div class="preview-tags" id="previewTags"></div>
      </div>
    </div>

    <div class="upload-tips-card">
      <h3>–ü–æ—Ä–∞–¥–∏</h3>
      <ul>
        <li>–î–æ–¥–∞–π 3‚Äì5 —Ñ–æ—Ç–æ: —Ä–µ–Ω–¥–µ—Ä + —Ä–µ–∞–ª—å–Ω–∏–π –¥—Ä—É–∫.</li>
        <li>–£–∫–∞–∂–∏ —á–∞—Å –¥—Ä—É–∫—É —Ç–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –≤ –æ–ø–∏—Å—ñ.</li>
        <li>–ß–∏–º —Ç–æ—á–Ω—ñ—à–∏–π –æ–ø–∏—Å, —Ç–∏–º –≤–∏—â–µ –º–æ–¥–µ–ª—å –≤ –ø–æ—à—É–∫—É.</li>
      </ul>
    </div>
  </aside>

</div>

<script>
(function(){
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};

  const form = document.getElementById('uploadForm');
  const msg  = document.getElementById('msg');

  // –ü—É–ª–∏
  const zipPool   = document.getElementById('zip_pool');
  const stlPool   = document.getElementById('stl_pool');
  const photoPool = document.getElementById('photo_pool');

  // –†–µ–∞–ª—å–Ω—ñ –ø–æ–ª—è –¥–ª—è –±–µ–∫–µ–Ω–¥—É
  const zipFile   = document.getElementById('zip_file');
  const stlMain   = document.getElementById('stl_file');   // name="file"
  const stlExtras = document.getElementById('stl_files');
  const coverFile = document.getElementById('cover_file'); // name="cover_file"
  const galFiles  = document.getElementById('gallery_files');
  const videoFile = document.getElementById('video_file');
  // –í—ñ–¥–µ–æ
  const videoPool   = document.getElementById('video_pool');
  const videoTile   = document.getElementById('video_tile');
  const videoBadge  = document.getElementById('video_badge');
  const videoPreview= document.getElementById('video_preview');

  function updateVideoUI(files){
    videoPreview.innerHTML = '';
    const n = files.length;
    videoBadge.textContent = n ? '1' : '‚Äî';
    if (n){
      const url = URL.createObjectURL(files[0]);
      const div = document.createElement('div');
      div.className = 'thumb';
      const video = document.createElement('video');
      video.src = url;
      video.controls = true;
      video.style.maxWidth = '120px';
      video.style.maxHeight = '90px';
      div.appendChild(video);
      videoPreview.appendChild(div);
      safeAssignFiles(videoFile, [files[0]], 1);
    } else {
      safeAssignFiles(videoFile, [], 1);
    }
  }

  attachTile(videoTile, videoPool, updateVideoUI);
  videoPool.addEventListener('change', ()=> updateVideoUI(videoPool.files||[]));
  updateVideoUI(videoPool.files||[]);

  // –ø–ª–∏—Ç–∫–∏
  const zipTile   = document.getElementById('zip_tile');
  const zipBadge  = document.getElementById('zip_badge');
  const zipList   = document.getElementById('zip_list');

  const stlTile   = document.getElementById('stl_tile');
  const stlBadge  = document.getElementById('stl_badge');
  const stlList   = document.getElementById('stl_list');
  const stlHint   = document.getElementById('stl_file_hint');

  const photoTile  = document.getElementById('photo_tile');
  const galBadge   = document.getElementById('gal_badge');
  const galPreview = document.getElementById('gallery_preview');
  const galNote    = document.getElementById('gallery_note');

  const STL_LIMIT   = 5;
  const PHOTO_LIMIT = 5;

  // live preview
  const titleInput   = document.getElementById('title');
  const priceInput   = document.getElementById('price');
  const isFreeToggle = document.getElementById('is_free');
  const previewTitle = document.getElementById('previewTitle');
  const previewPrice = document.getElementById('previewPrice');
  const previewTags  = document.getElementById('previewTags');
  const previewThumb = document.getElementById('previewThumbnail');

  // tags chips
  const tagsInput   = document.getElementById('tagsInput');
  const tagsHidden  = document.getElementById('tagsHidden');
  const tagsChips   = document.getElementById('tagsChips');
  let tags = [];

  function renderTags(){
    tagsChips.innerHTML = '';
    tags.forEach((t, idx)=>{
      const div = document.createElement('span');
      div.className = 'tag-chip';
      div.innerHTML = `<span>${t}</span>`;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.innerHTML = '&times;';
      btn.addEventListener('click', ()=>{
        tags.splice(idx,1);
        renderTags();
        updateTagsPreview();
      });
      div.appendChild(btn);
      tagsChips.appendChild(div);
    });
    // –Ω–∞ –±–µ–∫–µ–Ω–¥ —è–∫ CSV
    tagsHidden.value = tags.join(', ');
    updateTagsPreview();
  }

  function addTagFromInput(){
    let value = (tagsInput.value || '').trim();
    if (!value) return;
    const parts = value.split(',').map(s=>s.trim()).filter(Boolean);
    for (const p of parts){
      if (!p) continue;
      if (tags.includes(p)) continue;
      if (tags.length >= 15) break;
      tags.push(p);
    }
    tagsInput.value = '';
    renderTags();
  }

  tagsInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' || e.key === ','){
      e.preventDefault();
      addTagFromInput();
    } else if (e.key === 'Backspace' && !tagsInput.value && tags.length){
      tags.pop();
      renderTags();
    }
  });
  tagsInput.addEventListener('blur', addTagFromInput);

  function updateTitle(){
    const v = (titleInput.value || '').trim();
    previewTitle.textContent = v || '–ù–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ';
  }
  function updatePrice(){
    const free = isFreeToggle.checked;
    if (free){
      priceInput.value = 0;
      priceInput.disabled = true;
      previewPrice.textContent = 'FREE';
      previewPrice.classList.remove('paid');
      previewPrice.classList.add('free');
      return;
    }
    priceInput.disabled = false;
    const raw = priceInput.value;
    const num = Number(raw);
    if (!raw || isNaN(num) || num === 0){
      previewPrice.textContent = 'FREE';
      previewPrice.classList.remove('paid');
      previewPrice.classList.add('free');
    } else {
      previewPrice.textContent = num.toFixed(num % 1 ? 2 : 0) + ' z≈Ç';
      previewPrice.classList.remove('free');
      previewPrice.classList.add('paid');
    }
  }
  function updateTagsPreview(){
    previewTags.innerHTML = '';
    tags.forEach(t=>{
      const span = document.createElement('span');
      span.className = 'preview-tag';
      span.textContent = t;
      previewTags.appendChild(span);
    });
  }

  titleInput.addEventListener('input', updateTitle);
  priceInput.addEventListener('input', updatePrice);
  isFreeToggle.addEventListener('change', updatePrice);
  updateTitle(); updatePrice(); renderTags();

  // helpers –¥–ª—è —Ñ–∞–π–ª—ñ–≤
  function accepts(input){
    const acc = (input.getAttribute('accept') || '').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    if (!acc.length) return null;
    const exts = acc.filter(s=>s.startsWith('.'));
    const mimes= acc.filter(s=>s.includes('/'));
    return {exts, mimes};
  }
  function fileAccepted(file, input){
    const rule = accepts(input);
    if (!rule) return true;
    const name = (file.name || '').toLowerCase();
    const type = (file.type || '').toLowerCase();
    if (rule.exts.some(ext => name.endsWith(ext))) return true;
    if (rule.mimes.some(m => m.endsWith('/*') ? type.startsWith(m.slice(0,-1)) : type===m)) return true;
    return false;
  }
  function safeAssignFiles(input, filesArr, limit){
    const dt = new DataTransfer();
    for (let i=0; i<filesArr.length && i<limit; i++){
      const f = filesArr[i];
      if (fileAccepted(f, input)) dt.items.add(f);
    }
    input.files = dt.files;
  }

  function attachTile(tile, input, onFiles){
    tile.addEventListener('click', ()=> input.click());
    tile.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); input.click(); }});

    ['dragenter','dragover'].forEach(ev=>{
      tile.addEventListener(ev, (e)=>{ e.preventDefault(); tile.style.borderColor='#8ea0d8'; tile.style.transform='scale(1.01)'; });
    });
    ['dragleave','drop'].forEach(ev=>{
      tile.addEventListener(ev, (e)=>{ e.preventDefault(); tile.style.borderColor=''; tile.style.transform=''; });
    });

    tile.addEventListener('drop', (e)=>{
      if (!e.dataTransfer || !e.dataTransfer.files) return;
      const files = Array.from(e.dataTransfer.files);
      safeAssignFiles(input, files, input===stlPool ? STL_LIMIT : (input===photoPool ? PHOTO_LIMIT : 1));
      onFiles && onFiles(input.files);
    });

    input.addEventListener('change', ()=> onFiles && onFiles(input.files||[]));
  }

  function updateZipUI(files){
    const n = files.length;
    zipBadge.textContent = n ? '1' : '‚Äî';
    zipList.textContent  = n ? files[0].name : '';
    if (n) safeAssignFiles(zipFile, [files[0]], 1);
    else   safeAssignFiles(zipFile, [], 1);
  }

  function updateStlUI(files){
    const n = Math.min(files.length, STL_LIMIT);
    stlBadge.textContent = `${n}/${STL_LIMIT}`;
    stlList.textContent = n ? Array.from(files).slice(0,STL_LIMIT).map(f=>f.name).join(' ‚Ä¢ ') : '';
    stlHint.textContent = n ? '–§–∞–π–ª–∏ –≤–∏–±—Ä–∞–Ω–æ.' : '–ü–µ—Ä—à–∏–π —Ñ–∞–π–ª —Å—Ç–∞–Ω–µ –æ—Å–Ω–æ–≤–Ω–∏–º –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É, —Ä–µ—à—Ç–∞ ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤—ñ.';
    if (n){
      const list = Array.from(files).slice(0, STL_LIMIT);
      safeAssignFiles(stlMain,  [list[0]], 1);      // file
      safeAssignFiles(stlExtras, list.slice(1), 4); // stl_files
    } else {
      safeAssignFiles(stlMain,  [], 1);
      safeAssignFiles(stlExtras, [], 4);
    }
  }

  function updatePhotoUI(files){
    galPreview.innerHTML = '';
    const n = Math.min(files.length, PHOTO_LIMIT);
    let firstUrl = null;
    for(let i=0;i<n;i++){
      const url = URL.createObjectURL(files[i]);
      if (!firstUrl) firstUrl = url;
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = document.createElement('img');
      img.src = url;
      div.appendChild(img);
      galPreview.appendChild(div);
    }
    galBadge.textContent = `${n}/${PHOTO_LIMIT}`;
    galNote.textContent  = '–ü–µ—Ä—à–µ —Ñ–æ—Ç–æ —Å—Ç–∞–Ω–µ –æ–±–∫–ª–∞–¥–∏–Ω–∫–æ—é, —Ä–µ—à—Ç–∞ ‚Äî –≤ –≥–∞–ª–µ—Ä–µ—é.' + (files.length>PHOTO_LIMIT ? ' –ó–∞–π–≤—ñ –±—É–¥—É—Ç—å –ø—Ä–æ—ñ–≥–Ω–æ—Ä–æ–≤–∞–Ω—ñ.' : '');

    // –ø—Ä–µ–≤ º—é –∫–∞—Ä—Ç–∏–Ω–∫–∞
    previewThumb.innerHTML = '';
    if (firstUrl){
      const img = document.createElement('img');
      img.src = firstUrl;
      previewThumb.appendChild(img);
    } else {
      const span = document.createElement('span');
      span.className = 'preview-placeholder-text';
      span.textContent = '–¢—É—Ç –∑‚Äô—è–≤–∏—Ç—å—Å—è —Ç–≤–æ—è –º–æ–¥–µ–ª—å (–ø–µ—Ä—à–µ —Ñ–æ—Ç–æ)';
      previewThumb.appendChild(span);
    }

    if (n){
      const list = Array.from(files).slice(0, PHOTO_LIMIT);
      safeAssignFiles(coverFile, [list[0]], 1);   // cover_file
      safeAssignFiles(galFiles,  list.slice(1), 4);
    } else {
      safeAssignFiles(coverFile, [], 1);
      safeAssignFiles(galFiles,  [], 4);
    }
  }

  attachTile(zipTile,  zipPool,  updateZipUI);
  attachTile(stlTile,  stlPool,  updateStlUI);
  attachTile(photoTile,photoPool,updatePhotoUI);

  // init
  updateZipUI(zipPool.files||[]);
  updateStlUI(stlPool.files||[]);
  updatePhotoUI(photoPool.files||[]);

  function validateFiles(){
    return !!(stlPool.files && stlPool.files.length);
  }

  // Legacy upload (fallback if draft workflow fails)
  async function legacyUploadSubmit() {
    const fd = new FormData(form);
    fd.set('user_id', String(CURRENT_USER_ID));
    fd.set('tags', tags.join(', '));
    
    const free = isFreeToggle.checked;
    fd.set('is_free', free ? '1' : '0');
    const priceVal = Number(priceInput.value || 0);
    fd.set('price', String(Math.max(0, Math.floor(priceVal))));

    if (!(zipFile.files && zipFile.files.length))     fd.delete('zip_file');
    if (!(stlMain.files && stlMain.files.length))     fd.delete('file');
    if (!(coverFile.files && coverFile.files.length)) fd.delete('cover_file');

    if (stlExtras && stlExtras.files && stlExtras.files.length){
      const keep = Math.min(stlExtras.files.length, 4);
      fd.delete('stl_files');
      for (let i=0;i<keep;i++){
        fd.append('stl_files', stlExtras.files[i], stlExtras.files[i].name);
      }
    }
    if (galFiles && galFiles.files && galFiles.files.length){
      const keep = Math.min(galFiles.files.length, 4);
      fd.delete('gallery_files');
      for (let i=0;i<keep;i++){
        fd.append('gallery_files', galFiles.files[i], galFiles.files[i].name);
      }
    }

    const r = await fetch('/api/market/upload', {
      method:'POST',
      body: fd,
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin'
    });

    let j = null;
    try {
      j = await r.clone().json();
    } catch {
      const txt = (await r.text()).slice(0,200);
      msg.textContent = '–ü–æ–º–∏–ª–∫–∞ ' + r.status + ': ' + txt;
      return;
    }

    if (j.ok){
      msg.textContent = '–ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏‚Ä¶';
      if (j.id){
        setTimeout(()=>{ window.location.href = '/item/' + j.id; }, 500);
      }
    } else {
      msg.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + (j.error || 'server');
    }
  }

  // NEW: Draft workflow with background upload
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';

    if (!CURRENT_USER_ID){
      msg.textContent = '–ü–æ—Ç—Ä—ñ–±–Ω–æ —É–≤—ñ–π—Ç–∏, —â–æ–± –¥–æ–¥–∞—Ç–∏ –º–æ–¥–µ–ª—å.';
      return;
    }
    if (!validateFiles()){
      msg.textContent = '–î–æ–¥–∞–π 3D-—Ñ–∞–π–ª–∏ (–º—ñ–Ω—ñ–º—É–º 1).';
      return;
    }

    // Check if uploadManager available
    if (!window.uploadManager) {
      console.warn('[UPLOAD] uploadManager not available, using legacy upload');
      return legacyUploadSubmit();
    }

    try {
      // Collect form data
      const descTextarea = document.querySelector('#desc') || document.querySelector('textarea[name="desc"]') || document.querySelector('textarea[name="description"]');
      const descVal = (descTextarea?.value || '').trim();
      const formData = {
        title: titleInput.value || 'Untitled Model',
        price: Number(priceInput.value || 0),
        tags: tags.join(', '),
        desc: descVal
      };

      // STEP 1: Create draft
      msg.textContent = '–°—Ç–≤–æ—Ä—é—î–º–æ —á–µ—Ä–Ω–µ—Ç–∫—É...';
      const draft = await window.uploadManager.createDraft(formData);
      
      if (!draft || !draft.ok) {
        console.warn('[UPLOAD] Draft creation failed, using legacy');
        return legacyUploadSubmit();
      }

      console.log('[UPLOAD] Draft created:', draft.item_id);

      // STEP 2: Collect files for upload
      const files = {
        stl: stlMain.files[0],
        zip: zipFile.files[0],
        cover: coverFile.files[0]
      };

      // STEP 3: Check if we have large files that need chunking
      // ‚úÖ Use shared threshold from upload_manager.js
      const THRESHOLD = window.UPLOAD_LARGE_FILE_THRESHOLD || (15 * 1024 * 1024);
      
      // ‚úÖ Check BOTH individual file size AND total size
      const fileSizes = Object.values(files).filter(f => f).map(f => f.size);
      const totalSize = fileSizes.reduce((sum, size) => sum + size, 0);
      const hasLargeFiles = fileSizes.some(size => size > THRESHOLD) || totalSize > THRESHOLD;
      
      console.log(`[UPLOAD] Files check: individual max=${Math.max(...fileSizes, 0)} total=${totalSize} threshold=${THRESHOLD} large=${hasLargeFiles}`);
      
      if (hasLargeFiles) {
        // ‚úÖ PRODUCTION FIX: Don't redirect if large files
        // Keep user on upload.html, show progress, redirect after completion
        console.log('[UPLOAD] üì¶ Large files detected - staying on page for stable upload');
        msg.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤...';
        
        // Upload with await (blocking) - redirect only after completion
        await uploadInBackground(draft.item_id, draft.upload_urls, files, draft.cloudinary);
        
        console.log('[UPLOAD] ‚úÖ Upload complete, redirecting now');
        msg.textContent = '–ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ—Ö—ñ–¥...';
        setTimeout(() => {
          window.location.href = '/market';
        }, 500);
        
      } else {
        // ‚úÖ Small files - can redirect immediately
        console.log('[UPLOAD] üìÑ Small files - safe to redirect immediately');
        
        // Start background upload (non-blocking)
        uploadInBackground(draft.item_id, draft.upload_urls, files, draft.cloudinary);
        
        console.log('[UPLOAD] üöÄ Background upload started for item:', draft.item_id);
        
        // Redirect immediately
        msg.textContent = '–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –º–∞—Ä–∫–µ—Ç—É...';
        window.location.href = '/market';
      }

    } catch (err) {
      console.error('[UPLOAD] Error:', err);
      console.warn('[UPLOAD] Falling back to legacy upload');
      return legacyUploadSubmit();
    }
  });

  // Background upload function (returns Promise for await support)
  async function uploadInBackground(itemId, uploadUrls, files, cloudinaryConfig) {
    try {
      const uploadedUrls = {
        stl_urls: []  // ‚úÖ Collect multiple STL files in array
      };

      // Upload each file
      for (const [type, file] of Object.entries(files)) {
        if (!file) continue;

        try {
          console.log(`[UPLOAD] Uploading ${type}:`, file.name, `(${(file.size / 1024 / 1024).toFixed(1)}MB)`);
          const url = await window.uploadManager.uploadFile(itemId, file, type);
          
          if (url) {
            // ‚úÖ Handle multiple STL files (collect in array instead of overwriting)
            if (type === 'stl') {
              uploadedUrls.stl_urls.push(url);
              console.log(`[UPLOAD] ‚úÖ STL uploaded (${uploadedUrls.stl_urls.length}):`, url);
            } else {
              uploadedUrls[`${type}_url`] = url;
              console.log(`[UPLOAD] ‚úÖ ${type} uploaded:`, url);
            }
          }
        } catch (err) {
          console.error(`[UPLOAD] ‚ùå Failed to upload ${type}:`, err);
        }
      }

      // STEP 3: Attach files and publish
      console.log('[UPLOAD] Attaching files:', uploadedUrls);
      await window.uploadManager.completeUpload(itemId, uploadedUrls);
      console.log('[UPLOAD] ‚úÖ Upload complete!');

      return true; // Success

    } catch (err) {
      console.error('[UPLOAD] ‚ùå Background upload failed:', err);
      throw err; // Re-throw for caller to handle
    }
  }
})();
</script>

<!-- Upload Manager for draft workflow + chunked uploads -->
<script defer src="{{ url_for('static', filename='market/js/upload_manager.js', v=asset_v) }}"></script>
{% endblock %} 
