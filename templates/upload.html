{% extends "base.html" %}
{% block content %}
<h1>+ Додати STL</h1>

<style>
  .drop-tile{
    width:100%; aspect-ratio: 16/6; max-height:280px;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#3a3f51 0%, #2a2f3d 100%);
    border:2px dashed #5a6380; border-radius:14px;
    cursor:pointer; position:relative; overflow:hidden;
    transition: transform .12s ease, border-color .12s ease;
  }
  .drop-tile:hover{ transform:scale(1.005); border-color:#7c88b2; }
  .drop-center{ text-align:center; pointer-events:none; user-select:none; }
  .drop-title{ font-size:22px; font-weight:700; }
  .drop-sub{ font-size:13px; opacity:.85; margin-top:4px }
  .thumbs{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
  .thumb{ width:100px; height:75px; border-radius:10px; overflow:hidden; border:1px solid #1b2131; background:#111 }
  .thumb img{ width:100%; height:100%; object-fit:cover }
  .badge{
    position:absolute; top:10px; right:10px;
    background:#111a; color:#fff; padding:4px 8px; border-radius:999px;
    font-size:12px; border:1px solid #ffffff22;
  }
  .note-muted{ color:#aab1c7; font-size:12px }
  .fieldset{ border:1px solid #1b2131; border-radius:10px; padding:12px }
  .list{ font-size:13px; color:#cdd3e6; margin-top:8px }
</style>

<div class="card" style="max-width:800px">
  <!-- важливо: novalidate — відключає нативну валідацію, щоб не було focusable-ерору -->
  <form id="uploadForm" enctype="multipart/form-data" novalidate>
    <label>Назва</label>
    <input id="title" name="title" required placeholder="Dragon, Phone stand…" style="width:100%">

    <div style="height:10px"></div>

    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <div style="flex:1; min-width:160px">
        <label>Ціна (0 = безкоштовно)</label>
        <input id="price" name="price" type="number" min="0" value="0" required style="width:100%">
      </div>
      <div style="flex:2; min-width:220px">
        <label>Теги (через кому)</label>
        <input id="tags" name="tags" placeholder="dragon,toy,figure" style="width:100%">
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- 3D-ФАЙЛИ (одна плитка, до 5) -->
    <fieldset class="fieldset">
      <legend style="padding:0 6px">3D-файли (обовʼязково, до 5)</legend>

      <!-- Пул (користувач обирає тут) -->
      <input id="stl_pool" type="file" multiple accept=".stl,.obj,.ply,.gltf,.glb" style="display:none" aria-required="true">

      <!-- Реальні поля для бекенду (приховані). ВАЖЛИВО: без required -->
      <input id="stl_file"  name="stl_file"  type="file" accept=".stl,.obj,.ply,.gltf,.glb" style="display:none">
      <input id="stl_files" name="stl_files" type="file" accept=".stl,.obj,.ply,.gltf,.glb" multiple style="display:none">

      <div id="stl_tile" class="drop-tile" tabindex="0" aria-label="Додай 3D-файли">
        <div class="drop-center">
          <div class="drop-title">Додай 3D-файли</div>
          <div class="drop-sub">STL / OBJ / PLY / GLTF / GLB — перетягни або натисни (до 5)</div>
        </div>
        <div id="stl_badge" class="badge">0/5</div>
      </div>

      <div id="stl_list" class="list"></div>
      <div id="stl_file_hint" class="note-muted" style="margin-top:6px">Перший файл стане основним, решта — додаткові.</div>
    </fieldset>

    <div style="height:14px"></div>

    <!-- ФОТО (одна плитка, до 5) -->
    <fieldset class="fieldset">
      <legend style="padding:0 6px">Фото (необовʼязково, до 5)</legend>

      <!-- Пул -->
      <input id="photo_pool" type="file" multiple accept=".jpg,.jpeg,.png,.webp" style="display:none">

      <!-- Реальні поля для бекенду (приховані) -->
      <input id="cover_file"    name="cover_file"    type="file" accept=".jpg,.jpeg,.png,.webp" style="display:none">
      <input id="gallery_files" name="gallery_files" type="file" accept=".jpg,.jpeg,.png,.webp" multiple style="display:none">

      <div id="photo_tile" class="drop-tile" tabindex="0" aria-label="Додай фото">
        <div class="drop-center">
          <div class="drop-title">Додай фото</div>
          <div class="drop-sub">JPG / PNG / WEBP — перетягни або натисни (до 5)</div>
        </div>
        <div id="gal_badge" class="badge">0/5</div>
      </div>

      <div id="gallery_preview" class="thumbs"></div>
      <div id="gallery_note" class="note-muted" style="margin-top:6px">Перше фото стане обкладинкою, решта — в галерею.</div>
    </fieldset>

    <div style="height:14px"></div>

    <label>Опис</label>
    <textarea id="desc" name="desc" rows="5" placeholder="Короткий опис моделі…" style="width:100%"></textarea>

    <div style="height:14px"></div>

    <button class="btn primary" id="send" type="submit">Зберегти</button>
    <span id="msg" class="muted" style="margin-left:10px"></span>
  </form>
</div>

<script>
(function(){
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};

  const form = document.getElementById('uploadForm');
  const msg  = document.getElementById('msg');

  // Пули
  const stlPool   = document.getElementById('stl_pool');
  const photoPool = document.getElementById('photo_pool');

  // Реальні поля для бекенду
  const stlMain   = document.getElementById('stl_file');
  const stlExtras = document.getElementById('stl_files');
  const coverFile = document.getElementById('cover_file');
  const galFiles  = document.getElementById('gallery_files');

  // Плитки/віджети
  const stlTile   = document.getElementById('stl_tile');
  const stlBadge  = document.getElementById('stl_badge');
  const stlList   = document.getElementById('stl_list');
  const stlHint   = document.getElementById('stl_file_hint');

  const photoTile  = document.getElementById('photo_tile');
  const galBadge   = document.getElementById('gal_badge');
  const galPreview = document.getElementById('gallery_preview');
  const galNote    = document.getElementById('gallery_note');

  const STL_LIMIT = 5;
  const PHOTO_LIMIT = 5;

  function attachTile(tile, input, onFiles){
    tile.addEventListener('click', ()=> input.click());
    tile.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); input.click(); }});
    ['dragenter','dragover'].forEach(ev=>{
      tile.addEventListener(ev, (e)=>{ e.preventDefault(); tile.style.borderColor='#8ea0d8'; tile.style.transform='scale(1.01)'; });
    });
    ['dragleave','drop'].forEach(ev=>{
      tile.addEventListener(ev, (e)=>{ e.preventDefault(); tile.style.borderColor=''; tile.style.transform=''; });
    });
    tile.addEventListener('drop', (e)=>{
      if(!e.dataTransfer || !e.dataTransfer.files) return;
      input.files = e.dataTransfer.files;
      onFiles && onFiles(input.files);
    });
    input.addEventListener('change', ()=> onFiles && onFiles(input.files||[]));
  }

  function updateStlUI(files){
    const n = Math.min(files.length, STL_LIMIT);
    stlBadge.textContent = `${n}/${STL_LIMIT}`;
    stlList.textContent = n ? Array.from(files).slice(0,STL_LIMIT).map(f=>f.name).join(' • ') : '';
    stlHint.textContent = n ? 'Файли вибрано.' : 'Перший файл стане основним, решта — додаткові.';
  }

  function updatePhotoUI(files){
    galPreview.innerHTML = '';
    const n = Math.min(files.length, PHOTO_LIMIT);
    for(let i=0;i<n;i++){
      const url = URL.createObjectURL(files[i]);
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = document.createElement('img');
      img.src = url;
      div.appendChild(img);
      galPreview.appendChild(div);
    }
    galBadge.textContent = `${n}/${PHOTO_LIMIT}`;
    galNote.textContent  = 'Перше фото стане обкладинкою, решта — в галерею.' + (files.length>PHOTO_LIMIT ? ' Зайві будуть проігноровані.' : '');
  }

  function distributeFiles(){
    // STL → stl_file + stl_files
    if (stlPool.files && stlPool.files.length){
      const list = Array.from(stlPool.files).slice(0, STL_LIMIT);
      const dtMain = new DataTransfer();
      dtMain.items.add(list[0]);
      stlMain.files = dtMain.files;

      const dtExtra = new DataTransfer();
      for(let i=1; i<list.length && i<5; i++){ dtExtra.items.add(list[i]); }
      stlExtras.files = dtExtra.files;
    } else {
      const empty = new DataTransfer();
      stlMain.files = empty.files;
      stlExtras.files = empty.files;
    }

    // Photos → cover_file + gallery_files
    if (photoPool.files && photoPool.files.length){
      const list = Array.from(photoPool.files).slice(0, PHOTO_LIMIT);
      const dtCover = new DataTransfer();
      dtCover.items.add(list[0]);
      coverFile.files = dtCover.files;

      const dtGal = new DataTransfer();
      for(let i=1; i<list.length && i<5; i++){ dtGal.items.add(list[i]); }
      galFiles.files = dtGal.files;
    } else {
      const empty = new DataTransfer();
      coverFile.files = empty.files;
      galFiles.files = empty.files;
    }
  }

  attachTile(stlTile, stlPool, updateStlUI);
  attachTile(photoTile, photoPool, updatePhotoUI);

  // init
  updateStlUI(stlPool.files||[]);
  updatePhotoUI(photoPool.files||[]);

  function validateFiles(){
    return !!(stlPool.files && stlPool.files.length);
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';

    if (!CURRENT_USER_ID){ msg.textContent = 'Потрібно увійти, щоб додати модель.'; return; }
    if (!validateFiles()){ msg.textContent = 'Додай 3D-файли (мінімум 1).'; return; }

    // Розкладаємо пули у реальні поля
    distributeFiles();

    const fd = new FormData(form);

    // якщо порожньо — видаляємо (як і раніше)
    if (!(stlMain.files && stlMain.files.length)) fd.delete('stl_file');
    if (!(coverFile.files && coverFile.files.length)) fd.delete('cover_file');

    const tagsRaw = (document.getElementById('tags').value || '').trim();
    const tagsArr = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
    fd.set('tags', JSON.stringify(tagsArr));
    fd.set('user_id', String(CURRENT_USER_ID));

    // контроль лімітів для старих браузерів
    if (stlExtras && stlExtras.files && stlExtras.files.length){
      const keep = Math.min(stlExtras.files.length, 4);
      fd.delete('stl_files');
      for (let i=0;i<keep;i++){ fd.append('stl_files', stlExtras.files[i], stlExtras.files[i].name); }
    }
    if (galFiles && galFiles.files && galFiles.files.length){
      const keep = Math.min(galFiles.files.length, 4);
      fd.delete('gallery_files');
      for (let i=0;i<keep;i++){ fd.append('gallery_files', galFiles.files[i], galFiles.files[i].name); }
    }

    try{
      const r = await fetch('/api/upload', { method:'POST', body: fd, headers: { 'Accept': 'application/json' }});
      let j = null;
      try { j = await r.clone().json(); }
      catch { msg.textContent = 'Помилка ' + r.status + ': ' + (await r.text()).slice(0,200); return; }

      if (j.ok){
        msg.textContent = 'Готово! Перехід до сторінки…';
        setTimeout(()=>{ window.location.href = '/item/' + j.id; }, 500);
      } else {
        msg.textContent = 'Помилка: ' + (j.error || 'server');
      }
    } catch(err){
      console.error(err);
      msg.textContent = 'Помилка мережі.';
    }
  });
})();
</script>
{% endblock %}
