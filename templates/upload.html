{% extends "base.html" %}
{% block content %}
<h1>+ Додати STL</h1>

<style>
  .drop-tile{
    width:100%; aspect-ratio: 16/6; max-height:280px;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#3a3f51 0%, #2a2f3d 100%);
    border:2px dashed #5a6380; border-radius:14px;
    cursor:pointer; position:relative; overflow:hidden;
    transition: transform .12s ease, border-color .12s ease;
  }
  .drop-tile:hover{ transform:scale(1.005); border-color:#7c88b2; }
  .drop-center{
    text-align:center; pointer-events:none; user-select:none;
  }
  .drop-title{ font-size:22px; font-weight:700; }
  .drop-sub{ font-size:13px; opacity:.85; margin-top:4px }
  .thumbs{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
  .thumb{
    width:100px; height:75px; border-radius:10px; overflow:hidden;
    border:1px solid #1b2131; position:relative; background:#111;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover }
  .badge{
    position:absolute; top:10px; right:10px;
    background:#111a; color:#fff; padding:4px 8px; border-radius:999px;
    font-size:12px; border:1px solid #ffffff22;
  }
  .note-row{ display:flex; align-items:center; gap:12px; margin-top:10px }
  .note-muted{ color:#aab1c7; font-size:12px }
  .fieldset{ border:1px solid #1b2131; border-radius:10px; padding:12px }
</style>

<div class="card" style="max-width:800px">
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Назва</label>
    <input id="title" name="title" required placeholder="Dragon, Phone stand…" style="width:100%">

    <div style="height:10px"></div>

    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <div style="flex:1; min-width:160px">
        <label>Ціна (0 = безкоштовно)</label>
        <input id="price" name="price" type="number" min="0" value="0" required style="width:100%">
      </div>
      <div style="flex:2; min-width:220px">
        <label>Теги (через кому)</label>
        <input id="tags" name="tags" placeholder="dragon,toy,figure" style="width:100%">
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- ОСНОВНИЙ 3D-ФАЙЛ (плитка) -->
    <fieldset class="fieldset">
      <legend style="padding:0 6px">3D-модель (обовʼязково)</legend>

      <!-- Прихований інпут (не чіпаємо ідентифікатор/імʼя) -->
      <input id="stl_file" name="stl_file" type="file" accept=".stl,.obj,.ply,.gltf,.glb" required style="display:none">

      <!-- Плитка як на OLX -->
      <div id="stl_tile" class="drop-tile" tabindex="0" aria-label="Додай основний 3D-файл">
        <div class="drop-center">
          <div class="drop-title">Додай 3D-файл</div>
          <div class="drop-sub">STL / OBJ / PLY / GLTF / GLB — перетягни сюди або натисни</div>
        </div>
        <div id="stl_badge" class="badge" style="display:none">1/1</div>
      </div>

      <div class="note-row">
        <div id="stl_file_hint" class="note-muted">Перетягни файл сюди або вибери.</div>
      </div>

      <div class="note-muted" style="margin-top:8px">
        Макс. загалом 3D-файлів: 5 (1 основний + до 4 додаткових нижче).
      </div>
    </fieldset>

    <div style="height:10px"></div>

    <!-- ДОДАТКОВІ 3D-ФАЙЛИ (плитка з прев’ю) -->
    <fieldset class="fieldset">
      <legend style="padding:0 6px">Додаткові 3D-файли (необовʼязково)</legend>

      <input id="stl_files" name="stl_files" type="file" multiple accept=".stl,.obj,.ply,.gltf,.glb" style="display:none">
      <div id="stl_multi_tile" class="drop-tile" tabindex="0" aria-label="Додай додаткові 3D-файли">
        <div class="drop-center">
          <div class="drop-title">Додай ще 3D-файли</div>
          <div class="drop-sub">До 4 шт. — перетягни або натисни</div>
        </div>
        <div id="stl_multi_badge" class="badge">0/4</div>
      </div>

      <div id="stl_multi_note" class="note-muted" style="margin-top:8px">Обрано: 0 / 4</div>
      <div id="stl_list" class="note-muted" style="margin-top:6px"></div>
    </fieldset>

    <div style="height:14px"></div>

    <!-- ОБКЛАДИНКА (1 фото) -->
    <fieldset class="fieldset">
      <legend style="padding:0 6px">Обкладинка (необовʼязково)</legend>

      <input id="cover_file" name="cover_file" type="file" accept=".jpg,.jpeg,.png,.webp" style="display:none">

      <div id="cover_tile" class="drop-tile" tabindex="0" aria-label="Додай обкладинку">
        <div class="drop-center" id="cover_center">
          <div class="drop-title">Додай обкладинку</div>
          <div class="drop-sub">JPG / PNG / WEBP — 1 фото</div>
        </div>
        <img id="cover_preview" src="" alt="" style="display:none; width:100%; height:100%; object-fit:cover">
      </div>

      <div class="note-row">
        <span id="cover_note" class="note-muted">Попередній перегляд зʼявиться після вибору файлу.</span>
      </div>
    </fieldset>

    <div style="height:10px"></div>

    <!-- ГАЛЕРЕЯ ФОТО (плитка як на OLX) -->
    <fieldset class="fieldset">
      <legend style="padding:0 6px">Галерея фото (необовʼязково)</legend>

      <input id="gallery_files" name="gallery_files" type="file" multiple accept=".jpg,.jpeg,.png,.webp" style="display:none">

      <div id="gal_tile" class="drop-tile" tabindex="0" aria-label="Додай фото до галереї">
        <div class="drop-center">
          <div class="drop-title">Додай фото</div>
          <div class="drop-sub">До 5 знімків — перетягни або натисни</div>
        </div>
        <div id="gal_badge" class="badge">0/5</div>
      </div>

      <div id="gallery_note" class="note-muted" style="margin-top:8px">Обрано: 0 / 5</div>
      <div id="gallery_preview" class="thumbs"></div>
    </fieldset>

    <div style="height:14px"></div>

    <label>Опис</label>
    <textarea id="desc" name="desc" rows="5" placeholder="Короткий опис моделі…" style="width:100%"></textarea>

    <div style="height:14px"></div>

    <button class="btn primary" id="send" type="submit">Зберегти</button>
    <span id="msg" class="muted" style="margin-left:10px"></span>
  </form>
</div>

<script>
(function(){
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};

  const form = document.getElementById('uploadForm');
  const msg  = document.getElementById('msg');

  // ----- ЕЛЕМЕНТИ -----
  const coverFile = document.getElementById('cover_file');
  const coverPrev = document.getElementById('cover_preview');
  const coverNote = document.getElementById('cover_note');
  const coverTile = document.getElementById('cover_tile');
  const coverCenter = document.getElementById('cover_center');

  const stlFileEl = document.getElementById('stl_file');
  const stlTile   = document.getElementById('stl_tile');
  const stlBadge  = document.getElementById('stl_badge');
  const stlHint   = document.getElementById('stl_file_hint');

  const stlMulti   = document.getElementById('stl_files');
  const stlMultiTile = document.getElementById('stl_multi_tile');
  const stlMultiBadge = document.getElementById('stl_multi_badge');
  const stlMultiNote  = document.getElementById('stl_multi_note');
  const stlList    = document.getElementById('stl_list');

  const galInput   = document.getElementById('gallery_files');
  const galTile    = document.getElementById('gal_tile');
  const galBadge   = document.getElementById('gal_badge');
  const galNote    = document.getElementById('gallery_note');
  const galPreview = document.getElementById('gallery_preview');

  const STL_TOTAL_LIMIT = 5;  // 1 основний + додаткові
  const STL_EXTRA_LIMIT = 4;  // саме додаткові
  const GALLERY_LIMIT   = 5;

  // ----- ХЕЛПЕРИ -----
  function attachTile(tile, input, onFiles){
    // клік по плитці -> вибір файлів
    tile.addEventListener('click', ()=> input.click());
    tile.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); input.click(); }});

    // drag & drop
    ['dragenter','dragover'].forEach(ev=>{
      tile.addEventListener(ev, (e)=>{ e.preventDefault(); tile.style.borderColor='#8ea0d8'; tile.style.transform='scale(1.01)'; });
    });
    ['dragleave','drop'].forEach(ev=>{
      tile.addEventListener(ev, (e)=>{ e.preventDefault(); tile.style.borderColor=''; tile.style.transform=''; });
    });
    tile.addEventListener('drop', (e)=>{
      if(!e.dataTransfer || !e.dataTransfer.files) return;
      input.files = e.dataTransfer.files;
      onFiles && onFiles(input.files);
    });

    // звичайний вибір
    input.addEventListener('change', ()=> onFiles && onFiles(input.files||[]));
  }

  function showCover(file){
    if(!file){
      coverPrev.style.display='none';
      coverPrev.src='';
      coverCenter.style.display='';
      coverNote.textContent='Попередній перегляд зʼявиться після вибору файлу.';
      return;
    }
    coverPrev.src = URL.createObjectURL(file);
    coverPrev.onload = ()=>{
      coverPrev.style.display='block';
      coverCenter.style.display='none';
      coverNote.textContent='Обкладинку додано.';
    };
  }

  function renderGalleryPreview(files){
    galPreview.innerHTML = '';
    const n = Math.min(files.length, GALLERY_LIMIT);
    for(let i=0;i<n;i++){
      const f = files[i];
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className='thumb';
      const img = document.createElement('img');
      img.src = url;
      div.appendChild(img);
      galPreview.appendChild(div);
    }
    galBadge.textContent = `${Math.min(files.length, GALLERY_LIMIT)}/${GALLERY_LIMIT}`;
    galNote.textContent  = `Обрано: ${Math.min(files.length, GALLERY_LIMIT)} / ${GALLERY_LIMIT}` + (files.length>GALLERY_LIMIT ? ' (зайві будуть проігноровані)' : '');
  }

  function renderStlList(files){
    const n = Math.min(files.length, STL_EXTRA_LIMIT);
    stlList.textContent = n ? Array.from(files).slice(0,n).map(f=>f.name).join(' • ') : '';
    stlMultiBadge.textContent = `${n}/${STL_EXTRA_LIMIT}`;
    stlMultiNote.textContent  = `Обрано: ${n} / ${STL_EXTRA_LIMIT}` + (files.length>STL_EXTRA_LIMIT ? ' (зайві будуть проігноровані)' : '');
  }

  function updateMainStlBadge(){
    const has = stlFileEl.files && stlFileEl.files.length;
    stlBadge.style.display = has ? 'block' : 'none';
    stlBadge.textContent = has ? '1/1' : '';
    stlHint.textContent  = has ? 'Файл вибрано.' : 'Перетягни файл сюди або вибери.';
  }

  // ----- ПРИВʼЯЗКА ПЛИТОК -----
  attachTile(stlTile, stlFileEl, ()=> updateMainStlBadge());
  attachTile(stlMultiTile, stlMulti, renderStlList);
  attachTile(coverTile, coverFile, (files)=> showCover(files && files[0]));
  attachTile(galTile, galInput, renderGalleryPreview);

  // ініціалізація
  updateMainStlBadge();
  renderStlList(stlMulti.files||[]);
  renderGalleryPreview(galInput.files||[]);
  showCover(coverFile.files && coverFile.files[0]);

  // ----- ВАЛІДАЦІЯ -----
  function validateFiles(){
    return !!(stlFileEl.files && stlFileEl.files.length);
  }

  // ----- SUBMIT (НЕ ЗМІНЮВАЛИ ЛОГІКУ) -----
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';

    if (!CURRENT_USER_ID){ msg.textContent = 'Потрібно увійти, щоб додати модель.'; return; }
    if (!validateFiles()){ msg.textContent = 'Додай файл моделі (STL/OBJ/PLY/GLTF/GLB).'; return; }

    const fd = new FormData(form);

    if (!(stlFileEl.files && stlFileEl.files.length)) fd.delete('stl_file');
    if (!(coverFile.files && coverFile.files.length)) fd.delete('cover_file');

    const tagsRaw = (document.getElementById('tags').value || '').trim();
    const tagsArr = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
    fd.set('tags', JSON.stringify(tagsArr));
    fd.set('user_id', String(CURRENT_USER_ID));

    // ліміти — як раніше
    const baseCount = stlFileEl.files && stlFileEl.files.length ? 1 : 0;
    const extraAllowed = Math.max(0, Math.min(4, 5 - baseCount));
    if (stlMulti && stlMulti.files && stlMulti.files.length){
      fd.delete('stl_files');
      for (let i=0; i<Math.min(stlMulti.files.length, extraAllowed); i++){
        fd.append('stl_files', stlMulti.files[i], stlMulti.files[i].name);
      }
      if (stlMulti.files.length > extraAllowed){
        msg.textContent = `Увага: додаткових 3D-файлів понад ліміт. Зайві проігноровано.`;
      }
    }

    if (galInput && galInput.files && galInput.files.length){
      fd.delete('gallery_files');
      for (let i=0; i<Math.min(galInput.files.length, 5); i++){
        fd.append('gallery_files', galInput.files[i], galInput.files[i].name);
      }
      if (galInput.files.length > 5){
        msg.textContent = `Увага: фото у галереї понад ліміт. Зайві проігноровано.`;
      }
    }

    try{
      const r = await fetch('/api/upload', { method:'POST', body: fd, headers: { 'Accept': 'application/json' }});
      let j = null;
      try { j = await r.clone().json(); }
      catch { msg.textContent = 'Помилка ' + r.status + ': ' + (await r.text()).slice(0,200); return; }

      if (j.ok){
        msg.textContent = 'Готово! Перехід до сторінки…';
        setTimeout(()=>{ window.location.href = '/item/' + j.id; }, 500);
      } else {
        msg.textContent = 'Помилка: ' + (j.error || 'server');
      }
    } catch(err){
      console.error(err);
      msg.textContent = 'Помилка мережі.';
    }
  });

  // drag-feedback для основного інпута (залишив з твоєї версії)
  ['dragenter','dragover'].forEach(ev=>{
    stlFileEl.addEventListener(ev, (e)=>{ e.preventDefault(); if(stlHint){ stlHint.style.opacity='1'; stlHint.textContent='Відпускай — додамо файл'; } });
  });
  ['dragleave','drop'].forEach(ev=>{
    stlFileEl.addEventListener(ev, (e)=>{ e.preventDefault(); if(stlHint){ stlHint.style.opacity='0.8'; stlHint.textContent='Перетягни файл сюди або вибери.'; } });
  });
})();
</script>
{% endblock %}
