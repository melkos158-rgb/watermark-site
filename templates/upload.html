{% extends "base.html" %}
{% block content %}
<h1>+ Додати STL</h1>

<div class="card" style="max-width:800px">
  <form id="uploadForm" onsubmit="return false">
    <!-- Назва -->
    <label>Назва</label>
    <input id="title" name="title" required placeholder="Dragon, Phone stand…" style="width:100%">

    <div style="height:10px"></div>

    <!-- Ціна / Теги -->
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <div style="flex:1; min-width:160px">
        <label>Ціна (0 = безкоштовно)</label>
        <input id="price" name="price" type="number" min="0" value="0" required style="width:100%">
      </div>
      <div style="flex:2; min-width:220px">
        <label>Теги (через кому)</label>
        <input id="tags" placeholder="dragon,toy,figure" style="width:100%">
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- STL: файл або URL -->
    <fieldset style="border:1px solid #1b2131; border-radius:10px; padding:12px">
      <legend style="padding:0 6px">3D-модель</legend>

      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end">
        <div style="flex:1; min-width:260px">
          <label>Файл STL/OBJ/PLY/GLTF/GLB (не активний без ендпойнта аплоаду)</label>
          <input id="stl_file" name="stl_file" type="file"
                 accept=".stl,.obj,.ply,.gltf,.glb" />
          <div class="muted">Поки що використовуй поле “URL на файл” нижче.</div>
        </div>

        <div style="flex:1; min-width:260px">
          <label>АБО URL на файл</label>
          <input id="stl_url" name="stl_url" placeholder="/static/models/dragon.stl" style="width:100%">
        </div>
      </div>
    </fieldset>

    <div style="height:14px"></div>

    <!-- Обкладинка: файл або URL -->
    <fieldset style="border:1px solid #1b2131; border-radius:10px; padding:12px">
      <legend style="padding:0 6px">Обкладинка</legend>

      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end">
        <div style="flex:1; min-width:260px">
          <label>Файл JPG/PNG/WEBP (не активний без ендпойнта аплоаду)</label>
          <input id="cover_file" name="cover_file" type="file" accept=".jpg,.jpeg,.png,.webp">
          <div class="muted">Поки що використовуй “URL на картинку”.</div>
        </div>

        <div style="flex:1; min-width:260px">
          <label>АБО URL на картинку</label>
          <input id="cover_url" name="cover_url" placeholder="/static/img/dragon.jpg" style="width:100%">
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:12px; align-items:center">
        <img id="cover_preview" src="" alt="" style="display:none; width:120px; height:90px; object-fit:cover; border:1px solid #1b2131; border-radius:8px">
        <span class="muted" id="cover_note">Попередній перегляд зʼявиться після URL.</span>
      </div>
    </fieldset>

    <div style="height:14px"></div>

    <!-- Опис -->
    <label>Опис</label>
    <textarea id="desc" name="desc" rows="5" placeholder="Короткий опис моделі…" style="width:100%"></textarea>

    <div style="height:14px"></div>

    <button class="btn primary" id="send" type="submit">Зберегти</button>
    <span id="msg" class="muted" style="margin-left:10px"></span>
  </form>
</div>

<script>
(function(){
  const CURRENT_USER_ID = {{ (g.user.id if g is defined and g.user else 'null') }};
  const msg  = document.getElementById('msg');
  const form = document.getElementById('uploadForm');

  // Превʼю обкладинки за URL
  const coverUrl  = document.getElementById('cover_url');
  const coverPrev = document.getElementById('cover_preview');
  const coverNote = document.getElementById('cover_note');
  coverUrl.addEventListener('input', ()=>{
    const url = coverUrl.value.trim();
    if (!url){ coverPrev.style.display='none'; coverPrev.src=''; coverNote.textContent='Попередній перегляд зʼявиться після URL.'; return; }
    coverPrev.src = url;
    coverPrev.onload = ()=>{ coverPrev.style.display='inline-block'; coverNote.textContent=''; };
  });

  form.addEventListener('submit', async ()=>{
    msg.textContent = '';

    if (!CURRENT_USER_ID){
      msg.textContent = 'Потрібно увійти, щоб додати модель.';
      return;
    }

    // Якщо користувач вибрав файл — попереджаємо (аплоадів немає)
    const stlFile = document.getElementById('stl_file');
    const coverFile = document.getElementById('cover_file');
    if (stlFile.files.length){
      msg.textContent = 'Зараз аплоад файлів не підключений. Завантаж файл у /static і встав URL нижче.';
      return;
    }
    if (coverFile.files.length){
      msg.textContent = 'Зараз аплоад зображень не підключений. Завантаж у /static і встав URL нижче.';
      return;
    }

    const title = document.getElementById('title').value.trim();
    const price = +document.getElementById('price').value || 0;
    const tagsRaw = (document.getElementById('tags').value || '').trim();
    const tagsArr = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
    const url   = document.getElementById('stl_url').value.trim();
    const cover = document.getElementById('cover_url').value.trim();
    const desc  = document.getElementById('desc').value.trim();

    if (!title || !url){
      msg.textContent = 'Заповни Назву і URL STL.';
      return;
    }

    const body = {
      title, price, tags: tagsArr, url, cover, desc,
      user_id: CURRENT_USER_ID
    };

    try{
      const r = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const j = await r.json();
      if (j.ok){
        msg.textContent = 'Готово! Перехід до сторінки…';
        setTimeout(()=>{ window.location.href = '/item/' + j.id; }, 500);
      }else{
        msg.textContent = 'Помилка: ' + (j.error || 'server');
      }
    }catch(e){
      console.error(e);
      msg.textContent = 'Помилка мережі.';
    }
  });
})();
</script>
{% endblock %}
