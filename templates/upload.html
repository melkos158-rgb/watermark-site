{% extends "base.html" %}
{% block content %}
<h1>+ Додати STL</h1>

<div class="card" style="max-width:800px">
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Назва</label>
    <input id="title" name="title" required placeholder="Dragon, Phone stand…" style="width:100%">

    <div style="height:10px"></div>

    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <div style="flex:1; min-width:160px">
        <label>Ціна (0 = безкоштовно)</label>
        <input id="price" name="price" type="number" min="0" value="0" required style="width:100%">
      </div>
      <div style="flex:2; min-width:220px">
        <label>Теги (через кому)</label>
        <input id="tags" name="tags" placeholder="dragon,toy,figure" style="width:100%">
      </div>
    </div>

    <div style="height:14px"></div>

    <fieldset style="border:1px solid #1b2131; border-radius:10px; padding:12px">
      <legend style="padding:0 6px">3D-модель</legend>
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end">
        <div style="flex:1; min-width:260px">
          <label>Файл STL/OBJ/PLY/GLTF/GLB</label>
          <input id="stl_file" name="stl_file" type="file" accept=".stl,.obj,.ply,.gltf,.glb">
          <div class="muted" id="stl_file_hint">Можна перетягнути файл сюди або вибрати.</div>
        </div>
        <div style="flex:1; min-width:260px">
          <label>АБО URL на файл</label>
          <input id="stl_url" name="stl_url" placeholder="https://..., або /static/market_uploads/... .stl" style="width:100%">
        </div>
      </div>
    </fieldset>

    <div style="height:14px"></div>

    <fieldset style="border:1px solid #1b2131; border-radius:10px; padding:12px">
      <legend style="padding:0 6px">Обкладинка</legend>
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end">
        <div style="flex:1; min-width:260px">
          <label>Файл JPG/PNG/WEBP</label>
          <input id="cover_file" name="cover_file" type="file" accept=".jpg,.jpeg,.png,.webp">
          <div class="muted">Необовʼязково. Якщо не вкажеш — поставимо плейсхолдер.</div>
        </div>
        <div style="flex:1; min-width:260px">
          <label>АБО URL на картинку</label>
          <input id="cover_url" name="cover_url" placeholder="https://..., або /static/..." style="width:100%">
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:12px; align-items:center">
        <img id="cover_preview" src="" alt="" style="display:none; width:120px; height:90px; object-fit:cover; border:1px solid #1b2131; border-radius:8px">
        <span class="muted" id="cover_note">Попередній перегляд зʼявиться після вибору файлу або URL.</span>
      </div>
    </fieldset>

    <div style="height:14px"></div>

    <label>Опис</label>
    <textarea id="desc" name="desc" rows="5" placeholder="Короткий опис моделі…" style="width:100%"></textarea>

    <div style="height:14px"></div>

    <button class="btn primary" id="send" type="submit">Зберегти</button>
    <span id="msg" class="muted" style="margin-left:10px"></span>
  </form>
</div>

<script>
(function(){
  const CURRENT_USER_ID = {{ (session.get('user_id') or none) | tojson }};

  const form = document.getElementById('uploadForm');
  const msg  = document.getElementById('msg');

  const coverFile = document.getElementById('cover_file');
  const coverUrl  = document.getElementById('cover_url');
  const coverPrev = document.getElementById('cover_preview');
  const coverNote = document.getElementById('cover_note');

  const stlFileEl = document.getElementById('stl_file');
  const stlUrlEl  = document.getElementById('stl_url');

  // Допускаємо лише абсолютний http(s) або шлях, що починається з /static/
  const isValidUrlField = (u) => /^https?:\/\//i.test(u) || u.startsWith('/static/');

  function showCover(src){
    if(!src){
      coverPrev.style.display='none';
      coverPrev.src='';
      coverNote.textContent='Попередній перегляд зʼявиться після вибору файлу або URL.';
      return;
    }
    coverPrev.src = src;
    coverPrev.onload = ()=>{ coverPrev.style.display='inline-block'; coverNote.textContent=''; };
    coverPrev.onerror = ()=>{ coverPrev.style.display='none'; coverNote.textContent='Не вдалося завантажити зображення.'; };
  }

  coverFile.addEventListener('change', ()=>{
    const f = coverFile.files && coverFile.files[0];
    if (f) showCover(URL.createObjectURL(f));
  });

  coverUrl.addEventListener('input', ()=>{
    const url = coverUrl.value.trim();
    if (isValidUrlField(url)) showCover(url); else if (!url) showCover('');
  });

  function validateModelSource(){
    const hasFile = stlFileEl.files && stlFileEl.files.length;
    const u = (stlUrlEl.value || '').trim();
    const hasUrl = u && isValidUrlField(u);
    return hasFile || hasUrl;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';

    if (!CURRENT_USER_ID){ msg.textContent = 'Потрібно увійти, щоб додати модель.'; return; }

    // Жорстка валідація джерела моделі
    const hasFile = stlFileEl.files && stlFileEl.files.length;
    const stlUrl  = (stlUrlEl.value || '').trim();
    if (!hasFile && !isValidUrlField(stlUrl)){
      msg.textContent = 'Вкажи файл моделі або коректний URL (http/https або шлях, що починається з /static/...).';
      return;
    }

    // Якщо вибрано файл — URL прибираємо, щоб не плутати бекенд
    const fd = new FormData(form);
    if (hasFile) fd.delete('stl_url');

    // Обкладинка: якщо файл не вибрали, але в полі URL щось є — візьмемо тільки коректний варіант
    const coverHasFile = coverFile.files && coverFile.files.length;
    const coverU = (coverUrl.value || '').trim();
    if (coverHasFile) {
      fd.delete('cover_url');
    } else {
      if (!isValidUrlField(coverU)) fd.delete('cover_url');
    }

    // Теги -> масив
    const tagsRaw = (document.getElementById('tags').value || '').trim();
    const tagsArr = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
    fd.set('tags', JSON.stringify(tagsArr));

    // Ціна -> число
    const priceEl = document.getElementById('price');
    const priceNum = Number(priceEl.value || 0);
    fd.set('price', String(isFinite(priceNum) ? priceNum : 0));

    // user_id
    fd.set('user_id', String(CURRENT_USER_ID));

    try{
      const r = await fetch('/api/upload', { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });
      let j = null;
      try { j = await r.clone().json(); }
      catch { msg.textContent = `Помилка ${r.status}: ${(await r.text()).slice(0,200)}`; return; }

      if (j.ok){
        msg.textContent = 'Готово! Перехід до сторінки…';
        setTimeout(()=>{ window.location.href = '/item/' + j.id; }, 400);
      } else {
        msg.textContent = 'Помилка: ' + (j.error || 'server');
      }
    } catch(err){
      console.error(err);
      msg.textContent = 'Помилка мережі.';
    }
  });

  // drag&drop підказки
  const stlHint  = document.getElementById('stl_file_hint');
  ['dragenter','dragover'].forEach(ev=>{
    stlFileEl.addEventListener(ev, (e)=>{ e.preventDefault(); if(stlHint){ stlHint.style.opacity='1'; stlHint.textContent='Відпускай — додамо файл'; } });
  });
  ['dragleave','drop'].forEach(ev=>{
    stlFileEl.addEventListener(ev, (e)=>{ e.preventDefault(); if(stlHint){ stlHint.style.opacity='0.8'; stlHint.textContent='Можна перетягнути файл сюди або вибрати.'; } });
  });
})();
</script>
{% endblock %}
